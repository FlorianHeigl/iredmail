diff -ruNa 0.2-stable.old/config/main.inc.php.dist 0.2-stable/config/main.inc.php.dist
--- 0.2-stable.old/config/main.inc.php.dist	2008-12-30 15:33:28.000000000 +0100
+++ 0.2-stable/config/main.inc.php.dist	2009-01-03 13:51:32.635810415 +0100
@@ -316,6 +316,24 @@
 // default sort order
 $rcmail_config['message_sort_order'] = 'DESC';
 
+// managesieve server port
+$rcmail_config['managesieve_port'] = 2000;
+
+// managesieve server address
+$rcmail_config['managesieve_host'] = 'localhost';
+
+// use or not TLS for managesieve server connection
+// it's because I've problems with TLS and dovecot's managesieve plugin
+// and it's not needed on localhost
+$rcmail_config['managesieve_usetls'] = false;
+
+// default contents of filters script (eg. default spam filter)
+$rcmail_config['managesieve_default'] = '/etc/dovecot/sieve/global';
+
+// I need this because my dovecot (with listescape plugin) uses
+// ':' delimiter, but creates folders with dot delimiter
+$rcmail_config['managesieve_replace_delimiter'] = '';
+
 // THIS OPTION WILL ALLOW THE INSTALLER TO RUN AND CAN EXPOSE SENSITIVE CONFIG DATA.
 // ONLY ENABLE IT IF YOU'RE REALLY SURE WHAT YOU'RE DOING!
 $rcmail_config['enable_installer'] = false;
diff -ruNa 0.2-stable.old/program/include/rcube_sieve.php 0.2-stable/program/include/rcube_sieve.php
--- 0.2-stable.old/program/include/rcube_sieve.php	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/program/include/rcube_sieve.php	2009-01-03 13:51:32.651809367 +0100
@@ -0,0 +1,593 @@
+<?php
+
+/*
+ +-----------------------------------------------------------------------+
+ | program/include/rcube_sieve.php                                       |
+ |                                                                       |
+ | This file is part of the RoundCube Webmail client                     |
+ | Copyright (C) 2007-2008, RoundCube Dev. - Switzerland                 |
+ | Licensed under the GNU GPL                                            |
+ |                                                                       |
+ | PURPOSE:                                                              |
+ |   Classes for managesieve operations (using PEAR::Net_Sieve)          |
+ |                                                                       |
+ +-----------------------------------------------------------------------+
+ | Author: Aleksander Machniak <alec@alec.pl>                            |
+ +-----------------------------------------------------------------------+
+
+$Id$
+
+*/
+
+//  Sieve Language Basics: http://www.ietf.org/rfc/rfc5228.txt
+
+define('SIEVE_ERROR_CONNECTION', 1);
+define('SIEVE_ERROR_LOGIN', 2);
+define('SIEVE_ERROR_NOT_EXISTS', 3);	// script not exists
+define('SIEVE_ERROR_INSTALL', 4);	// script installation
+define('SIEVE_ERROR_ACTIVATE', 5);	// script activation
+define('SIEVE_ERROR_OTHER', 255);	// other/unknown error
+
+
+class rcube_sieve
+{
+  var $sieve;				// Net_Sieve object
+  var $error = false; 			// error flag 
+  var $list = array(); 			// scripts list 
+
+  public $script;			// rcube_sieve_script object
+
+  /**
+    * Object constructor
+    *
+    * @param  string  Username (to managesieve login)
+    * @param  string  Password (to managesieve login)
+    * @param  string  Managesieve server hostname/address
+    * @param  string  Managesieve server port number
+    * @param  string  Enable/disable TLS use
+    */
+  public function __construct($username, $password='', $host='localhost', $port=2000, $usetls=true)
+    {
+      require_once('Net/Sieve.php');
+    
+      $this->sieve = new Net_Sieve();
+      
+//      $this->sieve->setDebug();
+      if (PEAR::isError($this->sieve->connect($host, $port, NULL, $usetls)))
+        return $this->_set_error(SIEVE_ERROR_CONNECTION);
+
+      if (PEAR::isError($this->sieve->login($username, $password)))
+        return $this->_set_error(SIEVE_ERROR_LOGIN);
+
+      $this->_get_script();
+    }
+
+  /**
+    * Getter for error code
+    */
+  public function error()
+    {
+      return $this->error ? $this->error : false;
+    }
+			    
+  public function save()
+    {
+      $script = $this->script->as_text();
+
+      if (!$script)
+	$script = '/* empty script */';
+
+      if (PEAR::isError($this->sieve->installScript('roundcube', $script)))
+    	return $this->_set_error(SIEVE_ERROR_INSTALL);
+
+      if (PEAR::isError($this->sieve->setActive('roundcube')))
+    	return $this->_set_error(SIEVE_ERROR_ACTIVATE);
+
+      return true;
+    }
+
+  public function get_extensions()
+    {
+      if ($this->sieve)
+	return $this->sieve->getExtensions();
+    }
+
+  private function _get_script()
+    {
+      if (!$this->sieve)
+        return false;
+    
+      $this->list = $this->sieve->listScripts();
+
+      if (PEAR::isError($this->list))
+    	return $this->_set_error(SIEVE_ERROR_OTHER);
+    
+      if (in_array('roundcube', $this->list))
+        {
+          $script = $this->sieve->getScript('roundcube');
+    
+          if (PEAR::isError($script))
+    	    return $this->_set_error(SIEVE_ERROR_OTHER);
+	}
+      else
+        {
+	  $this->_set_error(SIEVE_ERROR_NOT_EXISTS);
+          $script = '';
+	}
+
+      $this->script = new rcube_sieve_script($script);
+    }
+    
+  private function _set_error($error)
+    {
+      $this->error = $error;
+      return false;
+    }    
+}
+
+class rcube_sieve_script
+{
+  var $content = array();	// script rules array   
+
+  public $supported = array(	// extensions supported by class
+    'fileinto',
+    'reject',
+//    'ereject',
+    // TODO: (most wanted first) vacation, body, imapflags, notify, regex
+    );
+  
+  /**
+    * Object constructor
+    *
+    * @param  string  Script's text content
+    */
+  public function __construct($script)
+    {
+      $this->content = $this->_parse_text($script);
+    }
+
+  /**
+    * Adds script contents as text to the script array (at the end)
+    *
+    * @param	string	Text script contents
+    */
+  public function add_text($script)
+    {
+      $content = $this->_parse_text($script);
+      $result = false;
+      
+      // check existsing script rules names
+      foreach ($this->content as $idx => $elem)
+        $names[$elem['name']] = $idx;
+      
+      foreach ($content as $elem)
+        if (!isset($names[$elem['name']]))
+	  {
+            array_push($this->content, $elem);
+	    $result = true;
+	  }
+
+      return $result;
+    }
+
+  /**
+    * Adds rule to the script (at the end)
+    *
+    * @param	string	Rule name
+    * @param	array	Rule content (as array)
+    */
+  public function add_rule($content)
+    {
+      // TODO: check this->supported
+      array_push($this->content, $content);
+      return sizeof($this->content)-1;
+    }
+
+  public function delete_rule($index)
+    {
+      if(isset($this->content[$index]))
+        {
+          unset($this->content[$index]);
+	  return true;
+	}
+      return false;
+    }
+
+  public function size()
+    {
+      return sizeof($this->content);
+    }
+
+  public function update_rule($index, $content)
+    {
+      // TODO: check this->supported
+      if ($this->content[$index])
+        {
+	  $this->content[$index] = $content;
+	  return $index;
+	}
+      return false;
+    }
+
+  /**
+    * Returns script as text
+    */
+  public function as_text()
+    {
+      $script = '';
+      $exts = array();
+      
+      // rules
+      foreach ($this->content as $idx => $rule)
+        {
+	  $extension = '';
+	  $tests = array();
+	  $i = 0;
+	  
+	  // header
+	  $script .= '# rule:[' . $rule['name'] . "]\n";
+  
+	  // constraints expressions
+	  foreach ($rule['tests'] as $test)
+	    {
+	      $tests[$i] = '';
+	      switch ($test['test'])
+	        {
+		  case 'size':
+		    $tests[$i] .= ($test['not'] ? 'not ' : '');
+		    $tests[$i] .= 'size :' . ($test['type']=='under' ? 'under ' : 'over ') . $test['arg'];
+		  break;
+		  case 'true':
+		    $tests[$i] .= ($test['not'] ? 'not true' : 'true');
+		  break;
+		  case 'exists':
+		    $tests[$i] .= ($test['not'] ? 'not ' : '');
+		    if (is_array($test['arg']))
+			$tests[$i] .= 'exists ["' . implode('", "', $this->_escape_string($test['arg'])) . '"]';
+		    else
+			$tests[$i] .= 'exists "' . $this->_escape_string($test['arg']) . '"';
+		  break;    
+		  case 'header':
+		    $tests[$i] .= ($test['not'] ? 'not ' : '');
+		    $tests[$i] .= 'header :' . $test['type'];
+		    if (is_array($test['arg1']))
+			$tests[$i] .= ' ["' . implode('", "', $this->_escape_string($test['arg1'])) . '"]';
+		    else
+			$tests[$i] .= ' "' . $this->_escape_string($test['arg1']) . '"';
+		    if (is_array($test['arg2']))
+			$tests[$i] .= ' ["' . implode('", "', $this->_escape_string($test['arg2'])) . '"]';
+		    else
+			$tests[$i] .= ' "' . $this->_escape_string($test['arg2']) . '"';
+		  break;
+		}
+	      $i++;
+	    }
+  
+	  $script .= ($idx>0 ? 'els' : '').($rule['join'] ? 'if allof (' : 'if anyof (');
+	  if (sizeof($tests) > 1)
+	    $script .= implode(",\n\t", $tests);
+	  elseif (sizeof($tests))
+	    $script .= $tests[0];
+	  else
+	    $script .= 'true';
+	  $script .= ")\n{\n";
+  
+	  // action(s)
+	  foreach ($rule['actions'] as $action)
+	    switch ($action['type'])
+	    {
+	      case 'fileinto':
+	        $extension = 'fileinto';
+		$script .= "\tfileinto \"" . $this->_escape_string($action['target']) . "\";\n";
+	      break;
+	      case 'redirect':
+		$script .= "\tredirect \"" . $this->_escape_string($action['target']) . "\";\n";
+	      break;
+	      case 'reject':
+	      case 'ereject':
+	        $extension = $action['type'];
+		if (strpos($action['target'], "\n")!==false)
+		  $script .= "\t".$action['type']." text:\n" . $action['target'] . "\n.\n;\n";
+		else
+		  $script .= "\t".$action['type']." \"" . $this->_escape_string($action['target']) . "\";\n";
+	      break;
+	      case 'keep':
+	      case 'discard':
+	        $script .= "\t" . $action['type'] .";\n";
+	      break;
+	    }
+	  
+	  $script .= "}\n";
+	
+	  if ($extension && !isset($exts[$extension]))
+	    $exts[$extension] = $extension;
+	}
+      
+      // requires
+      if (sizeof($exts))
+        $script = 'require ["' . implode('","', $exts) . "\"];\n" . $script;
+
+      return $script;
+    }
+
+  /**
+    * Returns script object
+    *
+    */
+  public function as_array()
+    {
+      return $this->content;
+    }
+
+  /**
+    * Converts text script to rules array
+    *
+    * @param	string	Text script
+    */
+  private function _parse_text($script)
+    {
+      $i = 0;
+      $content = array();
+
+      // remove C comments
+      $script = preg_replace('|/\*.*?\*/|sm', '', $script);
+
+      // tokenize rules
+      if ($tokens = preg_split('/(# rule:\[.*\])\n/', $script, -1, PREG_SPLIT_DELIM_CAPTURE))
+        foreach($tokens as $token)
+	  {
+	    if (preg_match('/^# rule:\[(.*)\]/', $token, $matches))
+	      {
+	        $content[$i]['name'] = $matches[1];
+	      }
+	    elseif (isset($content[$i]['name']) && sizeof($content[$i]) == 1)
+	      {
+	        if ($rule = $this->_tokenize_rule($token))
+		  {
+	    	    $content[$i] = array_merge($content[$i], $rule);
+	    	    $i++;
+		  }
+		else // unknown rule format
+		    unset($content[$i]);
+	      }
+	  }
+
+      return $content;
+    }
+
+  /**
+    * Convert text script fragment to rule object
+    *
+    * @param	string	Text rule
+    */
+  private function _tokenize_rule($content)
+    {
+      $result = NULL;
+    
+      if (preg_match('/^(if|elsif|else)\s+((allof|anyof|exists|header|not|size)\s+(.*))\s+\{(.*)\}$/sm', trim($content), $matches))
+        {
+	  list($tests, $join) = $this->_parse_tests(trim($matches[2]));
+	  $actions = $this->_parse_actions(trim($matches[5]));
+
+	  if ($tests && $actions)
+	    $result = array(
+		    'tests' => $tests,
+		    'actions' => $actions,
+		    'join' => $join,
+	    );
+	}
+    
+      return $result;
+    }    
+
+  /**
+    * Parse body of actions section
+    *
+    * @param	string	Text body
+    * @return	array	Array of parsed action type/target pairs
+    */
+  private function _parse_actions($content)
+    {
+      $result = NULL;
+
+      // supported actions
+      $patterns[] = '^\s*discard;';
+      $patterns[] = '^\s*keep;';
+      $patterns[] = '^\s*fileinto\s+(.*?[^\\\]);';
+      $patterns[] = '^\s*redirect\s+(.*?[^\\\]);';
+      $patterns[] = '^\s*reject\s+text:(.*)\n\.\n;';
+      $patterns[] = '^\s*ereject\s+text:(.*)\n\.\n;';
+      $patterns[] = '^\s*reject\s+(.*?[^\\\]);';
+      $patterns[] = '^\s*ereject\s+(.*?[^\\\]);';
+
+      $pattern = '/(' . implode('$)|(', $patterns) . '$)/ms';
+
+      // parse actions body
+      if (preg_match_all($pattern, $content, $mm, PREG_SET_ORDER))
+      {
+    	foreach ($mm as $m)
+	{
+	  $content = trim($m[0]);
+	  
+    	  if(preg_match('/^(discard|keep)/', $content, $matches))
+    	    {
+	      $result[] = array('type' => $matches[1]);
+	    }
+          elseif(preg_match('/^fileinto/', $content))
+    	    {
+	      $result[] = array('type' => 'fileinto', 'target' => $this->_parse_string($m[sizeof($m)-1])); 
+	    }
+          elseif(preg_match('/^redirect/', $content))
+    	    {
+	      $result[] = array('type' => 'redirect', 'target' => $this->_parse_string($m[sizeof($m)-1])); 
+	    }
+    	  elseif(preg_match('/^(reject|ereject)\s+(.*);$/sm', $content, $matches))
+    	    {
+	      $result[] = array('type' => $matches[1], 'target' => $this->_parse_string($matches[2])); 
+	    }
+        }
+      }
+
+      return $result;
+    }    
+    
+   /**
+    * Parse test/conditions section
+    *
+    * @param	string	Text 
+    */
+
+  private function _parse_tests($content)
+    {
+      $result = NULL;
+
+      // lists
+      if (preg_match('/^(allof|anyof)\s+\((.*)\)$/sm', $content, $matches))
+	{
+	  $content = $matches[2];
+	  $join = $matches[1]=='allof' ? true : false;
+	}
+      else
+	  $join = false;
+      
+      // supported tests regular expressions
+      // TODO: comparators, envelope
+      $patterns[] = '(not\s+)?(exists)\s+\[(.*?[^\\\])\]';
+      $patterns[] = '(not\s+)?(exists)\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(true)';
+      $patterns[] = '(not\s+)?(size)\s+:(under|over)\s+([0-9]+[KGM]{0,1})';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+\[(.*?[^\\\]")\]\s+\[(.*?[^\\\]")\]';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+(".*?[^\\\]")\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+\[(.*?[^\\\]")\]\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+(".*?[^\\\]")\s+\[(.*?[^\\\]")\]';
+      
+      // join patterns...
+      $pattern = '/(' . implode(')|(', $patterns) . ')/';
+
+      // ...and parse tests list
+      if (preg_match_all($pattern, $content, $matches, PREG_SET_ORDER))
+        {
+	  foreach ($matches as $match)
+	    {
+	      $size = sizeof($match);
+	      
+	      if (preg_match('/^(not\s+)?size/', $match[0]))
+	        {
+		  $result[] = array(
+		    'test' 	=> 'size',
+		    'not' 	=> $match[$size-4] ? true : false,
+		    'type' 	=> $match[$size-2], // under/over
+		    'arg'	=> $match[$size-1], // value
+		  );
+		}
+	      elseif (preg_match('/^(not\s+)?header/', $match[0]))
+	    	{
+		  $result[] = array(
+		    'test'	=> 'header',
+		    'not' 	=> $match[$size-5] ? true : false,
+		    'type'	=> $match[$size-3], // is/contains/matches
+		    'arg1' 	=> $this->_parse_list($match[$size-2]), // header(s)
+		    'arg2'	=> $this->_parse_list($match[$size-1]), // string(s)
+		  );  
+		}
+	      elseif (preg_match('/^(not\s+)?exists/', $match[0]))
+		{
+		  $result[] = array(
+		    'test' 	=> 'exists',
+		    'not' 	=> $match[$size-3] ? true : false,
+		    'arg' 	=> $this->_parse_list($match[$size-1]), // header(s)
+		  );
+	        }
+	      elseif (preg_match('/^(not\s+)?true/', $match[0]))
+		{
+		  $result[] = array(
+		    'test' 	=> 'true',
+		    'not' 	=> $match[$size-2] ? true : false,
+		  );
+	        }
+	    }
+	}
+
+      return array($result, $join);
+    }    
+
+   /**
+    * Parse string value
+    *
+    * @param	string	Text 
+    */
+  private function _parse_string($content)
+    {
+      $text = '';
+      $content = trim($content);
+
+      if (preg_match('/^text:(.*)\.$/sm', $content, $matches))
+        $text = trim($matches[1]);
+      elseif (preg_match('/^"(.*)"$/', $content, $matches))
+        $text = str_replace('\"', '"', $matches[1]);
+
+      return $text;
+    }    
+
+   /**
+    * Escape special chars in string value
+    *
+    * @param	string	Text 
+    */
+  private function _escape_string($content)
+    {
+      $replace['/"/'] = '\\"';
+      
+      if (is_array($content))
+        {
+	  for ($x=0, $y=sizeof($content); $x<$y; $x++)
+	    $content[$x] = preg_replace(array_keys($replace), array_values($replace), $content[$x]);
+        
+	  return $content;
+	}
+      else
+        return preg_replace(array_keys($replace), array_values($replace), $content);
+    }
+
+   /**
+    * Parse string or list of strings to string or array of strings
+    *
+    * @param	string	Text 
+    */
+  private function _parse_list($content)
+    {
+      $result = array();
+      
+      for ($x=0, $len=strlen($content); $x<$len; $x++)
+        {
+	  switch ($content[$x])
+	    {
+	      case '\\':
+	        $str .= $content[++$x];
+              break;
+	      case '"':
+	        if (isset($str))
+	    	  {
+		    $result[] = $str;
+		    unset($str);
+		  }
+	        else
+	          $str = '';
+	      break;
+	      default:
+	        if(isset($str))
+	          $str .= $content[$x];
+	      break;
+	    }
+	}
+      
+      if (sizeof($result)>1)
+        return $result;
+      elseif (sizeof($result) == 1)
+	return $result[0];
+      else
+        return NULL;
+    }    
+}
+
+?>
diff -ruNa 0.2-stable.old/program/js/app.js 0.2-stable/program/js/app.js
--- 0.2-stable.old/program/js/app.js	2008-12-30 16:25:56.000000000 +0100
+++ 0.2-stable/program/js/app.js	2009-01-03 14:06:30.927372199 +0100
@@ -236,6 +236,7 @@
 break;
 case "settings":
 this.enable_command("preferences","identities","save","folders",true);
+this.enable_command("managesieve",true);
 if(this.env.action=="identities"||this.env.action=="edit-identity"||this.env.action=="add-identity"){
 this.enable_command("add",this.env.identities_level<2);
 this.enable_command("delete","edit",true);
@@ -246,6 +247,22 @@
 if(this.env.action=="folders"){
 this.enable_command("subscribe","unsubscribe","create-folder","rename-folder","delete-folder",true);
 }
+if(this.env.action=="managesieve"){
+if(!this.env.sieveconnerror){
+this.enable_command("sievefilteradd",true);
+}
+if(this.gui_objects.filterslist){
+this.sievefilters_list=new rcube_list_widget(this.gui_objects.filterslist,{multiselect:false,draggable:false,keyboard:false});
+this.sievefilters_list.addEventListener("select",function(o){
+p.sievefilter_select(o);
+});
+this.sievefilters_list.init();
+this.sievefilters_list.focus();
+}
+if(this.gui_objects.sieveform){
+this.enable_command("sievefiltersave",true);
+}
+}
 if(this.gui_objects.identitieslist){
 this.identity_list=new rcube_list_widget(this.gui_objects.identitieslist,{multiselect:false,draggable:false,keyboard:false});
 this.identity_list.addEventListener("select",function(o){
@@ -262,23 +279,23 @@
 }
 break;
 case "login":
-var _29=rcube_find_object("rcmloginuser");
-var _2a=rcube_find_object("rcmloginpwd");
-var _2b=rcube_find_object("rcmlogintz");
-if(_29){
-_29.onkeyup=function(e){
+var _2a=rcube_find_object("rcmloginuser");
+var _2b=rcube_find_object("rcmloginpwd");
+var _2c=rcube_find_object("rcmlogintz");
+if(_2a){
+_2a.onkeyup=function(e){
 return rcmail.login_user_keyup(e);
 };
 }
-if(_29&&_29.value==""){
-_29.focus();
-}else{
-if(_2a){
+if(_2a&&_2a.value==""){
 _2a.focus();
+}else{
+if(_2b){
+_2b.focus();
 }
 }
-if(_2b){
-_2b.value=new Date().getTimezoneOffset()/-60;
+if(_2c){
+_2c.value=new Date().getTimezoneOffset()/-60;
 }
 this.enable_command("login",true);
 break;
@@ -332,9 +349,9 @@
 };
 }
 if(!this.env.flagged_col&&this.env.coltypes){
-var _32;
-if((_32=find_in_array("flag",this.env.coltypes))>=0){
-this.set_env("flagged_col",_32+1);
+var _33;
+if((_33=find_in_array("flag",this.env.coltypes))>=0){
+this.set_env("flagged_col",_33+1);
 }
 }
 if(this.env.flagged_col&&(row.flagged_icon=row.obj.cells[this.env.flagged_col].childNodes[0])&&row.flagged_icon.nodeName=="IMG"){
@@ -350,34 +367,34 @@
 if(!this.gui_objects.messageform){
 return false;
 }
-var _34=rcube_find_object("_from");
-var _35=rcube_find_object("_to");
-var _36=rcube_find_object("_cc");
-var _37=rcube_find_object("_bcc");
-var _38=rcube_find_object("_replyto");
-var _39=rcube_find_object("_subject");
-var _3a=rcube_find_object("_message");
-var _3b=rcube_find_object("_draft_saveid");
-if(_35){
-this.init_address_input_events(_35);
-}
+var _35=rcube_find_object("_from");
+var _36=rcube_find_object("_to");
+var _37=rcube_find_object("_cc");
+var _38=rcube_find_object("_bcc");
+var _39=rcube_find_object("_replyto");
+var _3a=rcube_find_object("_subject");
+var _3b=rcube_find_object("_message");
+var _3c=rcube_find_object("_draft_saveid");
 if(_36){
 this.init_address_input_events(_36);
 }
 if(_37){
 this.init_address_input_events(_37);
 }
-if(_34&&_34.type=="select-one"&&(!_3b||_3b.value=="")&&rcube_find_object("_is_html").value!="1"){
-this.change_identity(_34);
+if(_38){
+this.init_address_input_events(_38);
+}
+if(_35&&_35.type=="select-one"&&(!_3c||_3c.value=="")&&rcube_find_object("_is_html").value!="1"){
+this.change_identity(_35);
 }
-if(_35&&_35.value==""){
-_35.focus();
+if(_36&&_36.value==""){
+_36.focus();
 }else{
-if(_39&&_39.value==""){
-_39.focus();
+if(_3a&&_3a.value==""){
+_3a.focus();
 }else{
-if(_3a){
-this.set_caret2start(_3a);
+if(_3b){
+this.set_caret2start(_3b);
 }
 }
 }
@@ -385,35 +402,35 @@
 this.auto_save_start();
 };
 this.init_address_input_events=function(obj){
-var _3d=function(e){
+var _3e=function(e){
 return _1.ksearch_keypress(e,this);
 };
 if(obj.addEventListener){
-obj.addEventListener(bw.safari?"keydown":"keypress",_3d,false);
+obj.addEventListener(bw.safari?"keydown":"keypress",_3e,false);
 }else{
-obj.onkeydown=_3d;
+obj.onkeydown=_3e;
 }
 obj.setAttribute("autocomplete","off");
 };
-this.command=function(_3f,_40,obj){
+this.command=function(_40,_41,obj){
 if(obj&&obj.blur){
 obj.blur();
 }
 if(this.busy){
 return false;
 }
-if(!this.commands[_3f]){
+if(!this.commands[_40]){
 if(this.env.framed&&parent.rcmail&&parent.rcmail.command){
-parent.rcmail.command(_3f,_40);
+parent.rcmail.command(_40,_41);
 }
 return false;
 }
-if(this.task=="mail"&&this.env.action=="compose"&&(_3f=="list"||_3f=="mail"||_3f=="addressbook"||_3f=="settings")){
+if(this.task=="mail"&&this.env.action=="compose"&&(_40=="list"||_40=="mail"||_40=="addressbook"||_40=="settings")){
 if(this.cmp_hash!=this.compose_field_hash()&&!confirm(this.get_label("notsentwarning"))){
 return false;
 }
 }
-switch(_3f){
+switch(_40){
 case "login":
 if(this.gui_objects.loginform){
 this.gui_objects.loginform.submit();
@@ -425,7 +442,7 @@
 case "mail":
 case "addressbook":
 case "settings":
-this.switch_task(_3f);
+this.switch_task(_40);
 break;
 case "permaurl":
 if(obj&&obj.href&&obj.target){
@@ -438,20 +455,20 @@
 break;
 case "list":
 if(this.task=="mail"){
-if(this.env.search_request<0||(_40!=""&&(this.env.search_request&&_40!=this.env.mailbox))){
+if(this.env.search_request<0||(_41!=""&&(this.env.search_request&&_41!=this.env.mailbox))){
 this.reset_qsearch();
 }
-this.list_mailbox(_40);
+this.list_mailbox(_41);
 if(this.env.trash_mailbox){
 this.set_alttext("delete",this.env.mailbox!=this.env.trash_mailbox?"movemessagetotrash":"deletemessage");
 }
 }else{
 if(this.task=="addressbook"){
-if(this.env.search_request<0||(this.env.search_request&&_40!=this.env.source)){
+if(this.env.search_request<0||(this.env.search_request&&_41!=this.env.source)){
 this.reset_qsearch();
 }
-this.list_contacts(_40);
-this.enable_command("add",(this.env.address_sources&&!this.env.address_sources[_40].readonly));
+this.list_contacts(_41);
+this.enable_command("add",(this.env.address_sources&&!this.env.address_sources[_41].readonly));
 }
 }
 break;
@@ -459,29 +476,29 @@
 this.load_headers(obj);
 break;
 case "sort":
-var _42=_40.split("_");
-var _43=_42[0];
-var _44=_42[1]?_42[1].toUpperCase():null;
-var _45;
-if(_44==null){
-if(this.env.sort_col==_43){
-_44=this.env.sort_order=="ASC"?"DESC":"ASC";
+var _43=_41.split("_");
+var _44=_43[0];
+var _45=_43[1]?_43[1].toUpperCase():null;
+var _46;
+if(_45==null){
+if(this.env.sort_col==_44){
+_45=this.env.sort_order=="ASC"?"DESC":"ASC";
 }else{
-_44=this.env.sort_order;
+_45=this.env.sort_order;
 }
 }
-if(this.env.sort_col==_43&&this.env.sort_order==_44){
+if(this.env.sort_col==_44&&this.env.sort_order==_45){
 break;
 }
-if(_45=document.getElementById("rcm"+this.env.sort_col)){
-this.set_classname(_45,"sorted"+(this.env.sort_order.toUpperCase()),false);
+if(_46=document.getElementById("rcm"+this.env.sort_col)){
+this.set_classname(_46,"sorted"+(this.env.sort_order.toUpperCase()),false);
 }
-if(_45=document.getElementById("rcm"+_43)){
-this.set_classname(_45,"sorted"+_44,true);
+if(_46=document.getElementById("rcm"+_44)){
+this.set_classname(_46,"sorted"+_45,true);
 }
-this.env.sort_col=_43;
-this.env.sort_order=_44;
-this.list_mailbox("","",_43+"_"+_44);
+this.env.sort_col=_44;
+this.env.sort_order=_45;
+this.list_mailbox("","",_44+"_"+_45);
 break;
 case "nextpage":
 this.list_page("next");
@@ -518,7 +535,7 @@
 }
 }else{
 if(this.task=="addressbook"){
-var cid=_40?_40:this.get_single_cid();
+var cid=_41?_41:this.get_single_cid();
 if(cid&&!(this.env.action=="show"&&cid==this.env.cid)){
 this.load_contact(cid,"show");
 }
@@ -540,30 +557,30 @@
 if(this.task=="addressbook"&&(cid=this.get_single_cid())){
 this.load_contact(cid,"edit");
 }else{
-if(this.task=="settings"&&_40){
-this.load_identity(_40,"edit-identity");
+if(this.task=="settings"&&_41){
+this.load_identity(_41,"edit-identity");
 }
 }
 break;
 case "save-identity":
 case "save":
 if(this.gui_objects.editform){
-var _48=rcube_find_object("_pagesize");
-var _49=rcube_find_object("_name");
-var _4a=rcube_find_object("_email");
-if(_48&&isNaN(parseInt(_48.value))){
+var _49=rcube_find_object("_pagesize");
+var _4a=rcube_find_object("_name");
+var _4b=rcube_find_object("_email");
+if(_49&&isNaN(parseInt(_49.value))){
 alert(this.get_label("nopagesizewarning"));
-_48.focus();
+_49.focus();
 break;
 }else{
-if(_49&&_49.value==""){
+if(_4a&&_4a.value==""){
 alert(this.get_label("nonamewarning"));
-_49.focus();
+_4a.focus();
 break;
 }else{
-if(_4a&&!rcube_check_email(_4a.value)){
+if(_4b&&!rcube_check_email(_4b.value)){
 alert(this.get_label("noemailwarning"));
-_4a.focus();
+_4b.focus();
 break;
 }
 }
@@ -587,49 +604,49 @@
 case "move":
 case "moveto":
 if(this.task=="mail"){
-this.move_messages(_40);
+this.move_messages(_41);
 }else{
 if(this.task=="addressbook"&&this.drag_active){
-this.copy_contact(null,_40);
+this.copy_contact(null,_41);
 }
 }
 break;
 case "mark":
-if(_40){
-this.mark_message(_40);
+if(_41){
+this.mark_message(_41);
 }
 break;
 case "toggle_status":
-if(_40&&!_40._row){
+if(_41&&!_41._row){
 break;
 }
 var uid;
-var _4b="read";
-if(_40._row.uid){
-uid=_40._row.uid;
+var _4c="read";
+if(_41._row.uid){
+uid=_41._row.uid;
 if(this.message_list.rows[uid].deleted){
-_4b="undelete";
+_4c="undelete";
 }else{
 if(!this.message_list.rows[uid].unread){
-_4b="unread";
+_4c="unread";
 }
 }
 }
-this.mark_message(_4b,uid);
+this.mark_message(_4c,uid);
 break;
 case "toggle_flag":
-if(_40&&!_40._row){
+if(_41&&!_41._row){
 break;
 }
 var uid;
-var _4b="flagged";
-if(_40._row.uid){
-uid=_40._row.uid;
+var _4c="flagged";
+if(_41._row.uid){
+uid=_41._row.uid;
 if(this.message_list.rows[uid].flagged){
-_4b="unflagged";
+_4c="unflagged";
 }
 }
-this.mark_message(_4b,uid);
+this.mark_message(_4c,uid);
 break;
 case "always-load":
 if(this.env.uid&&this.env.sender){
@@ -645,12 +662,12 @@
 }
 break;
 case "load-attachment":
-var _4c="_mbox="+urlencode(this.env.mailbox)+"&_uid="+this.env.uid+"&_part="+_40.part;
-if(this.env.uid&&_40.mimetype&&find_in_array(_40.mimetype,this.mimetypes)>=0){
-if(_40.mimetype=="text/html"){
-_4c+="&_safe=1";
+var _4d="_mbox="+urlencode(this.env.mailbox)+"&_uid="+this.env.uid+"&_part="+_41.part;
+if(this.env.uid&&_41.mimetype&&find_in_array(_41.mimetype,this.mimetypes)>=0){
+if(_41.mimetype=="text/html"){
+_4d+="&_safe=1";
 }
-this.attachment_win=window.open(this.env.comm_path+"&_action=get&"+_4c+"&_frame=1","rcubemailattachment");
+this.attachment_win=window.open(this.env.comm_path+"&_action=get&"+_4d+"&_frame=1","rcubemailattachment");
 if(this.attachment_win){
 window.setTimeout(function(){
 _1.attachment_win.focus();
@@ -658,10 +675,10 @@
 break;
 }
 }
-this.goto_url("get",_4c+"&_download=1",false);
+this.goto_url("get",_4d+"&_download=1",false);
 break;
 case "select-all":
-this.message_list.select_all(_40);
+this.message_list.select_all(_41);
 break;
 case "select-none":
 this.message_list.clear_selection();
@@ -699,30 +716,30 @@
 url+="&_draft_uid="+uid;
 }
 }else{
-if(_40){
-url+="&_to="+urlencode(_40);
+if(_41){
+url+="&_to="+urlencode(_41);
 }
 }
 }else{
 if(this.task=="addressbook"){
-if(_40&&_40.indexOf("@")>0){
+if(_41&&_41.indexOf("@")>0){
 url=this.get_task_url("mail",url);
-this.redirect(url+"&_to="+urlencode(_40));
+this.redirect(url+"&_to="+urlencode(_41));
 break;
 }
-var _4e=new Array();
-if(_40){
-_4e[_4e.length]=_40;
+var _4f=new Array();
+if(_41){
+_4f[_4f.length]=_41;
 }else{
 if(this.contact_list){
-var _4f=this.contact_list.get_selection();
-for(var n=0;n<_4f.length;n++){
-_4e[_4e.length]=_4f[n];
+var _50=this.contact_list.get_selection();
+for(var n=0;n<_50.length;n++){
+_4f[_4f.length]=_50[n];
 }
 }
 }
-if(_4e.length){
-this.http_request("mailto","_cid="+urlencode(_4e.join(","))+"&_source="+urlencode(this.env.source),true);
+if(_4f.length){
+this.http_request("mailto","_cid="+urlencode(_4f.join(","))+"&_source="+urlencode(this.env.source),true);
 }
 break;
 }
@@ -749,10 +766,10 @@
 break;
 }
 this.set_busy(true,"savingmessage");
-var _51=this.gui_objects.messageform;
-_51.target="savetarget";
-_51._draft.value="1";
-_51.submit();
+var _52=this.gui_objects.messageform;
+_52.target="savetarget";
+_52._draft.value="1";
+_52.submit();
 break;
 case "send":
 if(!this.gui_objects.messageform){
@@ -763,26 +780,26 @@
 }
 self.clearTimeout(this.save_timer);
 this.set_busy(true,"sendingmessage");
-var _51=this.gui_objects.messageform;
-_51.target="savetarget";
-_51._draft.value="";
-_51.submit();
+var _52=this.gui_objects.messageform;
+_52.target="savetarget";
+_52._draft.value="";
+_52.submit();
 clearTimeout(this.request_timer);
 break;
 case "add-attachment":
 this.show_attachment_form(true);
 case "send-attachment":
 self.clearTimeout(this.save_timer);
-this.upload_file(_40);
+this.upload_file(_41);
 break;
 case "remove-attachment":
-this.remove_attachment(_40);
+this.remove_attachment(_41);
 break;
 case "reply-all":
 case "reply":
 var uid;
 if(uid=this.get_single_uid()){
-this.goto_url("compose","_reply_uid="+uid+"&_mbox="+urlencode(this.env.mailbox)+(_3f=="reply-all"?"&_all=1":""),true);
+this.goto_url("compose","_reply_uid="+uid+"&_mbox="+urlencode(this.env.mailbox)+(_40=="reply-all"?"&_all=1":""),true);
 }
 break;
 case "forward":
@@ -817,14 +834,14 @@
 }
 break;
 case "add-contact":
-this.add_contact(_40);
+this.add_contact(_41);
 break;
 case "search":
-if(!_40&&this.gui_objects.qsearchbox){
-_40=this.gui_objects.qsearchbox.value;
+if(!_41&&this.gui_objects.qsearchbox){
+_41=this.gui_objects.qsearchbox.value;
 }
-if(_40){
-this.qsearch(_40);
+if(_41){
+this.qsearch(_41);
 break;
 }
 case "reset-search":
@@ -840,8 +857,8 @@
 break;
 case "import":
 if(this.env.action=="import"&&this.gui_objects.importform){
-var _53=document.getElementById("rcmimportfile");
-if(_53&&!_53.value){
+var _54=document.getElementById("rcmimportfile");
+if(_54&&!_54.value){
 alert(this.get_label("selectimportfile"));
 break;
 }
@@ -854,16 +871,16 @@
 break;
 case "export":
 if(this.contact_list.rowcount>0){
-var _54=(this.env.source?"_source="+urlencode(this.env.source)+"&":"");
+var _55=(this.env.source?"_source="+urlencode(this.env.source)+"&":"");
 if(this.env.search_request){
-_54+="_search="+this.env.search_request;
+_55+="_search="+this.env.search_request;
 }
-this.goto_url("export",_54);
+this.goto_url("export",_55);
 }
 break;
 case "collapse-folder":
-if(_40){
-this.collapse_folder(_40);
+if(_41){
+this.collapse_folder(_41);
 }
 break;
 case "preferences":
@@ -878,41 +895,59 @@
 this.goto_url("folders");
 break;
 case "subscribe":
-this.subscribe_folder(_40);
+this.subscribe_folder(_41);
 break;
 case "unsubscribe":
-this.unsubscribe_folder(_40);
+this.unsubscribe_folder(_41);
 break;
 case "create-folder":
-this.create_folder(_40);
+this.create_folder(_41);
 break;
 case "rename-folder":
-this.rename_folder(_40);
+this.rename_folder(_41);
 break;
 case "delete-folder":
-this.delete_folder(_40);
+this.delete_folder(_41);
+break;
+case "managesieve":
+this.goto_url("managesieve","",true);
+break;
+case "sievefiltersave":
+this.sievefilter_save();
+break;
+case "sievefilteradd":
+this.sievefilter_add();
+break;
+case "sievefilterdel":
+this.sievefilter_del();
+break;
+case "sievefilterup":
+this.sievefilter_up();
+break;
+case "sievefilterdown":
+this.sievefilter_down();
 break;
 }
 return obj?false:true;
 };
 this.enable_command=function(){
-var _55=arguments;
-if(!_55.length){
+var _56=arguments;
+if(!_56.length){
 return -1;
 }
-var _56;
-var _57=_55[_55.length-1];
-for(var n=0;n<_55.length-1;n++){
-_56=_55[n];
-this.commands[_56]=_57;
-this.set_button(_56,(_57?"act":"pas"));
+var _57;
+var _58=_56[_56.length-1];
+for(var n=0;n<_56.length-1;n++){
+_57=_56[n];
+this.commands[_57]=_58;
+this.set_button(_57,(_58?"act":"pas"));
 }
 return true;
 };
-this.set_busy=function(a,_5a){
-if(a&&_5a){
-var msg=this.get_label(_5a);
-if(msg==_5a){
+this.set_busy=function(a,_5b){
+if(a&&_5b){
+var msg=this.get_label(_5b);
+if(msg==_5b){
 msg="Loading...";
 }
 this.display_message(msg,"loading",true);
@@ -934,71 +969,71 @@
 },this.env.request_timeout*1000);
 }
 };
-this.get_label=function(_5c){
-if(this.labels[_5c]){
-return this.labels[_5c];
+this.get_label=function(_5d){
+if(this.labels[_5d]){
+return this.labels[_5d];
 }else{
-return _5c;
+return _5d;
 }
 };
-this.switch_task=function(_5d){
-if(this.task===_5d&&_5d!="mail"){
+this.switch_task=function(_5e){
+if(this.task===_5e&&_5e!="mail"){
 return;
 }
-var url=this.get_task_url(_5d);
-if(_5d=="mail"){
+var url=this.get_task_url(_5e);
+if(_5e=="mail"){
 url+="&_mbox=INBOX";
 }
 this.redirect(url);
 };
-this.get_task_url=function(_5f,url){
+this.get_task_url=function(_60,url){
 if(!url){
 url=this.env.comm_path;
 }
-return url.replace(/_task=[a-z]+/,"_task="+_5f);
+return url.replace(/_task=[a-z]+/,"_task="+_60);
 };
 this.request_timed_out=function(){
 this.set_busy(false);
 this.display_message("Request timed out!","error");
 };
 this.doc_mouse_up=function(e){
-var _62,li;
+var _63,li;
 if(this.message_list){
 this.message_list.blur();
-_62=this.env.mailboxes;
+_63=this.env.mailboxes;
 }else{
 if(this.contact_list){
 this.contact_list.blur();
-_62=this.env.address_sources;
+_63=this.env.address_sources;
 }else{
 if(this.ksearch_value){
 this.ksearch_blur();
 }
 }
 }
-if(this.drag_active&&_62&&this.env.last_folder_target){
+if(this.drag_active&&_63&&this.env.last_folder_target){
 this.set_classname(this.get_folder_li(this.env.last_folder_target),"droptarget",false);
-this.command("moveto",_62[this.env.last_folder_target].id);
+this.command("moveto",_63[this.env.last_folder_target].id);
 this.env.last_folder_target=null;
 }
 };
-this.drag_start=function(_64){
-var _65=this.task=="mail"?this.env.mailboxes:this.env.address_sources;
+this.drag_start=function(_65){
+var _66=this.task=="mail"?this.env.mailboxes:this.env.address_sources;
 this.drag_active=true;
 if(this.preview_timer){
 clearTimeout(this.preview_timer);
 }
-if(this.gui_objects.folderlist&&_65){
-var li,pos,_64,_68;
-_64=rcube_find_object(this.task=="mail"?"mailboxlist":"directorylist");
-pos=rcube_get_object_pos(_64);
-this.env.folderlist_coords={x1:pos.x,y1:pos.y,x2:pos.x+_64.offsetWidth,y2:pos.y+_64.offsetHeight};
+if(this.gui_objects.folderlist&&_66){
+var li,pos,_65,_69;
+_65=rcube_find_object(this.task=="mail"?"mailboxlist":"directorylist");
+pos=rcube_get_object_pos(_65);
+this.env.folderlist_coords={x1:pos.x,y1:pos.y,x2:pos.x+_65.offsetWidth,y2:pos.y+_65.offsetHeight};
 this.env.folder_coords=new Array();
-for(var k in _65){
+for(var k in _66){
 if(li=this.get_folder_li(k)){
 pos=rcube_get_object_pos(li.firstChild);
-if(_68=li.firstChild.offsetHeight){
-this.env.folder_coords[k]={x1:pos.x,y1:pos.y,x2:pos.x+li.firstChild.offsetWidth,y2:pos.y+_68};
+if(_69=li.firstChild.offsetHeight){
+this.env.folder_coords[k]={x1:pos.x,y1:pos.y,x2:pos.x+li.firstChild.offsetWidth,y2:pos.y+_69};
 }
 }
 }
@@ -1006,10 +1041,10 @@
 };
 this.drag_move=function(e){
 if(this.gui_objects.folderlist&&this.env.folder_coords){
-var li,pos,_6d;
-_6d=rcube_event.get_mouse_pos(e);
+var li,pos,_6e;
+_6e=rcube_event.get_mouse_pos(e);
 pos=this.env.folderlist_coords;
-if(_6d.x<pos.x1||_6d.x>=pos.x2||_6d.y<pos.y1||_6d.y>=pos.y2){
+if(_6e.x<pos.x1||_6e.x>=pos.x2||_6e.y<pos.y1||_6e.y>=pos.y2){
 if(this.env.last_folder_target){
 this.set_classname(this.get_folder_li(this.env.last_folder_target),"droptarget",false);
 this.env.last_folder_target=null;
@@ -1018,7 +1053,7 @@
 }
 for(var k in this.env.folder_coords){
 pos=this.env.folder_coords[k];
-if(this.check_droptarget(k)&&((_6d.x>=pos.x1)&&(_6d.x<pos.x2)&&(_6d.y>=pos.y1)&&(_6d.y<pos.y2))){
+if(this.check_droptarget(k)&&((_6e.x>=pos.x1)&&(_6e.x<pos.x2)&&(_6e.y>=pos.y1)&&(_6e.y<pos.y2))){
 this.set_classname(this.get_folder_li(k),"droptarget",true);
 this.env.last_folder_target=k;
 }else{
@@ -1062,26 +1097,26 @@
 this.contact_list.focus();
 }
 }
-var _74;
-if(_74=this.get_folder_li()){
-this.set_classname(_74,"unfocused",true);
+var _75;
+if(_75=this.get_folder_li()){
+this.set_classname(_75,"unfocused",true);
 }
 return rcube_event.get_button(e)==2?true:rcube_event.cancel(e);
 };
-this.msglist_select=function(_75){
+this.msglist_select=function(_76){
 if(this.preview_timer){
 clearTimeout(this.preview_timer);
 }
-var _76=_75.selection.length==1;
+var _77=_76.selection.length==1;
 if(this.env.mailbox==this.env.drafts_mailbox){
 this.enable_command("reply","reply-all","forward",false);
-this.enable_command("show",_76);
-this.enable_command("delete","moveto","mark",(_75.selection.length>0?true:false));
+this.enable_command("show",_77);
+this.enable_command("delete","moveto","mark",(_76.selection.length>0?true:false));
 }else{
-this.enable_command("show","reply","reply-all","forward","print",_76);
-this.enable_command("delete","moveto","mark",(_75.selection.length>0?true:false));
+this.enable_command("show","reply","reply-all","forward","print",_77);
+this.enable_command("delete","moveto","mark",(_76.selection.length>0?true:false));
 }
-if(_76&&this.env.contentframe&&!_75.multi_selecting){
+if(_77&&this.env.contentframe&&!_76.multi_selecting){
 this.preview_timer=window.setTimeout(function(){
 _1.msglist_get_preview();
 },200);
@@ -1091,11 +1126,11 @@
 }
 }
 };
-this.msglist_dbl_click=function(_77){
+this.msglist_dbl_click=function(_78){
 if(this.preview_timer){
 clearTimeout(this.preview_timer);
 }
-var uid=_77.get_single_selection();
+var uid=_78.get_single_selection();
 if(uid&&this.env.mailbox==this.env.drafts_mailbox){
 this.goto_url("compose","_draft_uid="+uid+"&_mbox="+urlencode(this.env.mailbox),true);
 }else{
@@ -1104,17 +1139,17 @@
 }
 }
 };
-this.msglist_keypress=function(_79){
-if(_79.key_pressed==_79.ENTER_KEY){
+this.msglist_keypress=function(_7a){
+if(_7a.key_pressed==_7a.ENTER_KEY){
 this.command("show");
 }else{
-if(_79.key_pressed==_79.DELETE_KEY){
+if(_7a.key_pressed==_7a.DELETE_KEY){
 this.command("delete");
 }else{
-if(_79.key_pressed==_79.BACKSPACE_KEY){
+if(_7a.key_pressed==_7a.BACKSPACE_KEY){
 this.command("delete");
 }else{
-_79.shiftkey=false;
+_7a.shiftkey=false;
 }
 }
 }
@@ -1142,30 +1177,30 @@
 }
 }
 };
-this.show_message=function(id,_7d,_7e){
+this.show_message=function(id,_7e,_7f){
 if(!id){
 return;
 }
-var _7f="";
-var _80=_7e?"preview":"show";
-var _81=window;
-if(_7e&&this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
-_81=window.frames[this.env.contentframe];
-_7f="&_framed=1";
+var _80="";
+var _81=_7f?"preview":"show";
+var _82=window;
+if(_7f&&this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
+_82=window.frames[this.env.contentframe];
+_80="&_framed=1";
 }
-if(_7d){
-_7f="&_safe=1";
+if(_7e){
+_80="&_safe=1";
 }
 if(this.env.search_request){
-_7f+="&_search="+this.env.search_request;
+_80+="&_search="+this.env.search_request;
 }
-var url="&_action="+_80+"&_uid="+id+"&_mbox="+urlencode(this.env.mailbox)+_7f;
-if(_80=="preview"&&String(_81.location.href).indexOf(url)>=0){
+var url="&_action="+_81+"&_uid="+id+"&_mbox="+urlencode(this.env.mailbox)+_80;
+if(_81=="preview"&&String(_82.location.href).indexOf(url)>=0){
 this.show_contentframe(true);
 }else{
 this.set_busy(true,"loading");
-_81.location.href=this.env.comm_path+url;
-if(_80=="preview"&&this.message_list&&this.message_list.rows[id]&&this.message_list.rows[id].unread){
+_82.location.href=this.env.comm_path+url;
+if(_81=="preview"&&this.message_list&&this.message_list.rows[id]&&this.message_list.rows[id].unread){
 this.set_message(id,"unread",false);
 if(this.env.unread_counts[this.env.mailbox]){
 this.env.unread_counts[this.env.mailbox]-=1;
@@ -1174,246 +1209,246 @@
 }
 }
 };
-this.show_contentframe=function(_83){
+this.show_contentframe=function(_84){
 var frm;
 if(this.env.contentframe&&(frm=rcube_find_object(this.env.contentframe))){
-if(!_83&&window.frames[this.env.contentframe]){
+if(!_84&&window.frames[this.env.contentframe]){
 if(window.frames[this.env.contentframe].location.href.indexOf(this.env.blankpage)<0){
 window.frames[this.env.contentframe].location.href=this.env.blankpage;
 }
 }else{
 if(!bw.safari){
-frm.style.display=_83?"block":"none";
+frm.style.display=_84?"block":"none";
 }
 }
 }
-if(!_83&&this.busy){
+if(!_84&&this.busy){
 this.set_busy(false);
 }
 };
-this.list_page=function(_85){
-if(_85=="next"){
-_85=this.env.current_page+1;
+this.list_page=function(_86){
+if(_86=="next"){
+_86=this.env.current_page+1;
 }
-if(_85=="last"){
-_85=this.env.pagecount;
+if(_86=="last"){
+_86=this.env.pagecount;
 }
-if(_85=="prev"&&this.env.current_page>1){
-_85=this.env.current_page-1;
+if(_86=="prev"&&this.env.current_page>1){
+_86=this.env.current_page-1;
 }
-if(_85=="first"&&this.env.current_page>1){
-_85=1;
+if(_86=="first"&&this.env.current_page>1){
+_86=1;
 }
-if(_85>0&&_85<=this.env.pagecount){
-this.env.current_page=_85;
+if(_86>0&&_86<=this.env.pagecount){
+this.env.current_page=_86;
 if(this.task=="mail"){
-this.list_mailbox(this.env.mailbox,_85);
+this.list_mailbox(this.env.mailbox,_86);
 }else{
 if(this.task=="addressbook"){
-this.list_contacts(this.env.source,_85);
+this.list_contacts(this.env.source,_86);
 }
 }
 }
 };
-this.filter_mailbox=function(_86){
-var _87;
+this.filter_mailbox=function(_87){
+var _88;
 if(this.gui_objects.qsearchbox){
-_87=this.gui_objects.qsearchbox.value;
+_88=this.gui_objects.qsearchbox.value;
 }
 this.message_list.clear();
 this.env.current_page=1;
 this.set_busy(true,"searching");
-this.http_request("search","_filter="+_86+(_87?"&_q="+urlencode(_87):"")+(this.env.mailbox?"&_mbox="+urlencode(this.env.mailbox):""),true);
+this.http_request("search","_filter="+_87+(_88?"&_q="+urlencode(_88):"")+(this.env.mailbox?"&_mbox="+urlencode(this.env.mailbox):""),true);
 };
-this.list_mailbox=function(_88,_89,_8a){
+this.list_mailbox=function(_89,_8a,_8b){
 this.last_selected=0;
-var _8b="";
-var _8c=window;
-if(!_88){
-_88=this.env.mailbox;
+var _8c="";
+var _8d=window;
+if(!_89){
+_89=this.env.mailbox;
 }
-if(_8a){
-_8b+="&_sort="+_8a;
+if(_8b){
+_8c+="&_sort="+_8b;
 }
 if(this.env.search_request){
-_8b+="&_search="+this.env.search_request;
+_8c+="&_search="+this.env.search_request;
 }
-if(!_89&&_88!=this.env.mailbox){
-_89=1;
-this.env.current_page=_89;
+if(!_8a&&_89!=this.env.mailbox){
+_8a=1;
+this.env.current_page=_8a;
 if(this.message_list){
 this.message_list.clear_selection();
 }
 this.show_contentframe(false);
 }
-if(_88!=this.env.mailbox||(_88==this.env.mailbox&&!_89&&!_8a)){
-_8b+="&_refresh=1";
+if(_89!=this.env.mailbox||(_89==this.env.mailbox&&!_8a&&!_8b)){
+_8c+="&_refresh=1";
 }
-this.select_folder(_88,this.env.mailbox);
-this.env.mailbox=_88;
+this.select_folder(_89,this.env.mailbox);
+this.env.mailbox=_89;
 if(this.gui_objects.messagelist){
-this.list_mailbox_remote(_88,_89,_8b);
+this.list_mailbox_remote(_89,_8a,_8c);
 return;
 }
 if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
-_8c=window.frames[this.env.contentframe];
-_8b+="&_framed=1";
+_8d=window.frames[this.env.contentframe];
+_8c+="&_framed=1";
 }
-if(_88){
+if(_89){
 this.set_busy(true,"loading");
-_8c.location.href=this.env.comm_path+"&_mbox="+urlencode(_88)+(_89?"&_page="+_89:"")+_8b;
+_8d.location.href=this.env.comm_path+"&_mbox="+urlencode(_89)+(_8a?"&_page="+_8a:"")+_8c;
 }
 };
-this.list_mailbox_remote=function(_8d,_8e,_8f){
+this.list_mailbox_remote=function(_8e,_8f,_90){
 this.message_list.clear();
-var url="_mbox="+urlencode(_8d)+(_8e?"&_page="+_8e:"");
+var url="_mbox="+urlencode(_8e)+(_8f?"&_page="+_8f:"");
 this.set_busy(true,"loading");
-this.http_request("list",url+_8f,true);
+this.http_request("list",url+_90,true);
 };
-this.expunge_mailbox=function(_91){
-var _92=false;
-var _93="";
-if(_91==this.env.mailbox){
-_92=true;
+this.expunge_mailbox=function(_92){
+var _93=false;
+var _94="";
+if(_92==this.env.mailbox){
+_93=true;
 this.set_busy(true,"loading");
-_93="&_reload=1";
+_94="&_reload=1";
 }
-var url="_mbox="+urlencode(_91);
-this.http_post("expunge",url+_93,_92);
+var url="_mbox="+urlencode(_92);
+this.http_post("expunge",url+_94,_93);
 };
-this.purge_mailbox=function(_95){
-var _96=false;
-var _97="";
+this.purge_mailbox=function(_96){
+var _97=false;
+var _98="";
 if(!confirm(this.get_label("purgefolderconfirm"))){
 return false;
 }
-if(_95==this.env.mailbox){
-_96=true;
+if(_96==this.env.mailbox){
+_97=true;
 this.set_busy(true,"loading");
-_97="&_reload=1";
+_98="&_reload=1";
 }
-var url="_mbox="+urlencode(_95);
-this.http_post("purge",url+_97,_96);
+var url="_mbox="+urlencode(_96);
+this.http_post("purge",url+_98,_97);
 return true;
 };
 this.purge_mailbox_test=function(){
 return (this.env.messagecount&&(this.env.mailbox==this.env.trash_mailbox||this.env.mailbox==this.env.junk_mailbox||this.env.mailbox.match("^"+RegExp.escape(this.env.trash_mailbox)+RegExp.escape(this.env.delimiter))||this.env.mailbox.match("^"+RegExp.escape(this.env.junk_mailbox)+RegExp.escape(this.env.delimiter))));
 };
 this.set_message_icon=function(uid){
-var _9a;
-var _9b=this.message_list.rows;
-if(!_9b[uid]){
+var _9b;
+var _9c=this.message_list.rows;
+if(!_9c[uid]){
 return false;
 }
-if(_9b[uid].deleted&&this.env.deletedicon){
-_9a=this.env.deletedicon;
+if(_9c[uid].deleted&&this.env.deletedicon){
+_9b=this.env.deletedicon;
 }else{
-if(_9b[uid].replied&&this.env.repliedicon){
-if(_9b[uid].forwarded&&this.env.forwardedrepliedicon){
-_9a=this.env.forwardedrepliedicon;
+if(_9c[uid].replied&&this.env.repliedicon){
+if(_9c[uid].forwarded&&this.env.forwardedrepliedicon){
+_9b=this.env.forwardedrepliedicon;
 }else{
-_9a=this.env.repliedicon;
+_9b=this.env.repliedicon;
 }
 }else{
-if(_9b[uid].forwarded&&this.env.forwardedicon){
-_9a=this.env.forwardedicon;
+if(_9c[uid].forwarded&&this.env.forwardedicon){
+_9b=this.env.forwardedicon;
 }else{
-if(_9b[uid].unread&&this.env.unreadicon){
-_9a=this.env.unreadicon;
+if(_9c[uid].unread&&this.env.unreadicon){
+_9b=this.env.unreadicon;
 }else{
 if(this.env.messageicon){
-_9a=this.env.messageicon;
+_9b=this.env.messageicon;
 }
 }
 }
 }
 }
-if(_9a&&_9b[uid].icon){
-_9b[uid].icon.src=_9a;
+if(_9b&&_9c[uid].icon){
+_9c[uid].icon.src=_9b;
 }
-_9a="";
-if(_9b[uid].flagged&&this.env.flaggedicon){
-_9a=this.env.flaggedicon;
+_9b="";
+if(_9c[uid].flagged&&this.env.flaggedicon){
+_9b=this.env.flaggedicon;
 }else{
-if(!_9b[uid].flagged&&this.env.unflaggedicon){
-_9a=this.env.unflaggedicon;
+if(!_9c[uid].flagged&&this.env.unflaggedicon){
+_9b=this.env.unflaggedicon;
 }
 }
-if(_9b[uid].flagged_icon&&_9a){
-_9b[uid].flagged_icon.src=_9a;
+if(_9c[uid].flagged_icon&&_9b){
+_9c[uid].flagged_icon.src=_9b;
 }
 };
-this.set_message_status=function(uid,_9d,_9e){
-var _9f=this.message_list.rows;
-if(!_9f[uid]){
+this.set_message_status=function(uid,_9e,_9f){
+var _a0=this.message_list.rows;
+if(!_a0[uid]){
 return false;
 }
-if(_9d=="unread"){
-_9f[uid].unread=_9e;
+if(_9e=="unread"){
+_a0[uid].unread=_9f;
 }else{
-if(_9d=="deleted"){
-_9f[uid].deleted=_9e;
+if(_9e=="deleted"){
+_a0[uid].deleted=_9f;
 }else{
-if(_9d=="replied"){
-_9f[uid].replied=_9e;
+if(_9e=="replied"){
+_a0[uid].replied=_9f;
 }else{
-if(_9d=="forwarded"){
-_9f[uid].forwarded=_9e;
+if(_9e=="forwarded"){
+_a0[uid].forwarded=_9f;
 }else{
-if(_9d=="flagged"){
-_9f[uid].flagged=_9e;
+if(_9e=="flagged"){
+_a0[uid].flagged=_9f;
 }
 }
 }
 }
 }
-this.env.messages[uid]=_9f[uid];
+this.env.messages[uid]=_a0[uid];
 };
-this.set_message=function(uid,_a1,_a2){
-var _a3=this.message_list.rows;
-if(!_a3[uid]){
+this.set_message=function(uid,_a2,_a3){
+var _a4=this.message_list.rows;
+if(!_a4[uid]){
 return false;
 }
-if(_a1){
-this.set_message_status(uid,_a1,_a2);
+if(_a2){
+this.set_message_status(uid,_a2,_a3);
 }
-if(_a3[uid].unread&&_a3[uid].classname.indexOf("unread")<0){
-_a3[uid].classname+=" unread";
-this.set_classname(_a3[uid].obj,"unread",true);
+if(_a4[uid].unread&&_a4[uid].classname.indexOf("unread")<0){
+_a4[uid].classname+=" unread";
+this.set_classname(_a4[uid].obj,"unread",true);
 }else{
-if(!_a3[uid].unread&&_a3[uid].classname.indexOf("unread")>=0){
-_a3[uid].classname=_a3[uid].classname.replace(/\s*unread/,"");
-this.set_classname(_a3[uid].obj,"unread",false);
+if(!_a4[uid].unread&&_a4[uid].classname.indexOf("unread")>=0){
+_a4[uid].classname=_a4[uid].classname.replace(/\s*unread/,"");
+this.set_classname(_a4[uid].obj,"unread",false);
 }
 }
-if(_a3[uid].deleted&&_a3[uid].classname.indexOf("deleted")<0){
-_a3[uid].classname+=" deleted";
-this.set_classname(_a3[uid].obj,"deleted",true);
+if(_a4[uid].deleted&&_a4[uid].classname.indexOf("deleted")<0){
+_a4[uid].classname+=" deleted";
+this.set_classname(_a4[uid].obj,"deleted",true);
 }else{
-if(!_a3[uid].deleted&&_a3[uid].classname.indexOf("deleted")>=0){
-_a3[uid].classname=_a3[uid].classname.replace(/\s*deleted/,"");
-this.set_classname(_a3[uid].obj,"deleted",false);
+if(!_a4[uid].deleted&&_a4[uid].classname.indexOf("deleted")>=0){
+_a4[uid].classname=_a4[uid].classname.replace(/\s*deleted/,"");
+this.set_classname(_a4[uid].obj,"deleted",false);
 }
 }
-if(_a3[uid].flagged&&_a3[uid].classname.indexOf("flagged")<0){
-_a3[uid].classname+=" flagged";
-this.set_classname(_a3[uid].obj,"flagged",true);
+if(_a4[uid].flagged&&_a4[uid].classname.indexOf("flagged")<0){
+_a4[uid].classname+=" flagged";
+this.set_classname(_a4[uid].obj,"flagged",true);
 }else{
-if(!_a3[uid].flagged&&_a3[uid].classname.indexOf("flagged")>=0){
-_a3[uid].classname=_a3[uid].classname.replace(/\s*flagged/,"");
-this.set_classname(_a3[uid].obj,"flagged",false);
+if(!_a4[uid].flagged&&_a4[uid].classname.indexOf("flagged")>=0){
+_a4[uid].classname=_a4[uid].classname.replace(/\s*flagged/,"");
+this.set_classname(_a4[uid].obj,"flagged",false);
 }
 }
 this.set_message_icon(uid);
 };
-this.move_messages=function(_a4){
-if(!_a4||_a4==this.env.mailbox||(!this.env.uid&&(!this.message_list||!this.message_list.get_selection().length))){
+this.move_messages=function(_a5){
+if(!_a5||_a5==this.env.mailbox||(!this.env.uid&&(!this.message_list||!this.message_list.get_selection().length))){
 return;
 }
-var _a5=false;
-var _a6="&_target_mbox="+urlencode(_a4)+"&_from="+(this.env.action?this.env.action:"");
+var _a6=false;
+var _a7="&_target_mbox="+urlencode(_a5)+"&_from="+(this.env.action?this.env.action:"");
 if(this.env.action=="show"){
-_a5=true;
+_a6=true;
 this.set_busy(true,"movingmessage");
 }else{
 if(!this.env.flag_for_deletion){
@@ -1421,11 +1456,11 @@
 }
 }
 this.enable_command("reply","reply-all","forward","delete","mark","print",false);
-this._with_selected_messages("moveto",_a5,_a6,(this.env.flag_for_deletion?false:true));
+this._with_selected_messages("moveto",_a6,_a7,(this.env.flag_for_deletion?false:true));
 };
 this.delete_messages=function(){
-var _a7=this.message_list?this.message_list.get_selection():new Array();
-if(!this.env.uid&&!_a7.length){
+var _a8=this.message_list?this.message_list.get_selection():new Array();
+if(!this.env.uid&&!_a8.length){
 return;
 }
 if(this.env.trash_mailbox&&String(this.env.mailbox).toLowerCase()!=String(this.env.trash_mailbox).toLowerCase()){
@@ -1445,7 +1480,7 @@
 if(this.env.action=="show"){
 this.command("nextmessage","",this);
 }else{
-if(_a7.length==1){
+if(_a8.length==1){
 this.message_list.select_next();
 }
 }
@@ -1464,19 +1499,19 @@
 this.show_contentframe(false);
 this._with_selected_messages("delete",false,"&_from="+(this.env.action?this.env.action:""),true);
 };
-this._with_selected_messages=function(_a8,_a9,_aa,_ab){
-var _ac=new Array();
+this._with_selected_messages=function(_a9,_aa,_ab,_ac){
+var _ad=new Array();
 if(this.env.uid){
-_ac[0]=this.env.uid;
+_ad[0]=this.env.uid;
 }else{
-var _ad=this.message_list.get_selection();
-var _ae=this.message_list.rows;
+var _ae=this.message_list.get_selection();
+var _af=this.message_list.rows;
 var id;
-for(var n=0;n<_ad.length;n++){
-id=_ad[n];
-_ac[_ac.length]=id;
-if(_ab){
-this.message_list.remove_row(id,(n==_ad.length-1));
+for(var n=0;n<_ae.length;n++){
+id=_ae[n];
+_ad[_ad.length]=id;
+if(_ac){
+this.message_list.remove_row(id,(n==_ae.length-1));
 }else{
 this.set_message_status(id,"deleted",true);
 if(this.env.read_when_deleted){
@@ -1487,129 +1522,129 @@
 }
 }
 if(this.env.search_request){
-_aa+="&_search="+this.env.search_request;
+_ab+="&_search="+this.env.search_request;
 }
-this.http_post(_a8,"_uid="+_ac.join(",")+"&_mbox="+urlencode(this.env.mailbox)+_aa,_a9);
+this.http_post(_a9,"_uid="+_ad.join(",")+"&_mbox="+urlencode(this.env.mailbox)+_ab,_aa);
 };
-this.mark_message=function(_b1,uid){
-var _b3=new Array();
+this.mark_message=function(_b2,uid){
 var _b4=new Array();
-var _b5=this.message_list?this.message_list.get_selection():new Array();
+var _b5=new Array();
+var _b6=this.message_list?this.message_list.get_selection():new Array();
 if(uid){
-_b3[0]=uid;
+_b4[0]=uid;
 }else{
 if(this.env.uid){
-_b3[0]=this.env.uid;
+_b4[0]=this.env.uid;
 }else{
 if(this.message_list){
-for(var n=0;n<_b5.length;n++){
-_b3[_b3.length]=_b5[n];
+for(var n=0;n<_b6.length;n++){
+_b4[_b4.length]=_b6[n];
 }
 }
 }
 }
 if(!this.message_list){
-_b4=_b3;
+_b5=_b4;
 }else{
-for(var id,n=0;n<_b3.length;n++){
-id=_b3[n];
-if((_b1=="read"&&this.message_list.rows[id].unread)||(_b1=="unread"&&!this.message_list.rows[id].unread)||(_b1=="delete"&&!this.message_list.rows[id].deleted)||(_b1=="undelete"&&this.message_list.rows[id].deleted)||(_b1=="flagged"&&!this.message_list.rows[id].flagged)||(_b1=="unflagged"&&this.message_list.rows[id].flagged)){
-_b4[_b4.length]=id;
+for(var id,n=0;n<_b4.length;n++){
+id=_b4[n];
+if((_b2=="read"&&this.message_list.rows[id].unread)||(_b2=="unread"&&!this.message_list.rows[id].unread)||(_b2=="delete"&&!this.message_list.rows[id].deleted)||(_b2=="undelete"&&this.message_list.rows[id].deleted)||(_b2=="flagged"&&!this.message_list.rows[id].flagged)||(_b2=="unflagged"&&this.message_list.rows[id].flagged)){
+_b5[_b5.length]=id;
 }
 }
 }
-if(!_b4.length){
+if(!_b5.length){
 return;
 }
-switch(_b1){
+switch(_b2){
 case "read":
 case "unread":
-this.toggle_read_status(_b1,_b4);
+this.toggle_read_status(_b2,_b5);
 break;
 case "delete":
 case "undelete":
-this.toggle_delete_status(_b4);
+this.toggle_delete_status(_b5);
 break;
 case "flagged":
 case "unflagged":
-this.toggle_flagged_status(_b1,_b3);
+this.toggle_flagged_status(_b2,_b4);
 break;
 }
 };
-this.toggle_read_status=function(_b8,_b9){
-for(var i=0;i<_b9.length;i++){
-this.set_message(_b9[i],"unread",(_b8=="unread"?true:false));
+this.toggle_read_status=function(_b9,_ba){
+for(var i=0;i<_ba.length;i++){
+this.set_message(_ba[i],"unread",(_b9=="unread"?true:false));
 }
-this.http_post("mark","_uid="+_b9.join(",")+"&_flag="+_b8);
+this.http_post("mark","_uid="+_ba.join(",")+"&_flag="+_b9);
 };
-this.toggle_flagged_status=function(_bb,_bc){
-for(var i=0;i<_bc.length;i++){
-this.set_message(_bc[i],"flagged",(_bb=="flagged"?true:false));
+this.toggle_flagged_status=function(_bc,_bd){
+for(var i=0;i<_bd.length;i++){
+this.set_message(_bd[i],"flagged",(_bc=="flagged"?true:false));
 }
-this.http_post("mark","_uid="+_bc.join(",")+"&_flag="+_bb);
+this.http_post("mark","_uid="+_bd.join(",")+"&_flag="+_bc);
 };
-this.toggle_delete_status=function(_be){
-var _bf=this.message_list?this.message_list.rows:new Array();
-if(_be.length==1){
-if(!_bf.length||(_bf[_be[0]]&&!_bf[_be[0]].deleted)){
-this.flag_as_deleted(_be);
+this.toggle_delete_status=function(_bf){
+var _c0=this.message_list?this.message_list.rows:new Array();
+if(_bf.length==1){
+if(!_c0.length||(_c0[_bf[0]]&&!_c0[_bf[0]].deleted)){
+this.flag_as_deleted(_bf);
 }else{
-this.flag_as_undeleted(_be);
+this.flag_as_undeleted(_bf);
 }
 return true;
 }
-var _c0=true;
-for(var i=0;i<_be.length;i++){
-uid=_be[i];
-if(_bf[uid]){
-if(!_bf[uid].deleted){
-_c0=false;
+var _c1=true;
+for(var i=0;i<_bf.length;i++){
+uid=_bf[i];
+if(_c0[uid]){
+if(!_c0[uid].deleted){
+_c1=false;
 break;
 }
 }
 }
-if(_c0){
-this.flag_as_undeleted(_be);
+if(_c1){
+this.flag_as_undeleted(_bf);
 }else{
-this.flag_as_deleted(_be);
+this.flag_as_deleted(_bf);
 }
 return true;
 };
-this.flag_as_undeleted=function(_c2){
-for(var i=0;i<_c2.length;i++){
-this.set_message(_c2[i],"deleted",false);
+this.flag_as_undeleted=function(_c3){
+for(var i=0;i<_c3.length;i++){
+this.set_message(_c3[i],"deleted",false);
 }
-this.http_post("mark","_uid="+_c2.join(",")+"&_flag=undelete");
+this.http_post("mark","_uid="+_c3.join(",")+"&_flag=undelete");
 return true;
 };
-this.flag_as_deleted=function(_c4){
-var _c5="";
-var _c6=new Array();
-var _c7=this.message_list?this.message_list.rows:new Array();
-for(var i=0;i<_c4.length;i++){
-uid=_c4[i];
-if(_c7[uid]){
+this.flag_as_deleted=function(_c5){
+var _c6="";
+var _c7=new Array();
+var _c8=this.message_list?this.message_list.rows:new Array();
+for(var i=0;i<_c5.length;i++){
+uid=_c5[i];
+if(_c8[uid]){
 this.set_message(uid,"deleted",true);
-if(_c7[uid].unread){
-_c6[_c6.length]=uid;
+if(_c8[uid].unread){
+_c7[_c7.length]=uid;
 }
 }
 }
-if(_c6.length){
-_c5="&_ruid="+_c6.join(",");
+if(_c7.length){
+_c6="&_ruid="+_c7.join(",");
 }
-this.http_post("mark","_uid="+_c4.join(",")+"&_flag=delete"+_c5);
+this.http_post("mark","_uid="+_c5.join(",")+"&_flag=delete"+_c6);
 return true;
 };
-this.flag_deleted_as_read=function(_c9){
-var _ca;
-var _cb=this.message_list?this.message_list.rows:new Array();
-var str=String(_c9);
-var _cd=new Array();
-_cd=str.split(",");
-for(var uid,i=0;i<_cd.length;i++){
-uid=_cd[i];
-if(_cb[uid]){
+this.flag_deleted_as_read=function(_ca){
+var _cb;
+var _cc=this.message_list?this.message_list.rows:new Array();
+var str=String(_ca);
+var _ce=new Array();
+_ce=str.split(",");
+for(var uid,i=0;i<_ce.length;i++){
+uid=_ce[i];
+if(_cc[uid]){
 this.set_message(uid,"unread",false);
 }
 }
@@ -1623,34 +1658,34 @@
 }
 };
 this.check_compose_input=function(){
-var _d3=rcube_find_object("_to");
-var _d4=rcube_find_object("_cc");
-var _d5=rcube_find_object("_bcc");
-var _d6=rcube_find_object("_from");
-var _d7=rcube_find_object("_subject");
-var _d8=rcube_find_object("_message");
-if(_d6.type=="text"&&!rcube_check_email(_d6.value,true)){
+var _d4=rcube_find_object("_to");
+var _d5=rcube_find_object("_cc");
+var _d6=rcube_find_object("_bcc");
+var _d7=rcube_find_object("_from");
+var _d8=rcube_find_object("_subject");
+var _d9=rcube_find_object("_message");
+if(_d7.type=="text"&&!rcube_check_email(_d7.value,true)){
 alert(this.get_label("nosenderwarning"));
-_d6.focus();
+_d7.focus();
 return false;
 }
-var _d9=_d3.value?_d3.value:(_d4.value?_d4.value:_d5.value);
-if(!rcube_check_email(_d9.replace(/^\s+/,"").replace(/[\s,;]+$/,""),true)){
+var _da=_d4.value?_d4.value:(_d5.value?_d5.value:_d6.value);
+if(!rcube_check_email(_da.replace(/^\s+/,"").replace(/[\s,;]+$/,""),true)){
 alert(this.get_label("norecipientwarning"));
-_d3.focus();
+_d4.focus();
 return false;
 }
-if(_d7&&_d7.value==""){
-var _da=prompt(this.get_label("nosubjectwarning"),this.get_label("nosubject"));
-if(!_da&&_da!==""){
-_d7.focus();
+if(_d8&&_d8.value==""){
+var _db=prompt(this.get_label("nosubjectwarning"),this.get_label("nosubject"));
+if(!_db&&_db!==""){
+_d8.focus();
 return false;
 }else{
-_d7.value=_da?_da:this.get_label("nosubject");
+_d8.value=_db?_db:this.get_label("nosubject");
 }
 }
-if((!window.tinyMCE||!tinyMCE.get("compose-body"))&&_d8.value==""&&!confirm(this.get_label("nobodywarning"))){
-_d8.focus();
+if((!window.tinyMCE||!tinyMCE.get("compose-body"))&&_d9.value==""&&!confirm(this.get_label("nobodywarning"))){
+_d9.focus();
 return false;
 }else{
 if(window.tinyMCE&&tinyMCE.get("compose-body")&&!tinyMCE.get("compose-body").getContent()&&!confirm(this.get_label("nobodywarning"))){
@@ -1694,16 +1729,13 @@
 }
 this.busy=false;
 };
-this.compose_field_hash=function(_df){
-var _e0=rcube_find_object("_to");
-var _e1=rcube_find_object("_cc");
-var _e2=rcube_find_object("_bcc");
-var _e3=rcube_find_object("_subject");
-var _e4,_e5;
+this.compose_field_hash=function(_e0){
+var _e1=rcube_find_object("_to");
+var _e2=rcube_find_object("_cc");
+var _e3=rcube_find_object("_bcc");
+var _e4=rcube_find_object("_subject");
+var _e5,_e6;
 var str="";
-if(_e0&&_e0.value){
-str+=_e0.value+":";
-}
 if(_e1&&_e1.value){
 str+=_e1.value+":";
 }
@@ -1713,13 +1745,16 @@
 if(_e3&&_e3.value){
 str+=_e3.value+":";
 }
-if(_e4=tinyMCE.get("compose-body")){
-str+=_e4.getContent();
+if(_e4&&_e4.value){
+str+=_e4.value+":";
+}
+if(_e5=tinyMCE.get("compose-body")){
+str+=_e5.getContent();
 }else{
-_e5=rcube_find_object("_message");
-str+=_e5.value;
+_e6=rcube_find_object("_message");
+str+=_e6.value;
 }
-if(_df){
+if(_e0){
 this.cmp_hash=str;
 }
 return str;
@@ -1729,14 +1764,14 @@
 return false;
 }
 var id=obj.options[obj.selectedIndex].value;
-var _e9=rcube_find_object("_message");
-var _ea=_e9?_e9.value:"";
-var _eb=(rcube_find_object("_is_html").value=="1");
+var _ea=rcube_find_object("_message");
+var _eb=_ea?_ea.value:"";
+var _ec=(rcube_find_object("_is_html").value=="1");
 var sig,p;
 if(!this.env.identity){
 this.env.identity=id;
 }
-if(!_eb){
+if(!_ec){
 if(this.env.identity&&this.env.signatures&&this.env.signatures[this.env.identity]){
 if(this.env.signatures[this.env.identity]["is_html"]){
 sig=this.env.signatures[this.env.identity]["plain_text"];
@@ -1746,12 +1781,12 @@
 if(sig.indexOf("-- ")!=0){
 sig="-- \n"+sig;
 }
-p=_ea.lastIndexOf(sig);
+p=_eb.lastIndexOf(sig);
 if(p>=0){
-_ea=_ea.substring(0,p-1)+_ea.substring(p+sig.length,_ea.length);
+_eb=_eb.substring(0,p-1)+_eb.substring(p+sig.length,_eb.length);
 }
 }
-_ea=_ea.replace(/[\r\n]+$/,"");
+_eb=_eb.replace(/[\r\n]+$/,"");
 if(this.env.signatures&&this.env.signatures[id]){
 sig=this.env.signatures[id]["text"];
 if(this.env.signatures[id]["is_html"]){
@@ -1760,35 +1795,35 @@
 if(sig.indexOf("-- ")!=0){
 sig="-- \n"+sig;
 }
-_ea+="\n\n"+sig;
+_eb+="\n\n"+sig;
 }
 }else{
-var _ee=tinyMCE.get("compose-body");
+var _ef=tinyMCE.get("compose-body");
 if(this.env.signatures){
-var _ef=_ee.dom.get("_rc_sig");
-var _f0="";
-var _f1=true;
-if(!_ef){
+var _f0=_ef.dom.get("_rc_sig");
+var _f1="";
+var _f2=true;
+if(!_f0){
 if(bw.ie){
-_ee.getBody().appendChild(_ee.getDoc().createElement("br"));
+_ef.getBody().appendChild(_ef.getDoc().createElement("br"));
 }
-_ef=_ee.getDoc().createElement("div");
-_ef.setAttribute("id","_rc_sig");
-_ee.getBody().appendChild(_ef);
+_f0=_ef.getDoc().createElement("div");
+_f0.setAttribute("id","_rc_sig");
+_ef.getBody().appendChild(_f0);
 }
 if(this.env.signatures[id]){
-_f0=this.env.signatures[id]["text"];
-_f1=this.env.signatures[id]["is_html"];
+_f1=this.env.signatures[id]["text"];
+_f2=this.env.signatures[id]["is_html"];
 }
-if(_f1){
-_ef.innerHTML=_f0;
+if(_f2){
+_f0.innerHTML=_f1;
 }else{
-_ef.innerHTML="<pre>"+_f0+"</pre>";
+_f0.innerHTML="<pre>"+_f1+"</pre>";
 }
 }
 }
-if(_e9){
-_e9.value=_ea;
+if(_ea){
+_ea.value=_eb;
 }
 this.env.identity=id;
 return true;
@@ -1797,14 +1832,14 @@
 if(!this.gui_objects.uploadbox){
 return false;
 }
-var elm,_f4;
+var elm,_f5;
 if(elm=this.gui_objects.uploadbox){
-if(a&&(_f4=this.gui_objects.attachmentlist)){
-var pos=rcube_get_object_pos(_f4);
-var _f6=pos.x;
-var top=pos.y+_f4.offsetHeight+10;
+if(a&&(_f5=this.gui_objects.attachmentlist)){
+var pos=rcube_get_object_pos(_f5);
+var _f7=pos.x;
+var top=pos.y+_f5.offsetHeight+10;
 elm.style.top=top+"px";
-elm.style.left=_f6+"px";
+elm.style.left=_f7+"px";
 }
 elm.style.visibility=a?"visible":"hidden";
 }
@@ -1817,47 +1852,47 @@
 }
 return true;
 };
-this.upload_file=function(_f8){
-if(!_f8){
+this.upload_file=function(_f9){
+if(!_f9){
 return false;
 }
-var _f9=false;
-for(var n=0;n<_f8.elements.length;n++){
-if(_f8.elements[n].type=="file"&&_f8.elements[n].value){
-_f9=true;
+var _fa=false;
+for(var n=0;n<_f9.elements.length;n++){
+if(_f9.elements[n].type=="file"&&_f9.elements[n].value){
+_fa=true;
 break;
 }
 }
-if(_f9){
+if(_fa){
 var ts=new Date().getTime();
-var _fc="rcmupload"+ts;
+var _fd="rcmupload"+ts;
 if(document.all){
-var _fd="<iframe name=\""+_fc+"\" src=\"program/blank.gif\" style=\"width:0;height:0;visibility:hidden;\"></iframe>";
-document.body.insertAdjacentHTML("BeforeEnd",_fd);
+var _fe="<iframe name=\""+_fd+"\" src=\"program/blank.gif\" style=\"width:0;height:0;visibility:hidden;\"></iframe>";
+document.body.insertAdjacentHTML("BeforeEnd",_fe);
 }else{
-var _fe=document.createElement("IFRAME");
-_fe.name=_fc;
-_fe.style.border="none";
-_fe.style.width=0;
-_fe.style.height=0;
-_fe.style.visibility="hidden";
-document.body.appendChild(_fe);
-}
-_f8.target=_fc;
-_f8.action=this.env.comm_path+"&_action=upload";
-_f8.setAttribute("enctype","multipart/form-data");
-_f8.submit();
+var _ff=document.createElement("IFRAME");
+_ff.name=_fd;
+_ff.style.border="none";
+_ff.style.width=0;
+_ff.style.height=0;
+_ff.style.visibility="hidden";
+document.body.appendChild(_ff);
+}
+_f9.target=_fd;
+_f9.action=this.env.comm_path+"&_action=upload";
+_f9.setAttribute("enctype","multipart/form-data");
+_f9.submit();
 }
-this.gui_objects.attachmentform=_f8;
+this.gui_objects.attachmentform=_f9;
 return true;
 };
-this.add2attachment_list=function(_ff,_100){
+this.add2attachment_list=function(name,_101){
 if(!this.gui_objects.attachmentlist){
 return false;
 }
 var li=document.createElement("LI");
-li.id=_ff;
-li.innerHTML=_100;
+li.id=name;
+li.innerHTML=_101;
 this.gui_objects.attachmentlist.appendChild(li);
 return true;
 };
@@ -1878,14 +1913,14 @@
 }
 return true;
 };
-this.add_contact=function(_105){
-if(_105){
-this.http_post("addcontact","_address="+_105);
+this.add_contact=function(_106){
+if(_106){
+this.http_post("addcontact","_address="+_106);
 }
 return true;
 };
-this.qsearch=function(_106,_107){
-if(_106!=""){
+this.qsearch=function(_107,_108){
+if(_107!=""){
 if(this.message_list){
 this.message_list.clear();
 }else{
@@ -1895,11 +1930,11 @@
 }
 }
 if(this.gui_objects.search_filter){
-_107="&_filter="+this.gui_objects.search_filter.value;
+_108="&_filter="+this.gui_objects.search_filter.value;
 }
 this.env.current_page=1;
 this.set_busy(true,"searching");
-this.http_request("search","_q="+urlencode(_106)+(this.env.mailbox?"&_mbox="+urlencode(this.env.mailbox):"")+(this.env.source?"&_source="+urlencode(this.env.source):"")+(_107?_107:""),true);
+this.http_request("search","_q="+urlencode(_107)+(this.env.mailbox?"&_mbox="+urlencode(this.env.mailbox):"")+(this.env.source?"&_source="+urlencode(this.env.source):"")+(_108?_108:""),true);
 }
 return true;
 };
@@ -1918,7 +1953,7 @@
 if(this.ksearch_timer){
 clearTimeout(this.ksearch_timer);
 }
-var _10c;
+var _10d;
 var key=rcube_event.get_keycode(e);
 var mod=rcube_event.get_modifier(e);
 switch(key){
@@ -1928,12 +1963,12 @@
 break;
 }
 var dir=key==38?1:0;
-_10c=document.getElementById("rcmksearchSelected");
-if(!_10c){
-_10c=this.ksearch_pane.ul.firstChild;
+_10d=document.getElementById("rcmksearchSelected");
+if(!_10d){
+_10d=this.ksearch_pane.ul.firstChild;
 }
-if(_10c){
-this.ksearch_select(dir?_10c.previousSibling:_10c.nextSibling);
+if(_10d){
+this.ksearch_select(dir?_10d.previousSibling:_10d.nextSibling);
 }
 return rcube_event.cancel(e);
 case 9:
@@ -1958,10 +1993,10 @@
 return true;
 };
 this.ksearch_select=function(node){
-var _111=document.getElementById("rcmksearchSelected");
-if(_111&&node){
-_111.removeAttribute("id");
-this.set_classname(_111,"selected",false);
+var _112=document.getElementById("rcmksearchSelected");
+if(_112&&node){
+_112.removeAttribute("id");
+this.set_classname(_112,"selected",false);
 }
 if(node){
 node.setAttribute("id","rcmksearchSelected");
@@ -1973,29 +2008,29 @@
 if(!this.env.contacts[id]||!this.ksearch_input){
 return;
 }
-var _113=this.ksearch_input.value.toLowerCase();
+var _114=this.ksearch_input.value.toLowerCase();
 var cpos=this.get_caret_pos(this.ksearch_input);
-var p=_113.lastIndexOf(this.ksearch_value,cpos);
+var p=_114.lastIndexOf(this.ksearch_value,cpos);
 var pre=this.ksearch_input.value.substring(0,p);
 var end=this.ksearch_input.value.substring(p+this.ksearch_value.length,this.ksearch_input.value.length);
-var _118=this.env.contacts[id]+", ";
-this.ksearch_input.value=pre+_118+end;
-cpos=p+_118.length;
+var _119=this.env.contacts[id]+", ";
+this.ksearch_input.value=pre+_119+end;
+cpos=p+_119.length;
 if(this.ksearch_input.setSelectionRange){
 this.ksearch_input.setSelectionRange(cpos,cpos);
 }
 };
 this.ksearch_get_results=function(){
-var _119=this.ksearch_input?this.ksearch_input.value:null;
-if(_119===null){
+var _11a=this.ksearch_input?this.ksearch_input.value:null;
+if(_11a===null){
 return;
 }
 if(this.ksearch_pane&&this.ksearch_pane.visible){
 this.ksearch_pane.show(0);
 }
 var cpos=this.get_caret_pos(this.ksearch_input);
-var p=_119.lastIndexOf(",",cpos-1);
-var q=_119.substring(p+1,cpos);
+var p=_11a.lastIndexOf(",",cpos-1);
+var q=_11a.substring(p+1,cpos);
 q=q.replace(/(^\s+|\s+$)/g,"").toLowerCase();
 if(!q.length||q==this.ksearch_value){
 return;
@@ -2004,21 +2039,21 @@
 this.display_message(this.get_label("searching"),"loading",true);
 this.http_post("autocomplete","_search="+q);
 };
-this.ksearch_query_results=function(_11d){
+this.ksearch_query_results=function(_11e){
 this.hide_message();
-this.env.contacts=_11d?_11d:[];
-var _11e=new Array();
+this.env.contacts=_11e?_11e:[];
+var _11f=new Array();
 var c=0;
 for(var i=0;i<this.env.contacts.length;i++){
-_11e[c++]=i;
+_11f[c++]=i;
 if(c==15){
 break;
 }
 }
-this.ksearch_display_results(this.env.contacts,_11e,c);
+this.ksearch_display_results(this.env.contacts,_11f,c);
 };
-this.ksearch_display_results=function(_121,_122,c){
-if(c&&_121.length&&this.ksearch_input){
+this.ksearch_display_results=function(_122,_123,c){
+if(c&&_122.length&&this.ksearch_input){
 var p,ul,li;
 if(!this.ksearch_pane){
 ul=document.createElement("UL");
@@ -2029,20 +2064,20 @@
 ul=this.ksearch_pane.ul;
 }
 ul.innerHTML="";
-for(i=0;i<_121.length;i++){
+for(i=0;i<_122.length;i++){
 li=document.createElement("LI");
-li.innerHTML=_121[i].replace(new RegExp("("+this.ksearch_value+")","ig"),"##$1%%").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/##([^%]+)%%/g,"<b>$1</b>");
+li.innerHTML=_122[i].replace(new RegExp("("+this.ksearch_value+")","ig"),"##$1%%").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/##([^%]+)%%/g,"<b>$1</b>");
 li.onmouseover=function(){
 _1.ksearch_select(this);
 };
 li.onmouseup=function(){
 _1.ksearch_click(this);
 };
-li._rcm_id=_122[i];
+li._rcm_id=_123[i];
 ul.appendChild(li);
 }
 if(this.ksearch_selected!==null){
-p=find_in_array(this.ksearch_selected,_122);
+p=find_in_array(this.ksearch_selected,_123);
 if(p>=0&&ul.childNodes){
 ul.childNodes[p].setAttribute("id","rcmksearchSelected");
 this.set_classname(ul.childNodes[p],"selected",true);
@@ -2053,7 +2088,7 @@
 if(this.ksearch_selected===null){
 ul.firstChild.setAttribute("id","rcmksearchSelected");
 this.set_classname(ul.firstChild,"selected",true);
-this.ksearch_selected=_122[0];
+this.ksearch_selected=_123[0];
 }
 var pos=rcube_get_object_pos(this.ksearch_input);
 this.ksearch_pane.move(pos.x,pos.y+this.ksearch_input.offsetHeight);
@@ -2092,7 +2127,7 @@
 if(this.preview_timer){
 clearTimeout(this.preview_timer);
 }
-var id,_12c,_1=this;
+var id,_12d,_1=this;
 if(id=list.get_single_selection()){
 this.preview_timer=window.setTimeout(function(){
 _1.load_contact(id,"show");
@@ -2108,8 +2143,8 @@
 return false;
 };
 this.list_contacts=function(src,page){
-var _12f="";
-var _130=window;
+var _130="";
+var _131=window;
 if(!src){
 src=this.env.source;
 }
@@ -2128,14 +2163,14 @@
 return;
 }
 if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
-_130=window.frames[this.env.contentframe];
-_12f="&_framed=1";
+_131=window.frames[this.env.contentframe];
+_130="&_framed=1";
 }
 if(this.env.search_request){
-_12f+="&_search="+this.env.search_request;
+_130+="&_search="+this.env.search_request;
 }
 this.set_busy(true,"loading");
-_130.location.href=this.env.comm_path+(src?"&_source="+urlencode(src):"")+(page?"&_page="+page:"")+_12f;
+_131.location.href=this.env.comm_path+(src?"&_source="+urlencode(src):"")+(page?"&_page="+page:"")+_130;
 };
 this.list_contacts_remote=function(src,page){
 this.contact_list.clear(true);
@@ -2149,21 +2184,21 @@
 this.set_busy(true,"loading");
 this.http_request("list",url,true);
 };
-this.load_contact=function(cid,_135,_136){
-var _137="";
-var _138=window;
+this.load_contact=function(cid,_136,_137){
+var _138="";
+var _139=window;
 if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
-_137="&_framed=1";
-_138=window.frames[this.env.contentframe];
+_138="&_framed=1";
+_139=window.frames[this.env.contentframe];
 this.show_contentframe(true);
 }else{
-if(_136){
+if(_137){
 return false;
 }
 }
-if(_135&&(cid||_135=="add")&&!this.drag_active){
+if(_136&&(cid||_136=="add")&&!this.drag_active){
 this.set_busy(true);
-_138.location.href=this.env.comm_path+"&_action="+_135+"&_source="+urlencode(this.env.source)+"&_cid="+urlencode(cid)+_137;
+_139.location.href=this.env.comm_path+"&_action="+_136+"&_source="+urlencode(this.env.source)+"&_cid="+urlencode(cid)+_138;
 }
 return true;
 };
@@ -2176,43 +2211,304 @@
 }
 };
 this.delete_contacts=function(){
-var _13b=this.contact_list.get_selection();
-if(!(_13b.length||this.env.cid)||!confirm(this.get_label("deletecontactconfirm"))){
+var _13c=this.contact_list.get_selection();
+if(!(_13c.length||this.env.cid)||!confirm(this.get_label("deletecontactconfirm"))){
 return;
 }
-var _13c=new Array();
+var _13d=new Array();
 var qs="";
 if(this.env.cid){
-_13c[_13c.length]=this.env.cid;
+_13d[_13d.length]=this.env.cid;
 }else{
 var id;
-for(var n=0;n<_13b.length;n++){
-id=_13b[n];
-_13c[_13c.length]=id;
-this.contact_list.remove_row(id,(n==_13b.length-1));
+for(var n=0;n<_13c.length;n++){
+id=_13c[n];
+_13d[_13d.length]=id;
+this.contact_list.remove_row(id,(n==_13c.length-1));
 }
-if(_13b.length==1){
+if(_13c.length==1){
 this.show_contentframe(false);
 }
 }
 if(this.env.search_request){
 qs+="&_search="+this.env.search_request;
 }
-this.http_post("delete","_cid="+urlencode(_13c.join(","))+"&_source="+urlencode(this.env.source)+"&_from="+(this.env.action?this.env.action:"")+qs);
+this.http_post("delete","_cid="+urlencode(_13d.join(","))+"&_source="+urlencode(this.env.source)+"&_from="+(this.env.action?this.env.action:"")+qs);
 return true;
 };
-this.update_contact_row=function(cid,_141){
+this.update_contact_row=function(cid,_142){
 var row;
 if(this.contact_list.rows[cid]&&(row=this.contact_list.rows[cid].obj)){
-for(var c=0;c<_141.length;c++){
+for(var c=0;c<_142.length;c++){
 if(row.cells[c]){
-row.cells[c].innerHTML=_141[c];
+row.cells[c].innerHTML=_142[c];
 }
 }
 return true;
 }
 return false;
 };
+this.sievefilter_add=function(){
+this.load_sievefilterframe();
+this.sievefilters_list.clear_selection();
+};
+this.sievefilter_del=function(){
+var id=this.sievefilters_list.get_single_selection();
+if(confirm(this.get_label("filterconfirmdelete"))){
+this.http_request("managesieve","_act=delete&_fid="+this.sievefilters_list.rows[id].uid,true);
+}
+};
+this.sievefilter_up=function(){
+var id=this.sievefilters_list.get_single_selection();
+this.http_request("managesieve","_act=up&_fid="+this.sievefilters_list.rows[id].uid,true);
+};
+this.sievefilter_down=function(){
+var id=this.sievefilters_list.get_single_selection();
+this.http_request("managesieve","_act=down&_fid="+this.sievefilters_list.rows[id].uid,true);
+};
+this.sievefilter_rowid=function(id){
+var rows=this.sievefilters_list.rows;
+for(var i=0;i<rows.length;i++){
+if(rows[i]!=null&&rows[i].uid==id){
+return i;
+}
+}
+};
+this.sievefilter_updatelist=function(_14b,name,id){
+this.set_busy(true);
+switch(_14b){
+case "delete":
+this.sievefilters_list.remove_row(this.sievefilter_rowid(id));
+this.sievefilters_list.clear_selection();
+this.enable_command("sievefilterdel","sievefilterup","sievefilterdown",false);
+this.show_contentframe(false);
+var rows=this.sievefilters_list.rows;
+for(var i=0;i<rows.length;i++){
+if(rows[i]!=null&&rows[i].uid>id){
+rows[i].uid=rows[i].uid-1;
+}
+}
+break;
+case "down":
+var rows=this.sievefilters_list.rows;
+var from;
+for(var i=0;i<rows.length;i++){
+if(rows[i]==null){
+continue;
+}else{
+if(rows[i].uid==id){
+from=rows[i].obj.cells[0];
+}else{
+if(rows[i].uid==parseInt(id)+1){
+name=rows[i].obj.cells[0].innerHTML;
+rows[i].obj.cells[0].innerHTML=from.innerHTML;
+from.innerHTML=name;
+this.sievefilters_list.highlight_row(i);
+break;
+}
+}
+}
+}
+this.sievefilter_listbuttons();
+break;
+case "up":
+var rows=this.sievefilters_list.rows;
+var from;
+for(var i=0;i<rows.length;i++){
+if(rows[i]==null){
+continue;
+}else{
+if(rows[i].uid==id-1){
+from=rows[i].obj.cells[0];
+this.sievefilters_list.highlight_row(i);
+}else{
+if(rows[i].uid==id){
+name=rows[i].obj.cells[0].innerHTML;
+rows[i].obj.cells[0].innerHTML=from.innerHTML;
+from.innerHTML=name;
+break;
+}
+}
+}
+}
+this.sievefilter_listbuttons();
+break;
+case "update":
+var rows=parent.rcmail.sievefilters_list.rows;
+for(var i=0;i<rows.length;i++){
+if(rows[i]&&rows[i].uid==id){
+rows[i].obj.cells[0].innerHTML=name;
+break;
+}
+}
+break;
+case "add":
+var row,_152,td;
+var list=parent.rcmail.sievefilters_list;
+if(!list){
+break;
+}
+for(var i=0;i<list.rows.length;i++){
+if(list.rows[i]!=null&&String(list.rows[i].obj.id).match(/^rcmrow/)){
+row=list.rows[i].obj;
+}
+}
+if(row){
+_152=parent.document.createElement("TR");
+_152.id="rcmrow"+id;
+td=parent.document.createElement("TD");
+_152.appendChild(td);
+list.insert_row(_152,false);
+if(row.cells[0].className){
+td.className=row.cells[0].className;
+}
+td.innerHTML=name;
+list.highlight_row(id);
+parent.rcmail.enable_command("sievefilterdel","sievefilterup",true);
+}else{
+parent.rcmail.goto_url("managesieve");
+}
+break;
+}
+this.set_busy(false);
+};
+this.sievefilter_select=function(list){
+var id=list.get_single_selection();
+if(id!=null){
+this.load_sievefilterframe(list.rows[id].uid);
+}
+};
+this.sievefilter_save=function(){
+if(parent.rcmail&&parent.rcmail.sievefilters_list){
+var id=parent.rcmail.sievefilters_list.get_single_selection();
+if(id!=null){
+this.gui_objects.sieveform.elements["_fid"].value=parent.rcmail.sievefilters_list.rows[id].uid;
+}
+}
+this.gui_objects.sieveform.submit();
+};
+this.load_sievefilterframe=function(id){
+if(typeof (id)!="undefined"&&id!=null){
+this.enable_command("sievefilterdel",true);
+this.sievefilter_listbuttons();
+}else{
+this.enable_command("sievefilterup","sievefilterdown","sievefilterdel",false);
+}
+if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
+target=window.frames[this.env.contentframe];
+this.set_busy(true,"loading");
+target.location.href=this.env.comm_path+"&_action=managesieve&_framed=1&_fid="+id;
+}
+};
+this.sievefilter_listbuttons=function(){
+var id=this.sievefilters_list.get_single_selection();
+var rows=this.sievefilters_list.rows;
+for(var i=0;i<rows.length;i++){
+if(rows[i]==null){
+}else{
+if(i==id){
+this.enable_command("sievefilterup",false);
+break;
+}else{
+this.enable_command("sievefilterup",true);
+break;
+}
+}
+}
+for(var i=rows.length-1;i>0;i--){
+if(rows[i]==null){
+}else{
+if(i==id){
+this.enable_command("sievefilterdown",false);
+break;
+}else{
+this.enable_command("sievefilterdown",true);
+break;
+}
+}
+}
+};
+this.sievefilter_ruleadd=function(id){
+this.http_post("managesieve","_act=ruleadd&_rid="+id);
+};
+this.sievefilter_rulefill=function(_15d,id,_15f){
+if(_15d!=""){
+var div=document.getElementById("rules");
+var row=document.createElement("div");
+this.sievefilter_insertrow(div,row,_15f);
+row.setAttribute("id","rulerow"+id);
+row.className="rulerow";
+row.innerHTML=_15d;
+this.sievefilter_formbuttons(div);
+}
+};
+this.sievefilter_ruledel=function(id){
+if(confirm(this.get_label("ruledeleteconfirm"))){
+var row=document.getElementById("rulerow"+id);
+row.parentNode.removeChild(row);
+this.sievefilter_formbuttons(document.getElementById("rules"));
+}
+};
+this.sievefilter_actionadd=function(id){
+this.http_post("managesieve","_act=actionadd&_aid="+id);
+};
+this.sievefilter_actionfill=function(_165,id,_167){
+if(_165!=""){
+var div=document.getElementById("actions");
+var row=document.createElement("div");
+this.sievefilter_insertrow(div,row,_167);
+row.setAttribute("id","actionrow"+id);
+row.className="actionrow";
+row.innerHTML=_165;
+this.sievefilter_formbuttons(div);
+}
+};
+this.sievefilter_actiondel=function(id){
+if(confirm(this.get_label("actiondeleteconfirm"))){
+var row=document.getElementById("actionrow"+id);
+row.parentNode.removeChild(row);
+this.sievefilter_formbuttons(document.getElementById("actions"));
+}
+};
+this.sievefilter_insertrow=function(div,row,_16e){
+for(var i=0;i<div.childNodes.length;i++){
+if(div.childNodes[i].id==((div.id=="rules"?"rulerow":"actionrow")+_16e)){
+break;
+}
+}
+if(div.childNodes[i+1]){
+div.insertBefore(row,div.childNodes[i+1]);
+}else{
+div.appendChild(row);
+}
+};
+this.sievefilter_formbuttons=function(div){
+var _171=new Array();
+var i;
+for(i=0;i<div.childNodes.length;i++){
+if(div.id=="rules"&&div.childNodes[i].id){
+if(/rulerow/.test(div.childNodes[i].id)){
+_171.push("ruledel"+div.childNodes[i].id.replace(/rulerow/,""));
+}
+}else{
+if(div.childNodes[i].id){
+if(/actionrow/.test(div.childNodes[i].id)){
+_171.push("actiondel"+div.childNodes[i].id.replace(/actionrow/,""));
+}
+}
+}
+}
+for(i=0;i<_171.length;i++){
+var _173=document.getElementById(_171[i]);
+if(i>0||_171.length>1){
+this.set_classname(_173,"disabled",false);
+_173.removeAttribute("disabled");
+}else{
+this.set_classname(_173,"disabled",true);
+_173.setAttribute("disabled",true);
+}
+}
+};
 this.init_subscription_list=function(){
 var p=this;
 this.subscription_list=new rcube_list_widget(this.gui_objects.subscriptionlist,{multiselect:false,draggable:true,keyboard:false,toggleselect:true});
@@ -2226,15 +2522,15 @@
 p.subscription_move_folder(o);
 });
 this.subscription_list.row_init=function(row){
-var _149=row.obj.getElementsByTagName("A");
-if(_149[0]){
-_149[0].onclick=function(){
+var _179=row.obj.getElementsByTagName("A");
+if(_179[0]){
+_179[0].onclick=function(){
 p.rename_folder(row.id);
 return false;
 };
 }
-if(_149[1]){
-_149[1].onclick=function(){
+if(_179[1]){
+_179[1].onclick=function(){
 p.delete_folder(row.id);
 return false;
 };
@@ -2254,41 +2550,41 @@
 this.load_identity(id,"edit-identity");
 }
 };
-this.load_identity=function(id,_14d){
-if(_14d=="edit-identity"&&(!id||id==this.env.iid)){
+this.load_identity=function(id,_17d){
+if(_17d=="edit-identity"&&(!id||id==this.env.iid)){
 return false;
 }
-var _14e="";
-var _14f=window;
+var _17e="";
+var _17f=window;
 if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){
-_14e="&_framed=1";
-_14f=window.frames[this.env.contentframe];
+_17e="&_framed=1";
+_17f=window.frames[this.env.contentframe];
 document.getElementById(this.env.contentframe).style.visibility="inherit";
 }
-if(_14d&&(id||_14d=="add-identity")){
+if(_17d&&(id||_17d=="add-identity")){
 this.set_busy(true);
-_14f.location.href=this.env.comm_path+"&_action="+_14d+"&_iid="+id+_14e;
+_17f.location.href=this.env.comm_path+"&_action="+_17d+"&_iid="+id+_17e;
 }
 return true;
 };
 this.delete_identity=function(id){
-var _151=this.identity_list.get_selection();
-if(!(_151.length||this.env.iid)){
+var _181=this.identity_list.get_selection();
+if(!(_181.length||this.env.iid)){
 return;
 }
 if(!id){
-id=this.env.iid?this.env.iid:_151[0];
+id=this.env.iid?this.env.iid:_181[0];
 }
 this.goto_url("delete-identity","_iid="+id,true);
 return true;
 };
 this.focus_subscription=function(id){
-var row,_154;
+var row,_184;
 var reg=RegExp("["+RegExp.escape(this.env.delimiter)+"]?[^"+RegExp.escape(this.env.delimiter)+"]+$");
 if(this.drag_active&&this.env.folder&&(row=document.getElementById(id))){
-if(this.env.subscriptionrows[id]&&(_154=this.env.subscriptionrows[id][0])){
-if(this.check_droptarget(_154)&&!this.env.subscriptionrows[this.get_folder_row_id(this.env.folder)][2]&&(_154!=this.env.folder.replace(reg,""))&&(!_154.match(new RegExp("^"+RegExp.escape(this.env.folder+this.env.delimiter))))){
-this.set_env("dstfolder",_154);
+if(this.env.subscriptionrows[id]&&(_184=this.env.subscriptionrows[id][0])){
+if(this.check_droptarget(_184)&&!this.env.subscriptionrows[this.get_folder_row_id(this.env.folder)][2]&&(_184!=this.env.folder.replace(reg,""))&&(!_184.match(new RegExp("^"+RegExp.escape(this.env.folder+this.env.delimiter))))){
+this.set_env("dstfolder",_184);
 this.set_classname(row,"droptarget",true);
 }
 }else{
@@ -2309,9 +2605,9 @@
 }
 };
 this.subscription_select=function(list){
-var id,_15a;
-if((id=list.get_single_selection())&&this.env.subscriptionrows["rcmrow"+id]&&(_15a=this.env.subscriptionrows["rcmrow"+id][0])){
-this.set_env("folder",_15a);
+var id,_18a;
+if((id=list.get_single_selection())&&this.env.subscriptionrows["rcmrow"+id]&&(_18a=this.env.subscriptionrows["rcmrow"+id][0])){
+this.set_env("folder",_18a);
 }else{
 this.set_env("folder",null);
 }
@@ -2323,10 +2619,10 @@
 var reg=RegExp("["+RegExp.escape(this.env.delimiter)+"]?[^"+RegExp.escape(this.env.delimiter)+"]+$");
 if(this.env.folder&&this.env.dstfolder&&(this.env.dstfolder!=this.env.folder)&&(this.env.dstfolder!=this.env.folder.replace(reg,""))){
 var reg=new RegExp("[^"+RegExp.escape(this.env.delimiter)+"]*["+RegExp.escape(this.env.delimiter)+"]","g");
-var _15d=this.env.folder.replace(reg,"");
-var _15e=this.env.dstfolder==this.env.delimiter?_15d:this.env.dstfolder+this.env.delimiter+_15d;
+var _18d=this.env.folder.replace(reg,"");
+var _18e=this.env.dstfolder==this.env.delimiter?_18d:this.env.dstfolder+this.env.delimiter+_18d;
 this.set_busy(true,"foldermoving");
-this.http_post("rename-folder","_folder_oldname="+urlencode(this.env.folder)+"&_folder_newname="+urlencode(_15e),true);
+this.http_post("rename-folder","_folder_oldname="+urlencode(this.env.folder)+"&_folder_newname="+urlencode(_18e),true);
 }
 this.drag_active=false;
 this.unfocus_subscription(this.get_folder_row_id(this.env.dstfolder));
@@ -2391,17 +2687,17 @@
 this.name_input_keypress=function(e){
 var key=rcube_event.get_keycode(e);
 if(key==13){
-var _16a=this.name_input?this.name_input.value:null;
-if(this.edit_folder&&_16a){
-if(_16a.indexOf(this.env.delimiter)>=0){
+var _19a=this.name_input?this.name_input.value:null;
+if(this.edit_folder&&_19a){
+if(_19a.indexOf(this.env.delimiter)>=0){
 alert(this.get_label("forbiddencharacter")+" ("+this.env.delimiter+")");
 return false;
 }
 if(this.name_input.__parent){
-_16a=this.name_input.__parent+this.env.delimiter+_16a;
+_19a=this.name_input.__parent+this.env.delimiter+_19a;
 }
 this.set_busy(true,"folderrenaming");
-this.http_post("rename-folder","_folder_oldname="+urlencode(this.env.subscriptionrows[this.edit_folder][0])+"&_folder_newname="+urlencode(_16a),true);
+this.http_post("rename-folder","_folder_oldname="+urlencode(this.env.subscriptionrows[this.edit_folder][0])+"&_folder_newname="+urlencode(_19a),true);
 }
 }else{
 if(key==27){
@@ -2410,60 +2706,60 @@
 }
 };
 this.delete_folder=function(id){
-var _16c=this.env.subscriptionrows[id][0];
+var _19c=this.env.subscriptionrows[id][0];
 if(this.edit_folder){
 this.reset_folder_rename();
 }
-if(_16c&&confirm(this.get_label("deletefolderconfirm"))){
+if(_19c&&confirm(this.get_label("deletefolderconfirm"))){
 this.set_busy(true,"folderdeleting");
-this.http_post("delete-folder","_mboxes="+urlencode(_16c),true);
+this.http_post("delete-folder","_mboxes="+urlencode(_19c),true);
 this.set_env("folder",null);
 if(this.gui_objects.createfolderhint){
 this.gui_objects.createfolderhint.innerHTML="";
 }
 }
 };
-this.add_folder_row=function(name,_16e,_16f,_170){
+this.add_folder_row=function(name,_19e,_19f,_1a0){
 if(!this.gui_objects.subscriptionlist){
 return false;
 }
-for(var _171 in this.env.subscriptionrows){
-if(this.env.subscriptionrows[_171]!=null&&!this.env.subscriptionrows[_171][2]){
+for(var _1a1 in this.env.subscriptionrows){
+if(this.env.subscriptionrows[_1a1]!=null&&!this.env.subscriptionrows[_1a1][2]){
 break;
 }
 }
-var _172,form;
-var _174=this.gui_objects.subscriptionlist.tBodies[0];
-var id="rcmrow"+(_174.childNodes.length+1);
-var _176=this.subscription_list.get_single_selection();
-if(_16f&&_16f.id){
-id=_16f.id;
-_171=_16f.id;
+var _1a2,form;
+var _1a4=this.gui_objects.subscriptionlist.tBodies[0];
+var id="rcmrow"+(_1a4.childNodes.length+1);
+var _1a6=this.subscription_list.get_single_selection();
+if(_19f&&_19f.id){
+id=_19f.id;
+_1a1=_19f.id;
 }
-if(!id||!(_172=document.getElementById(_171))){
+if(!id||!(_1a2=document.getElementById(_1a1))){
 this.goto_url("folders");
 }else{
-var row=this.clone_table_row(_172);
+var row=this.clone_table_row(_1a2);
 row.id=id;
-if(_170&&(_170=this.get_folder_row_id(_170))){
-_174.insertBefore(row,document.getElementById(_170));
+if(_1a0&&(_1a0=this.get_folder_row_id(_1a0))){
+_1a4.insertBefore(row,document.getElementById(_1a0));
 }else{
-_174.appendChild(row);
+_1a4.appendChild(row);
 }
-if(_16f){
-_174.removeChild(_16f);
+if(_19f){
+_1a4.removeChild(_19f);
 }
 }
-this.env.subscriptionrows[row.id]=[name,_16e,0];
-row.cells[0].innerHTML=_16e;
-if(!_16f){
+this.env.subscriptionrows[row.id]=[name,_19e,0];
+row.cells[0].innerHTML=_19e;
+if(!_19f){
 row.cells[1].innerHTML="*";
 }
-if(!_16f&&row.cells[2]&&row.cells[2].firstChild.tagName=="INPUT"){
+if(!_19f&&row.cells[2]&&row.cells[2].firstChild.tagName=="INPUT"){
 row.cells[2].firstChild.value=name;
 row.cells[2].firstChild.checked=true;
 }
-if(!_16f&&(form=this.gui_objects.editform)){
+if(!_19f&&(form=this.gui_objects.editform)){
 if(form.elements["_folder_oldname"]){
 form.elements["_folder_oldname"].options[form.elements["_folder_oldname"].options.length]=new Option(name,name);
 }
@@ -2472,39 +2768,39 @@
 }
 }
 this.init_subscription_list();
-if(_176&&document.getElementById("rcmrow"+_176)){
-this.subscription_list.select_row(_176);
+if(_1a6&&document.getElementById("rcmrow"+_1a6)){
+this.subscription_list.select_row(_1a6);
 }
 if(document.getElementById(id).scrollIntoView){
 document.getElementById(id).scrollIntoView();
 }
 };
-this.replace_folder_row=function(_178,_179,_17a,_17b){
-var id=this.get_folder_row_id(_178);
+this.replace_folder_row=function(_1a8,_1a9,_1aa,_1ab){
+var id=this.get_folder_row_id(_1a8);
 var row=document.getElementById(id);
-this.add_folder_row(_179,_17a,row,_17b);
+this.add_folder_row(_1a9,_1aa,row,_1ab);
 var form,elm;
 if((form=this.gui_objects.editform)&&(elm=form.elements["_folder_oldname"])){
 for(var i=0;i<elm.options.length;i++){
-if(elm.options[i].value==_178){
-elm.options[i].text=_17a;
-elm.options[i].value=_179;
+if(elm.options[i].value==_1a8){
+elm.options[i].text=_1aa;
+elm.options[i].value=_1a9;
 break;
 }
 }
 form.elements["_folder_newname"].value="";
 }
 };
-this.remove_folder_row=function(_181){
+this.remove_folder_row=function(_1b1){
 var row;
-var id=this.get_folder_row_id(_181);
+var id=this.get_folder_row_id(_1b1);
 if(id&&(row=document.getElementById(id))){
 row.style.display="none";
 }
 var form;
 if((form=this.gui_objects.editform)&&form.elements["_folder_oldname"]){
 for(var i=0;i<form.elements["_folder_oldname"].options.length;i++){
-if(form.elements["_folder_oldname"].options[i].value==_181){
+if(form.elements["_folder_oldname"].options[i].value==_1b1){
 form.elements["_folder_oldname"].options[i]=null;
 break;
 }
@@ -2514,19 +2810,19 @@
 form.elements["_folder_newname"].value="";
 }
 };
-this.subscribe_folder=function(_186){
-if(_186){
-this.http_post("subscribe","_mbox="+urlencode(_186));
+this.subscribe_folder=function(_1b6){
+if(_1b6){
+this.http_post("subscribe","_mbox="+urlencode(_1b6));
 }
 };
-this.unsubscribe_folder=function(_187){
-if(_187){
-this.http_post("unsubscribe","_mbox="+urlencode(_187));
+this.unsubscribe_folder=function(_1b7){
+if(_1b7){
+this.http_post("unsubscribe","_mbox="+urlencode(_1b7));
 }
 };
-this.get_folder_row_id=function(_188){
+this.get_folder_row_id=function(_1b8){
 for(var id in this.env.subscriptionrows){
-if(this.env.subscriptionrows[id]&&this.env.subscriptionrows[id][0]==_188){
+if(this.env.subscriptionrows[id]&&this.env.subscriptionrows[id][0]==_1b8){
 break;
 }
 }
@@ -2534,7 +2830,7 @@
 };
 this.clone_table_row=function(row){
 var cell,td;
-var _18d=document.createElement("TR");
+var _1bd=document.createElement("TR");
 for(var n=0;n<row.cells.length;n++){
 cell=row.cells[n];
 td=document.createElement("TD");
@@ -2545,9 +2841,9 @@
 td.setAttribute("align",cell.align);
 }
 td.innerHTML=cell.innerHTML;
-_18d.appendChild(td);
+_1bd.appendChild(td);
 }
-return _18d;
+return _1bd;
 };
 this.set_page_buttons=function(){
 this.enable_command("nextpage",(this.env.pagecount>this.env.current_page));
@@ -2555,121 +2851,121 @@
 this.enable_command("previouspage",(this.env.current_page>1));
 this.enable_command("firstpage",(this.env.current_page>1));
 };
-this.set_button=function(_18f,_190){
-var _191=this.buttons[_18f];
-var _192,obj;
-if(!_191||!_191.length){
+this.set_button=function(_1bf,_1c0){
+var _1c1=this.buttons[_1bf];
+var _1c2,obj;
+if(!_1c1||!_1c1.length){
 return false;
 }
-for(var n=0;n<_191.length;n++){
-_192=_191[n];
-obj=document.getElementById(_192.id);
-if(obj&&_192.type=="image"&&!_192.status){
-_192.pas=obj._original_src?obj._original_src:obj.src;
+for(var n=0;n<_1c1.length;n++){
+_1c2=_1c1[n];
+obj=document.getElementById(_1c2.id);
+if(obj&&_1c2.type=="image"&&!_1c2.status){
+_1c2.pas=obj._original_src?obj._original_src:obj.src;
 if(obj.runtimeStyle&&obj.runtimeStyle.filter&&obj.runtimeStyle.filter.match(/src=['"]([^'"]+)['"]/)){
-_192.pas=RegExp.$1;
+_1c2.pas=RegExp.$1;
 }
 }else{
-if(obj&&!_192.status){
-_192.pas=String(obj.className);
+if(obj&&!_1c2.status){
+_1c2.pas=String(obj.className);
 }
 }
-if(obj&&_192.type=="image"&&_192[_190]){
-_192.status=_190;
-obj.src=_192[_190];
+if(obj&&_1c2.type=="image"&&_1c2[_1c0]){
+_1c2.status=_1c0;
+obj.src=_1c2[_1c0];
 }else{
-if(obj&&typeof (_192[_190])!="undefined"){
-_192.status=_190;
-obj.className=_192[_190];
+if(obj&&typeof (_1c2[_1c0])!="undefined"){
+_1c2.status=_1c0;
+obj.className=_1c2[_1c0];
 }
 }
-if(obj&&_192.type=="input"){
-_192.status=_190;
-obj.disabled=!_190;
+if(obj&&_1c2.type=="input"){
+_1c2.status=_1c0;
+obj.disabled=!_1c0;
 }
 }
 };
-this.set_alttext=function(_195,_196){
-if(!this.buttons[_195]||!this.buttons[_195].length){
+this.set_alttext=function(_1c5,_1c6){
+if(!this.buttons[_1c5]||!this.buttons[_1c5].length){
 return;
 }
-var _197,obj,link;
-for(var n=0;n<this.buttons[_195].length;n++){
-_197=this.buttons[_195][n];
-obj=document.getElementById(_197.id);
-if(_197.type=="image"&&obj){
-obj.setAttribute("alt",this.get_label(_196));
+var _1c7,obj,link;
+for(var n=0;n<this.buttons[_1c5].length;n++){
+_1c7=this.buttons[_1c5][n];
+obj=document.getElementById(_1c7.id);
+if(_1c7.type=="image"&&obj){
+obj.setAttribute("alt",this.get_label(_1c6));
 if((link=obj.parentNode)&&link.tagName=="A"){
-link.setAttribute("title",this.get_label(_196));
+link.setAttribute("title",this.get_label(_1c6));
 }
 }else{
 if(obj){
-obj.setAttribute("title",this.get_label(_196));
+obj.setAttribute("title",this.get_label(_1c6));
 }
 }
 }
 };
-this.button_over=function(_19b,id){
-var _19d=this.buttons[_19b];
-var _19e,img;
-if(!_19d||!_19d.length){
+this.button_over=function(_1cb,id){
+var _1cd=this.buttons[_1cb];
+var _1ce,img;
+if(!_1cd||!_1cd.length){
 return false;
 }
-for(var n=0;n<_19d.length;n++){
-_19e=_19d[n];
-if(_19e.id==id&&_19e.status=="act"){
-img=document.getElementById(_19e.id);
-if(img&&_19e.over){
-img.src=_19e.over;
+for(var n=0;n<_1cd.length;n++){
+_1ce=_1cd[n];
+if(_1ce.id==id&&_1ce.status=="act"){
+img=document.getElementById(_1ce.id);
+if(img&&_1ce.over){
+img.src=_1ce.over;
 }
 }
 }
 };
-this.button_sel=function(_1a1,id){
-var _1a3=this.buttons[_1a1];
-var _1a4,img;
-if(!_1a3||!_1a3.length){
+this.button_sel=function(_1d1,id){
+var _1d3=this.buttons[_1d1];
+var _1d4,img;
+if(!_1d3||!_1d3.length){
 return;
 }
-for(var n=0;n<_1a3.length;n++){
-_1a4=_1a3[n];
-if(_1a4.id==id&&_1a4.status=="act"){
-img=document.getElementById(_1a4.id);
-if(img&&_1a4.sel){
-img.src=_1a4.sel;
+for(var n=0;n<_1d3.length;n++){
+_1d4=_1d3[n];
+if(_1d4.id==id&&_1d4.status=="act"){
+img=document.getElementById(_1d4.id);
+if(img&&_1d4.sel){
+img.src=_1d4.sel;
 }
 }
 }
 };
-this.button_out=function(_1a7,id){
-var _1a9=this.buttons[_1a7];
-var _1aa,img;
-if(!_1a9||!_1a9.length){
+this.button_out=function(_1d7,id){
+var _1d9=this.buttons[_1d7];
+var _1da,img;
+if(!_1d9||!_1d9.length){
 return;
 }
-for(var n=0;n<_1a9.length;n++){
-_1aa=_1a9[n];
-if(_1aa.id==id&&_1aa.status=="act"){
-img=document.getElementById(_1aa.id);
-if(img&&_1aa.act){
-img.src=_1aa.act;
+for(var n=0;n<_1d9.length;n++){
+_1da=_1d9[n];
+if(_1da.id==id&&_1da.status=="act"){
+img=document.getElementById(_1da.id);
+if(img&&_1da.act){
+img.src=_1da.act;
 }
 }
 }
 };
-this.set_classname=function(obj,_1ae,set){
-var reg=new RegExp("s*"+_1ae,"i");
+this.set_classname=function(obj,_1de,set){
+var reg=new RegExp("s*"+_1de,"i");
 if(!set&&obj.className.match(reg)){
 obj.className=obj.className.replace(reg,"");
 }else{
 if(set&&!obj.className.match(reg)){
-obj.className+=" "+_1ae;
+obj.className+=" "+_1de;
 }
 }
 };
-this.set_pagetitle=function(_1b1){
-if(_1b1&&document.title){
-document.title=_1b1;
+this.set_pagetitle=function(_1e1){
+if(_1e1&&document.title){
+document.title=_1e1;
 }
 };
 this.display_message=function(msg,type,hold){
@@ -2690,12 +2986,12 @@
 if(type){
 cont="<div class=\""+type+"\">"+cont+"</div>";
 }
-var _1b6=this;
+var _1e6=this;
 this.gui_objects.message.innerHTML=cont;
 this.gui_objects.message.style.display="block";
 if(type!="loading"){
 this.gui_objects.message.onmousedown=function(){
-_1b6.hide_message();
+_1e6.hide_message();
 return true;
 };
 }
@@ -2713,14 +3009,14 @@
 };
 this.select_folder=function(name,old){
 if(this.gui_objects.folderlist){
-var _1b9,_1ba;
-if((_1b9=this.get_folder_li(old))){
-this.set_classname(_1b9,"selected",false);
-this.set_classname(_1b9,"unfocused",false);
-}
-if((_1ba=this.get_folder_li(name))){
-this.set_classname(_1ba,"unfocused",false);
-this.set_classname(_1ba,"selected",true);
+var _1e9,_1ea;
+if((_1e9=this.get_folder_li(old))){
+this.set_classname(_1e9,"selected",false);
+this.set_classname(_1e9,"unfocused",false);
+}
+if((_1ea=this.get_folder_li(name))){
+this.set_classname(_1ea,"unfocused",false);
+this.set_classname(_1ea,"selected",true);
 }
 }
 };
@@ -2731,13 +3027,13 @@
 }
 return null;
 };
-this.set_message_coltypes=function(_1bc){
-this.coltypes=_1bc;
+this.set_message_coltypes=function(_1ec){
+this.coltypes=_1ec;
 var cell,col;
-var _1bf=this.gui_objects.messagelist?this.gui_objects.messagelist.tHead:null;
-for(var n=0;_1bf&&n<this.coltypes.length;n++){
+var _1ef=this.gui_objects.messagelist?this.gui_objects.messagelist.tHead:null;
+for(var n=0;_1ef&&n<this.coltypes.length;n++){
 col=this.coltypes[n];
-if((cell=_1bf.rows[0].cells[n+1])&&(col=="from"||col=="to")){
+if((cell=_1ef.rows[0].cells[n+1])&&(col=="from"||col=="to")){
 if(cell.firstChild&&cell.firstChild.tagName=="A"){
 cell.firstChild.innerHTML=this.get_label(this.coltypes[n]);
 cell.firstChild.onclick=function(){
@@ -2755,35 +3051,35 @@
 }
 }
 };
-this.add_message_row=function(uid,cols,_1c3,_1c4,_1c5){
+this.add_message_row=function(uid,cols,_1f3,_1f4,_1f5){
 if(!this.gui_objects.messagelist||!this.message_list){
 return false;
 }
-var _1c6=this.gui_objects.messagelist.tBodies[0];
-var _1c7=_1c6.rows.length;
-var even=_1c7%2;
-this.env.messages[uid]={deleted:_1c3.deleted?1:0,replied:_1c3.replied?1:0,unread:_1c3.unread?1:0,forwarded:_1c3.forwarded?1:0,flagged:_1c3.flagged?1:0};
+var _1f6=this.gui_objects.messagelist.tBodies[0];
+var _1f7=_1f6.rows.length;
+var even=_1f7%2;
+this.env.messages[uid]={deleted:_1f3.deleted?1:0,replied:_1f3.replied?1:0,unread:_1f3.unread?1:0,forwarded:_1f3.forwarded?1:0,flagged:_1f3.flagged?1:0};
 var row=document.createElement("TR");
 row.id="rcmrow"+uid;
-row.className="message"+(even?" even":" odd")+(_1c3.unread?" unread":"")+(_1c3.deleted?" deleted":"")+(_1c3.flagged?" flagged":"");
+row.className="message"+(even?" even":" odd")+(_1f3.unread?" unread":"")+(_1f3.deleted?" deleted":"")+(_1f3.flagged?" flagged":"");
 if(this.message_list.in_selection(uid)){
 row.className+=" selected";
 }
 var icon=this.env.messageicon;
-if(_1c3.deleted&&this.env.deletedicon){
+if(_1f3.deleted&&this.env.deletedicon){
 icon=this.env.deletedicon;
 }else{
-if(_1c3.replied&&this.env.repliedicon){
-if(_1c3.forwarded&&this.env.forwardedrepliedicon){
+if(_1f3.replied&&this.env.repliedicon){
+if(_1f3.forwarded&&this.env.forwardedrepliedicon){
 icon=this.env.forwardedrepliedicon;
 }else{
 icon=this.env.repliedicon;
 }
 }else{
-if(_1c3.forwarded&&this.env.forwardedicon){
+if(_1f3.forwarded&&this.env.forwardedicon){
 icon=this.env.forwardedicon;
 }else{
-if(_1c3.unread&&this.env.unreadicon){
+if(_1f3.unread&&this.env.unreadicon){
 icon=this.env.unreadicon;
 }
 }
@@ -2798,24 +3094,24 @@
 col=document.createElement("TD");
 col.className=String(c).toLowerCase();
 if(c=="flag"){
-if(_1c3.flagged&&this.env.flaggedicon){
+if(_1f3.flagged&&this.env.flaggedicon){
 col.innerHTML="<img src=\""+this.env.flaggedicon+"\" alt=\"\" />";
 }else{
-if(!_1c3.flagged&&this.env.unflaggedicon){
+if(!_1f3.flagged&&this.env.unflaggedicon){
 col.innerHTML="<img src=\""+this.env.unflaggedicon+"\" alt=\"\" />";
 }
 }
 }else{
 if(c=="attachment"){
-col.innerHTML=_1c4&&this.env.attachmenticon?"<img src=\""+this.env.attachmenticon+"\" alt=\"\" />":"&nbsp;";
+col.innerHTML=_1f4&&this.env.attachmenticon?"<img src=\""+this.env.attachmenticon+"\" alt=\"\" />":"&nbsp;";
 }else{
 col.innerHTML=cols[c];
 }
 }
 row.appendChild(col);
 }
-this.message_list.insert_row(row,_1c5);
-if(_1c5&&this.env.pagesize&&this.message_list.rowcount>this.env.pagesize){
+this.message_list.insert_row(row,_1f5);
+if(_1f5&&this.env.pagesize&&this.message_list.rowcount>this.env.pagesize){
 var uid=this.message_list.get_last_row();
 this.message_list.remove_row(uid);
 this.message_list.clear_selection(uid);
@@ -2827,66 +3123,66 @@
 }
 this.set_page_buttons();
 };
-this.set_mailboxname=function(_1cf){
-if(this.gui_objects.mailboxname&&_1cf){
-this.gui_objects.mailboxname.innerHTML=_1cf;
+this.set_mailboxname=function(_1ff){
+if(this.gui_objects.mailboxname&&_1ff){
+this.gui_objects.mailboxname.innerHTML=_1ff;
 }
 };
-this.set_quota=function(_1d0){
-if(this.gui_objects.quotadisplay&&_1d0){
-this.gui_objects.quotadisplay.innerHTML=_1d0;
+this.set_quota=function(_200){
+if(this.gui_objects.quotadisplay&&_200){
+this.gui_objects.quotadisplay.innerHTML=_200;
 }
 };
-this.set_unread_count=function(mbox,_1d2,_1d3){
+this.set_unread_count=function(mbox,_202,_203){
 if(!this.gui_objects.mailboxlist){
 return false;
 }
-this.env.unread_counts[mbox]=_1d2;
-this.set_unread_count_display(mbox,_1d3);
+this.env.unread_counts[mbox]=_202;
+this.set_unread_count_display(mbox,_203);
 };
-this.set_unread_count_display=function(mbox,_1d5){
-var reg,_1d7,item,_1d9,_1da,div;
+this.set_unread_count_display=function(mbox,_205){
+var reg,_207,item,_209,_20a,div;
 if(item=this.get_folder_li(mbox)){
-_1d9=this.env.unread_counts[mbox]?this.env.unread_counts[mbox]:0;
-_1d7=item.getElementsByTagName("a")[0];
+_209=this.env.unread_counts[mbox]?this.env.unread_counts[mbox]:0;
+_207=item.getElementsByTagName("a")[0];
 reg=/\s+\([0-9]+\)$/i;
-_1da=0;
+_20a=0;
 if((div=item.getElementsByTagName("div")[0])&&div.className.match(/collapsed/)){
 for(var k in this.env.unread_counts){
 if(k.indexOf(mbox+this.env.delimiter)==0){
-_1da+=this.env.unread_counts[k];
+_20a+=this.env.unread_counts[k];
 }
 }
 }
-if(_1d9&&_1d7.innerHTML.match(reg)){
-_1d7.innerHTML=_1d7.innerHTML.replace(reg," ("+_1d9+")");
+if(_209&&_207.innerHTML.match(reg)){
+_207.innerHTML=_207.innerHTML.replace(reg," ("+_209+")");
 }else{
-if(_1d9){
-_1d7.innerHTML+=" ("+_1d9+")";
+if(_209){
+_207.innerHTML+=" ("+_209+")";
 }else{
-_1d7.innerHTML=_1d7.innerHTML.replace(reg,"");
+_207.innerHTML=_207.innerHTML.replace(reg,"");
 }
 }
 reg=new RegExp(RegExp.escape(this.env.delimiter)+"[^"+RegExp.escape(this.env.delimiter)+"]+$");
 if(mbox.match(reg)){
 this.set_unread_count_display(mbox.replace(reg,""),false);
 }
-this.set_classname(item,"unread",(_1d9+_1da)>0?true:false);
+this.set_classname(item,"unread",(_209+_20a)>0?true:false);
 }
 reg=/^\([0-9]+\)\s+/i;
-if(_1d5&&document.title){
-var _1dd=String(document.title);
-var _1de="";
-if(_1d9&&_1dd.match(reg)){
-_1de=_1dd.replace(reg,"("+_1d9+") ");
+if(_205&&document.title){
+var _20d=String(document.title);
+var _20e="";
+if(_209&&_20d.match(reg)){
+_20e=_20d.replace(reg,"("+_209+") ");
 }else{
-if(_1d9){
-_1de="("+_1d9+") "+_1dd;
+if(_209){
+_20e="("+_209+") "+_20d;
 }else{
-_1de=_1dd.replace(reg,"");
+_20e=_20d.replace(reg,"");
 }
 }
-this.set_pagetitle(_1de);
+this.set_pagetitle(_20e);
 }
 };
 this.new_message_focus=function(){
@@ -2896,13 +3192,13 @@
 window.focus();
 }
 };
-this.add_contact_row=function(cid,cols,_1e1){
+this.add_contact_row=function(cid,cols,_211){
 if(!this.gui_objects.contactslist||!this.gui_objects.contactslist.tBodies[0]){
 return false;
 }
-var _1e2=this.gui_objects.contactslist.tBodies[0];
-var _1e3=_1e2.rows.length;
-var even=_1e3%2;
+var _212=this.gui_objects.contactslist.tBodies[0];
+var _213=_212.rows.length;
+var even=_213%2;
 var row=document.createElement("TR");
 row.id="rcmrow"+cid;
 row.className="contact "+(even?"even":"odd");
@@ -2918,16 +3214,16 @@
 this.contact_list.insert_row(row);
 this.enable_command("export",(this.contact_list.rowcount>0));
 };
-this.toggle_prefer_html=function(_1e7){
-var _1e8;
-if(_1e8=document.getElementById("rcmfd_addrbook_show_images")){
-_1e8.disabled=!_1e7.checked;
+this.toggle_prefer_html=function(_217){
+var _218;
+if(_218=document.getElementById("rcmfd_addrbook_show_images")){
+_218.disabled=!_217.checked;
 }
 };
-this.set_headers=function(_1e9){
-if(this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&_1e9){
+this.set_headers=function(_219){
+if(this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&_219){
 var box=this.gui_objects.all_headers_box;
-box.innerHTML=_1e9;
+box.innerHTML=_219;
 box.style.display="block";
 if(this.env.framed&&parent.rcmail){
 parent.rcmail.set_busy(false);
@@ -2962,22 +3258,22 @@
 rcmail.load_headers(elem);
 };
 };
-this.html2plain=function(_1ed,id){
-var _1ef=new rcube_http_request();
+this.html2plain=function(_21d,id){
+var _21f=new rcube_http_request();
 var url=this.env.bin_path+"html2text.php";
-var _1f1=this;
+var _221=this;
 this.set_busy(true,"converting");
-_1ef.onerror=function(o){
-_1f1.http_error(o);
+_21f.onerror=function(o){
+_221.http_error(o);
 };
-_1ef.oncomplete=function(o){
-_1f1.set_text_value(o,id);
+_21f.oncomplete=function(o){
+_221.set_text_value(o,id);
 };
-_1ef.POST(url,_1ed,"application/octet-stream");
+_21f.POST(url,_21d,"application/octet-stream");
 };
-this.set_text_value=function(_1f4,id){
+this.set_text_value=function(_224,id){
 this.set_busy(false);
-document.getElementById(id).value=_1f4.get_text();
+document.getElementById(id).value=_224.get_text();
 };
 this.redirect=function(url,lock){
 if(lock||lock===null){
@@ -2989,9 +3285,9 @@
 location.href=url;
 }
 };
-this.goto_url=function(_1f8,_1f9,lock){
-var _1fb=_1f9?"&"+_1f9:"";
-this.redirect(this.env.comm_path+"&_action="+_1f8+_1fb,lock);
+this.goto_url=function(_228,_229,lock){
+var _22b=_229?"&"+_229:"";
+this.redirect(this.env.comm_path+"&_action="+_228+_22b,lock);
 };
 this.http_sockets=new Array();
 this.get_request_obj=function(){
@@ -3004,65 +3300,65 @@
 this.http_sockets[i]=new rcube_http_request();
 return this.http_sockets[i];
 };
-this.http_request=function(_1fe,_1ff,lock){
-var _201=this.get_request_obj();
-_1ff+=(_1ff?"&":"")+"_remote=1";
+this.http_request=function(_22e,_22f,lock){
+var _231=this.get_request_obj();
+_22f+=(_22f?"&":"")+"_remote=1";
 if(bw.safari){
-_1ff+="&_ts="+(new Date().getTime());
+_22f+="&_ts="+(new Date().getTime());
 }
-if(_201){
+if(_231){
 if(lock){
 this.set_busy(true);
 }
 var rcm=this;
-_201.__lock=lock?true:false;
-_201.__action=_1fe;
-_201.onerror=function(o){
+_231.__lock=lock?true:false;
+_231.__action=_22e;
+_231.onerror=function(o){
 _1.http_error(o);
 };
-_201.oncomplete=function(o){
+_231.oncomplete=function(o){
 _1.http_response(o);
 };
-_201.GET(this.env.comm_path+"&_action="+_1fe+"&"+_1ff);
+_231.GET(this.env.comm_path+"&_action="+_22e+"&"+_22f);
 }
 };
-this.http_post=function(_205,_206,lock){
-var _208;
-if(_206&&typeof (_206)=="object"){
-_206._remote=1;
+this.http_post=function(_235,_236,lock){
+var _238;
+if(_236&&typeof (_236)=="object"){
+_236._remote=1;
 }else{
-_206+=(_206?"&":"")+"_remote=1";
+_236+=(_236?"&":"")+"_remote=1";
 }
-if(_208=this.get_request_obj()){
+if(_238=this.get_request_obj()){
 if(lock){
 this.set_busy(true);
 }
 var rcm=this;
-_208.__lock=lock?true:false;
-_208.__action=_205;
-_208.onerror=function(o){
+_238.__lock=lock?true:false;
+_238.__action=_235;
+_238.onerror=function(o){
 rcm.http_error(o);
 };
-_208.oncomplete=function(o){
+_238.oncomplete=function(o){
 rcm.http_response(o);
 };
-_208.POST(this.env.comm_path+"&_action="+_205,_206);
+_238.POST(this.env.comm_path+"&_action="+_235,_236);
 }
 };
-this.http_response=function(_20c){
-var _20d=_20c.get_header("Content-Type");
-if(_20d){
-_20d=String(_20d).toLowerCase();
-var _20e=_20d.split(";");
-_20d=_20e[0];
+this.http_response=function(_23c){
+var _23d=_23c.get_header("Content-Type");
+if(_23d){
+_23d=String(_23d).toLowerCase();
+var _23e=_23d.split(";");
+_23d=_23e[0];
 }
-if(_20c.__lock){
+if(_23c.__lock){
 this.set_busy(false);
 }
-if(_20c.get_text()&&(_20d=="text/javascript"||_20d=="application/x-javascript")){
-eval(_20c.get_text());
+if(_23c.get_text()&&(_23d=="text/javascript"||_23d=="application/x-javascript")){
+eval(_23c.get_text());
 }
-switch(_20c.__action){
+switch(_23c.__action){
 case "delete":
 if(this.task=="addressbook"){
 var uid=this.contact_list.get_selection();
@@ -3092,7 +3388,7 @@
 case "getunread":
 case "list":
 if(this.task=="mail"){
-if(this.message_list&&_20c.__action=="list"){
+if(this.message_list&&_23c.__action=="list"){
 this.msglist_select(this.message_list);
 }
 this.enable_command("show","expunge","select-all","select-none","sort",(this.env.messagecount>0));
@@ -3104,25 +3400,25 @@
 }
 break;
 }
-_20c.reset();
+_23c.reset();
 };
-this.http_error=function(_210){
-if(_210.__lock){
+this.http_error=function(_240){
+if(_240.__lock){
 this.set_busy(false);
 }
-_210.reset();
-_210.__lock=false;
+_240.reset();
+_240.__lock=false;
 this.display_message("Unknown Server Error!","error");
 };
 this.send_keep_alive=function(){
 var d=new Date();
 this.http_request("keep-alive","_t="+d.getTime());
 };
-this.check_for_recent=function(_212){
+this.check_for_recent=function(_242){
 if(this.busy){
 return;
 }
-if(_212){
+if(_242){
 this.set_busy(true,"checkingmail");
 }
 this.http_request("check-recent",(this.env.search_request?"_search="+this.env.search_request+"&":"")+"_t="+(new Date().getTime()),true);
@@ -3138,17 +3434,17 @@
 return obj.selectionEnd;
 }else{
 if(document.selection&&document.selection.createRange){
-var _214=document.selection.createRange();
-if(_214.parentElement()!=obj){
+var _244=document.selection.createRange();
+if(_244.parentElement()!=obj){
 return 0;
 }
-var gm=_214.duplicate();
+var gm=_244.duplicate();
 if(obj.tagName=="TEXTAREA"){
 gm.moveToElementText(obj);
 }else{
 gm.expand("textedit");
 }
-gm.setEndPoint("EndToStart",_214);
+gm.setEndPoint("EndToStart",_244);
 var p=gm.text.length;
 return p<=obj.value.length?p:-1;
 }else{
@@ -3158,9 +3454,9 @@
 };
 this.set_caret2start=function(obj){
 if(obj.createTextRange){
-var _218=obj.createTextRange();
-_218.collapse(true);
-_218.select();
+var _248=obj.createTextRange();
+_248.collapse(true);
+_248.select();
 }else{
 if(obj.setSelectionRange){
 obj.setSelectionRange(0,0);
@@ -3234,20 +3530,20 @@
 this.xmlhttp.setRequestHeader("X-RoundCube-Referer",bw.get_cookie("roundcube_sessid"));
 this.xmlhttp.send(null);
 };
-this.POST=function(url,body,_221){
-if(typeof (_221)=="undefined"){
-_221="application/x-www-form-urlencoded";
+this.POST=function(url,body,_251){
+if(typeof (_251)=="undefined"){
+_251="application/x-www-form-urlencoded";
 }
 this.build();
 if(!this.xmlhttp){
 this.onerror(this);
 return false;
 }
-var _222=body;
+var _252=body;
 if(typeof (body)=="object"){
-_222="";
+_252="";
 for(var p in body){
-_222+=(_222?"&":"")+p+"="+urlencode(body[p]);
+_252+=(_252?"&":"")+p+"="+urlencode(body[p]);
 }
 }
 var ref=this;
@@ -3257,9 +3553,9 @@
 ref.xmlhttp_onreadystatechange();
 };
 this.xmlhttp.open("POST",url,true);
-this.xmlhttp.setRequestHeader("Content-Type",_221);
+this.xmlhttp.setRequestHeader("Content-Type",_251);
 this.xmlhttp.setRequestHeader("X-RoundCube-Referer",bw.get_cookie("roundcube_sessid"));
-this.xmlhttp.send(_222);
+this.xmlhttp.send(_252);
 };
 this.xmlhttp_onreadystatechange=function(){
 if(this.xmlhttp.readyState==1){
diff -ruNa 0.2-stable.old/program/js/app.js.src 0.2-stable/program/js/app.js.src
--- 0.2-stable.old/program/js/app.js.src	2008-12-30 16:25:19.000000000 +0100
+++ 0.2-stable/program/js/app.js.src	2009-01-03 14:06:20.759147716 +0100
@@ -288,6 +288,7 @@
 
       case 'settings':
         this.enable_command('preferences', 'identities', 'save', 'folders', true);
+        this.enable_command('managesieve', true);
         
         if (this.env.action=='identities' || this.env.action=='edit-identity' || this.env.action=='add-identity') {
           this.enable_command('add', this.env.identities_level < 2);
@@ -300,6 +301,23 @@
         if (this.env.action=='folders')
           this.enable_command('subscribe', 'unsubscribe', 'create-folder', 'rename-folder', 'delete-folder', true);
 
+	if (this.env.action=='managesieve')
+	  {
+	    if (!this.env.sieveconnerror)
+	      this.enable_command('sievefilteradd', true);
+
+    	    if (this.gui_objects.filterslist)
+    	      {
+    		this.sievefilters_list = new rcube_list_widget(this.gui_objects.filterslist, {multiselect:false, draggable:false, keyboard:false});
+        	this.sievefilters_list.addEventListener('select', function(o){ p.sievefilter_select(o); });
+        	this.sievefilters_list.init();
+        	this.sievefilters_list.focus();
+	      }
+	    
+	    if (this.gui_objects.sieveform)
+	      this.enable_command('sievefiltersave', true);
+	  }
+	
         if (this.gui_objects.identitieslist)
           {
           this.identity_list = new rcube_list_widget(this.gui_objects.identitieslist, {multiselect:false, draggable:false, keyboard:false});
@@ -1062,6 +1080,31 @@
         this.delete_folder(props);
         break;
 
+      case 'managesieve':
+        this.goto_url('managesieve', '', true);
+        break;
+
+      case 'sievefiltersave':
+        this.sievefilter_save();
+        break;
+
+      case 'sievefilteradd':
+        this.sievefilter_add();
+        break;
+
+      case 'sievefilterdel':
+          this.sievefilter_del();
+        break;
+
+      case 'sievefilterup':
+        this.sievefilter_up();
+        break;
+
+      case 'sievefilterdown':
+        this.sievefilter_down();
+        break;
+	
+
       }
 
     return obj ? false : true;
@@ -2796,6 +2839,348 @@
 
 
   /*********************************************************/
+  /*********     Managesieve filters methods       *********/
+  /*********************************************************/
+
+  this.sievefilter_add = function()
+    {
+      this.load_sievefilterframe();
+      this.sievefilters_list.clear_selection();
+    };
+
+  this.sievefilter_del = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+
+    if (confirm(this.get_label('filterconfirmdelete')))
+      this.http_request('managesieve',
+	    '_act=delete&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_up = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    this.http_request('managesieve',
+    	    '_act=up&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_down = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    this.http_request('managesieve',
+    	    '_act=down&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_rowid = function(id)
+    {
+    var rows = this.sievefilters_list.rows;
+    
+    for (var i=0; i<rows.length; i++)
+      if (rows[i] != null && rows[i].uid == id)
+	return i;
+    }
+
+  this.sievefilter_updatelist = function(action, name, id)
+    {
+    this.set_busy(true);
+
+    switch (action)
+      {
+      case 'delete':
+        this.sievefilters_list.remove_row(this.sievefilter_rowid(id));
+	this.sievefilters_list.clear_selection();
+	this.enable_command('sievefilterdel', 'sievefilterup', 'sievefilterdown', false);
+	this.show_contentframe(false);
+
+	// re-numbering filters
+        var rows = this.sievefilters_list.rows;
+        for (var i=0; i<rows.length; i++)
+          {
+	  if (rows[i] != null && rows[i].uid > id)
+	    rows[i].uid = rows[i].uid-1;
+	  }
+	break;
+
+      case 'down':
+        var rows = this.sievefilters_list.rows;
+	var from;
+
+	// we need only to replace filter names...
+        for (var i=0; i<rows.length; i++)
+        {
+	  if (rows[i]==null) { // removed row
+	    continue;
+          } else if (rows[i].uid == id) {
+	    from = rows[i].obj.cells[0];
+	  } else if (rows[i].uid == parseInt(id)+1){
+	    name = rows[i].obj.cells[0].innerHTML;
+	    rows[i].obj.cells[0].innerHTML = from.innerHTML;
+	    from.innerHTML = name;
+	    this.sievefilters_list.highlight_row(i);
+	    break;
+	  }
+	}
+	// ... and disable/enable Down button
+	this.sievefilter_listbuttons();
+        break;
+
+      case 'up':
+        var rows = this.sievefilters_list.rows;
+	var from;
+
+	// we need only to replace filter names...
+        for (var i=0; i<rows.length; i++)
+        {
+	  if (rows[i]==null) { // removed row
+	    continue;
+          } else if (rows[i].uid == id-1) {
+	    from = rows[i].obj.cells[0];
+	    this.sievefilters_list.highlight_row(i);
+	  } else if (rows[i].uid == id) {
+	    name = rows[i].obj.cells[0].innerHTML;
+	    rows[i].obj.cells[0].innerHTML = from.innerHTML;
+	    from.innerHTML = name;
+	    break;
+	  }
+	}
+	// ... and disable/enable Up button
+	this.sievefilter_listbuttons();
+        break;
+	
+      case 'update':
+        var rows = parent.rcmail.sievefilters_list.rows;
+        for (var i=0; i<rows.length; i++)
+	  if (rows[i] && rows[i].uid == id)
+	    {
+	    rows[i].obj.cells[0].innerHTML = name;
+	    break;
+	    }
+        break;
+      
+      case 'add':
+        var row, new_row, td;
+	var list = parent.rcmail.sievefilters_list;
+
+	if (!list)
+          break;
+
+	for (var i=0; i<list.rows.length; i++)
+	  if (list.rows[i] != null && String(list.rows[i].obj.id).match(/^rcmrow/))
+	    row = list.rows[i].obj;
+
+        if (row)
+	  {
+	    new_row = parent.document.createElement('TR');
+	    new_row.id = 'rcmrow'+id;
+    	    td = parent.document.createElement('TD');
+    	    new_row.appendChild(td);
+	    list.insert_row(new_row, false);
+
+    	    if (row.cells[0].className)
+    	      td.className = row.cells[0].className;
+        
+    	    td.innerHTML = name;
+	    list.highlight_row(id);
+
+	    parent.rcmail.enable_command('sievefilterdel', 'sievefilterup', true);
+	  }
+        else // refresh whole page
+	  parent.rcmail.goto_url('managesieve');
+	break;
+      }
+
+    this.set_busy(false);
+
+    };
+
+  this.sievefilter_select = function(list)
+    {
+    var id = list.get_single_selection();
+    if (id != null)
+      this.load_sievefilterframe(list.rows[id].uid);
+    };
+
+  this.sievefilter_save = function()
+    {
+      if (parent.rcmail && parent.rcmail.sievefilters_list)
+        {
+        var id = parent.rcmail.sievefilters_list.get_single_selection();
+	if (id != null)
+	  this.gui_objects.sieveform.elements['_fid'].value = parent.rcmail.sievefilters_list.rows[id].uid;
+        }
+      this.gui_objects.sieveform.submit();
+    };
+
+  // load filter frame
+  this.load_sievefilterframe = function(id)
+    {
+    if (typeof(id) != 'undefined' && id != null)
+      {
+      this.enable_command('sievefilterdel', true);
+      this.sievefilter_listbuttons();
+      }
+    else
+      this.enable_command('sievefilterup', 'sievefilterdown', 'sievefilterdel', false);
+
+    if (this.env.contentframe && window.frames && window.frames[this.env.contentframe])
+      {
+      target = window.frames[this.env.contentframe];
+      this.set_busy(true, 'loading');
+      target.location.href = this.env.comm_path+'&_action=managesieve&_framed=1&_fid='+id;
+      }
+    };
+
+  // enable/disable Up/Down buttons
+  this.sievefilter_listbuttons = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    var rows = this.sievefilters_list.rows;
+
+    for (var i=0; i<rows.length; i++)
+      {
+      if (rows[i] == null) { // removed row
+        } else if (i == id) {
+	  this.enable_command('sievefilterup', false);
+	  break;
+        } else {
+	  this.enable_command('sievefilterup', true);
+	  break;
+        }
+      }
+
+    for (var i=rows.length-1; i>0; i--)
+      {
+        if (rows[i] == null) { // removed row
+	} else if (i == id) {
+	  this.enable_command('sievefilterdown', false);
+	  break;
+	} else {
+	  this.enable_command('sievefilterdown', true);
+	  break;
+	}
+      } 
+    };
+
+  // operations on filters form
+  this.sievefilter_ruleadd = function(id)
+    {
+      this.http_post('managesieve', '_act=ruleadd&_rid='+id);
+    };
+
+  this.sievefilter_rulefill = function(content, id, after)
+    {
+      if (content != '')
+        {
+	// create new element
+	var div = document.getElementById('rules');
+	var row = document.createElement('div');
+
+	this.sievefilter_insertrow(div, row, after);
+	// fill row after inserting (for IE)
+	row.setAttribute('id', 'rulerow'+id);
+	row.className = 'rulerow';
+        row.innerHTML = content;
+
+	this.sievefilter_formbuttons(div);
+	}
+    };
+
+  this.sievefilter_ruledel = function(id)
+    {
+      if (confirm(this.get_label('ruledeleteconfirm')))
+	{
+	var row = document.getElementById('rulerow'+id);
+	row.parentNode.removeChild(row);
+	this.sievefilter_formbuttons(document.getElementById('rules'));
+	}
+    };
+
+  this.sievefilter_actionadd = function(id)
+    {
+      this.http_post('managesieve', '_act=actionadd&_aid='+id);
+    };
+
+  this.sievefilter_actionfill = function(content, id, after)
+    {
+      if (content != '')
+        {
+	var div = document.getElementById('actions');
+	var row = document.createElement('div');
+
+	this.sievefilter_insertrow(div, row, after);
+
+	row.setAttribute('id', 'actionrow'+id);
+	row.className = 'actionrow';
+        row.innerHTML = content;
+
+        this.sievefilter_formbuttons(div);
+	}
+    };
+
+  this.sievefilter_actiondel = function(id)
+    {
+      if (confirm(this.get_label('actiondeleteconfirm')))
+	{
+	var row = document.getElementById('actionrow'+id);
+	row.parentNode.removeChild(row);
+	this.sievefilter_formbuttons(document.getElementById('actions'));
+	}
+    };
+
+  // insert rule/action row in specified place on the list
+  this.sievefilter_insertrow = function(div, row, after)
+    {
+      for (var i=0; i<div.childNodes.length; i++)
+	{
+        if (div.childNodes[i].id == ((div.id=='rules' ? 'rulerow' : 'actionrow') + after))
+	  break;
+	}
+
+      if (div.childNodes[i+1])
+        div.insertBefore(row, div.childNodes[i+1]);
+      else
+        div.appendChild(row);
+    }
+
+  // update Delete buttons status
+  this.sievefilter_formbuttons = function(div)
+    {
+      var buttons = new Array();
+      var i;
+
+      // count and get buttons
+      for (i=0; i<div.childNodes.length; i++)
+	{
+	if (div.id == 'rules' && div.childNodes[i].id)
+	  {
+	  if (/rulerow/.test(div.childNodes[i].id))
+	    buttons.push('ruledel' + div.childNodes[i].id.replace(/rulerow/, ''));
+	  }
+	else if (div.childNodes[i].id)
+	  {
+	  if (/actionrow/.test(div.childNodes[i].id))
+	    buttons.push('actiondel' + div.childNodes[i].id.replace(/actionrow/, ''));
+	  }
+        }
+
+      for (i=0; i<buttons.length; i++)
+	{
+	var button = document.getElementById(buttons[i]);
+	if (i>0 || buttons.length>1)
+	  {
+	  this.set_classname(button, 'disabled', false);
+	  button.removeAttribute('disabled');
+	  }
+	else
+	  {
+	  this.set_classname(button, 'disabled', true);
+	  button.setAttribute('disabled', true);
+	  }
+        }
+    }
+    
+    
+  /*********************************************************/
   /*********        user settings methods          *********/
   /*********************************************************/
 
diff -ruNa 0.2-stable.old/program/lib/Net/Sieve.php 0.2-stable/program/lib/Net/Sieve.php
--- 0.2-stable.old/program/lib/Net/Sieve.php	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/program/lib/Net/Sieve.php	2009-01-03 13:51:32.699810412 +0100
@@ -0,0 +1,1149 @@
+<?php
+// +-----------------------------------------------------------------------+
+// | Copyright (c) 2002-2003, Richard Heyes                                |
+// | Copyright (c) 2006, Anish Mistry                                      |
+// | All rights reserved.                                                  |
+// |                                                                       |
+// | Redistribution and use in source and binary forms, with or without    |
+// | modification, are permitted provided that the following conditions    |
+// | are met:                                                              |
+// |                                                                       |
+// | o Redistributions of source code must retain the above copyright      |
+// |   notice, this list of conditions and the following disclaimer.       |
+// | o Redistributions in binary form must reproduce the above copyright   |
+// |   notice, this list of conditions and the following disclaimer in the |
+// |   documentation and/or other materials provided with the distribution.|
+// | o The names of the authors may not be used to endorse or promote      |
+// |   products derived from this software without specific prior written  |
+// |   permission.                                                         |
+// |                                                                       |
+// | THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS   |
+// | "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT     |
+// | LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR |
+// | A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  |
+// | OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, |
+// | SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT      |
+// | LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, |
+// | DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY |
+// | THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT   |
+// | (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE |
+// | OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  |
+// |                                                                       |
+// +-----------------------------------------------------------------------+
+// | Author: Richard Heyes <richard@phpguru.org>                           |
+// | Co-Author: Damian Fernandez Sosa <damlists@cnba.uba.ar>               |
+// | Co-Author: Anish Mistry <amistry@am-productions.biz>                  |
+// +-----------------------------------------------------------------------+
+
+require_once('Net/Socket.php');
+
+/**
+* TODO
+*
+* o supportsAuthMech()
+*/
+
+/**
+* Disconnected state
+* @const NET_SIEVE_STATE_DISCONNECTED
+*/
+define('NET_SIEVE_STATE_DISCONNECTED',  1, true);
+
+/**
+* Authorisation state
+* @const NET_SIEVE_STATE_AUTHORISATION
+*/
+define('NET_SIEVE_STATE_AUTHORISATION', 2, true);
+
+/**
+* Transaction state
+* @const NET_SIEVE_STATE_TRANSACTION
+*/
+define('NET_SIEVE_STATE_TRANSACTION',   3, true);
+
+/**
+* A class for talking to the timsieved server which
+* comes with Cyrus IMAP.
+*
+* SIEVE: RFC3028 http://www.ietf.org/rfc/rfc3028.txt
+* MANAGE-SIEVE: http://www.ietf.org/internet-drafts/draft-martin-managesieve-07.txt
+*
+* @author  Richard Heyes <richard@php.net>
+* @author  Damian Fernandez Sosa <damlists@cnba.uba.ar>
+* @author  Anish Mistry <amistry@am-productions.biz>
+* @access  public
+* @version 1.2.0
+* @package Net_Sieve
+*/
+
+class Net_Sieve
+{
+    /**
+    * The socket object
+    * @var object
+    */
+    var $_sock;
+
+    /**
+    * Info about the connect
+    * @var array
+    */
+    var $_data;
+
+    /**
+    * Current state of the connection
+    * @var integer
+    */
+    var $_state;
+
+    /**
+    * Constructor error is any
+    * @var object
+    */
+    var $_error;
+
+    /**
+    * To allow class debuging
+    * @var boolean
+    */
+    var $_debug = false;
+
+    /**
+    * Allows picking up of an already established connection
+    * @var boolean
+    */
+    var $_bypassAuth = false;
+
+    /**
+    * Whether to use TLS if available
+    * @var boolean
+    */
+    var $_useTLS = true;
+
+    /**
+    * The auth methods this class support
+    * @var array
+    */
+    var $supportedAuthMethods=array('DIGEST-MD5', 'CRAM-MD5', 'PLAIN' , 'LOGIN');
+    //if you have problems using DIGEST-MD5 authentication  please comment the line above and uncomment the following line
+    //var $supportedAuthMethods=array( 'CRAM-MD5', 'PLAIN' , 'LOGIN');
+
+    //var $supportedAuthMethods=array( 'PLAIN' , 'LOGIN');
+
+    /**
+    * The auth methods this class support
+    * @var array
+    */
+    var $supportedSASLAuthMethods=array('DIGEST-MD5', 'CRAM-MD5');
+
+    /**
+    * Handles posible referral loops
+    * @var array
+    */
+    var $_maxReferralCount = 15;
+
+    /**
+    * Constructor
+    * Sets up the object, connects to the server and logs in. stores
+    * any generated error in $this->_error, which can be retrieved
+    * using the getError() method.
+    *
+    * @param  string $user      Login username
+    * @param  string $pass      Login password
+    * @param  string $host      Hostname of server
+    * @param  string $port      Port of server
+    * @param  string $logintype Type of login to perform
+    * @param  string $euser     Effective User (if $user=admin, login as $euser)
+    * @param  string $bypassAuth Skip the authentication phase.  Useful if the socket
+                                  is already open.
+    * @param  boolean $useTLS Use TLS if available
+    */
+    function Net_Sieve($user = null , $pass  = null , $host = 'localhost', $port = 2000, $logintype = '', $euser = '', $debug = false, $bypassAuth = false, $useTLS = true)
+    {
+        $this->_state = NET_SIEVE_STATE_DISCONNECTED;
+        $this->_data['user'] = $user;
+        $this->_data['pass'] = $pass;
+        $this->_data['host'] = $host;
+        $this->_data['port'] = $port;
+        $this->_data['logintype'] = $logintype;
+        $this->_data['euser'] = $euser;
+        $this->_sock = &new Net_Socket();
+        $this->_debug = $debug;
+        $this->_bypassAuth = $bypassAuth;
+        $this->_useTLS = $useTLS;
+        /*
+        * Include the Auth_SASL package.  If the package is not available,
+        * we disable the authentication methods that depend upon it.
+        */
+        if ((@include_once 'Auth/SASL.php') === false) {
+            if($this->_debug){
+                echo "AUTH_SASL NOT PRESENT!\n";
+            }
+            foreach($this->supportedSASLAuthMethods as $SASLMethod){
+                $pos = array_search( $SASLMethod, $this->supportedAuthMethods );
+                if($this->_debug){
+                    echo "DISABLING METHOD $SASLMethod\n";
+                }
+                unset($this->supportedAuthMethods[$pos]);
+            }
+        }
+        if( ($user != null) && ($pass != null) ){
+            $this->_error = $this->_handleConnectAndLogin();
+        }
+    }
+
+    /**
+    * Handles the errors the class can find
+    * on the server
+    *
+    * @access private
+    * @param mixed $msg  Text error message or PEAR error object
+    * @param integer $code  Numeric error code
+    * @return PEAR_Error
+    */
+    function _raiseError($msg, $code)
+    {
+        include_once 'PEAR.php';
+        return PEAR::raiseError($msg, $code);
+    }
+
+    /**
+    * Handles connect and login.
+    * on the server
+    *
+    * @access private
+    * @return mixed Indexed array of scriptnames or PEAR_Error on failure
+    */
+    function _handleConnectAndLogin()
+    {
+        if (PEAR::isError($res = $this->connect($this->_data['host'] , $this->_data['port'], null, $this->_useTLS ))) {
+            return $res;
+        }
+        if($this->_bypassAuth === false) {
+           if (PEAR::isError($res = $this->login($this->_data['user'], $this->_data['pass'], $this->_data['logintype'] , $this->_data['euser'] , $this->_bypassAuth) ) ) {
+                return $res;
+            }
+        }
+        return true;
+    }
+
+    /**
+    * Returns an indexed array of scripts currently
+    * on the server
+    *
+    * @return mixed Indexed array of scriptnames or PEAR_Error on failure
+    */
+    function listScripts()
+    {
+        if (is_array($scripts = $this->_cmdListScripts())) {
+            $this->_active = $scripts[1];
+            return $scripts[0];
+        } else {
+            return $scripts;
+        }
+    }
+
+    /**
+    * Returns the active script
+    *
+    * @return mixed The active scriptname or PEAR_Error on failure
+    */
+    function getActive()
+    {
+        if (!empty($this->_active)) {
+            return $this->_active;
+
+        } elseif (is_array($scripts = $this->_cmdListScripts())) {
+            $this->_active = $scripts[1];
+            return $scripts[1];
+        }
+    }
+
+    /**
+    * Sets the active script
+    *
+    * @param  string $scriptname The name of the script to be set as active
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function setActive($scriptname)
+    {
+        return $this->_cmdSetActive($scriptname);
+    }
+
+    /**
+    * Retrieves a script
+    *
+    * @param  string $scriptname The name of the script to be retrieved
+    * @return mixed              The script on success, PEAR_Error on failure
+    */
+    function getScript($scriptname)
+    {
+        return $this->_cmdGetScript($scriptname);
+    }
+
+    /**
+    * Adds a script to the server
+    *
+    * @param  string $scriptname Name of the script
+    * @param  string $script     The script
+    * @param  boolean $makeactive Whether to make this the active script
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function installScript($scriptname, $script, $makeactive = false)
+    {
+        if (PEAR::isError($res = $this->_cmdPutScript($scriptname, $script))) {
+            return $res;
+
+        } elseif ($makeactive) {
+            return $this->_cmdSetActive($scriptname);
+
+        } else {
+            return true;
+        }
+    }
+
+    /**
+    * Removes a script from the server
+    *
+    * @param  string $scriptname Name of the script
+    * @return mixed              True on success, PEAR_Error on failure
+    */
+    function removeScript($scriptname)
+    {
+        return $this->_cmdDeleteScript($scriptname);
+    }
+
+    /**
+    * Returns any error that may have been generated in the
+    * constructor
+    *
+    * @return mixed False if no error, PEAR_Error otherwise
+    */
+    function getError()
+    {
+        return PEAR::isError($this->_error) ? $this->_error : false;
+    }
+
+    /**
+    * Handles connecting to the server and checking the
+    * response is valid.
+    *
+    * @access private
+    * @param  string $host Hostname of server
+    * @param  string $port Port of server
+    * @param  array  $options List of options to pass to connect
+    * @param  boolean $useTLS Use TLS if available
+    * @return mixed        True on success, PEAR_Error otherwise
+    */
+    function connect($host, $port, $options = null, $useTLS = true)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED != $this->_state) {
+            $msg='Not currently in DISCONNECTED state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_sock->connect($host, $port, false, 5, $options))) {
+            return $res;
+        }
+
+        if($this->_bypassAuth === false) {
+            $this->_state = NET_SIEVE_STATE_AUTHORISATION;
+            if (PEAR::isError($res = $this->_doCmd())) {
+                return $res;
+            }
+        } else {
+            $this->_state = NET_SIEVE_STATE_TRANSACTION;
+        }
+
+        // Explicitly ask for the capabilities in case the connection
+        // is picked up from an existing connection.
+        if(PEAR::isError($res = $this->_cmdCapability() )) {
+            $msg='Failed to connect, server said: ' . $res->getMessage();
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+
+        // Get logon greeting/capability and parse
+        $this->_parseCapability($res);
+
+        if($useTLS === true) {
+            // check if we can enable TLS via STARTTLS
+            if(isset($this->_capability['starttls']) && function_exists('stream_socket_enable_crypto') === true) {
+                if (PEAR::isError($res = $this->_startTLS())) {
+                    return $res;
+                }
+            }
+        }
+
+        return true;
+    }
+
+    /**
+    * Logs into server.
+    *
+    * @param  string  $user          Login username
+    * @param  string  $pass          Login password
+    * @param  string  $logintype     Type of login method to use
+    * @param  string  $euser         Effective UID (perform on behalf of $euser)
+    * @param  boolean $bypassAuth    Do not perform authentication
+    * @return mixed                  True on success, PEAR_Error otherwise
+    */
+    function login($user, $pass, $logintype = null , $euser = '', $bypassAuth = false)
+    {
+        if (NET_SIEVE_STATE_AUTHORISATION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if( $bypassAuth === false ){
+            if(PEAR::isError($res=$this->_cmdAuthenticate($user , $pass , $logintype, $euser ) ) ){
+                return $res;
+            }
+        }
+        $this->_state = NET_SIEVE_STATE_TRANSACTION;
+        return true;
+    }
+
+    /**
+     * Handles the authentication using any known method
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $userMethod The method to use ( if $userMethod == '' then the class chooses the best method (the stronger is the best ) )
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return mixed  string or PEAR_Error
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _cmdAuthenticate($uid , $pwd , $userMethod = null , $euser = '' )
+    {
+        if ( PEAR::isError( $method = $this->_getBestAuthMethod($userMethod) ) ) {
+            return $method;
+        }
+        switch ($method) {
+            case 'DIGEST-MD5':
+                $result = $this->_authDigest_MD5( $uid , $pwd , $euser );
+                return $result;
+                break;
+            case 'CRAM-MD5':
+                $result = $this->_authCRAM_MD5( $uid , $pwd, $euser);
+                break;
+            case 'LOGIN':
+                $result = $this->_authLOGIN( $uid , $pwd , $euser );
+                break;
+            case 'PLAIN':
+                $result = $this->_authPLAIN( $uid , $pwd , $euser );
+                break;
+            default :
+                $result = new PEAR_Error( "$method is not a supported authentication method" );
+                break;
+        }
+
+        if (PEAR::isError($res = $this->_doCmd() )) {
+            return $res;
+        }
+        return $result;
+    }
+
+    /**
+     * Authenticates the user using the PLAIN method.
+     *
+     * @param string $user The userid to authenticate as.
+     * @param string $pass The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authPLAIN($user, $pass , $euser )
+    {
+        if ($euser != '') {
+            $cmd=sprintf('AUTHENTICATE "PLAIN" "%s"', base64_encode($euser . chr(0) . $user . chr(0) . $pass ) ) ;
+        } else {
+            $cmd=sprintf('AUTHENTICATE "PLAIN" "%s"', base64_encode( chr(0) . $user . chr(0) . $pass ) );
+        }
+        return  $this->_sendCmd( $cmd ) ;
+    }
+
+    /**
+     * Authenticates the user using the PLAIN method.
+     *
+     * @param string $user The userid to authenticate as.
+     * @param string $pass The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authLOGIN($user, $pass , $euser )
+    {
+        $this->_sendCmd('AUTHENTICATE "LOGIN"');
+        $this->_doCmd(sprintf('"%s"', base64_encode($user)));
+        $this->_doCmd(sprintf('"%s"', base64_encode($pass)));
+    }
+
+    /**
+     * Authenticates the user using the CRAM-MD5 method.
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authCRAM_MD5($uid, $pwd, $euser)
+    {
+        if ( PEAR::isError( $challenge = $this->_doCmd( 'AUTHENTICATE "CRAM-MD5"' ) ) ) {
+            $this->_error=$challenge;
+            return $challenge;
+        }
+        $challenge=trim($challenge);
+        $challenge = base64_decode( trim($challenge) );
+        $cram = &Auth_SASL::factory('crammd5');
+        if ( PEAR::isError($resp=$cram->getResponse( $uid , $pwd , $challenge ) ) ) {
+            $this->_error=$resp;
+            return $resp;
+        }
+        $auth_str = base64_encode( $resp );
+        if ( PEAR::isError($error = $this->_sendStringResponse( $auth_str  ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+    }
+
+    /**
+     * Authenticates the user using the DIGEST-MD5 method.
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authDigest_MD5($uid, $pwd, $euser)
+    {
+        if ( PEAR::isError( $challenge = $this->_doCmd('AUTHENTICATE "DIGEST-MD5"') ) ) {
+            $this->_error= $challenge;
+            return $challenge;
+        }
+        $challenge = base64_decode( $challenge );
+        $digest = &Auth_SASL::factory('digestmd5');
+
+        if(PEAR::isError($param=$digest->getResponse($uid, $pwd, $challenge, "localhost", "sieve" , $euser) )) {
+            return $param;
+        }
+        $auth_str = base64_encode($param);
+
+        if ( PEAR::isError($error = $this->_sendStringResponse( $auth_str  ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+        if ( PEAR::isError( $challenge = $this->_doCmd() ) ) {
+            $this->_error=$challenge ;
+            return $challenge ;
+        }
+
+        if( strtoupper(substr($challenge,0,2))== 'OK' ){
+                return true;
+        }
+
+        /**
+        * We don't use the protocol's third step because SIEVE doesn't allow
+        * subsequent authentication, so we just silently ignore it.
+        */
+        if ( PEAR::isError($error = $this->_sendStringResponse( '' ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+        if (PEAR::isError($res = $this->_doCmd() )) {
+            return $res;
+        }
+    }
+
+    /**
+    * Removes a script from the server
+    *
+    * @access private
+    * @param  string $scriptname Name of the script to delete
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdDeleteScript($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+        if (PEAR::isError($res = $this->_doCmd(sprintf('DELETESCRIPT "%s"', $scriptname) ) )) {
+            return $res;
+        }
+        return true;
+    }
+
+    /**
+    * Retrieves the contents of the named script
+    *
+    * @access private
+    * @param  string $scriptname Name of the script to retrieve
+    * @return mixed              The script if successful, PEAR_Error otherwise
+    */
+    function _cmdGetScript($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('GETSCRIPT "%s"', $scriptname) ) ) ) {
+            return $res;
+        }
+
+        return preg_replace('/{[0-9]+}\r\n/', '', $res);
+    }
+
+    /**
+    * Sets the ACTIVE script, ie the one that gets run on new mail
+    * by the server
+    *
+    * @access private
+    * @param  string $scriptname The name of the script to mark as active
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdSetActive($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('SETACTIVE "%s"', $scriptname) ) ) ) {
+            return $res;
+        }
+
+        $this->_activeScript = $scriptname;
+        return true;
+    }
+
+    /**
+    * Sends the LISTSCRIPTS command
+    *
+    * @access private
+    * @return mixed Two item array of scripts, and active script on success,
+    *               PEAR_Error otherwise.
+    */
+    function _cmdListScripts()
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        $scripts = array();
+        $activescript = null;
+
+        if (PEAR::isError($res = $this->_doCmd('LISTSCRIPTS'))) {
+            return $res;
+        }
+
+        $res = explode("\r\n", $res);
+
+        foreach ($res as $value) {
+            if (preg_match('/^"(.*)"( ACTIVE)?$/i', $value, $matches)) {
+                $scripts[] = $matches[1];
+                if (!empty($matches[2])) {
+                    $activescript = $matches[1];
+                }
+            }
+        }
+
+        return array($scripts, $activescript);
+    }
+
+    /**
+    * Sends the PUTSCRIPT command to add a script to
+    * the server.
+    *
+    * @access private
+    * @param  string $scriptname Name of the new script
+    * @param  string $scriptdata The new script
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdPutScript($scriptname, $scriptdata)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in TRANSACTION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        $stringLength = $this->_getLineLength($scriptdata);
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf("PUTSCRIPT \"%s\" {%d+}\r\n%s", $scriptname, $stringLength, $scriptdata) ))) {
+            return $res;
+        }
+
+        return true;
+    }
+
+    /**
+    * Sends the LOGOUT command and terminates the connection
+    *
+    * @access private
+    * @param boolean $sendLogoutCMD True to send LOGOUT command before disconnecting
+    * @return mixed True on success, PEAR_Error otherwise
+    */
+    function _cmdLogout($sendLogoutCMD=true)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+            //return PEAR::raiseError('Not currently connected');
+        }
+
+        if($sendLogoutCMD){
+            if (PEAR::isError($res = $this->_doCmd('LOGOUT'))) {
+                return $res;
+            }
+        }
+
+        $this->_sock->disconnect();
+        $this->_state = NET_SIEVE_STATE_DISCONNECTED;
+        return true;
+    }
+
+    /**
+    * Sends the CAPABILITY command
+    *
+    * @access private
+    * @return mixed True on success, PEAR_Error otherwise
+    */
+    function _cmdCapability()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd('CAPABILITY'))) {
+            return $res;
+        }
+        $this->_parseCapability($res);
+        return true;
+    }
+
+    /**
+    * Checks if the server has space to store the script
+    * by the server
+    *
+    * @param  string $scriptname The name of the script to mark as active
+    * @param integer $size The size of the script
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function haveSpace($scriptname,$size)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in TRANSACTION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('HAVESPACE "%s" %d', $scriptname, $size) ) ) ) {
+            return $res;
+        }
+
+        return true;
+    }
+
+    /**
+    * Parses the response from the capability command. Stores
+    * the result in $this->_capability
+    *
+    * @access private
+    * @param string $data The response from the capability command
+    */
+    function _parseCapability($data)
+    {
+        $data = preg_split('/\r?\n/', $data, -1, PREG_SPLIT_NO_EMPTY);
+
+        for ($i = 0; $i < count($data); $i++) {
+            if (preg_match('/^"([a-z]+)"( "(.*)")?$/i', $data[$i], $matches)) {
+                switch (strtolower($matches[1])) {
+                    case 'implementation':
+                        $this->_capability['implementation'] = $matches[3];
+                        break;
+
+                    case 'sasl':
+                        $this->_capability['sasl'] = preg_split('/\s+/', $matches[3]);
+                        break;
+
+                    case 'sieve':
+                        $this->_capability['extensions'] = preg_split('/\s+/', $matches[3]);
+                        break;
+
+                    case 'starttls':
+                        $this->_capability['starttls'] = true;
+                        break;
+                }
+            }
+        }
+    }
+
+    /**
+    * Sends a command to the server
+    *
+    * @access private
+    * @param string $cmd The command to send
+    */
+    function _sendCmd($cmd)
+    {
+        $status = $this->_sock->getStatus();
+        if (PEAR::isError($status) || $status['eof']) {
+            return new PEAR_Error( 'Failed to write to socket: (connection lost!) ' );
+        }
+        if ( PEAR::isError( $error = $this->_sock->write( $cmd . "\r\n" ) ) ) {
+            return new PEAR_Error( 'Failed to write to socket: ' . $error->getMessage() );
+        }
+
+        if( $this->_debug ){
+            // C: means this data was sent by  the client (this class)
+            echo "C:$cmd\n";
+        }
+        return true;
+    }
+
+    /**
+    * Sends a string response to the server
+    *
+    * @access private
+    * @param string $cmd The command to send
+    */
+    function _sendStringResponse($str)
+    {
+        $response='{' .  $this->_getLineLength($str) . "+}\r\n" . $str  ;
+        return $this->_sendCmd($response);
+    }
+
+    function _recvLn()
+    {
+        $lastline='';
+        if (PEAR::isError( $lastline = $this->_sock->gets( 8192 ) ) ) {
+            return new PEAR_Error( 'Failed to write to socket: ' . $lastline->getMessage() );
+        }
+        $lastline=rtrim($lastline);
+        if($this->_debug){
+            // S: means this data was sent by  the IMAP Server
+            echo "S:$lastline\n" ;
+        }
+
+        if( $lastline === '' ) {
+            return new PEAR_Error( 'Failed to receive from the socket' );
+        }
+
+        return $lastline;
+    }
+
+    /**
+    * Send a command and retrieves a response from the server.
+    *
+    *
+    * @access private
+    * @param string $cmd The command to send
+    * @return mixed Reponse string if an OK response, PEAR_Error if a NO response
+    */
+    function _doCmd($cmd = '' )
+    {
+        $referralCount=0;
+        while($referralCount < $this->_maxReferralCount ){
+
+            if($cmd != '' ){
+                if(PEAR::isError($error = $this->_sendCmd($cmd) )) {
+                    return $error;
+                }
+            }
+            $response = '';
+
+            while (true) {
+                    if(PEAR::isError( $line=$this->_recvLn() )){
+                        return $line;
+                    }
+                    if ('ok' === strtolower(substr($line, 0, 2))) {
+                        $response .= $line;
+                        return rtrim($response);
+
+                    } elseif ('no' === strtolower(substr($line, 0, 2))) {
+                        // Check for string literal error message
+                        if (preg_match('/^no {([0-9]+)\+?}/i', $line, $matches)) {
+                            $line .= str_replace("\r\n", ' ', $this->_sock->read($matches[1] + 2 ));
+                            if($this->_debug){
+                                echo "S:$line\n";
+                            }
+                        }
+                        $msg=trim($response . substr($line, 2));
+                        $code=3;
+                        return $this->_raiseError($msg,$code);
+                    } elseif ('bye' === strtolower(substr($line, 0, 3))) {
+
+                        if(PEAR::isError($error = $this->disconnect(false) ) ){
+                            $msg="Can't handle bye, The error was= " . $error->getMessage() ;
+                            $code=4;
+                            return $this->_raiseError($msg,$code);
+                        }
+                        //if (preg_match('/^bye \(referral "([^"]+)/i', $line, $matches)) {
+                        if (preg_match('/^bye \(referral "(sieve:\/\/)?([^"]+)/i', $line, $matches)) {
+                            // Check for referral, then follow it.  Otherwise, carp an error.
+                            // Replace the old host with the referral host preserving any protocol prefix
+                            $this->_data['host'] = preg_replace('/\w+(?!(\w|\:\/\/)).*/',$matches[2],$this->_data['host']);
+                           if (PEAR::isError($error = $this->_handleConnectAndLogin() ) ){
+                                $msg="Can't follow referral to " . $this->_data['host'] . ", The error was= " . $error->getMessage() ;
+                                $code=5;
+                                return $this->_raiseError($msg,$code);
+                            }
+                            break;
+                            // Retry the command
+                            if(PEAR::isError($error = $this->_sendCmd($cmd) )) {
+                                return $error;
+                            }
+                            continue;
+                        }
+                        $msg=trim($response . $line);
+                        $code=6;
+                        return $this->_raiseError($msg,$code);
+                    } elseif (preg_match('/^{([0-9]+)\+?}/i', $line, $matches)) {
+                        // Matches String Responses.
+                        //$line = str_replace("\r\n", ' ', $this->_sock->read($matches[1] + 2 ));
+                        $str_size = $matches[1] + 2;
+                        $line = '';
+                        $line_length = 0;
+                        while ($line_length < $str_size) {
+                            $line .= $this->_sock->read($str_size - $line_length);
+                            $line_length = $this->_getLineLength($line);
+                        }
+                        if($this->_debug){
+                            echo "S:$line\n";
+                        }
+                        if($this->_state != NET_SIEVE_STATE_AUTHORISATION) {
+                            // receive the pending OK only if we aren't authenticating
+                            // since string responses during authentication don't need an
+                            // OK.
+                            $this->_recvLn();
+                        }
+                        return $line;
+                    }
+                    $response .= $line . "\r\n";
+                    $referralCount++;
+                }
+        }
+        $msg="Max referral count reached ($referralCount times) Cyrus murder loop error?";
+        $code=7;
+        return $this->_raiseError($msg,$code);
+    }
+
+    /**
+    * Sets the debug state
+    *
+    * @param boolean $debug
+    * @return void
+    */
+    function setDebug($debug = true)
+    {
+        $this->_debug = $debug;
+    }
+
+    /**
+    * Disconnect from the Sieve server
+    *
+    * @param  string $scriptname The name of the script to be set as active
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function disconnect($sendLogoutCMD=true)
+    {
+        return $this->_cmdLogout($sendLogoutCMD);
+    }
+
+    /**
+     * Returns the name of the best authentication method that the server
+     * has advertised.
+     *
+     * @param string if !=null,authenticate with this method ($userMethod).
+     *
+     * @return mixed    Returns a string containing the name of the best
+     *                  supported authentication method or a PEAR_Error object
+     *                  if a failure condition is encountered.
+     * @access private
+     * @since  1.0
+     */
+    function _getBestAuthMethod($userMethod = null)
+    {
+       if( isset($this->_capability['sasl']) ){
+           $serverMethods=$this->_capability['sasl'];
+       }else{
+           // if the server don't send an sasl capability fallback to login auth
+           //return 'LOGIN';
+           return new PEAR_Error("This server don't support any Auth methods SASL problem?");
+       }
+
+        if($userMethod != null ){
+            $methods = array();
+            $methods[] = $userMethod;
+        }else{
+
+            $methods = $this->supportedAuthMethods;
+        }
+        if( ($methods != null) && ($serverMethods != null)){
+            foreach ( $methods as $method ) {
+                if ( in_array( $method , $serverMethods ) ) {
+                    return $method;
+                }
+            }
+            $serverMethods=implode(',' , $serverMethods );
+            $myMethods=implode(',' ,$this->supportedAuthMethods);
+            return new PEAR_Error("$method NOT supported authentication method!. This server " .
+                "supports these methods= $serverMethods, but I support $myMethods");
+        }else{
+            return new PEAR_Error("This server don't support any Auth methods");
+        }
+    }
+
+    /**
+    * Return the list of extensions the server supports
+    *
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function getExtensions()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+
+        return $this->_capability['extensions'];
+    }
+
+    /**
+    * Return true if tyhe server has that extension
+    *
+    * @param string  the extension to compare
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function hasExtension($extension)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if(is_array($this->_capability['extensions'] ) ){
+            foreach( $this->_capability['extensions'] as $ext){
+                if( trim( strtolower( $ext ) ) === trim( strtolower( $extension ) ) )
+                    return true;
+            }
+        }
+        return false;
+    }
+
+    /**
+    * Return the list of auth methods the server supports
+    *
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function getAuthMechs()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+        if(!isset($this->_capability['sasl']) ){
+            $this->_capability['sasl']=array();
+        }
+        return $this->_capability['sasl'];
+    }
+
+    /**
+    * Return true if the server has that extension
+    *
+    * @param string  the extension to compare
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function hasAuthMech($method)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+            //return PEAR::raiseError('Not currently connected');
+        }
+
+        if(is_array($this->_capability['sasl'] ) ){
+            foreach( $this->_capability['sasl'] as $ext){
+                if( trim( strtolower( $ext ) ) === trim( strtolower( $method ) ) )
+                    return true;
+            }
+        }
+        return false;
+    }
+
+    /**
+    * Return true if the TLS negotiation was successful
+    *
+    * @access private
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function _startTLS()
+    {
+        if (PEAR::isError($res = $this->_doCmd("STARTTLS"))) {
+            return $res;
+        }
+	
+        if(stream_socket_enable_crypto($this->_sock->fp, true, STREAM_CRYPTO_METHOD_TLS_CLIENT) == false) {
+            $msg='Failed to establish TLS connection';
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if($this->_debug === true) {
+            echo "STARTTLS Negotiation Successful\n";
+        }
+
+        // RFC says we need to query the server capabilities again
+        if(PEAR::isError($res = $this->_cmdCapability() )) {
+            $msg='Failed to connect, server said: ' . $res->getMessage();
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+        return true;
+    }
+
+    function _getLineLength($string) {
+        if (extension_loaded('mbstring') || @dl(PHP_SHLIB_PREFIX.'mbstring.'.PHP_SHLIB_SUFFIX)) {
+          return mb_strlen($string,'latin1');
+        } else {
+          return strlen($string);
+        }
+    }
+}
+?>
diff -ruNa 0.2-stable.old/program/localization/de_DE/labels.inc 0.2-stable/program/localization/de_DE/labels.inc
--- 0.2-stable.old/program/localization/de_DE/labels.inc	2008-12-06 18:59:26.000000000 +0100
+++ 0.2-stable/program/localization/de_DE/labels.inc	2009-01-03 13:51:32.735810078 +0100
@@ -264,4 +264,36 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = 'Filter';
+$labels['managefilters'] = 'Verwalte eingehende Nachrichtenfilter';
+$labels['filtername'] = 'Filtername';
+$labels['newfilter'] = 'Neuer Filter';
+$labels['filteradd'] = 'Filter hinzufgen';
+$labels['filterdel'] = 'Filter lschen';
+$labels['moveup'] = 'Nach oben';
+$labels['movedown'] = 'Nach unten';
+$labels['filterallof'] = 'trifft auf alle folgenden Regeln zu';
+$labels['filteranyof'] = 'trifft auf eine der folgenden Regeln zu';
+$labels['filterany'] = 'alle Nachrichten';
+$labels['filtercontains'] = 'enthlt';
+$labels['filternotcontains'] = 'enthlt nicht';
+$labels['filteris'] = 'ist gleich';
+$labels['filterisnot'] = 'ist ungleich';
+$labels['filterexists'] = 'vorhanden';
+$labels['filternotexists'] = 'nicht vorhanden';
+$labels['filterunder'] = 'unter';
+$labels['filterover'] = 'ber';
+$labels['addrule'] = 'Regel hinzufgen';
+$labels['delrule'] = 'Regel lschen';
+$labels['messagemoveto'] = 'Verschiebe Nachricht nach';
+$labels['messageredirect'] = 'Leite Nachricht um nach';
+$labels['messagereply'] = 'Antworte mit Nachricht';
+$labels['messagedelete'] = 'Nachricht lschen';
+$labels['messagediscard'] = 'Discard with message';
+$labels['messagesrules'] = 'Fr eingehende Nachrichten:';
+$labels['messagesactions'] = '...fhre folgende Aktionen aus:';
+$labels['add'] = 'Hinzufgen';
+$labels['del'] = 'Lschen';
+$labels['sender'] = 'Absender';
+$labels['recipient'] = 'Empfnger';
 ?>
diff -ruNa 0.2-stable.old/program/localization/de_DE/messages.inc 0.2-stable/program/localization/de_DE/messages.inc
--- 0.2-stable.old/program/localization/de_DE/messages.inc	2008-11-17 19:52:43.000000000 +0100
+++ 0.2-stable/program/localization/de_DE/messages.inc	2009-01-03 13:51:32.775811228 +0100
@@ -95,4 +95,16 @@
 $messages['nofromaddress'] = 'Fehlende E-Mail-Adresse in ausgewhlter Identitt';
 $messages['editorwarning'] = 'Beim Wechseln in den Texteditor gehen alle Textformatierungen verloren. Mchten Sie fortfahren?';
 
+$messages['filterunknownerror'] = 'Unbekannter Serverfehler';
+$messages['filterconnerror'] = 'Kann nicht zum Sieve-Server verbinden';
+$messages['filterdeleteerror'] = 'Fehler beim des lschen  Filters. Serverfehler';
+$messages['filterdeleted'] = 'Filter erfolgreich gelscht';
+$messages['filterconfirmdelete'] = 'Mchten Sie den Filter lschen ?';
+$messages['filtersaved'] = 'Filter gespeichert';
+$messages['filtersaveerror'] = 'Serverfehler, konnte den Filter nicht speichern.';
+$messages['ruledeleteconfirm'] = 'Sicher, dass Sie die Regel lschen wollen?';
+$messages['actiondeleteconfirm'] = 'Sicher, dass Sie die ausgewaehlte Aktion lschen wollen?';
+$messages['forbiddenchars'] = 'Unerlaubte Zeichen im Feld';
+$messages['cannotbeempty'] = 'Feld darf nicht leer sein';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/en_US/labels.inc 0.2-stable/program/localization/en_US/labels.inc
--- 0.2-stable.old/program/localization/en_US/labels.inc	2008-12-06 18:59:26.000000000 +0100
+++ 0.2-stable/program/localization/en_US/labels.inc	2009-01-03 13:51:32.815812938 +0100
@@ -323,4 +323,37 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = 'Filters';
+$labels['managefilters'] = 'Manage incoming mail filters';
+$labels['filtername'] = 'Filter name';
+$labels['newfilter'] = 'New filter';
+$labels['filteradd'] = 'Add filter';
+$labels['filterdel'] = 'Delete filter';
+$labels['moveup'] = 'Move up';
+$labels['movedown'] = 'Move down';
+$labels['filterallof'] = 'matching all of the following rules';
+$labels['filteranyof'] = 'matching any of the following rules';
+$labels['filterany'] = 'all messages';
+$labels['filtercontains'] = 'contains';
+$labels['filternotcontains'] = 'not contains';
+$labels['filteris'] = 'is equal to';
+$labels['filterisnot'] = 'is not equal to';
+$labels['filterexists'] = 'exists';
+$labels['filternotexists'] = 'not exists';
+$labels['filterunder'] = 'under';
+$labels['filterover'] = 'over';
+$labels['addrule'] = 'Add rule';
+$labels['delrule'] = 'Delete rule';
+$labels['messagemoveto'] = 'Move message to';
+$labels['messageredirect'] = 'Redirect message to';
+$labels['messagereply'] = 'Reply with message';
+$labels['messagedelete'] = 'Delete message';
+$labels['messagediscard'] = 'Discard with message';
+$labels['messagesrules'] = 'For incoming mail:';
+$labels['messagesactions'] = '...execute the following actions:';
+$labels['add'] = 'Add';
+$labels['del'] = 'Delete';
+$labels['sender'] = 'Sender';
+$labels['recipient'] = 'Recipient';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/en_US/messages.inc 0.2-stable/program/localization/en_US/messages.inc
--- 0.2-stable.old/program/localization/en_US/messages.inc	2008-11-03 19:09:35.000000000 +0100
+++ 0.2-stable/program/localization/en_US/messages.inc	2009-01-03 13:51:32.859813058 +0100
@@ -95,4 +95,16 @@
 $messages['nofromaddress'] = 'Missing e-mail address in selected identity';
 $messages['editorwarning'] = 'Switching to the plain text editor will cause all text formatting to be lost. Do you wish to continue?';
 
+$messages['filterunknownerror'] = 'Unknown server error';
+$messages['filterconnerror'] = 'Unable to connect to managesieve server';
+$messages['filterdeleteerror'] = 'Unable to delete filter. Server error occured';
+$messages['filterdeleted'] = 'Filter deleted successfully';
+$messages['filterconfirmdelete'] = 'Do you really want to delete selected filter?';
+$messages['filtersaved'] = 'Filter saved successfully';
+$messages['filtersaveerror'] = 'Unable to save filter. Server error occured.';
+$messages['ruledeleteconfirm'] = 'Are you sure, you want to delete selected rule?';
+$messages['actiondeleteconfirm'] = 'Are you sure, you want to delete selected action?';
+$messages['forbiddenchars'] = 'Forbidden characters in field';
+$messages['cannotbeempty'] = 'Field cannot be empty';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/fr_FR/labels.inc 0.2-stable/program/localization/fr_FR/labels.inc
--- 0.2-stable.old/program/localization/fr_FR/labels.inc	2008-12-10 20:22:22.000000000 +0100
+++ 0.2-stable/program/localization/fr_FR/labels.inc	2009-01-03 13:51:32.907813265 +0100
@@ -266,4 +266,37 @@
 $labels['MB'] = 'Mo';
 $labels['GB'] = 'Go';
 
+$labels['filters'] = 'Filtres';
+$labels['managefilters'] = 'Gestion des filtres sur les mails entrants';
+$labels['filtername'] = 'Nom du filtre';
+$labels['newfilter'] = 'Nouveau filtre';
+$labels['filteradd'] = 'Ajouter un filtre';
+$labels['filterdel'] = 'Supprimer un filtre';
+$labels['moveup'] = 'Monter';
+$labels['movedown'] = 'Descendre';
+$labels['filterallof'] = 'valident toutes les conditions suivantes';
+$labels['filteranyof'] = 'valident au moins une des conditions suivantes';
+$labels['filterany'] = 'tous les messages';
+$labels['filtercontains'] = 'contient';
+$labels['filternotcontains'] = 'ne contient pas';
+$labels['filteris'] = 'est ';
+$labels['filterisnot'] = 'n\'est pas';
+$labels['filterexists'] = 'existe';
+$labels['filternotexists'] = 'n\'existe pas';
+$labels['filterunder'] = 'est plus petit que';
+$labels['filterover'] = 'est plus grand que';
+$labels['addrule'] = 'Ajouter une rgle';
+$labels['delrule'] = 'Supprimer une rgle';
+$labels['messagemoveto'] = 'Dplacer le message vers';
+$labels['messageredirect'] = 'Transfrer le message ';
+$labels['messagereply'] = 'Rpondre avec le message';
+$labels['messagedelete'] = 'Supprimer le message';
+$labels['messagediscard'] = 'Rejeter avec le message';
+$labels['messagesrules'] = 'Pour les mails entrants:';
+$labels['messagesactions'] = '...excuter les actions suivantes:';
+$labels['add'] = 'Ajouter';
+$labels['del'] = 'Supprimer';
+$labels['sender'] = 'Expditeur';
+$labels['recipient'] = 'Destinataire';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/fr_FR/messages.inc 0.2-stable/program/localization/fr_FR/messages.inc
--- 0.2-stable.old/program/localization/fr_FR/messages.inc	2008-12-01 11:46:11.000000000 +0100
+++ 0.2-stable/program/localization/fr_FR/messages.inc	2009-01-03 13:51:32.951813944 +0100
@@ -97,4 +97,16 @@
 $messages['nofromaddress'] = 'Il manque une adresse e-mail dans l\'identite slectionne';
 $messages['editorwarning'] = 'Passer  l\'diteur texte seul causera la perte du formatage du texte. Voulez-vous continuer ?';
 
+$messages['filterunknownerror'] = 'Erreur du serveur inconnue';
+$messages['filterconnerror'] = 'Connexion au serveur Managesieve impossible';
+$messages['filterdeleteerror'] = 'Suppression du filtre impossible. Le serveur  produit une erreur';
+$messages['filterdeleted'] = 'Le filtre a bien t supprim';
+$messages['filterconfirmdelete'] = 'Voulez-vous vraiment supprimer le filtre slectionn ?';
+$messages['filtersaved'] = 'Le filtre a bien t enregistr';
+$messages['filtersaveerror'] = 'Enregistrement du filtre impossibe. Le serveur  produit une erreur';
+$messages['ruledeleteconfirm'] = 'Voulez-vous vraiment supprimer la rgle slectionne ?';
+$messages['actiondeleteconfirm'] = 'Voulez-vous vraiment supprimer l\'action slectionne ?';
+$messages['forbiddenchars'] = 'Caractres interdits dans le champ';
+$messages['cannotbeempty'] = 'Le champ ne peut pas tre vide';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/pl_PL/labels.inc 0.2-stable/program/localization/pl_PL/labels.inc
--- 0.2-stable.old/program/localization/pl_PL/labels.inc	2008-12-06 20:31:06.000000000 +0100
+++ 0.2-stable/program/localization/pl_PL/labels.inc	2009-01-03 13:51:32.991816491 +0100
@@ -269,4 +269,37 @@
 $labels['GB'] = 'GB';
 $labels['checkallfolders'] = 'Sprawdzaj czy nadeszy nowe wiadomoci we wszystkich folderach';
 
+$labels['filters'] = 'Filtry';
+$labels['managefilters'] = 'Zarzdzaj filtrami wiadomoci przychodzcych';
+$labels['filtername'] = 'Nazwa filtru';
+$labels['newfilter'] = 'Nowy filtr';
+$labels['filteradd'] = 'Dodaj filtr';
+$labels['filterdel'] = 'Usu filtr';
+$labels['moveup'] = 'Przenie wyej';
+$labels['movedown'] = 'Przenie niej';
+$labels['filterallof'] = 'speniajce wszystkie ponisze kryteria';
+$labels['filteranyof'] = 'speniajce dowolne z poniszych kryteriw';
+$labels['filterany'] = 'wszystkich';
+$labels['filtercontains'] = 'zawiera';
+$labels['filternotcontains'] = 'nie zawiera';
+$labels['filteris'] = 'jest rwne';
+$labels['filterisnot'] = 'nie jest rwne';
+$labels['filterexists'] = 'istnieje';
+$labels['filternotexists'] = 'nie istnieje';
+$labels['filterunder'] = 'poniej';
+$labels['filterover'] = 'ponad';
+$labels['addrule'] = 'Dodaj regu';
+$labels['delrule'] = 'Usu regu';
+$labels['messagemoveto'] = 'Przenie wiadomo do';
+$labels['messageredirect'] = 'Przeka wiadomo na konto';
+$labels['messagereply'] = 'Odpowiedz wiadomoci o treci';
+$labels['messagedelete'] = 'Usu wiadomo';
+$labels['messagediscard'] = 'Odrzu z komunikatem';
+$labels['messagesrules'] = 'W stosunku do przychodzcych wiadomoci:';
+$labels['messagesactions'] = '...wykonaj nastpujce czynnoci:';
+$labels['add'] = 'Dodaj';
+$labels['del'] = 'Usu';
+$labels['sender'] = 'Nadawca';
+$labels['recipient'] = 'Odbiorca';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/pl_PL/messages.inc 0.2-stable/program/localization/pl_PL/messages.inc
--- 0.2-stable.old/program/localization/pl_PL/messages.inc	2008-11-03 15:26:23.000000000 +0100
+++ 0.2-stable/program/localization/pl_PL/messages.inc	2009-01-03 13:51:33.035817170 +0100
@@ -100,4 +100,16 @@
 $messages['nofromaddress'] = 'Brak adresu e-mail w wybranej tosamoci';
 $messages['editorwarning'] = 'Zmiana edytora spowoduje utrat formatowania tekstu. Czy jeste pewien, e chcesz to zrobi?';
 
+$messages['filterunknownerror'] = 'Nieznany bd serwera';
+$messages['filterconnerror'] = 'Nie mona nawiza poczenia z serwerem managesieve';
+$messages['filterdeleteerror'] = 'Nie mona usun filtra. Wystpi bd serwera';
+$messages['filterdeleted'] = 'Filtr zosta usunity pomylnie';
+$messages['filterconfirmdelete'] = 'Czy na pewno chcesz usun wybrany filtr?';
+$messages['filtersaved'] = 'Filtr zosta zapisany pomylnie';
+$messages['filtersaveerror'] = 'Nie mona zapisa filtra. Wystpi bd serwera.';
+$messages['ruledeleteconfirm'] = 'Czy na pewno chcesz usun wybran regu?';
+$messages['actiondeleteconfirm'] = 'Czy na pewno usun wybran akcj?';
+$messages['forbiddenchars'] = 'Pole zawiera niedozwolone znaki';
+$messages['cannotbeempty'] = 'Pole nie moe by puste';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/ru_RU/labels.inc 0.2-stable/program/localization/ru_RU/labels.inc
--- 0.2-stable.old/program/localization/ru_RU/labels.inc	2008-12-04 11:21:34.000000000 +0100
+++ 0.2-stable/program/localization/ru_RU/labels.inc	2009-01-03 13:51:33.075804421 +0100
@@ -262,4 +262,37 @@
 $labels['MB'] = '';
 $labels['GB'] = '';
 
+$labels['filters'] = '';
+$labels['managefilters'] = '    ';
+$labels['filtername'] = ' ';
+$labels['newfilter'] = ' ';
+$labels['filteradd'] = ' ';
+$labels['filterdel'] = ' ';
+$labels['moveup'] = ' ';
+$labels['movedown'] = ' ';
+$labels['filterallof'] = '   ';
+$labels['filteranyof'] = '    ';
+$labels['filterany'] = ' ';
+$labels['filtercontains'] = '';
+$labels['filternotcontains'] = ' ';
+$labels['filteris'] = '';
+$labels['filterisnot'] = ' ';
+$labels['filterexists'] = '';
+$labels['filternotexists'] = ' ';
+$labels['filterunder'] = '';
+$labels['filterover'] = '';
+$labels['addrule'] = ' ';
+$labels['delrule'] = ' ';
+$labels['messagemoveto'] = '  ';
+$labels['messageredirect'] = '   ';
+$labels['messagereply'] = '  ';
+$labels['messagedelete'] = ' ';
+$labels['messagediscard'] = '  ';
+$labels['messagesrules'] = '  :';
+$labels['messagesactions'] = '...  :';
+$labels['add'] = '';
+$labels['del'] = '';
+$labels['sender'] = '';
+$labels['recipient'] = '';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/ru_RU/messages.inc 0.2-stable/program/localization/ru_RU/messages.inc
--- 0.2-stable.old/program/localization/ru_RU/messages.inc	2008-12-01 18:50:13.000000000 +0100
+++ 0.2-stable/program/localization/ru_RU/messages.inc	2009-01-03 13:51:33.119804891 +0100
@@ -97,4 +97,16 @@
 $messages['nofromaddress'] = '       ';
 $messages['editorwarning'] = '         . ?';
 
+$messages['filterunknownerror'] = '  ';
+$messages['filterconnerror'] = '    ';
+$messages['filterdeleteerror'] = '  .  ';
+$messages['filterdeleted'] = '  ';
+$messages['filterconfirmdelete'] = '    ?';
+$messages['filtersaved'] = '  ';
+$messages['filtersaveerror'] = '  .  ';
+$messages['ruledeleteconfirm'] = ' ,     ?';
+$messages['actiondeleteconfirm'] = ' ,     ?';
+$messages['forbiddenchars'] = '   ';
+$messages['cannotbeempty'] = '    ';
+
 ?>
diff -ruNa 0.2-stable.old/program/localization/zh_CN/labels.inc 0.2-stable/program/localization/zh_CN/labels.inc
--- 0.2-stable.old/program/localization/zh_CN/labels.inc	2008-12-14 22:37:19.000000000 +0100
+++ 0.2-stable/program/localization/zh_CN/labels.inc	2009-01-03 13:51:33.159819590 +0100
@@ -265,4 +265,36 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = '';
+$labels['managefilters'] = '';
+$labels['filtername'] = '';
+$labels['newfilter'] = '';
+$labels['filteradd'] = '';
+$labels['filterdel'] = '';
+$labels['moveup'] = '';
+$labels['movedown'] = '';
+$labels['filterallof'] = '';
+$labels['filteranyof'] = '';
+$labels['filterany'] = '';
+$labels['filtercontains'] = '';
+$labels['filternotcontains'] = '';
+$labels['filteris'] = '';
+$labels['filterisnot'] = '';
+$labels['filterexists'] = '';
+$labels['filternotexists'] = '';
+$labels['filterunder'] = '';
+$labels['filterover'] = '';
+$labels['addrule'] = '';
+$labels['delrule'] = '';
+$labels['messagemoveto'] = '';
+$labels['messageredirect'] = '';
+$labels['messagereply'] = '';
+$labels['messagedelete'] = '';
+$labels['messagediscard'] = '';
+$labels['messagesrules'] = '';
+$labels['messagesactions'] = '...';
+$labels['add'] = '';
+$labels['del'] = '';
+$labels['sender'] = '';
+$labels['recipient'] = '';
 ?>
diff -ruNa 0.2-stable.old/program/localization/zh_CN/messages.inc 0.2-stable/program/localization/zh_CN/messages.inc
--- 0.2-stable.old/program/localization/zh_CN/messages.inc	2008-12-08 21:44:46.000000000 +0100
+++ 0.2-stable/program/localization/zh_CN/messages.inc	2009-01-03 13:51:33.199822697 +0100
@@ -96,4 +96,16 @@
 $messages['nofromaddress'] = '';
 $messages['editorwarning'] = '';
 
+$messages['filterunknownerror'] = '';
+$messages['filterconnerror'] = ' managesieve ';
+$messages['filterdeleteerror'] = '';
+$messages['filterdeleted'] = '';
+$messages['filterconfirmdelete'] = '';
+$messages['filtersaved'] = '';
+$messages['filtersaveerror'] = '';
+$messages['ruledeleteconfirm'] = '';
+$messages['actiondeleteconfirm'] = '';
+$messages['forbiddenchars'] = '';
+$messages['cannotbeempty'] = '';
+
 ?>
diff -ruNa 0.2-stable.old/program/steps/settings/managesieve.inc 0.2-stable/program/steps/settings/managesieve.inc
--- 0.2-stable.old/program/steps/settings/managesieve.inc	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/program/steps/settings/managesieve.inc	2009-01-03 13:51:33.223807086 +0100
@@ -0,0 +1,756 @@
+<?php
+
+/*
+ +-----------------------------------------------------------------------+
+ | program/steps/settings/managesieve.inc                                |
+ |                                                                       |
+ | This file is part of the RoundCube Webmail client                     |
+ | Copyright (C) 2007, RoundCube Dev. - Switzerland                      |
+ | Licensed under the GNU GPL                                            |
+ |                                                                       |
+ | PURPOSE:                                                              |
+ |   Sieve scripts management                                            |
+ |                                                                       |
+ +-----------------------------------------------------------------------+
+ | Author: Aleksander Machniak <alec@alec.pl>                            |
+ +-----------------------------------------------------------------------+
+ $Id$
+*/
+
+// try to connect to managesieve server and to fetch the script
+$SIEVE = new rcube_sieve($_SESSION['username'], 
+		$RCMAIL->decrypt_passwd($_SESSION['password']), 
+		($CONFIG['managesieve_host'] ? $CONFIG['managesieve_host'] : 'localhost'),
+		($CONFIG['managesieve_port'] ? $CONFIG['managesieve_port'] : 2000),
+		(bool) $CONFIG['managesieve_usetls']);
+
+$error = $SIEVE->error();
+
+if ($error == SIEVE_ERROR_NOT_EXISTS)
+{
+  // if script not exists build default script contents
+  if (!empty($CONFIG['managesieve_default']) && is_readable($CONFIG['managesieve_default']))
+    $SIEVE->script->add_text(file_get_contents($CONFIG['managesieve_default'])); 
+  // that's not exactly an error
+  $error = false;
+}
+elseif ($error)
+{
+  switch ($error)
+  {
+    case SIEVE_ERROR_CONNECTION:
+    case SIEVE_ERROR_LOGIN:
+      $OUTPUT->show_message('filterconnerror', 'error');  
+    break;
+    default:
+      $OUTPUT->show_message('filterunknownerror', 'error');
+    break;
+  }
+
+  // to disable 'Add filter' button set env variable
+  $OUTPUT->set_env('filterconnerror', true);
+}
+
+// finally set script objects
+if ($error)
+{
+  $SCRIPT = array();
+}
+else
+{
+  $SCRIPT = $SIEVE->script->as_array();
+  $EXT = $SIEVE->get_extensions();
+}
+
+
+// Some helper data and functions
+$HEADERS = array(
+  'subject' => 'Subject',
+  'sender' => 'From',
+  'recipient' => 'To',
+);
+
+
+function strip_val($str)
+{
+  return trim(strip_tags($str));
+}
+
+function error_class($id, $type, $target, $name_only=false)
+{
+  global $FORM_ERR;
+
+  // TODO: tooltips
+  if ($type == 'test' && isset($FORM_ERR['tests'][$id][$target]))
+    return ($name_only ? 'error' : ' class="error"');
+  elseif ($type == 'action' && isset($FORM_ERR['actions'][$id][$target]))
+    return ($name_only ? 'error' : ' class="error"');
+
+  return '';
+}
+
+function check_email($email)
+{
+  // Check for invalid characters
+  if (preg_match('/[\x00-\x1F\x7F-\xFF]/', $email))
+    return false;
+
+  // Check that there's one @ symbol, and that the lengths are right
+  if (!preg_match('/^[^@]{1,64}@[^@]{1,255}$/', $email))
+    return false;
+
+  // Split it into sections to make life easier
+  $email_array = explode('@', $email);
+
+  // Check local part
+  $local_array = explode('.', $email_array[0]);
+  foreach ($local_array as $local_part)
+    if (!preg_match('/^(([A-Za-z0-9!#$%&\'*+\/=?^_`{|}~-]+)|("[^"]+"))$/', $local_part))
+      return false;
+
+  // Check domain part
+  if (preg_match('/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}$/', $email_array[1]) 
+    || preg_match('/^\[(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}\]$/', $email_array[1]))
+    return true; // If an IP address
+  else
+  { // If not an IP address
+    $domain_array = explode('.', $email_array[1]);
+    if (sizeof($domain_array) < 2)
+      return false; // Not enough parts to be a valid domain
+
+    foreach ($domain_array as $domain_part)
+      if (!preg_match('/^(([A-Za-z0-9][A-Za-z0-9-]{0,61}[A-Za-z0-9])|([A-Za-z0-9]))$/', $domain_part))
+	return false;
+
+    return true;
+  }
+  
+  return false;
+} 
+
+// add/edit action
+if (isset($_POST['_name']))
+{
+  $name = trim(get_input_value('_name', RCUBE_INPUT_POST));
+  $fid = trim(get_input_value('_fid', RCUBE_INPUT_POST));
+  $join = trim(get_input_value('_join', RCUBE_INPUT_POST));
+  
+  // and arrays
+  $headers = $_POST['_header'];
+  $cust_headers = $_POST['_custom_header'];
+  $ops = $_POST['_rule_op'];
+  $sizeops = $_POST['_rule_size_op'];
+  $sizeitems = $_POST['_rule_size_item'];
+  $sizetargets = $_POST['_rule_size_target'];
+  $targets = $_POST['_rule_target'];
+  $act_types = $_POST['_action_type'];
+  $mailboxes = $_POST['_action_mailbox'];
+  $act_targets = $_POST['_action_target'];
+  $area_targets = $_POST['_action_target_area'];
+
+  // we need a "hack" for radiobuttons
+  foreach ($sizeitems as $item)
+    $items[] = $item;
+
+  $S['join'] = $join=='allof' ? true : false;
+  $S['name'] = $name;
+  $S['tests'] = array();
+  $S['actions'] = array();
+
+  if ($name == '')
+    $FORM_ERR['name'] = rcube_label('cannotbeempty');
+  else
+    foreach($SCRIPT as $idx => $rule)
+      if($rule['name'] == $name && $idx != $fid)
+      {
+	$FORM_ERR['name'] = rcube_label('ruleexist');
+        break;
+      }
+      
+  $i = 0;
+  // rules
+  if ($join == 'any')
+  {
+    $S['tests'][0]['test'] = 'true';
+  }
+  else foreach($headers as $idx => $header)
+  {
+    $header = strip_val($header);
+    $target = strip_val($targets[$idx]);
+    $op = strip_val($ops[$idx]);
+
+    // normal header
+    if (in_array($header, $HEADERS))
+    {
+      if(preg_match('/^not/', $op))
+        $S['tests'][$i]['not'] = true;
+      $type = preg_replace('/^not/', '', $op);
+
+      if ($type == 'exists')
+        {
+	$S['tests'][$i]['test'] = 'exists';
+        $S['tests'][$i]['arg'] = $header;
+	}
+      else
+        {	
+	$S['tests'][$i]['type'] = $type;
+        $S['tests'][$i]['test'] = 'header';
+        $S['tests'][$i]['arg1'] = $header;
+        $S['tests'][$i]['arg2'] = $target;
+	
+        if ($target == '')
+          $FORM_ERR['tests'][$i]['target'] = rcube_label('cannotbeempty');
+	}
+    }
+    else
+      switch ($header)
+      {
+        case 'size':
+	  $sizeop = strip_val($sizeops[$idx]);
+	  $sizeitem = strip_val($items[$idx]);
+	  $sizetarget = strip_val($sizetargets[$idx]);
+
+          $S['tests'][$i]['test'] = 'size';
+          $S['tests'][$i]['type'] = $sizeop;
+          $S['tests'][$i]['arg'] = $sizetarget.$sizeitem;
+
+	  if (!preg_match('/^[0-9]+(K|M|G)*$/i', $sizetarget))
+	    $FORM_ERR['tests'][$i]['sizetarget'] = rcube_label('wrongformat');
+	break;
+	case '...':
+          $cust_header = strip_val($cust_headers[$idx]);
+
+          if(preg_match('/^not/', $op))
+	    $S['tests'][$i]['not'] = true;
+    	  $type = preg_replace('/^not/', '', $op);
+
+          if ($cust_header == '')
+    	    $FORM_ERR['tests'][$i]['header'] = rcube_label('cannotbeempty');
+          elseif (!preg_match('/^[a-z0-9-]+$/i', $cust_header))
+    	    $FORM_ERR['tests'][$i]['header'] = rcube_label('forbiddenchars');
+
+          if ($type == 'exists')
+    	    {
+	    $S['tests'][$i]['test'] = 'exists';
+    	    $S['tests'][$i]['arg'] = $cust_header;
+	    }
+          else
+    	    {	
+    	    $S['tests'][$i]['test'] = 'header';
+	    $S['tests'][$i]['type'] = $type;
+            $S['tests'][$i]['arg1'] = $cust_header;
+    	    $S['tests'][$i]['arg2'] = $target;
+
+            if ($target == '')
+    	      $FORM_ERR['tests'][$i]['target'] = rcube_label('cannotbeempty');
+	    }
+	break;
+      }
+    $i++;
+  }
+  
+  $i = 0;
+  // actions
+  foreach($act_types as $idx => $type)
+  {
+    $type = strip_val($type);
+    $target = strip_val($act_targets[$idx]);
+  
+    $S['actions'][$i]['type'] = $type;
+    
+    switch ($type)
+    {
+      case 'fileinto':
+	$mailbox = strip_val($mailboxes[$idx]);
+	$S['actions'][$i]['target'] = $mailbox;
+      break;
+      case 'reject':
+      case 'ereject':
+	$target = strip_val($area_targets[$idx]);
+	$S['actions'][$i]['target'] = str_replace("\r\n", "\n", $target);
+
+ //       if ($target == '')
+//    	  $FORM_ERR['actions'][$i]['targetarea'] = rcube_label('cannotbeempty');
+      break;
+      case 'redirect':
+	$S['actions'][$i]['target'] = $target;
+
+        if ($S['actions'][$i]['target'] == '')
+    	  $FORM_ERR['actions'][$i]['target'] = rcube_label('cannotbeempty');
+        else if (!check_email($S['actions'][$i]['target']))
+    	  $FORM_ERR['actions'][$i]['target'] = rcube_label('noemailwarning');
+      break;
+    }
+  
+    $i++;
+  }
+
+  if (!$FORM_ERR)
+  {
+    // zapis skryptu
+    if (!isset($SCRIPT[$fid]))
+    {
+      $fid = $SIEVE->script->add_rule($S);
+      $new = true;
+    }
+    else
+      $fid = $SIEVE->script->update_rule($fid, $S);
+
+    if ($fid !== false)
+      $save = $SIEVE->save();
+
+    if ($save && $fid !== false)
+    {
+	    $OUTPUT->show_message('filtersaved', 'confirmation');
+	    $OUTPUT->command('sievefilter_updatelist', isset($new) ? 'add' : 'update', $S['name'], $fid);
+//	    $OUTPUT->send();
+    }
+    else
+    {
+	    $OUTPUT->show_message('filtersaveerror', 'error');
+//	    $OUTPUT->send();
+    }
+  }
+}
+
+// return the filters list as HTML table
+function rcmail_filters_list($attrib)
+{
+  global $SCRIPT, $OUTPUT;
+
+  // add id to message list table if not specified
+  if (!strlen($attrib['id']))
+    $attrib['id'] = 'rcmfilterslist';
+  
+  // define list of cols to be displayed
+  $a_show_cols = array('filtername');
+
+  foreach($SCRIPT as $idx => $filter)
+    $result[] = array('filtername' => $filter['name'], 'id' => $idx);
+    
+  // create XHTML table
+  $out = rcube_table_output($attrib, $result, $a_show_cols, 'id');
+  
+  // set client env
+  $OUTPUT->add_gui_object('filterslist', $attrib['id']);
+  $OUTPUT->include_script('list.js');
+  
+  // add some labels to client
+  $OUTPUT->add_label('filterconfirmdelete');
+  
+  return $out;
+}
+
+
+function rcmail_filter_frame($attrib)
+{
+  global $OUTPUT;
+
+  if (!$attrib['id'])
+    $attrib['id'] = 'rcmfilterframe';
+    
+  $attrib['name'] = $attrib['id'];
+
+  $OUTPUT->set_env('contentframe', $attrib['name']);
+  $OUTPUT->set_env('blankpage', $attrib['src'] ? $OUTPUT->abs_url($attrib['src']) : 'program/blank.gif');
+
+  return html::tag('iframe', $attrib);
+}
+
+
+function rcmail_filter_form($attrib)
+{
+  global $RCMAIL, $OUTPUT, $SCRIPT, $S, $FORM_ERR, $SIEVE;
+
+  if (!$attrib['id'])
+    $attrib['id'] = 'rcmfilterform';
+
+  $fid = get_input_value('_fid', RCUBE_INPUT_GPC);
+  $scr = isset($S) ? $S : $SCRIPT[$fid];
+
+  $hiddenfields = new html_hiddenfield(array('name' => '_task', 'value' => $RCMAIL->task));
+  $hiddenfields->add(array('name' => '_action', 'value' => 'managesieve'));
+  $hiddenfields->add(array('name' => '_framed', 'value' => ($_POST['_framed'] || $_GET['_framed'] ? 1 : 0)));
+  $hiddenfields->add(array('name' => '_fid', 'value' => $fid));
+
+  $out = '<form name="filterform" action="./" method="post">'."\n";
+  $out .= $hiddenfields->show();
+//  $out .= $SESS_HIDDEN_FIELD;
+
+  // 'any' flag 
+  if (sizeof($scr['tests']) == 1 && $scr['tests'][0]['test'] == 'true' && !$scr['tests'][0]['not'])
+    $any = true; 
+
+  // filter name input
+  $field_id = '_name';
+  $input_name = new html_inputfield(array('name' => '_name', 'id' => $field_id, 'size' => 30,
+	'class' => ($FORM_ERR['name'] ? 'error' : '')));
+
+  if (isset($scr))
+    $input_name = $input_name->show($scr['name']);
+  else
+    $input_name = $input_name->show();
+
+  $out .= sprintf("\n<label for=\"%s\"><b>%s:</b></label> %s<br /><br />\n",
+        	$field_id, Q(rcube_label('filtername')), $input_name);
+
+  $out .= '<fieldset><legend>' . Q(rcube_label('messagesrules')) . "</legend>\n";
+
+  // any, allof, anyof radio buttons
+  $field_id = '_allof';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'allof',
+	'onclick' => 'rule_join_radio(\'allof\')', 'class' => 'radio'));
+
+  if (isset($scr) && !$any)
+    $input_join = $input_join->show($scr['join'] ? 'allof' : '');
+  else
+    $input_join = $input_join->show();
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>&nbsp;\n",
+        	$input_join, $field_id, Q(rcube_label('filterallof')));
+
+  $field_id = '_anyof';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'anyof',
+	'onclick' => 'rule_join_radio(\'anyof\')', 'class' => 'radio'));
+
+  if (isset($scr) && !$any)
+    $input_join = $input_join->show($scr['join'] ? '' : 'anyof');
+  else
+    $input_join = $input_join->show('anyof'); // default
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>\n",
+        	$input_join, $field_id, Q(rcube_label('filteranyof')));
+
+  $field_id = '_any';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'any',
+  	'onclick' => 'rule_join_radio(\'any\')', 'class' => 'radio'));
+
+  $input_join = $input_join->show($any ? 'any' : '');
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>\n",
+        	$input_join, $field_id, Q(rcube_label('filterany')));
+
+  $rows_num = isset($scr) ? sizeof($scr['tests']) : 1;
+
+  $out .= '<div id="rules"'.($any ? ' style="display: none"' : '').'>';
+  for ($x=0; $x<$rows_num; $x++)
+    $out .= rcmail_rule_div($fid, $x);
+  $out .= "</div>\n";
+
+  $out .= "</fieldset>\n";
+
+  // actions
+  $out .= '<fieldset><legend>' . Q(rcube_label('messagesactions')) . "</legend>\n";
+
+  $rows_num = isset($scr) ? sizeof($scr['actions']) : 1;
+
+  $out .= '<div id="actions">';
+  for ($x=0; $x<$rows_num; $x++)
+    $out .= rcmail_action_div($fid, $x);
+  $out .= "</div>\n";
+
+  $out .= "</fieldset>\n";
+
+  $OUTPUT->add_label('ruledeleteconfirm');
+  $OUTPUT->add_label('actiondeleteconfirm');
+  $OUTPUT->add_gui_object('sieveform', 'filterform');
+
+  return $out;
+}
+
+
+function rcmail_rule_div($fid, $id, $div=true)
+{
+  global $SCRIPT, $S, $OUTPUT, $HEADERS;
+  
+  $rule = isset($S) ? $S['tests'][$id] : $SCRIPT[$fid]['tests'][$id];
+  $rows_num = isset($S) ? sizeof($S['tests']) : sizeof($SCRIPT[$fid]['tests']);
+  
+  $out = $div ? '<div class="rulerow" id="rulerow' .$id .'">'."\n" : '';
+  $out .= '<div class="rowactions">';
+
+  // headers select
+  $select_header = new html_select(array('name' => "_header[]", 'id' => 'header'.$id,
+    'onchange' => 'header_select(' .$id .')'));
+  foreach($HEADERS as $name => $val)
+    $select_header->add(Q(rcube_label($name)), Q($val));
+  $select_header->add(Q(rcube_label('size')), 'size');
+  $select_header->add(Q(rcube_label('...')), '...');
+
+  // TODO: list arguments
+
+  if ((isset($rule['test']) && $rule['test'] == 'header') && in_array($rule['arg1'], $HEADERS))
+    $out .= $select_header->show($rule['arg1']);
+  elseif ((isset($rule['test']) && $rule['test'] == 'exists') && in_array($rule['arg'], $HEADERS))
+    $out .= $select_header->show($rule['arg']);
+  elseif (isset($rule['test']) && $rule['test'] == 'size')
+    $out .= $select_header->show('size');
+  elseif (isset($rule['test']) && $rule['test'] != 'true')
+    $out .= $select_header->show('...');
+  else
+    $out .= $select_header->show();
+
+  if ((isset($rule['test']) && $rule['test'] == 'header') && !in_array($rule['arg1'], $HEADERS))
+    $custom = $rule['arg1'];
+  elseif ((isset($rule['test']) && $rule['test'] == 'exists') && !in_array($rule['arg'], $HEADERS))
+    $custom = $rule['arg'];
+    
+  $out .= '<div id="custom_header' .$id. '" style="display:' .(isset($custom) ? 'inline' : 'none'). '">
+    <input type="text" name="_custom_header[]" '. error_class($id, 'test', 'header') .'
+    value="' .Q($custom). '" size="20" />&nbsp;</div>' . "\n";
+  
+  // matching type select (operator)
+  $select_op = new html_select(array('name' => "_rule_op[]", 'id' => 'rule_op'.$id, 
+    'style' => 'display:' .($rule['test']!='size' ? 'inline' : 'none'), 'onchange' => 'rule_op_select('.$id.')'));
+  $select_op->add(Q(rcube_label('filtercontains')), 'contains');
+  $select_op->add(Q(rcube_label('filternotcontains')), 'notcontains');
+  $select_op->add(Q(rcube_label('filteris')), 'is');
+  $select_op->add(Q(rcube_label('filterisnot')), 'notis');
+  $select_op->add(Q(rcube_label('filterexists')), 'exists');
+  $select_op->add(Q(rcube_label('filternotexists')), 'notexists');
+//    $select_op->add(Q(rcube_label('filtermatches')), 'matches');
+//    $select_op->add(Q(rcube_label('filternotmatches')), 'notmatches');
+
+  // target input (TODO: lists)
+
+  if ($rule['test'] == 'header')
+    {
+    $out .= $select_op->show(($rule['not'] ? 'not' : '').$rule['type']);
+    $target = $rule['arg2'];
+    }
+  elseif ($rule['test'] == 'size')
+    {
+    $out .= $select_op->show();
+    if(preg_match('/^([0-9]+)(K|M|G)*$/', $rule['arg'], $matches))
+      {
+	$sizetarget = $matches[1];
+	$sizeitem = $matches[2];
+      }
+    }
+  else
+    {
+    $out .= $select_op->show(($rule['not'] ? 'not' : '').$rule['test']);
+    $target = '';
+    }
+
+  $out .= '<input type="text" name="_rule_target[]" id="rule_target' .$id. '" 
+	value="' .Q($target). '" size="20" ' . error_class($id, 'test', 'target') 
+	. ' style="display:' . ($rule['test']!='size' && $rule['test'] != 'exists' ? 'inline' : 'none') . '" />'."\n";
+
+  $select_size_op = new html_select(array('name' => "_rule_size_op[]", 'id' => 'rule_size_op'.$id));
+  $select_size_op->add(Q(rcube_label('filterunder')), 'under');
+  $select_size_op->add(Q(rcube_label('filterover')), 'over');
+
+  $out .= '<div id="rule_size' .$id. '" style="display:' . ($rule['test']=='size' ? 'inline' : 'none') .'">';
+  $out .= $select_size_op->show($rule['test']=='size' ? $rule['type'] : '');
+  $out .= '<input type="text" name="_rule_size_target[]" value="'.$sizetarget.'" size="10" ' . error_class($id, 'test', 'sizetarget') .' />
+	<input type="radio" name="_rule_size_item['.$id.']" value=""'. (!$sizeitem ? ' checked="checked"' : '') .' class="radio" />B
+	<input type="radio" name="_rule_size_item['.$id.']" value="K"'. ($sizeitem=='K' ? ' checked="checked"' : '') .' class="radio" />kB
+	<input type="radio" name="_rule_size_item['.$id.']" value="M"'. ($sizeitem=='M' ? ' checked="checked"' : '') .' class="radio" />MB
+	<input type="radio" name="_rule_size_item['.$id.']" value="G"'. ($sizeitem=='G' ? ' checked="checked"' : '') .' class="radio" />GB';
+  $out .= '</div>';
+
+  $out .= "</div>\n";
+  
+  // add/del buttons
+  $out .= '<div class="rowbuttons">';
+  $out .= '<input type="button" id="ruleadd' . $id .'" value="'. Q(rcube_label('add')). '" 
+    onclick="rcmail.sievefilter_ruleadd(' . $id .')" class="button" /> ';
+  $out .= '<input type="button" id="ruledel' . $id .'" value="'. Q(rcube_label('del')). '"
+    onclick="rcmail.sievefilter_ruledel(' . $id .')" class="button' . ($rows_num<2 ? ' disabled' : '') .'"'
+    . ($rows_num<2 ? ' disabled="disabled"' : '') .' />';
+  $out .= '</div>';
+
+  $out .= $div ? "</div>\n" : '';
+        
+  return $out;
+}
+
+function rcmail_action_div($fid, $id, $div=true)
+{
+  global $RCMAIL, $CONFIG, $SCRIPT, $S, $EXT, $IMAP;
+
+  $action = isset($S) ? $S['actions'][$id] : $SCRIPT[$fid]['actions'][$id];
+  $rows_num = isset($S) ? sizeof($S['actions']) : sizeof($SCRIPT[$fid]['actions']);
+
+  $out = $div ? '<div class="actionrow" id="actionrow' .$id .'">'."\n" : '';
+  $out .= '<div class="rowactions">';
+  
+  // action select
+  $select_action = new html_select(array('name' => "_action_type[]", 'id' => 'action_type'.$id,
+    'onchange' => 'action_type_select(' .$id .')'));
+  if (in_array('fileinto', $EXT))
+    $select_action->add(Q(rcube_label('messagemoveto')), 'fileinto');
+  $select_action->add(Q(rcube_label('messageredirect')), 'redirect');
+  if (in_array('reject', $EXT))
+    $select_action->add(Q(rcube_label('messagediscard')), 'reject');
+  elseif (in_array('ereject', $EXT))
+    $select_action->add(Q(rcube_label('messagediscard')), 'ereject');
+//  if (in_array('vacation', $EXT))
+//	$select_action->add(Q(rcube_label('messagereply')), 'vacation');
+  $select_action->add(Q(rcube_label('messagedelete')), 'discard');
+
+  $out .= $select_action->show($action['type']);
+
+  // actions target inputs
+  $out .= '<input type="text" name="_action_target[]" id="action_target' .$id. '" '
+	.'value="' .($action['type']=='redirect' ? Q($action['target'], 'strict', false) : ''). '" size="40" '
+	.'style="display:' .($action['type']=='redirect' ? 'inline' : 'none') .'" '
+	. error_class($id, 'action', 'target') .' />';
+
+  $out .= '<textarea name="_action_target_area[]" id="action_target_area' .$id. '" '
+	.'rows="3" cols="40" '. error_class($id, 'action', 'targetarea')
+	.'style="display:' .($action['type']=='reject' || $action['type']=='ereject' ? 'inline' : 'none') .'">'
+	. ($action['type']=='reject' || $action['type']=='ereject' ? Q($action['target'], 'strict', false) : '')
+	. "</textarea>\n";
+  
+  // mailbox select
+  $out .= '<select id="action_mailbox' .$id. '" name="_action_mailbox[]" style="display:' 
+    .(!isset($action) || $action['type']=='fileinto' ? 'inline' : 'none'). '">';
+
+  $RCMAIL->imap_init(true);
+
+  $a_folders = $IMAP->list_mailboxes();
+  $delimiter = $IMAP->get_hierarchy_delimiter();
+
+  if ($action['type'] == 'fileinto')
+    $mailbox = $action['target'];
+  else
+    $mailbox = '';
+
+  foreach ($a_folders as $folder)
+  {
+    $utf7folder = $folder;
+    $names = explode($delimiter, rcube_charset_convert($folder, 'UTF-7'));
+    $name = $names[sizeof($names)-1];
+    
+    if (!empty($CONFIG['managesieve_replace_delimiter']))
+      $utf7folder = str_replace($delimiter, $CONFIG['managesieve_replace_delimiter'], $utf7folder);
+    
+    if ($folder_class = rcmail_folder_classname($name))
+      $foldername = rcube_label($folder_class);
+    else
+      $foldername = $name;
+
+    $out .= sprintf('<option value="%s"%s>%s%s</option>'."\n",
+                    htmlspecialchars($utf7folder),
+		    ($mailbox == $utf7folder ? ' selected="selected"' : ''),
+		    str_repeat('&nbsp;', 4 * (sizeof($names)-1)),
+		    Q(abbreviate_string($foldername, 40 - (2 * sizeof($names)-1))));
+  }
+  $out .= '</select>';
+
+  $out .= "</div>\n";
+
+  // add/del buttons
+  $out .= '<div class="rowbuttons">';
+  $out .= '<input type="button" id="actionadd' . $id .'" value="'. Q(rcube_label('add')). '" 
+    onclick="rcmail.sievefilter_actionadd(' . $id .')" class="button" /> ';
+  $out .= '<input type="button" id="actiondel' . $id .'" value="'. Q(rcube_label('del')). '"
+    onclick="rcmail.sievefilter_actiondel(' . $id .')" class="button' . ($rows_num<2 ? ' disabled' : '') .'"'
+    . ($rows_num<2 ? ' disabled="disabled"' : '') .' />';
+  $out .= '</div>';
+
+  $out .= $div ? "</div>\n" : '';
+
+  return $out;
+}
+
+function genid()
+{
+	$result = intval(rcube_timer());
+	return $result;
+}
+
+
+// Handle user requests
+if ($action = get_input_value('_act', RCUBE_INPUT_GPC))
+{
+  $fid = get_input_value('_fid', RCUBE_INPUT_GET);
+
+  if ($action=='up' && !$error)
+  {
+    if ($fid && isset($SCRIPT[$fid]) && isset($SCRIPT[$fid-1]))
+    {
+      if ($SIEVE->script->update_rule($fid, $SCRIPT[$fid-1]) !== false
+        && $SIEVE->script->update_rule($fid-1, $SCRIPT[$fid]) !== false)
+	$result = $SIEVE->save();
+      
+      if ($result)
+      {
+//        $OUTPUT->show_message('filtersaved', 'confirmation');
+	$OUTPUT->command('sievefilter_updatelist', 'up', '', $fid);
+      }
+      else
+        $OUTPUT->show_message('filtersaveerror', 'error');
+    }
+  }
+  elseif ($action=='down' && !$error)
+  {
+    if (isset($SCRIPT[$fid]) && isset($SCRIPT[$fid+1]))
+    {
+      if ($SIEVE->script->update_rule($fid, $SCRIPT[$fid+1]) !== false
+        && $SIEVE->script->update_rule($fid+1, $SCRIPT[$fid]) !== false)
+	$result = $SIEVE->save();
+      
+      if ($result)
+      {
+//        $OUTPUT->show_message('filtersaved', 'confirmation');
+	$OUTPUT->command('sievefilter_updatelist', 'down', '', $fid);
+      }
+      else
+        $OUTPUT->show_message('filtersaveerror', 'error');
+    }
+  }
+  elseif ($action=='delete' && !$error)
+  {
+    if (isset($SCRIPT[$fid]))
+    {
+      if ($SIEVE->script->delete_rule($fid))
+        $result = $SIEVE->save();
+
+      if (!$result)
+        $OUTPUT->show_message('filterdeleteerror', 'error');
+      else
+      {
+	$OUTPUT->show_message('filterdeleted', 'confirmation');
+	$OUTPUT->command('sievefilter_updatelist', 'delete', '', $fid);
+      }
+    }
+  }
+  elseif ($action=='ruleadd')
+  {
+    $rid = get_input_value('_rid', RCUBE_INPUT_GPC);
+    $id = genid();
+    $content = rcmail_rule_div($fid, $id, false);
+
+    $OUTPUT->command('sievefilter_rulefill', $content, $id, $rid);
+  }
+  elseif ($action=='actionadd')
+  {
+    $aid = get_input_value('_aid', RCUBE_INPUT_GPC);
+    $id = genid();
+    $content = rcmail_action_div($fid, $id, false);
+    
+    $OUTPUT->command('sievefilter_actionfill', $content, $id, $aid);
+  }
+
+  $OUTPUT->send();
+}
+
+$OUTPUT->set_pagetitle(rcube_label('filters'));
+  
+// register UI objects
+$OUTPUT->add_handlers(array(
+  'filterslist' => 'rcmail_filters_list',
+  'filterframe' => 'rcmail_filter_frame',
+  'filterform' => 'rcmail_filter_form',
+));
+
+// Handle form action 
+if (isset($_GET['_framed']) || isset($_POST['_framed']))
+  $OUTPUT->send('managesieveedit');
+else
+  $OUTPUT->send('managesieve');
+
+?>
diff -ruNa 0.2-stable.old/skins/default/filters.css 0.2-stable/skins/default/filters.css
--- 0.2-stable.old/skins/default/filters.css	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/filters.css	2009-01-03 13:51:33.231815851 +0100
@@ -0,0 +1,138 @@
+/***** RoundCube|Filters styles *****/
+
+
+#filterslist
+{
+  position: absolute;
+  left: 20px;
+  width: 220px;
+  top: 130px;
+  bottom: 30px;
+  border: 1px solid #999999;
+  background-color: #F9F9F9;
+  overflow: auto;
+  /* css hack for IE */
+  height: expression((parseInt(document.documentElement.clientHeight)-155)+'px');
+}
+
+#filters-table
+{
+  width: 100%;
+  table-layout: fixed;
+  /* css hack for IE */
+  width: expression(document.getElementById('filterslist').clientWidth);
+}
+
+#filters-table tbody td
+{
+  cursor: pointer;
+}
+
+#filtersbuttons
+{
+  position: absolute;
+  left: 20px;
+  top: 95px;
+}
+
+#filter-box
+{
+  position: absolute;
+  top: 95px;
+  left: 250px;
+  right: 20px;
+  bottom: 30px;
+  border: 1px solid #999999;
+  overflow: hidden;
+  /* css hack for IE */
+  width: expression((parseInt(document.documentElement.clientWidth)-30-parseInt(document.getElementById('filterslist').offsetLeft)-parseInt(document.getElementById('filterslist').offsetWidth))+'px');
+  height: expression((parseInt(document.documentElement.clientHeight)-120)+'px');
+}
+
+#filter-frame
+{
+  background-color: #F9F9F9;
+  border: none;
+}
+
+body.iframe
+{
+  background-color: #F9F9F9;
+  min-width: 740px;
+  width: expression(Math.max(740, document.documentElement.clientWidth)+'px');
+}
+
+#filter-form
+{
+  min-width: 650px;
+  white-space: nowrap;
+  background-color: #F9F9F9;
+  padding: 20px 10px 10px 10px;
+}
+
+#filter-form input, select
+{
+  font-size: 10pt;
+  font-family: inherit;
+}
+
+fieldset
+{
+  background-color: white;
+}
+
+label
+{
+  color: #666666;
+}
+
+#rules, #actions
+{
+  margin-top: 5px;
+}
+
+div.rulerow, div.actionrow
+{
+  width: 100%;
+  padding: 2px;
+  white-space: nowrap;
+  float: left;
+  border: 1px solid white;
+  display: block;
+}
+
+div.rulerow:hover, div.actionrow:hover
+{
+  padding: 2px;
+  white-space: nowrap;
+  display: block;
+  float: left;
+  background: #F2F2F2;
+  border: 1px solid silver;
+}
+
+div.rowbuttons
+{
+  float: right;
+}
+
+div.rowactions
+{
+  float: left;
+}
+
+input.disabled, input.disabled:hover
+{
+  color: #999999;
+}
+
+input.error, textarea.error
+{
+  background-color: #FFFF88;
+}
+
+input.box,
+input.radio
+{
+  border: 0;
+}
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_add_pas.png 0.2-stable/skins/default/images/buttons/filter_add_pas.png
--- 0.2-stable.old/skins/default/images/buttons/filter_add_pas.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_add_pas.png	2009-01-03 13:51:33.255817491 +0100
@@ -0,0 +1,6 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	+PX  IDATXMW^wmgm#'D:H!@NsD.Hp#K	BJ D^yegwvgg{0;3fUZT6lfG-U ?{WuD 3scYh:c9P]TET~c}XK{"2<E+K}cFQU([9x-8XTH 2`[k>wzkn]
+oDh=Q]hU%vI(>c9b.=?6&-'I'"2&GTnCJFYcx}DN:Byj0vxi4	Ag#j&GYgJg
+?v9Y	$1_pivzPT7hyH%(oKJTszjz>}~3yX+$BPjy//_'v1Sm:&_yjcnj;AV\90*PBnSIDz:peirc\Ikn|Y4UA L+/YL;C:Ni9)hEJ'RZ6pQ~)5Gi*w{bFb2jpbj&$VIlNm6XZ\XiLkX,M.6=5I{!2UQ=O:*oWhR"(*2K=:^=U9^>xubS0fMh!%:fsU!2B'qUv(a,DtJ@;o^Pws\F,u39ICB#j"_qcyiL4wwF_(M@P$Qt]s(R{i7&FJzLy/JVHwM<"1XCdbP.^goLa\UT:x-1Yh^TP:{"),MsyKk$U_Ss_(o&!ldYvSDHeGTasa,M]Yo}t1IL3k]`WGTwt:R%$33/;;b
+b`*^`vDi~7$UK&.GX-7s/DY^}{#Rdy>EtgSG     IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_add.png 0.2-stable/skins/default/images/buttons/filter_add.png
--- 0.2-stable.old/skins/default/images/buttons/filter_add.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_add.png	2009-01-03 13:51:33.279821645 +0100
@@ -0,0 +1,13 @@
+PNG
+
+   IHDR           szz   	pHYs         cHRM  z%        u0  `  :  o_F  IDATx[lWe/u89uHU*D> 
+%HT<5/H(T
+mS$-@.jq0k;q]83g;GYkyQ
+Br
+kmdjc5km>d3]=]lf?X"BdhzvnjFW &eM?ZbDLFoxR:kT"vmMVhJ}ndU)kP	1B:*~t\^mo`C\m@)[\&3\>F]]VuXikl&CGqA%IcD[4{(8Zy.A%UnvMnb-Xu`5n$Wlz(k,iw5KvDh%A- `BE4D+1"G)\WqHIuXR8gDzi
+nJ*2v;N	IP%a:xr~FKDbYC{oO/hgnEFnW7(UCl5N1W)T8?zv?K'3O\/ps
+ H3/Ezuy4Odgv/QH8w9E'7zhxifF=2H%cUcS>C<a!!qG{sWbwq::I<d>3|v[Ras6U(Xz2f?#>?Jw-_\[@bb "l4br|@{q Z<CP*|qr6[[6a$j'lXRx7WwliO98JvhXyXahv0x*cfjgGpicbIJNwz(wot4~'N2^PZE$"GD!+eUxZ9
+,b#v7#ZUG	[c'}g:()Zy<j2# @!NBjY+ay{$R06}\)EQ
+Oka68VLB@@dV-e ]-R-^d=<xqKb
+dMsxg/\n(	.}|$l}=vU.*aPta_LLhV5ZFh qd47MofG<.53]B;y{b^|:Fn|ZN5B7J_1J
+_xn;znX|usZyl+$x9g|d-8zruhzBo37&,MN.1gO"2J)J\vtFilz<(*jk:io9g f    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_add_sel.png 0.2-stable/skins/default/images/buttons/filter_add_sel.png
--- 0.2-stable.old/skins/default/images/buttons/filter_add_sel.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_add_sel.png	2009-01-03 13:51:33.295819759 +0100
@@ -0,0 +1,13 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	/,_i  IDATX]lWwm]v'4m*
+!}l%$} }}ABT"70 >()N(JDI DIqw3sa?NFuss)>	g1o*$sc~Ffra8::47M,
+"s^Y..,&M-6DcQJqX^ykXc&l=1fM_cZ)LfNrn Fw=&fOm3p/p]ry^#NCS xd0""h'F,X>f k,G!  'UP-@?i{(_\7vlCMVC:@nd%*w>o+ *8ib[6<u	J*Bg)9aUgo9*$I95w"N|2'8<o*~E6mE%n$h#Kg_c5m(XX:/}/o_> Z$ i^4F.bw(CI
+<79xg"?/\\kmW<Y5s8p<:ppmcC
+A|i$)fRj?<}DI]Dp*8u8&C"qJ-=PyHV
+Rgfocdpk')s:V3
+{
+~B: 8r>B!@?o3OtEAs02EL(FyFz>F`,X^Kv)
+ACZIc1M41+<oz6k40wc5N_gw=n>w+*I9?s9q
+zT7-j`0%qv@W`#Qh|__VkX@_O
+8y.a0,(fj,'yJJ#j34AjEYI?7iB!Oxk?QjjJ~ 6,TTRvM0s	r~,vz'Edl(]'%NJ[\wSQV1{#$ajvIXM&fBEwV_^]_vpo&:H9y8+'&4$eIp8^l+tv:cm~v3T+{FwiV%)Xx#<:Em;XJmfff7ON{[EUay`saq%*`YZ\8=ab%vkq{+FJ<R$LYR9[Y^y}.vZZkcW    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_del_pas.png 0.2-stable/skins/default/images/buttons/filter_del_pas.png
--- 0.2-stable.old/skins/default/images/buttons/filter_del_pas.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_del_pas.png	2009-01-03 13:51:33.315820473 +0100
@@ -0,0 +1,14 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	*4@  IDATXKGU===3uQ,"SDNGHNq\ '$KBID]1 az;L8qIQUD]^Riv(U9F<|7{" m0_&CkYD"ZYjw~``2~ EP
+t%)4wZ{C1y*)BV3~ihb/ s~*[qW 
+&Pj(6~0T1n/ezIZ59{
+0$	"X/_BkMh-n'['-{a&6DtWW@
+^H^- >[^&>HxR,;#|xi<41Ba-
+59c<C~XRN;7t/]w
+y`lH8=MggfP"n;G=>	XP
+U?<cOZ7	/x/8=koRFFFhRRF~MUa% 0RL/~M<}?`cJ)9{`'@,?F$kL?ZL"'3wll?$C_`QN{3u}8GeG*/<jZMF.-t+pKWac\F{?x^Gt<' 4SJz/\G7I?n#bkUomp <4:X9,dt:('50~/D8XgD@
+i r uOPG`!58tvDhH B38B^
+Q`b\^n:~k&s<t"C	|t$VeB~\syeF`f7K	 kZ~xpjI*laBpI6\:wl#Zo6 h5q9H':y2	^eb[4>"By*_9F%+_=Mk?&"!B"{w0{Roc'2j"&d .<
+237HH|c>O><_/
+ KY]RJ9*g/}b8L<LwJ;D}h;G;blxI\_y9*.c>x>Vyi/z};.rBd0vT>gsRx ikhF:+\6    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_del.png 0.2-stable/skins/default/images/buttons/filter_del.png
--- 0.2-stable.old/skins/default/images/buttons/filter_del.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_del.png	2009-01-03 13:51:33.339823231 +0100
@@ -0,0 +1,7 @@
+PNG
+
+   IHDR           szz   	pHYs         cHRM  z%        u0  `  :  o_F  IDATx{\U?;{gvfw]]m	HF&Q?TXQ?jB-T!AP$"RPJ*m)v{?]w93g^yBg#@p1?,bmq 2.eJkHH8SgXFs 'Kz1u+c/i@]Zm	,+gl:6-u#L1/t"&Jnh6UK a-Bc9 kflfkDMk'Ez7H5nh;jYaY R.&2M.#@`	H$L[[fL\	C{Cfm-u E5{0,6\A^Q4R frU m0A]ORJ+BQ:6FcqWNifY7T	0@	E4Hg3\xIlVx 4j fB1<y2F),h-[OW)Nyl;5ms+sk _o>TH7H.BXP2q$#M[[~u214eSg@)R
+YQ!RLI )lC7 x4|#/MQV|jc uPRGJE,)R>Ci\{IMRIRB(t@*w7[
+DcFKd+BQ0Sfd
+4wwn$$rSS6{p8,?}~;{kQ:Z*3 y$2k2Ayc/ LT1s;fD&&/g?Wa52I<7a;	h60vS3 zipbt]|~s]D >WrVR*P
+K"e)7v^,D2OFAWIg axj^ /HE&jAr$*AAUXs8ToUX,!0MkV_C2|?<ShCI?UwQ!D@ GG%/skUj4ZVIo3frOkm=@/s[/ 34:-^ i]y/NP}lh6Ee2rlpl$To54p/ =0r$%ue-t8Ba*izMG(S(q~mTylBvGqn3yZJ=8mlb3>SgYMr|o$S7mj3pT.XizwiY=E^A8	F*P|wLx3[	cq{F7uW_B7|;M59rT]6uIwF(d}45lP*m[yn= )r#d    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_del_sel.png 0.2-stable/skins/default/images/buttons/filter_del_sel.png
--- 0.2-stable.old/skins/default/images/buttons/filter_del_sel.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_del_sel.png	2009-01-03 13:51:33.363810693 +0100
@@ -0,0 +1,11 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	/78  IDATXm\Wwwg7y]45"$6mAh!_T)bc*APZ)"4*XjcUjLi^}73;3wytWz3{>s0opXyZ,B XXnXhQxN
+rwU`~c,Zk\yy:35u &ehocB-uhS37: B"vyE R)Dl<p2wkjR @HC'p^yz'Z[ao}u02>qq}R ,adaH0l6}v^E45RH!q=t: 6 ]\Xw!RKKvZ.wj~h&
+.PI[j!m *R<hQ`A@a)\`0y3)BVJD&	=g^:r= Y$qzl~ikUqm,l<WzTN*L][mZ?LGdG nmgmKDZ3{$)~R[C:%\ "[Mehk3t\1iZF+VyGkjq_O-g
+_<M}dK%O_zJn_keZb/eQ(Im/?3%WvyxztG@=Y^W6?T13SWqry 
+r49`,4c.(!Ei 1W0' s/8S(p7'8Y/E."'GS\mF'+APm"jZcGGaCy')/R)4bt&ubc!"B+3A{
+Y@8JA[dd$,7	:Zk1xr=;N>SAkMT C~14N*DQ$!P69h@PGZFm<zdNz{'S/&)
+_>JIZ-^j ZqI5:Zbl#DP7+p.2q  W`+5|yO& M0zx?h5$D/?O1m.3!*;iEp;\q
+cl3!$wZo~vo<Cp9rxU.8<a-"a;h4f)jZ!Sng*~DBMR`> =/L&yg&xxqs^G^Fqc6l[yfT<08 +<Xk>t
+7z)oTBkTyZ;W+V-:_1'v    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_down_pas.png 0.2-stable/skins/default/images/buttons/filter_down_pas.png
--- 0.2-stable.old/skins/default/images/buttons/filter_down_pas.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_down_pas.png	2009-01-03 13:51:33.387822601 +0100
@@ -0,0 +1,9 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	+87*  IDATXWU]/L31a^+6=d-%XDd	H@#a(qP:	3dLOUu9,_G<w{2J3I\n81GUP:Q2mZ>#	 gaUETaxtIN2O0(UJ4
+D?78}UDk/G?/ 7fDE	7W0b(\88O0%M36{[lQfcLc}H{\Pt-^|v L!3d9K=a_PU0%=SeZw<+ CgT.#x:rd0L|O$SUE%QuC&g #pJ!BV
+DS:rl:kEv(=L)l}^MBB:qO;Y/B0^3UT+ct;*:)
+.\';ENt{\>Z6QE:2UpS
+\\6p6Z4Oqdf(tX^#;}ETRiiFyg:G81wPz{(%eBY/K?oA3:Nh{utBp;h7ZwS0NTPa2YyF%q!fA5qPpr=;	 &4i22]p+j:;I	L[Q)9%D[=FQD:dAcWUHiE!ZVK*%K|b_o%B.ik`hZgZ[C^`>1UNePg`tu"`oQ[u7ll]`&j]k:OV
+5x N>X#OL',E($p.($	<[M`m\.dwerer1\*W\X0x*%,5#e^v3K!
+J-X0p_C'*(RI>d~lYnhI{})8_[dy*ugFD[k'l>G_p=v'9w^nYGk6` w-k=JdmI5w`~v0+M)R?dYza]_X!	}@8'qT<Ev^D:i /    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_down.png 0.2-stable/skins/default/images/buttons/filter_down.png
--- 0.2-stable.old/skins/default/images/buttons/filter_down.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_down.png	2009-01-03 13:51:33.407816330 +0100
@@ -0,0 +1,7 @@
+PNG
+
+   IHDR           szz   	pHYs         cHRM  z%        u0  `  :  o_F  IDATxil\Wyyl8u$mRVjZPDU$(PP	 HZ@B(PTTMhD@,JPIZI;3,sfc'Nbhyoy9mRR9'PTJbtbR HtJr"aD0"3Bt\7&ud274|1vu R( ZkRDFkuO7YkW(D/w_Fb~tjPD; W2xJP(qalJzou_f_B)
+b9sndR|SZUR	\HtgI%O`D"1i.CT0)HX#JJ$V"iT Y~s8PO\55d+3}GS];hu ?\h57_e+J7&JD\3.z!Qa \'1'NW p!p{"S
+A#d$NKQ%y*zi7A*&K<s(GGHa@M}|h`;6o{hT8D@jt(T- U6z_	3D&Lk86vgg>O~sJ7 A;cbli%E{3<?r?HWK'_GOM\:^,C'.Mu5k$ZptE2k$i'#<|lvtn")6ttRVO='x*v8X+UW[R	(283z[OXzBWB WZw}v^s]`& xzX1! c^ENI>*=T;R	6-nmjy`L5p:
+})KH B0<72tvcaao3=T l;y7K*'y;'R}KxZ6L4u$<|"QvE NgrwrP!	NDd3fYTN`m8|ANM` M&
+kIG7_K.$QU$SmRt z+RMFFu-P)y;P.Wx,X2I=2qTOP6,((WR*-F*?Y0JkCqV|`s WN_8q_sise6vOLT hVv8qRUWo"a5h6k-P:JV'+<EG"IEJ&?>>Q73>X3yb/0LO{]q69/_s{7%?ux1{+yp#4E%=s'Mn_ rEDV3[qG-l3)bHJmw{NNN7N[mwC5D"3ua|knuy##7`	,g (n=(    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_down_sel.png 0.2-stable/skins/default/images/buttons/filter_down_sel.png
--- 0.2-stable.old/skins/default/images/buttons/filter_down_sel.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_down_sel.png	2009-01-03 13:51:33.423824222 +0100
@@ -0,0 +1,4 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	.j  IDATXldU?yoLvm)eaYv(A	?DcH1/nCcFPPTVTTQ`A~fYnvf=N;f}|9Gy(puqajU1iO}l=~r ILNoPUDQnJuyt =6\SU/jf 8$eS?*?Ezp8zAsAPsbaqn<~d%Gkv|T,^\<YWx,w Qcely4pA' J&$ILR/J$gcY !QR,&=bY:a6NkoO{mXo7g5aFB&@e0.#"@(0 wfmA2	y*bB!SH-&tiEnvO=4O7sSxEEf:+lj')yk@{!RhZOYnRNJW]xCc+])~8 fd #@l D<?xV_r|^eveFxiM>8p=C+vP* ^U$|Ge[J"B373<C1l0{+)7 T!)bv8J=-ZG/1{e8Q@;*97&e4f8\T P#3" "xx*\yJQ`>:9G9N`0#s+B N:A' X7EmNRLkH:7x72`/JHvh!fZP<{?wp5K;n8pX)zVe%Mua\7k> rr, pv>sq.2\`vFwp(q@QPZ#U:|WO([LR{GsrAV4Qkg"j-tXKFsOWN,pj<`>aa	r[Wk]hs@
+&5iRKkOv7843/bqb,h_E7e^Z'?H8t^~1xi|5cu4m vVNS8cK_VJ)mK'07@DV^f7%w|fzt|9~YTd	k=M_)JXr/3=z<4b|.sJ5_=qRiP)`jZswg.+WQCqI/I AO--<R_pyCnq}V=>x>`S3_jWS-_    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_up_pas.png 0.2-stable/skins/default/images/buttons/filter_up_pas.png
--- 0.2-stable.old/skins/default/images/buttons/filter_up_pas.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_up_pas.png	2009-01-03 13:51:33.447826421 +0100
@@ -0,0 +1,11 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	*  IDATXWztx3$J A67XZbED@"@hdy$ggac;a+][}ss7_'wf`XR(~q|j  g(<fAzuts!VM ;>=$}UC  "oQx>Y Pbj:0V>#3"Q0wqt " #M36ln)x-DP%cx(A@Fh^Ie#
+C(|*2( ThT*y 8<  AYU<<53L{@L30_	09# B1%+s.a#\;fCY*R*;.vCiJ#f	\>23ng!>W"{uO:-
+[-~t$	D;3On*K>jjo5U?zTr
+[pgz|8i&	''OW1n&Oj@5C\(-qqH
+&#kKynrGF(ccGfA<~)\+:Je,
+pBg
+@Y6D}\2 {)fZy{(O_=g^f~la@_Z<*BF#P\kV0 =+LsC{]N6$	B^=\}j3L'uYnAK:\0/leng AZdLV\N\8!P+m(@p,pkg~tGOdore mbp7hm]g:q*now};<Xm'!IEQ"}JXeHK3>h+dLu
+R&nOSwNV'ah<e/]K/ 0j<vWy_-
+xeYViD&)9[3r-?b,a!rnAC=N7%q>35DQZbKksi]b/U(J%x~Ulwsf{i/3Lo.wc*]M^KsM<bq?-C4\075(~.Lm7%	cqjKyqgg,K/ H0xoa9	LyUZ% p/    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_up.png 0.2-stable/skins/default/images/buttons/filter_up.png
--- 0.2-stable.old/skins/default/images/buttons/filter_up.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_up.png	2009-01-03 13:51:33.471828621 +0100
@@ -0,0 +1,8 @@
+PNG
+
+   IHDR           szz   	pHYs         cHRM  z%        u0  `  :  o_F  IDATx]l\WwxNNRMjJ}T(	$T@j AZHUUB-JD@B)--$Nb;w];Wwf3s\@+(Xi98jXM]|v\ySV={79F ;6=[(LM*Ks"7e9sXJ%-/:5RfYk,xZF)4Z(^y
+B"r[&ED; sBPJvxf/33;+\\l]eu \WMH&tsS)81L8~4"}PDI{AISWV"[|joBTle%tw^{[g;NqkBJ(cKFb7p3LsQc7)k+8	!N8\\)<_5-CVA{"S	a#OSRbo|U|
+274 AU)^:?_-N!-8uru$j WGB1'8 'xLt{%Wex?Wg^~kkT(n
+fZLc-"*?E,ggm$}9w#?FCYlki M5]mTclDO[@&S|O!|W ttNzF#>VC*w59nte65Oym |{| I5Go0~tk{	X@ *p?3V;k0\J;Q0o@:%7/cxS8}}D/m;UKy|s!sy/3Nk1 (Xsqq@mrG~ P
+y{2^Rd: S<m3q MLopfcx Nw_ dPHCUpq`}s%ar|N\>l_G	_cX9kc:Mg\./dHZ"ds\}7y9lV*5!f3?R~ E-N-)zX>5[mOz4F dy)< B5R\<l -cAss<O(,}Vz^:9vZT[PKlFv.h7CT0QG2S%JHl}O<L6L~+9|,L|<HK
+6i`Tw22{+B[t3$c46|&OL]y^CC~ssf $ocdf{LVn]s7kt#sDdRv5 <3;IWn;e76u|N/]1&Z? B'    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/images/buttons/filter_up_sel.png 0.2-stable/skins/default/images/buttons/filter_up_sel.png
--- 0.2-stable.old/skins/default/images/buttons/filter_up_sel.png	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/images/buttons/filter_up_sel.png	2009-01-03 13:51:33.515827064 +0100
@@ -0,0 +1,14 @@
+PNG
+
+   IHDR           szz   sRGB    bKGD      	pHYs        tIME	.,d  IDATX]l\G3^v&1/7	m&m(OmPh
+	)HT|(jZ!JZG6) mL6q\o83pY;LLL03
+R51p
+EPqgK3WT(0 !@&r`l,*!s1pUT*E0@6+:?o`hob!0kmnm~/@1z&bx!zDG.}9VYW?s-wm{&E0(0UZ}@	kl- s2==,T
+L&s3T7HZBrlfr@R'Ubwu:4WvjX"p[FTI
+m15&1}BP^/( X+ 4^6Iu`W4a8tTAW0
+Q/HXnN9A3SflL/\#)v}xiXV}I*h 
+I-Zz{Uv1cq>+'EVIDq^Q\cz~HJ1|bFnF67ywf Ol,[ ^\;I'CM=wOm}<s|s|x=)<=r@{Tzi-
+x+N4ykzJQ^=`gK=hq _8@TL;F=Y3Sx8
+l(xq8q.qG)8S>B)F5!}M0 }=EN~|+^%KMwxwKs9>{(xhawZz)Jnv@kO$ UY/SLv d>7I@*xxUrl~4y,4b%;<J:4%4Ub7+oFgx T}Bdo-u`x/WB`acvsUR$op>G`{87_ZZv>G@hyB%+#ye6e:Fk=!#8%^~\^Dgax4lWHCZS/2fsx%9`f	LuCEtV}iu$eR,-c!btf+.fC>x+G^oB+xF	n\J[,7_e	 'KM>SUK>
+yG;z V{?]]\|557%-G*p^>utLYteNMCQ"y`eOCs6:fbb8(4^U09G:
+oL^Xy6)=VY(pmvDiH,]O6?8zI&5^NW_L/MtUO#&    IENDB`
\ Brak znaku nowej linii na kocu pliku
diff -ruNa 0.2-stable.old/skins/default/includes/settingstabs.html 0.2-stable/skins/default/includes/settingstabs.html
--- 0.2-stable.old/skins/default/includes/settingstabs.html	2008-05-20 15:33:47.000000000 +0200
+++ 0.2-stable/skins/default/includes/settingstabs.html	2009-01-03 13:51:33.599831408 +0100
@@ -2,4 +2,5 @@
 <span id="settingstabdefault" class="tablink"><roundcube:button command="preferences" type="link" label="preferences" title="editpreferences" /></span>
 <span id="settingstabfolders" class="tablink"><roundcube:button command="folders" type="link" label="folders" title="managefolders" class="tablink" /></span>
 <span id="settingstabidentities" class="tablink"><roundcube:button command="identities" type="link" label="identities" title="manageidentities" class="tablink" /></span>
+<span id="settingstabmanagesieve" class="tablink"><roundcube:button command="managesieve" type="link" label="filters" title="managefilters" class="tablink" /></span>
 </div>
diff -ruNa 0.2-stable.old/skins/default/templates/managesieveedit.html 0.2-stable/skins/default/templates/managesieveedit.html
--- 0.2-stable.old/skins/default/templates/managesieveedit.html	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/templates/managesieveedit.html	2009-01-03 13:51:33.639831161 +0100
@@ -0,0 +1,99 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<title><roundcube:object name="pagetitle" /></title>
+<roundcube:include file="/includes/links.html" />
+<link rel="stylesheet" type="text/css" href="/settings.css" />
+<link rel="stylesheet" type="text/css" href="/filters.css" />
+</head>
+<body class="iframe">
+
+<script type="text/javascript">
+
+function header_select(id)
+{
+    var obj = document.getElementById('header'+id);
+
+    if (obj.value == 'size')
+    {
+	document.getElementById('rule_size' + id).style.display = 'inline';
+	document.getElementById('rule_op' + id).style.display = 'none';
+	document.getElementById('rule_target' + id).style.display = 'none';
+	document.getElementById('custom_header' + id).style.display = 'none';
+    }
+    else
+    {
+	if (obj.value != '...')
+	    document.getElementById('custom_header' + id).style.display = 'none';
+	else
+	    document.getElementById('custom_header' + id).style.display = 'inline';
+    
+	document.getElementById('rule_size' + id).style.display = 'none';
+	document.getElementById('rule_op' + id).style.display = 'inline';
+	rule_op_select(id);
+    }
+}
+
+function rule_op_select(id)
+{
+    var obj = document.getElementById('rule_op'+id);
+
+    if (obj.value == 'exists' || obj.value == 'notexists')
+    {
+	document.getElementById('rule_target' + id).style.display = 'none';
+    }
+    else
+    {
+	document.getElementById('rule_target' + id).style.display = 'inline';
+    }
+}
+
+function action_type_select(id)
+{
+    var obj = document.getElementById('action_type'+id);
+
+    if (obj.value == 'fileinto')
+    {
+	document.getElementById('action_mailbox' + id).style.display = 'inline';
+	document.getElementById('action_target' + id).style.display = 'none';
+	document.getElementById('action_target_area' + id).style.display = 'none';
+    }
+    else if (obj.value == 'redirect')
+    {
+	document.getElementById('action_target' + id).style.display = 'inline';
+	document.getElementById('action_mailbox' + id).style.display = 'none';
+	document.getElementById('action_target_area' + id).style.display = 'none';
+    }
+    else if (obj.value.match(/^reject|ereject$/))
+    {
+	document.getElementById('action_target_area' + id).style.display = 'inline';
+	document.getElementById('action_target' + id).style.display = 'none';
+	document.getElementById('action_mailbox' + id).style.display = 'none';
+    }
+    else // discard, keep
+    {
+	document.getElementById('action_target_area' + id).style.display = 'none';
+	document.getElementById('action_target' + id).style.display = 'none';
+	document.getElementById('action_mailbox' + id).style.display = 'none';
+    }
+}
+
+function rule_join_radio(value)
+{
+    document.getElementById('rules').style.display = (value=='any' ? 'none' : 'block');
+}
+</script>
+
+<div id="filter-form">
+<roundcube:object name="filterform" />
+
+<p>
+<roundcube:button command="sievefiltersave" type="input" class="button mainaction" label="save" />
+</p>
+
+</form>
+</div>
+
+
+</body>
+</html>
diff -ruNa 0.2-stable.old/skins/default/templates/managesieve.html 0.2-stable/skins/default/templates/managesieve.html
--- 0.2-stable.old/skins/default/templates/managesieve.html	1970-01-01 01:00:00.000000000 +0100
+++ 0.2-stable/skins/default/templates/managesieve.html	2009-01-03 13:51:33.663817016 +0100
@@ -0,0 +1,34 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<title><roundcube:object name="pagetitle" /></title>
+<roundcube:include file="/includes/links.html" />
+<link rel="stylesheet" type="text/css" href="/settings.css" />
+<link rel="stylesheet" type="text/css" href="/filters.css" />
+<script type="text/javascript" src="/functions.js"></script>
+</head>
+<body onload="rcube_init_settings_tabs()">
+
+<roundcube:include file="/includes/taskbar.html" />
+<roundcube:include file="/includes/header.html" />
+<roundcube:include file="/includes/settingstabs.html" />
+
+<div id="filtersbuttons">
+<roundcube:button command="sievefilteradd" imageSel="/images/buttons/filter_add_sel.png" imagePas="/images/buttons/filter_add_pas.png" imageAct="/images/buttons/filter_add.png" width="32" height="32" title="filteradd" />
+<roundcube:button command="sievefilterdel" imageSel="/images/buttons/filter_del_sel.png" imagePas="/images/buttons/filter_del_pas.png" imageAct="/images/buttons/filter_del.png"  width="32" height="32" title="filterdel" />
+<roundcube:button command="sievefilterup" imageSel="/images/buttons/filter_up_sel.png" imagePas="/images/buttons/filter_up_pas.png" imageAct="/images/buttons/filter_up.png"  width="32" height="32" title="moveup" />
+<roundcube:button command="sievefilterdown" imageSel="/images/buttons/filter_down_sel.png" imagePas="/images/buttons/filter_down_pas.png" imageAct="/images/buttons/filter_down.png"  width="32" height="32" title="movedown" />
+</div>
+
+<div id="filterslist">
+<roundcube:object name="filterslist" id="filters-table" class="records-table" cellspacing="0" summary="Filters list" />
+</div>
+
+<div id="filter-box">
+<roundcube:object name="filterframe" id="filter-frame" width="100%" height="100%" frameborder="0" src="/watermark.html" />
+</div>
+
+<roundcube:include file="/includes/settingscripts.html" />
+
+</body>
+</html>
