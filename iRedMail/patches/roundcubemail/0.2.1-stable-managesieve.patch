diff -ruNa rc-beta2-old/config/main.inc.php.dist rc-beta2/config/main.inc.php.dist
--- rc-beta2-old/config/main.inc.php.dist   2009-01-18 10:39:07.000000000 +0100
+++ rc-beta2/config/main.inc.php.dist   2009-02-22 16:23:35.675003721 +0100
@@ -14,6 +14,30 @@
 
 $rcmail_config = array();
 
+// disabled sieve extensions (body, copy, date, editheader, encoded-character,
+// envelope, environment, ereject, fileinto, ihave, imap4flags, index, 
+// mailbox, mboxmetadata, regex, reject, relational, servermetadata, 
+// spamtest, spamtestplus, subaddress, vacation, variables, virustest, etc.
+// Note: not all extensions are implemented
+$rcmail_config['managesieve_disabled_extensions'] = array();
+
+// managesieve server port
+$rcmail_config['managesieve_port'] = 2000;
+
+// managesieve server address
+$rcmail_config['managesieve_host'] = 'localhost';
+
+// use or not TLS for managesieve server connection
+// it's because I've problems with TLS and dovecot's managesieve plugin
+// and it's not needed on localhost
+$rcmail_config['managesieve_usetls'] = false;
+
+// default contents of filters script (eg. default spam filter)
+$rcmail_config['managesieve_default'] = '/etc/dovecot/sieve/global';
+
+// I need this because my dovecot (with listescape plugin) uses
+// ':' delimiter, but creates folders with dot delimiter
+$rcmail_config['managesieve_replace_delimiter'] = '';
 
 // system error reporting: 1 = log; 2 = report (not implemented yet), 4 = show, 8 = trace
 $rcmail_config['debug_level'] = 1;
diff -ruNa rc-beta2-old/program/include/rcube_sieve.php rc-beta2/program/include/rcube_sieve.php
--- rc-beta2-old/program/include/rcube_sieve.php    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/program/include/rcube_sieve.php    2009-02-24 13:14:09.838074167 +0100
@@ -0,0 +1,741 @@
+<?php
+
+/*
+ +-----------------------------------------------------------------------+
+ | program/include/rcube_sieve.php                                       |
+ |                                                                       |
+ | This file is part of the RoundCube Webmail client                     |
+ | Copyright (C) 2007-2008, RoundCube Dev. - Switzerland                 |
+ | Licensed under the GNU GPL                                            |
+ |                                                                       |
+ | PURPOSE:                                                              |
+ |   Classes for managesieve operations (using PEAR::Net_Sieve)          |
+ |                                                                       |
+ +-----------------------------------------------------------------------+
+ | Author: Aleksander Machniak <alec@alec.pl>                            |
+ +-----------------------------------------------------------------------+
+
+$Id$
+
+*/
+
+//  Sieve Language Basics: http://www.ietf.org/rfc/rfc5228.txt
+
+define('SIEVE_ERROR_CONNECTION', 1);
+define('SIEVE_ERROR_LOGIN', 2);
+define('SIEVE_ERROR_NOT_EXISTS', 3);   // script not exists
+define('SIEVE_ERROR_INSTALL', 4);  // script installation
+define('SIEVE_ERROR_ACTIVATE', 5); // script activation
+define('SIEVE_ERROR_OTHER', 255);  // other/unknown error
+
+
+class rcube_sieve
+{
+  var $sieve;              // Net_Sieve object
+  var $error = false;          // error flag 
+  var $list = array();             // scripts list 
+
+  public $script;          // rcube_sieve_script object
+  private $disabled;           // array of disabled extensions
+
+  /**
+    * Object constructor
+    *
+    * @param  string  Username (to managesieve login)
+    * @param  string  Password (to managesieve login)
+    * @param  string  Managesieve server hostname/address
+    * @param  string  Managesieve server port number
+    * @param  string  Enable/disable TLS use
+    * @param  array   Disabled extensions
+    */
+  public function __construct($username, $password='', $host='localhost', $port=2000, $usetls=true, $disabled=array())
+    {
+      require_once('Net/Sieve.php');
+    
+      $this->sieve = new Net_Sieve();
+      
+//      $this->sieve->setDebug();
+      if (PEAR::isError($this->sieve->connect($host, $port, NULL, $usetls)))
+        return $this->_set_error(SIEVE_ERROR_CONNECTION);
+
+      if (PEAR::isError($this->sieve->login($username, $password)))
+        return $this->_set_error(SIEVE_ERROR_LOGIN);
+
+      $this->disabled = $disabled;
+      $this->_get_script();
+    }
+
+  /**
+    * Getter for error code
+    */
+  public function error()
+    {
+      return $this->error ? $this->error : false;
+    }
+               
+  public function save()
+    {
+      $script = $this->script->as_text();
+
+      if (!$script)
+   $script = '/* empty script */';
+
+      if (PEAR::isError($this->sieve->installScript('roundcube', $script)))
+       return $this->_set_error(SIEVE_ERROR_INSTALL);
+
+      if (PEAR::isError($this->sieve->setActive('roundcube')))
+       return $this->_set_error(SIEVE_ERROR_ACTIVATE);
+
+      return true;
+    }
+
+  public function get_extensions()
+    {
+      if ($this->sieve) {
+   $ext = $this->sieve->getExtensions();
+
+   if ($this->script) {
+     $supported = $this->script->get_extensions();
+     foreach ($ext as $idx => $ext_name)
+       if (!in_array($ext_name, $supported))
+         unset($ext[$idx]);
+   }
+
+        return array_values($ext);
+      }
+    }
+
+  private function _get_script()
+    {
+      if (!$this->sieve)
+        return false;
+    
+      $this->list = $this->sieve->listScripts();
+
+      if (PEAR::isError($this->list))
+       return $this->_set_error(SIEVE_ERROR_OTHER);
+    
+      if (in_array('roundcube', $this->list))
+        {
+          $script = $this->sieve->getScript('roundcube');
+    
+          if (PEAR::isError($script))
+           return $this->_set_error(SIEVE_ERROR_OTHER);
+   }
+      // import scripts from squirrelmail
+      elseif (in_array('phpscript', $this->list))
+        {
+          $script = $this->sieve->getScript('phpscript');
+
+          $script = $this->_convert_from_squirrel_rules($script);
+
+          $this->script = new rcube_sieve_script($script);
+       
+          $this->save();
+
+          $script = $this->sieve->getScript('roundcube');
+
+          if (PEAR::isError($script))
+            return $this->_set_error(SIEVE_ERROR_OTHER);
+        }
+      else
+        {
+     $this->_set_error(SIEVE_ERROR_NOT_EXISTS);
+          $script = '';
+   }
+
+      $this->script = new rcube_sieve_script($script, $this->disabled);
+    }
+    
+  private function _convert_from_squirrel_rules($script)
+    {
+      $i = 0;
+      $name = array();
+      // tokenize rules
+      if ($tokens = preg_split('/(#START_SIEVE_RULE.*END_SIEVE_RULE)\n/', $script, -1, PREG_SPLIT_DELIM_CAPTURE))
+        foreach($tokens as $token)
+          {
+            if (preg_match('/^#START_SIEVE_RULE.*/', $token, $matches))
+              {
+           $name[$i] = "unnamed rule ".($i+1);
+                $content .= "# rule:[".$name[$i]."]\n";
+              }
+            elseif (isset($name[$i]))
+              {
+           $content .= "if ".$token."\n";
+       $i++;
+              }
+          }
+
+      return $content;
+    }
+
+
+  private function _set_error($error)
+    {
+      $this->error = $error;
+      return false;
+    }    
+}
+
+class rcube_sieve_script
+{
+  var $content = array();  // script rules array   
+
+  private $supported = array(  // extensions supported by class
+    'fileinto',
+    'reject',
+    'ereject',
+    'vacation',    // RFC5230
+    // TODO: (most wanted first) body, imapflags, notify, regex
+    );
+  
+  /**
+    * Object constructor
+    *
+    * @param  string  Script's text content
+    * @param  array   Disabled extensions
+    */
+  public function __construct($script, $disabled)
+    {
+      global $CONFIG;
+
+      if (!empty($disabled))
+        foreach ($disabled as $ext)
+          if (($idx = array_search($ext, $this->supported)) !== false)
+       unset($this->supported[$idx]);
+
+      $this->content = $this->_parse_text($script);
+    }
+
+  /**
+    * Adds script contents as text to the script array (at the end)
+    *
+    * @param   string  Text script contents
+    */
+  public function add_text($script)
+    {
+      $content = $this->_parse_text($script);
+      $result = false;
+      
+      // check existsing script rules names
+      foreach ($this->content as $idx => $elem)
+        $names[$elem['name']] = $idx;
+      
+      foreach ($content as $elem)
+        if (!isset($names[$elem['name']]))
+     {
+            array_push($this->content, $elem);
+       $result = true;
+     }
+
+      return $result;
+    }
+
+  /**
+    * Adds rule to the script (at the end)
+    *
+    * @param   string  Rule name
+    * @param   array   Rule content (as array)
+    */
+  public function add_rule($content)
+    {
+      // TODO: check this->supported
+      array_push($this->content, $content);
+      return sizeof($this->content)-1;
+    }
+
+  public function delete_rule($index)
+    {
+      if(isset($this->content[$index]))
+        {
+          unset($this->content[$index]);
+     return true;
+   }
+      return false;
+    }
+
+  public function size()
+    {
+      return sizeof($this->content);
+    }
+
+  public function update_rule($index, $content)
+    {
+      // TODO: check this->supported
+      if ($this->content[$index])
+        {
+     $this->content[$index] = $content;
+     return $index;
+   }
+      return false;
+    }
+
+  /**
+    * Returns script as text
+    */
+  public function as_text()
+    {
+      $script = '';
+      $exts = array();
+      
+      // rules
+      foreach ($this->content as $idx => $rule)
+        {
+     $extension = '';
+     $tests = array();
+     $i = 0;
+     
+     // header
+     $script .= '# rule:[' . $rule['name'] . "]\n";
+  
+     // constraints expressions
+     foreach ($rule['tests'] as $test)
+       {
+         $tests[$i] = '';
+         switch ($test['test'])
+           {
+         case 'size':
+           $tests[$i] .= ($test['not'] ? 'not ' : '');
+           $tests[$i] .= 'size :' . ($test['type']=='under' ? 'under ' : 'over ') . $test['arg'];
+         break;
+         case 'true':
+           $tests[$i] .= ($test['not'] ? 'not true' : 'true');
+         break;
+         case 'exists':
+           $tests[$i] .= ($test['not'] ? 'not ' : '');
+           if (is_array($test['arg']))
+           $tests[$i] .= 'exists ["' . implode('", "', $this->_escape_string($test['arg'])) . '"]';
+           else
+           $tests[$i] .= 'exists "' . $this->_escape_string($test['arg']) . '"';
+         break;    
+         case 'header':
+           $tests[$i] .= ($test['not'] ? 'not ' : '');
+           $tests[$i] .= 'header :' . $test['type'];
+           if (is_array($test['arg1']))
+           $tests[$i] .= ' ["' . implode('", "', $this->_escape_string($test['arg1'])) . '"]';
+           else
+           $tests[$i] .= ' "' . $this->_escape_string($test['arg1']) . '"';
+           if (is_array($test['arg2']))
+           $tests[$i] .= ' ["' . implode('", "', $this->_escape_string($test['arg2'])) . '"]';
+           else
+           $tests[$i] .= ' "' . $this->_escape_string($test['arg2']) . '"';
+         break;
+       }
+         $i++;
+       }
+  
+     $script .= ($idx>0 ? 'els' : '').($rule['join'] ? 'if allof (' : 'if anyof (');
+     if (sizeof($tests) > 1)
+       $script .= implode(",\n\t", $tests);
+     elseif (sizeof($tests))
+       $script .= $tests[0];
+     else
+       $script .= 'true';
+     $script .= ")\n{\n";
+  
+     // action(s)
+     foreach ($rule['actions'] as $action)
+       switch ($action['type'])
+       {
+         case 'fileinto':
+           $extension = 'fileinto';
+       $script .= "\tfileinto \"" . $this->_escape_string($action['target']) . "\";\n";
+         break;
+         case 'redirect':
+       $script .= "\tredirect \"" . $this->_escape_string($action['target']) . "\";\n";
+         break;
+         case 'reject':
+         case 'ereject':
+           $extension = $action['type'];
+       if (strpos($action['target'], "\n")!==false)
+         $script .= "\t".$action['type']." text:\n" . $action['target'] . "\n.\n;\n";
+       else
+         $script .= "\t".$action['type']." \"" . $this->_escape_string($action['target']) . "\";\n";
+         break;
+         case 'keep':
+         case 'discard':
+         case 'stop':
+           $script .= "\t" . $action['type'] .";\n";
+         break;
+         case 'vacation':
+                $extension = 'vacation';
+                $script .= "\tvacation";
+       if ($action['days'])
+         $script .= " :days " . $action['days'];
+       if ($action['addresses'])
+         $script .= " :addresses " . $this->_print_list($action['addresses']);
+       if ($action['subject'])
+         $script .= " :subject \"" . $this->_escape_string($action['subject']) . "\"";
+       if ($action['handle'])
+         $script .= " :handle \"" . $this->_escape_string($action['handle']) . "\"";
+       if ($action['from'])
+         $script .= " :from \"" . $this->_escape_string($action['from']) . "\"";
+       if ($action['mime'])
+         $script .= " :mime";
+       if (strpos($action['reason'], "\n")!==false)
+         $script .= " text:\n" . $action['reason'] . "\n.\n;\n";
+       else
+         $script .= " \"" . $this->_escape_string($action['reason']) . "\";\n";
+         break;
+       }
+     
+     $script .= "}\n";
+   
+     if ($extension && !isset($exts[$extension]))
+       $exts[$extension] = $extension;
+   }
+      
+      // requires
+      if (sizeof($exts))
+        $script = 'require ["' . implode('","', $exts) . "\"];\n" . $script;
+
+      return $script;
+    }
+
+  /**
+    * Returns script object
+    *
+    */
+  public function as_array()
+    {
+      return $this->content;
+    }
+
+  /**
+    * Returns array of supported extensions
+    *
+    */
+  public function get_extensions()
+    {
+      return array_values($this->supported);
+    }
+
+  /**
+    * Converts text script to rules array
+    *
+    * @param   string  Text script
+    */
+  private function _parse_text($script)
+    {
+      $i = 0;
+      $content = array();
+
+      // remove C comments
+      $script = preg_replace('|/\*.*?\*/|sm', '', $script);
+
+      // tokenize rules
+      if ($tokens = preg_split('/(# rule:\[.*\])\n/', $script, -1, PREG_SPLIT_DELIM_CAPTURE))
+        foreach($tokens as $token)
+     {
+       if (preg_match('/^# rule:\[(.*)\]/', $token, $matches))
+         {
+           $content[$i]['name'] = $matches[1];
+         }
+       elseif (isset($content[$i]['name']) && sizeof($content[$i]) == 1)
+         {
+           if ($rule = $this->_tokenize_rule($token))
+         {
+               $content[$i] = array_merge($content[$i], $rule);
+               $i++;
+         }
+       else // unknown rule format
+           unset($content[$i]);
+         }
+     }
+
+      return $content;
+    }
+
+  /**
+    * Convert text script fragment to rule object
+    *
+    * @param   string  Text rule
+    */
+  private function _tokenize_rule($content)
+    {
+      $result = NULL;
+    
+      if (preg_match('/^(if|elsif|else)\s+((allof|anyof|exists|header|not|size)\s+(.*))\s+\{(.*)\}$/sm', trim($content), $matches))
+        {
+     list($tests, $join) = $this->_parse_tests(trim($matches[2]));
+     $actions = $this->_parse_actions(trim($matches[5]));
+
+     if ($tests && $actions)
+       $result = array(
+           'tests' => $tests,
+           'actions' => $actions,
+           'join' => $join,
+       );
+   }
+    
+      return $result;
+    }    
+
+  /**
+    * Parse body of actions section
+    *
+    * @param   string  Text body
+    * @return  array   Array of parsed action type/target pairs
+    */
+  private function _parse_actions($content)
+    {
+      $result = NULL;
+
+      // supported actions
+      $patterns[] = '^\s*discard;';
+      $patterns[] = '^\s*keep;';
+      $patterns[] = '^\s*stop;';
+      $patterns[] = '^\s*redirect\s+(.*?[^\\\]);';
+      if (in_array('fileinto', $this->supported))
+        $patterns[] = '^\s*fileinto\s+(.*?[^\\\]);';
+      if (in_array('reject', $this->supported)) {
+        $patterns[] = '^\s*reject\s+text:(.*)\n\.\n;';
+        $patterns[] = '^\s*reject\s+(.*?[^\\\]);';
+        $patterns[] = '^\s*ereject\s+text:(.*)\n\.\n;';
+        $patterns[] = '^\s*ereject\s+(.*?[^\\\]);';
+      }
+      if (in_array('vacation', $this->supported))
+        $patterns[] = '^\s*vacation\s+(.*?[^\\\]);';
+
+      $pattern = '/(' . implode('$)|(', $patterns) . '$)/ms';
+
+      // parse actions body
+      if (preg_match_all($pattern, $content, $mm, PREG_SET_ORDER))
+      {
+       foreach ($mm as $m)
+   {
+     $content = trim($m[0]);
+     
+         if(preg_match('/^(discard|keep|stop)/', $content, $matches))
+           {
+         $result[] = array('type' => $matches[1]);
+       }
+          elseif(preg_match('/^fileinto/', $content))
+           {
+         $result[] = array('type' => 'fileinto', 'target' => $this->_parse_string($m[sizeof($m)-1])); 
+       }
+          elseif(preg_match('/^redirect/', $content))
+           {
+         $result[] = array('type' => 'redirect', 'target' => $this->_parse_string($m[sizeof($m)-1])); 
+       }
+         elseif(preg_match('/^(reject|ereject)\s+(.*);$/sm', $content, $matches))
+           {
+         $result[] = array('type' => $matches[1], 'target' => $this->_parse_string($matches[2])); 
+       }
+          elseif(preg_match('/^vacation\s+(.*);$/sm', $content, $matches))
+            {
+         $vacation = array('type' => 'vacation');
+
+             if (preg_match('/:(days)\s+([0-9]+)/', $content, $vm)) {
+           $vacation['days'] = $vm[2];
+       $content = preg_replace('/:(days)\s+([0-9]+)/', '', $content); 
+         }
+             if (preg_match('/:(subject)\s+(".*?[^\\\]")/', $content, $vm)) {
+           $vacation['subject'] = $vm[2];
+       $content = preg_replace('/:(subject)\s+(".*?[^\\\]")/', '', $content); 
+         }
+             if (preg_match('/:(addresses)\s+\[(.*?[^\\\])\]/', $content, $vm)) {
+           $vacation['addresses'] = $this->_parse_list($vm[2]);
+       $content = preg_replace('/:(addresses)\s+\[(.*?[^\\\])\]/', '', $content); 
+         }
+             if (preg_match('/:(handle)\s+(".*?[^\\\]")/', $content, $vm)) {
+           $vacation['handle'] = $vm[2];
+       $content = preg_replace('/:(handle)\s+(".*?[^\\\]")/', '', $content); 
+         }
+             if (preg_match('/:(from)\s+(".*?[^\\\]")/', $content, $vm)) {
+           $vacation['from'] = $vm[2];
+       $content = preg_replace('/:(from)\s+(".*?[^\\\]")/', '', $content); 
+         }
+         $content = preg_replace('/^vacation/', '', $content);      
+         $content = preg_replace('/;$/', '', $content);
+         $content = trim($content);
+             if (preg_match('/^:(mime)/', $content, $vm)) {
+           $vacation['mime'] = true;
+       $content = preg_replace('/^:mime/', '', $content); 
+         }
+
+         $vacation['reason'] = $this->_parse_string($content);
+
+              $result[] = $vacation;
+            }
+        }
+      }
+
+      return $result;
+    }    
+    
+   /**
+    * Parse test/conditions section
+    *
+    * @param   string  Text 
+    */
+
+  private function _parse_tests($content)
+    {
+      $result = NULL;
+
+      // lists
+      if (preg_match('/^(allof|anyof)\s+\((.*)\)$/sm', $content, $matches))
+   {
+     $content = $matches[2];
+     $join = $matches[1]=='allof' ? true : false;
+   }
+      else
+     $join = false;
+      
+      // supported tests regular expressions
+      // TODO: comparators, envelope
+      $patterns[] = '(not\s+)?(exists)\s+\[(.*?[^\\\])\]';
+      $patterns[] = '(not\s+)?(exists)\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(true)';
+      $patterns[] = '(not\s+)?(size)\s+:(under|over)\s+([0-9]+[KGM]{0,1})';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+\[(.*?[^\\\]")\]\s+\[(.*?[^\\\]")\]';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+(".*?[^\\\]")\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+\[(.*?[^\\\]")\]\s+(".*?[^\\\]")';
+      $patterns[] = '(not\s+)?(header)\s+:(contains|is|matches)\s+(".*?[^\\\]")\s+\[(.*?[^\\\]")\]';
+      
+      // join patterns...
+      $pattern = '/(' . implode(')|(', $patterns) . ')/';
+
+      // ...and parse tests list
+      if (preg_match_all($pattern, $content, $matches, PREG_SET_ORDER))
+        {
+     foreach ($matches as $match)
+       {
+         $size = sizeof($match);
+         
+         if (preg_match('/^(not\s+)?size/', $match[0]))
+           {
+         $result[] = array(
+           'test'  => 'size',
+           'not'   => $match[$size-4] ? true : false,
+           'type'  => $match[$size-2], // under/over
+           'arg'   => $match[$size-1], // value
+         );
+       }
+         elseif (preg_match('/^(not\s+)?header/', $match[0]))
+           {
+         $result[] = array(
+           'test'  => 'header',
+           'not'   => $match[$size-5] ? true : false,
+           'type'  => $match[$size-3], // is/contains/matches
+           'arg1'  => $this->_parse_list($match[$size-2]), // header(s)
+           'arg2'  => $this->_parse_list($match[$size-1]), // string(s)
+         );  
+       }
+         elseif (preg_match('/^(not\s+)?exists/', $match[0]))
+       {
+         $result[] = array(
+           'test'  => 'exists',
+           'not'   => $match[$size-3] ? true : false,
+           'arg'   => $this->_parse_list($match[$size-1]), // header(s)
+         );
+           }
+         elseif (preg_match('/^(not\s+)?true/', $match[0]))
+       {
+         $result[] = array(
+           'test'  => 'true',
+           'not'   => $match[$size-2] ? true : false,
+         );
+           }
+       }
+   }
+
+      return array($result, $join);
+    }    
+
+   /**
+    * Parse string value
+    *
+    * @param   string  Text 
+    */
+  private function _parse_string($content)
+    {
+      $text = '';
+      $content = trim($content);
+
+      if (preg_match('/^text:(.*)\.$/sm', $content, $matches))
+        $text = trim($matches[1]);
+      elseif (preg_match('/^"(.*)"$/', $content, $matches))
+        $text = str_replace('\"', '"', $matches[1]);
+
+      return $text;
+    }    
+
+   /**
+    * Escape special chars in string value
+    *
+    * @param   string  Text 
+    */
+  private function _escape_string($content)
+    {
+      $replace['/"/'] = '\\"';
+      
+      if (is_array($content))
+        {
+     for ($x=0, $y=sizeof($content); $x<$y; $x++)
+       $content[$x] = preg_replace(array_keys($replace), array_values($replace), $content[$x]);
+        
+     return $content;
+   }
+      else
+        return preg_replace(array_keys($replace), array_values($replace), $content);
+    }
+
+   /**
+    * Parse string or list of strings to string or array of strings
+    *
+    * @param   string  Text 
+    */
+  private function _parse_list($content)
+    {
+      $result = array();
+      
+      for ($x=0, $len=strlen($content); $x<$len; $x++)
+        {
+     switch ($content[$x])
+       {
+         case '\\':
+           $str .= $content[++$x];
+              break;
+         case '"':
+           if (isset($str))
+             {
+           $result[] = $str;
+           unset($str);
+         }
+           else
+             $str = '';
+         break;
+         default:
+           if(isset($str))
+             $str .= $content[$x];
+         break;
+       }
+   }
+      
+      if (sizeof($result)>1)
+        return $result;
+      elseif (sizeof($result) == 1)
+   return $result[0];
+      else
+        return NULL;
+    }    
+
+   /**
+    * Convert array of elements to list of strings
+    *
+    * @param   string  Text 
+    */
+  private function _print_list($list)
+    {
+      $list = (array) $list;
+      foreach($list as $idx => $val)
+        $list[$idx] = $this->_escape_string($val);
+    
+      return '["' . implode('","', $list) . '"]';
+    }
+}
+
+?>
diff -ruNa rc-beta2-old/program/js/app.js rc-beta2/program/js/app.js
--- rc-beta2-old/program/js/app.js  2009-02-11 08:50:49.000000000 +0100
+++ rc-beta2/program/js/app.js  2009-03-01 15:23:00.047142288 +0100
@@ -288,6 +288,7 @@
 
       case 'settings':
         this.enable_command('preferences', 'identities', 'save', 'folders', true);
+        this.enable_command('managesieve', true);
         
         if (this.env.action=='identities' || this.env.action=='edit-identity' || this.env.action=='add-identity') {
           this.enable_command('add', this.env.identities_level < 2);
@@ -300,6 +301,23 @@
         if (this.env.action=='folders')
           this.enable_command('subscribe', 'unsubscribe', 'create-folder', 'rename-folder', 'delete-folder', true);
 
+       if (this.env.action=='managesieve')
+         {
+           if (!this.env.sieveconnerror)
+             this.enable_command('sievefilteradd', true);
+
+               if (this.gui_objects.filterslist)
+                 {
+               this.sievefilters_list = new rcube_list_widget(this.gui_objects.filterslist, {multiselect:false, draggable:false, keyboard:false});
+               this.sievefilters_list.addEventListener('select', function(o){ p.sievefilter_select(o); });
+               this.sievefilters_list.init();
+               this.sievefilters_list.focus();
+             }
+           
+           if (this.gui_objects.sieveform)
+             this.enable_command('sievefiltersave', true);
+         }
+   
         if (this.gui_objects.identitieslist)
           {
           this.identity_list = new rcube_list_widget(this.gui_objects.identitieslist, {multiselect:false, draggable:false, keyboard:false});
@@ -1062,6 +1080,30 @@
         this.delete_folder(props);
         break;
 
+      case 'managesieve':
+        this.goto_url('managesieve', '', true);
+        break;
+
+      case 'sievefiltersave':
+        this.sievefilter_save();
+        break;
+
+      case 'sievefilteradd':
+        this.sievefilter_add();
+        break;
+
+      case 'sievefilterdel':
+          this.sievefilter_del();
+        break;
+
+      case 'sievefilterup':
+        this.sievefilter_up();
+        break;
+
+      case 'sievefilterdown':
+        this.sievefilter_down();
+        break;
+
       }
 
     return obj ? false : true;
@@ -2800,6 +2842,347 @@
 
 
   /*********************************************************/
+  /*********     Managesieve filters methods       *********/
+  /*********************************************************/
+
+  this.sievefilter_add = function()
+    {
+      this.load_sievefilterframe();
+      this.sievefilters_list.clear_selection();
+    };
+
+  this.sievefilter_del = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+
+    if (confirm(this.get_label('filterconfirmdelete')))
+      this.http_request('managesieve',
+       '_act=delete&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_up = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    this.http_request('managesieve',
+           '_act=up&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_down = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    this.http_request('managesieve',
+           '_act=down&_fid='+this.sievefilters_list.rows[id].uid, true);
+    };
+
+  this.sievefilter_rowid = function(id)
+    {
+    var rows = this.sievefilters_list.rows;
+    
+    for (var i=0; i<rows.length; i++)
+      if (rows[i] != null && rows[i].uid == id)
+   return i;
+    }
+
+  this.sievefilter_updatelist = function(action, name, id)
+    {
+    this.set_busy(true);
+
+    switch (action)
+      {
+      case 'delete':
+        this.sievefilters_list.remove_row(this.sievefilter_rowid(id));
+   this.sievefilters_list.clear_selection();
+   this.enable_command('sievefilterdel', 'sievefilterup', 'sievefilterdown', false);
+   this.show_contentframe(false);
+
+   // re-numbering filters
+        var rows = this.sievefilters_list.rows;
+        for (var i=0; i<rows.length; i++)
+          {
+     if (rows[i] != null && rows[i].uid > id)
+       rows[i].uid = rows[i].uid-1;
+     }
+   break;
+
+      case 'down':
+        var rows = this.sievefilters_list.rows;
+   var from;
+
+   // we need only to replace filter names...
+        for (var i=0; i<rows.length; i++)
+        {
+     if (rows[i]==null) { // removed row
+       continue;
+          } else if (rows[i].uid == id) {
+       from = rows[i].obj.cells[0];
+     } else if (rows[i].uid == id+1){
+       name = rows[i].obj.cells[0].innerHTML;
+       rows[i].obj.cells[0].innerHTML = from.innerHTML;
+       from.innerHTML = name;
+       this.sievefilters_list.highlight_row(i);
+       break;
+     }
+   }
+   // ... and disable/enable Down button
+   this.sievefilter_listbuttons();
+        break;
+
+      case 'up':
+        var rows = this.sievefilters_list.rows;
+   var from;
+
+   // we need only to replace filter names...
+        for (var i=0; i<rows.length; i++)
+        {
+     if (rows[i]==null) { // removed row
+       continue;
+          } else if (rows[i].uid == id-1) {
+       from = rows[i].obj.cells[0];
+       this.sievefilters_list.highlight_row(i);
+     } else if (rows[i].uid == id) {
+       name = rows[i].obj.cells[0].innerHTML;
+       rows[i].obj.cells[0].innerHTML = from.innerHTML;
+       from.innerHTML = name;
+       break;
+     }
+   }
+   // ... and disable/enable Up button
+   this.sievefilter_listbuttons();
+        break;
+   
+      case 'update':
+        var rows = parent.rcmail.sievefilters_list.rows;
+        for (var i=0; i<rows.length; i++)
+     if (rows[i] && rows[i].uid == id)
+       {
+       rows[i].obj.cells[0].innerHTML = name;
+       break;
+       }
+        break;
+      
+      case 'add':
+        var row, new_row, td;
+   var list = parent.rcmail.sievefilters_list;
+
+   if (!list)
+          break;
+
+   for (var i=0; i<list.rows.length; i++)
+     if (list.rows[i] != null && String(list.rows[i].obj.id).match(/^rcmrow/))
+       row = list.rows[i].obj;
+
+        if (row)
+     {
+       new_row = parent.document.createElement('TR');
+       new_row.id = 'rcmrow'+id;
+           td = parent.document.createElement('TD');
+           new_row.appendChild(td);
+       list.insert_row(new_row, false);
+
+           if (row.cells[0].className)
+             td.className = row.cells[0].className;
+        
+           td.innerHTML = name;
+       list.highlight_row(id);
+
+       parent.rcmail.enable_command('sievefilterdel', 'sievefilterup', true);
+     }
+        else // refresh whole page
+     parent.rcmail.goto_url('managesieve');
+   break;
+      }
+
+    this.set_busy(false);
+
+    };
+
+  this.sievefilter_select = function(list)
+    {
+    var id = list.get_single_selection();
+    if (id != null)
+      this.load_sievefilterframe(list.rows[id].uid);
+    };
+
+  this.sievefilter_save = function()
+    {
+      if (parent.rcmail && parent.rcmail.sievefilters_list)
+        {
+        var id = parent.rcmail.sievefilters_list.get_single_selection();
+   if (id != null)
+     this.gui_objects.sieveform.elements['_fid'].value = parent.rcmail.sievefilters_list.rows[id].uid;
+        }
+      this.gui_objects.sieveform.submit();
+    };
+
+  // load filter frame
+  this.load_sievefilterframe = function(id)
+    {
+    if (typeof(id) != 'undefined' && id != null)
+      {
+      this.enable_command('sievefilterdel', true);
+      this.sievefilter_listbuttons();
+      }
+    else
+      this.enable_command('sievefilterup', 'sievefilterdown', 'sievefilterdel', false);
+
+    if (this.env.contentframe && window.frames && window.frames[this.env.contentframe])
+      {
+      target = window.frames[this.env.contentframe];
+      this.set_busy(true, 'loading');
+      target.location.href = this.env.comm_path+'&_action=managesieve&_framed=1&_fid='+id;
+      }
+    };
+
+  // enable/disable Up/Down buttons
+  this.sievefilter_listbuttons = function()
+    {
+    var id = this.sievefilters_list.get_single_selection();
+    var rows = this.sievefilters_list.rows;
+
+    for (var i=0; i<rows.length; i++)
+      {
+      if (rows[i] == null) { // removed row
+        } else if (i == id) {
+     this.enable_command('sievefilterup', false);
+     break;
+        } else {
+     this.enable_command('sievefilterup', true);
+     break;
+        }
+      }
+
+    for (var i=rows.length-1; i>0; i--)
+      {
+        if (rows[i] == null) { // removed row
+   } else if (i == id) {
+     this.enable_command('sievefilterdown', false);
+     break;
+   } else {
+     this.enable_command('sievefilterdown', true);
+     break;
+   }
+      } 
+    };
+
+  // operations on filters form
+  this.sievefilter_ruleadd = function(id)
+    {
+      this.http_post('managesieve', '_act=ruleadd&_rid='+id);
+    };
+
+  this.sievefilter_rulefill = function(content, id, after)
+    {
+      if (content != '')
+        {
+   // create new element
+   var div = document.getElementById('rules');
+   var row = document.createElement('div');
+
+   this.sievefilter_insertrow(div, row, after);
+   // fill row after inserting (for IE)
+   row.setAttribute('id', 'rulerow'+id);
+   row.className = 'rulerow';
+        row.innerHTML = content;
+
+   this.sievefilter_formbuttons(div);
+   }
+    };
+
+  this.sievefilter_ruledel = function(id)
+    {
+      if (confirm(this.get_label('ruledeleteconfirm')))
+   {
+   var row = document.getElementById('rulerow'+id);
+   row.parentNode.removeChild(row);
+   this.sievefilter_formbuttons(document.getElementById('rules'));
+   }
+    };
+
+  this.sievefilter_actionadd = function(id)
+    {
+      this.http_post('managesieve', '_act=actionadd&_aid='+id);
+    };
+
+  this.sievefilter_actionfill = function(content, id, after)
+    {
+      if (content != '')
+        {
+   var div = document.getElementById('actions');
+   var row = document.createElement('div');
+
+   this.sievefilter_insertrow(div, row, after);
+   // fill row after inserting (for IE)
+   row.className = 'actionrow';
+   row.setAttribute('id', 'actionrow'+id);
+        row.innerHTML = content;
+
+        this.sievefilter_formbuttons(div);
+   }
+    };
+
+  this.sievefilter_actiondel = function(id)
+    {
+      if (confirm(this.get_label('actiondeleteconfirm')))
+   {
+   var row = document.getElementById('actionrow'+id);
+   row.parentNode.removeChild(row);
+   this.sievefilter_formbuttons(document.getElementById('actions'));
+   }
+    };
+
+  // insert rule/action row in specified place on the list
+  this.sievefilter_insertrow = function(div, row, after)
+    {
+      for (var i=0; i<div.childNodes.length; i++)
+   {
+        if (div.childNodes[i].id == (div.id == 'rules' ? 'rulerow' : 'actionrow')  + after)
+     break;
+   }
+
+      if (div.childNodes[i+1])
+        div.insertBefore(row, div.childNodes[i+1]);
+      else
+        div.appendChild(row);
+    }
+
+  // update Delete buttons status
+  this.sievefilter_formbuttons = function(div)
+    {
+      var buttons = new Array();
+      var i, j=0;
+      // count and get buttons
+      for (i=0; i<div.childNodes.length; i++)
+   {
+   if (div.id == 'rules' && div.childNodes[i].id)
+     {
+     if (/rulerow/.test(div.childNodes[i].id))
+       buttons.push('ruledel' + div.childNodes[i].id.replace(/rulerow/, ''));
+     }
+   else if (div.childNodes[i].id)
+     {
+     if (/actionrow/.test(div.childNodes[i].id))
+       buttons.push( 'actiondel' + div.childNodes[i].id.replace(/actionrow/, ''));
+     }
+        }
+
+      for (i=0; i<buttons.length; i++)
+   {
+   var button = document.getElementById(buttons[i]);
+   if (i>0 || buttons.length>1)
+     {
+     this.set_classname(button, 'disabled', false);
+     button.removeAttribute('disabled');
+     }
+   else
+     {
+     this.set_classname(button, 'disabled', true);
+     button.setAttribute('disabled', true);
+     }
+        }
+    }
+    
+    
+  /*********************************************************/
   /*********        user settings methods          *********/
   /*********************************************************/
 
diff -ruNa rc-beta2-old/program/lib/Net/Sieve.php rc-beta2/program/lib/Net/Sieve.php
--- rc-beta2-old/program/lib/Net/Sieve.php  1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/program/lib/Net/Sieve.php  2009-02-11 08:59:02.576418179 +0100
@@ -0,0 +1,1149 @@
+<?php
+// +-----------------------------------------------------------------------+
+// | Copyright (c) 2002-2003, Richard Heyes                                |
+// | Copyright (c) 2006, Anish Mistry                                      |
+// | All rights reserved.                                                  |
+// |                                                                       |
+// | Redistribution and use in source and binary forms, with or without    |
+// | modification, are permitted provided that the following conditions    |
+// | are met:                                                              |
+// |                                                                       |
+// | o Redistributions of source code must retain the above copyright      |
+// |   notice, this list of conditions and the following disclaimer.       |
+// | o Redistributions in binary form must reproduce the above copyright   |
+// |   notice, this list of conditions and the following disclaimer in the |
+// |   documentation and/or other materials provided with the distribution.|
+// | o The names of the authors may not be used to endorse or promote      |
+// |   products derived from this software without specific prior written  |
+// |   permission.                                                         |
+// |                                                                       |
+// | THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS   |
+// | "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT     |
+// | LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR |
+// | A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  |
+// | OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, |
+// | SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT      |
+// | LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, |
+// | DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY |
+// | THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT   |
+// | (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE |
+// | OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  |
+// |                                                                       |
+// +-----------------------------------------------------------------------+
+// | Author: Richard Heyes <richard@phpguru.org>                           |
+// | Co-Author: Damian Fernandez Sosa <damlists@cnba.uba.ar>               |
+// | Co-Author: Anish Mistry <amistry@am-productions.biz>                  |
+// +-----------------------------------------------------------------------+
+
+require_once('Net/Socket.php');
+
+/**
+* TODO
+*
+* o supportsAuthMech()
+*/
+
+/**
+* Disconnected state
+* @const NET_SIEVE_STATE_DISCONNECTED
+*/
+define('NET_SIEVE_STATE_DISCONNECTED',  1, true);
+
+/**
+* Authorisation state
+* @const NET_SIEVE_STATE_AUTHORISATION
+*/
+define('NET_SIEVE_STATE_AUTHORISATION', 2, true);
+
+/**
+* Transaction state
+* @const NET_SIEVE_STATE_TRANSACTION
+*/
+define('NET_SIEVE_STATE_TRANSACTION',   3, true);
+
+/**
+* A class for talking to the timsieved server which
+* comes with Cyrus IMAP.
+*
+* SIEVE: RFC3028 http://www.ietf.org/rfc/rfc3028.txt
+* MANAGE-SIEVE: http://www.ietf.org/internet-drafts/draft-martin-managesieve-07.txt
+*
+* @author  Richard Heyes <richard@php.net>
+* @author  Damian Fernandez Sosa <damlists@cnba.uba.ar>
+* @author  Anish Mistry <amistry@am-productions.biz>
+* @access  public
+* @version 1.2.0
+* @package Net_Sieve
+*/
+
+class Net_Sieve
+{
+    /**
+    * The socket object
+    * @var object
+    */
+    var $_sock;
+
+    /**
+    * Info about the connect
+    * @var array
+    */
+    var $_data;
+
+    /**
+    * Current state of the connection
+    * @var integer
+    */
+    var $_state;
+
+    /**
+    * Constructor error is any
+    * @var object
+    */
+    var $_error;
+
+    /**
+    * To allow class debuging
+    * @var boolean
+    */
+    var $_debug = false;
+
+    /**
+    * Allows picking up of an already established connection
+    * @var boolean
+    */
+    var $_bypassAuth = false;
+
+    /**
+    * Whether to use TLS if available
+    * @var boolean
+    */
+    var $_useTLS = true;
+
+    /**
+    * The auth methods this class support
+    * @var array
+    */
+    var $supportedAuthMethods=array('DIGEST-MD5', 'CRAM-MD5', 'PLAIN' , 'LOGIN');
+    //if you have problems using DIGEST-MD5 authentication  please comment the line above and uncomment the following line
+    //var $supportedAuthMethods=array( 'CRAM-MD5', 'PLAIN' , 'LOGIN');
+
+    //var $supportedAuthMethods=array( 'PLAIN' , 'LOGIN');
+
+    /**
+    * The auth methods this class support
+    * @var array
+    */
+    var $supportedSASLAuthMethods=array('DIGEST-MD5', 'CRAM-MD5');
+
+    /**
+    * Handles posible referral loops
+    * @var array
+    */
+    var $_maxReferralCount = 15;
+
+    /**
+    * Constructor
+    * Sets up the object, connects to the server and logs in. stores
+    * any generated error in $this->_error, which can be retrieved
+    * using the getError() method.
+    *
+    * @param  string $user      Login username
+    * @param  string $pass      Login password
+    * @param  string $host      Hostname of server
+    * @param  string $port      Port of server
+    * @param  string $logintype Type of login to perform
+    * @param  string $euser     Effective User (if $user=admin, login as $euser)
+    * @param  string $bypassAuth Skip the authentication phase.  Useful if the socket
+                                  is already open.
+    * @param  boolean $useTLS Use TLS if available
+    */
+    function Net_Sieve($user = null , $pass  = null , $host = 'localhost', $port = 2000, $logintype = '', $euser = '', $debug = false, $bypassAuth = false, $useTLS = true)
+    {
+        $this->_state = NET_SIEVE_STATE_DISCONNECTED;
+        $this->_data['user'] = $user;
+        $this->_data['pass'] = $pass;
+        $this->_data['host'] = $host;
+        $this->_data['port'] = $port;
+        $this->_data['logintype'] = $logintype;
+        $this->_data['euser'] = $euser;
+        $this->_sock = &new Net_Socket();
+        $this->_debug = $debug;
+        $this->_bypassAuth = $bypassAuth;
+        $this->_useTLS = $useTLS;
+        /*
+        * Include the Auth_SASL package.  If the package is not available,
+        * we disable the authentication methods that depend upon it.
+        */
+        if ((@include_once 'Auth/SASL.php') === false) {
+            if($this->_debug){
+                echo "AUTH_SASL NOT PRESENT!\n";
+            }
+            foreach($this->supportedSASLAuthMethods as $SASLMethod){
+                $pos = array_search( $SASLMethod, $this->supportedAuthMethods );
+                if($this->_debug){
+                    echo "DISABLING METHOD $SASLMethod\n";
+                }
+                unset($this->supportedAuthMethods[$pos]);
+            }
+        }
+        if( ($user != null) && ($pass != null) ){
+            $this->_error = $this->_handleConnectAndLogin();
+        }
+    }
+
+    /**
+    * Handles the errors the class can find
+    * on the server
+    *
+    * @access private
+    * @param mixed $msg  Text error message or PEAR error object
+    * @param integer $code  Numeric error code
+    * @return PEAR_Error
+    */
+    function _raiseError($msg, $code)
+    {
+        include_once 'PEAR.php';
+        return PEAR::raiseError($msg, $code);
+    }
+
+    /**
+    * Handles connect and login.
+    * on the server
+    *
+    * @access private
+    * @return mixed Indexed array of scriptnames or PEAR_Error on failure
+    */
+    function _handleConnectAndLogin()
+    {
+        if (PEAR::isError($res = $this->connect($this->_data['host'] , $this->_data['port'], null, $this->_useTLS ))) {
+            return $res;
+        }
+        if($this->_bypassAuth === false) {
+           if (PEAR::isError($res = $this->login($this->_data['user'], $this->_data['pass'], $this->_data['logintype'] , $this->_data['euser'] , $this->_bypassAuth) ) ) {
+                return $res;
+            }
+        }
+        return true;
+    }
+
+    /**
+    * Returns an indexed array of scripts currently
+    * on the server
+    *
+    * @return mixed Indexed array of scriptnames or PEAR_Error on failure
+    */
+    function listScripts()
+    {
+        if (is_array($scripts = $this->_cmdListScripts())) {
+            $this->_active = $scripts[1];
+            return $scripts[0];
+        } else {
+            return $scripts;
+        }
+    }
+
+    /**
+    * Returns the active script
+    *
+    * @return mixed The active scriptname or PEAR_Error on failure
+    */
+    function getActive()
+    {
+        if (!empty($this->_active)) {
+            return $this->_active;
+
+        } elseif (is_array($scripts = $this->_cmdListScripts())) {
+            $this->_active = $scripts[1];
+            return $scripts[1];
+        }
+    }
+
+    /**
+    * Sets the active script
+    *
+    * @param  string $scriptname The name of the script to be set as active
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function setActive($scriptname)
+    {
+        return $this->_cmdSetActive($scriptname);
+    }
+
+    /**
+    * Retrieves a script
+    *
+    * @param  string $scriptname The name of the script to be retrieved
+    * @return mixed              The script on success, PEAR_Error on failure
+    */
+    function getScript($scriptname)
+    {
+        return $this->_cmdGetScript($scriptname);
+    }
+
+    /**
+    * Adds a script to the server
+    *
+    * @param  string $scriptname Name of the script
+    * @param  string $script     The script
+    * @param  boolean $makeactive Whether to make this the active script
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function installScript($scriptname, $script, $makeactive = false)
+    {
+        if (PEAR::isError($res = $this->_cmdPutScript($scriptname, $script))) {
+            return $res;
+
+        } elseif ($makeactive) {
+            return $this->_cmdSetActive($scriptname);
+
+        } else {
+            return true;
+        }
+    }
+
+    /**
+    * Removes a script from the server
+    *
+    * @param  string $scriptname Name of the script
+    * @return mixed              True on success, PEAR_Error on failure
+    */
+    function removeScript($scriptname)
+    {
+        return $this->_cmdDeleteScript($scriptname);
+    }
+
+    /**
+    * Returns any error that may have been generated in the
+    * constructor
+    *
+    * @return mixed False if no error, PEAR_Error otherwise
+    */
+    function getError()
+    {
+        return PEAR::isError($this->_error) ? $this->_error : false;
+    }
+
+    /**
+    * Handles connecting to the server and checking the
+    * response is valid.
+    *
+    * @access private
+    * @param  string $host Hostname of server
+    * @param  string $port Port of server
+    * @param  array  $options List of options to pass to connect
+    * @param  boolean $useTLS Use TLS if available
+    * @return mixed        True on success, PEAR_Error otherwise
+    */
+    function connect($host, $port, $options = null, $useTLS = true)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED != $this->_state) {
+            $msg='Not currently in DISCONNECTED state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_sock->connect($host, $port, false, 5, $options))) {
+            return $res;
+        }
+
+        if($this->_bypassAuth === false) {
+            $this->_state = NET_SIEVE_STATE_AUTHORISATION;
+            if (PEAR::isError($res = $this->_doCmd())) {
+                return $res;
+            }
+        } else {
+            $this->_state = NET_SIEVE_STATE_TRANSACTION;
+        }
+
+        // Explicitly ask for the capabilities in case the connection
+        // is picked up from an existing connection.
+        if(PEAR::isError($res = $this->_cmdCapability() )) {
+            $msg='Failed to connect, server said: ' . $res->getMessage();
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+
+        // Get logon greeting/capability and parse
+        $this->_parseCapability($res);
+
+        if($useTLS === true) {
+            // check if we can enable TLS via STARTTLS
+            if(isset($this->_capability['starttls']) && function_exists('stream_socket_enable_crypto') === true) {
+                if (PEAR::isError($res = $this->_startTLS())) {
+                    return $res;
+                }
+            }
+        }
+
+        return true;
+    }
+
+    /**
+    * Logs into server.
+    *
+    * @param  string  $user          Login username
+    * @param  string  $pass          Login password
+    * @param  string  $logintype     Type of login method to use
+    * @param  string  $euser         Effective UID (perform on behalf of $euser)
+    * @param  boolean $bypassAuth    Do not perform authentication
+    * @return mixed                  True on success, PEAR_Error otherwise
+    */
+    function login($user, $pass, $logintype = null , $euser = '', $bypassAuth = false)
+    {
+        if (NET_SIEVE_STATE_AUTHORISATION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if( $bypassAuth === false ){
+            if(PEAR::isError($res=$this->_cmdAuthenticate($user , $pass , $logintype, $euser ) ) ){
+                return $res;
+            }
+        }
+        $this->_state = NET_SIEVE_STATE_TRANSACTION;
+        return true;
+    }
+
+    /**
+     * Handles the authentication using any known method
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $userMethod The method to use ( if $userMethod == '' then the class chooses the best method (the stronger is the best ) )
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return mixed  string or PEAR_Error
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _cmdAuthenticate($uid , $pwd , $userMethod = null , $euser = '' )
+    {
+        if ( PEAR::isError( $method = $this->_getBestAuthMethod($userMethod) ) ) {
+            return $method;
+        }
+        switch ($method) {
+            case 'DIGEST-MD5':
+                $result = $this->_authDigest_MD5( $uid , $pwd , $euser );
+                return $result;
+                break;
+            case 'CRAM-MD5':
+                $result = $this->_authCRAM_MD5( $uid , $pwd, $euser);
+                break;
+            case 'LOGIN':
+                $result = $this->_authLOGIN( $uid , $pwd , $euser );
+                break;
+            case 'PLAIN':
+                $result = $this->_authPLAIN( $uid , $pwd , $euser );
+                break;
+            default :
+                $result = new PEAR_Error( "$method is not a supported authentication method" );
+                break;
+        }
+
+        if (PEAR::isError($res = $this->_doCmd() )) {
+            return $res;
+        }
+        return $result;
+    }
+
+    /**
+     * Authenticates the user using the PLAIN method.
+     *
+     * @param string $user The userid to authenticate as.
+     * @param string $pass The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authPLAIN($user, $pass , $euser )
+    {
+        if ($euser != '') {
+            $cmd=sprintf('AUTHENTICATE "PLAIN" "%s"', base64_encode($euser . chr(0) . $user . chr(0) . $pass ) ) ;
+        } else {
+            $cmd=sprintf('AUTHENTICATE "PLAIN" "%s"', base64_encode( chr(0) . $user . chr(0) . $pass ) );
+        }
+        return  $this->_sendCmd( $cmd ) ;
+    }
+
+    /**
+     * Authenticates the user using the PLAIN method.
+     *
+     * @param string $user The userid to authenticate as.
+     * @param string $pass The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authLOGIN($user, $pass , $euser )
+    {
+        $this->_sendCmd('AUTHENTICATE "LOGIN"');
+        $this->_doCmd(sprintf('"%s"', base64_encode($user)));
+        $this->_doCmd(sprintf('"%s"', base64_encode($pass)));
+    }
+
+    /**
+     * Authenticates the user using the CRAM-MD5 method.
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authCRAM_MD5($uid, $pwd, $euser)
+    {
+        if ( PEAR::isError( $challenge = $this->_doCmd( 'AUTHENTICATE "CRAM-MD5"' ) ) ) {
+            $this->_error=$challenge;
+            return $challenge;
+        }
+        $challenge=trim($challenge);
+        $challenge = base64_decode( trim($challenge) );
+        $cram = &Auth_SASL::factory('crammd5');
+        if ( PEAR::isError($resp=$cram->getResponse( $uid , $pwd , $challenge ) ) ) {
+            $this->_error=$resp;
+            return $resp;
+        }
+        $auth_str = base64_encode( $resp );
+        if ( PEAR::isError($error = $this->_sendStringResponse( $auth_str  ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+    }
+
+    /**
+     * Authenticates the user using the DIGEST-MD5 method.
+     *
+     * @param string $uid The userid to authenticate as.
+     * @param string $pwd The password to authenticate with.
+     * @param string $euser The effective uid to authenticate as.
+     *
+     * @return array Returns an array containing the response
+     *
+     * @access private
+     * @since  1.0
+     */
+    function _authDigest_MD5($uid, $pwd, $euser)
+    {
+        if ( PEAR::isError( $challenge = $this->_doCmd('AUTHENTICATE "DIGEST-MD5"') ) ) {
+            $this->_error= $challenge;
+            return $challenge;
+        }
+        $challenge = base64_decode( $challenge );
+        $digest = &Auth_SASL::factory('digestmd5');
+
+        if(PEAR::isError($param=$digest->getResponse($uid, $pwd, $challenge, "localhost", "sieve" , $euser) )) {
+            return $param;
+        }
+        $auth_str = base64_encode($param);
+
+        if ( PEAR::isError($error = $this->_sendStringResponse( $auth_str  ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+        if ( PEAR::isError( $challenge = $this->_doCmd() ) ) {
+            $this->_error=$challenge ;
+            return $challenge ;
+        }
+
+        if( strtoupper(substr($challenge,0,2))== 'OK' ){
+                return true;
+        }
+
+        /**
+        * We don't use the protocol's third step because SIEVE doesn't allow
+        * subsequent authentication, so we just silently ignore it.
+        */
+        if ( PEAR::isError($error = $this->_sendStringResponse( '' ) ) ) {
+            $this->_error=$error;
+            return $error;
+        }
+
+        if (PEAR::isError($res = $this->_doCmd() )) {
+            return $res;
+        }
+    }
+
+    /**
+    * Removes a script from the server
+    *
+    * @access private
+    * @param  string $scriptname Name of the script to delete
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdDeleteScript($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+        if (PEAR::isError($res = $this->_doCmd(sprintf('DELETESCRIPT "%s"', $scriptname) ) )) {
+            return $res;
+        }
+        return true;
+    }
+
+    /**
+    * Retrieves the contents of the named script
+    *
+    * @access private
+    * @param  string $scriptname Name of the script to retrieve
+    * @return mixed              The script if successful, PEAR_Error otherwise
+    */
+    function _cmdGetScript($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('GETSCRIPT "%s"', $scriptname) ) ) ) {
+            return $res;
+        }
+
+        return preg_replace('/{[0-9]+}\r\n/', '', $res);
+    }
+
+    /**
+    * Sets the ACTIVE script, ie the one that gets run on new mail
+    * by the server
+    *
+    * @access private
+    * @param  string $scriptname The name of the script to mark as active
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdSetActive($scriptname)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('SETACTIVE "%s"', $scriptname) ) ) ) {
+            return $res;
+        }
+
+        $this->_activeScript = $scriptname;
+        return true;
+    }
+
+    /**
+    * Sends the LISTSCRIPTS command
+    *
+    * @access private
+    * @return mixed Two item array of scripts, and active script on success,
+    *               PEAR_Error otherwise.
+    */
+    function _cmdListScripts()
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in AUTHORISATION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        $scripts = array();
+        $activescript = null;
+
+        if (PEAR::isError($res = $this->_doCmd('LISTSCRIPTS'))) {
+            return $res;
+        }
+
+        $res = explode("\r\n", $res);
+
+        foreach ($res as $value) {
+            if (preg_match('/^"(.*)"( ACTIVE)?$/i', $value, $matches)) {
+                $scripts[] = $matches[1];
+                if (!empty($matches[2])) {
+                    $activescript = $matches[1];
+                }
+            }
+        }
+
+        return array($scripts, $activescript);
+    }
+
+    /**
+    * Sends the PUTSCRIPT command to add a script to
+    * the server.
+    *
+    * @access private
+    * @param  string $scriptname Name of the new script
+    * @param  string $scriptdata The new script
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function _cmdPutScript($scriptname, $scriptdata)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in TRANSACTION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        $stringLength = $this->_getLineLength($scriptdata);
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf("PUTSCRIPT \"%s\" {%d+}\r\n%s", $scriptname, $stringLength, $scriptdata) ))) {
+            return $res;
+        }
+
+        return true;
+    }
+
+    /**
+    * Sends the LOGOUT command and terminates the connection
+    *
+    * @access private
+    * @param boolean $sendLogoutCMD True to send LOGOUT command before disconnecting
+    * @return mixed True on success, PEAR_Error otherwise
+    */
+    function _cmdLogout($sendLogoutCMD=true)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+            //return PEAR::raiseError('Not currently connected');
+        }
+
+        if($sendLogoutCMD){
+            if (PEAR::isError($res = $this->_doCmd('LOGOUT'))) {
+                return $res;
+            }
+        }
+
+        $this->_sock->disconnect();
+        $this->_state = NET_SIEVE_STATE_DISCONNECTED;
+        return true;
+    }
+
+    /**
+    * Sends the CAPABILITY command
+    *
+    * @access private
+    * @return mixed True on success, PEAR_Error otherwise
+    */
+    function _cmdCapability()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd('CAPABILITY'))) {
+            return $res;
+        }
+        $this->_parseCapability($res);
+        return true;
+    }
+
+    /**
+    * Checks if the server has space to store the script
+    * by the server
+    *
+    * @param  string $scriptname The name of the script to mark as active
+    * @param integer $size The size of the script
+    * @return mixed              True on success, PEAR_Error otherwise
+    */
+    function haveSpace($scriptname,$size)
+    {
+        if (NET_SIEVE_STATE_TRANSACTION != $this->_state) {
+            $msg='Not currently in TRANSACTION state';
+            $code=1;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if (PEAR::isError($res = $this->_doCmd(sprintf('HAVESPACE "%s" %d', $scriptname, $size) ) ) ) {
+            return $res;
+        }
+
+        return true;
+    }
+
+    /**
+    * Parses the response from the capability command. Stores
+    * the result in $this->_capability
+    *
+    * @access private
+    * @param string $data The response from the capability command
+    */
+    function _parseCapability($data)
+    {
+        $data = preg_split('/\r?\n/', $data, -1, PREG_SPLIT_NO_EMPTY);
+
+        for ($i = 0; $i < count($data); $i++) {
+            if (preg_match('/^"([a-z]+)"( "(.*)")?$/i', $data[$i], $matches)) {
+                switch (strtolower($matches[1])) {
+                    case 'implementation':
+                        $this->_capability['implementation'] = $matches[3];
+                        break;
+
+                    case 'sasl':
+                        $this->_capability['sasl'] = preg_split('/\s+/', $matches[3]);
+                        break;
+
+                    case 'sieve':
+                        $this->_capability['extensions'] = preg_split('/\s+/', $matches[3]);
+                        break;
+
+                    case 'starttls':
+                        $this->_capability['starttls'] = true;
+                        break;
+                }
+            }
+        }
+    }
+
+    /**
+    * Sends a command to the server
+    *
+    * @access private
+    * @param string $cmd The command to send
+    */
+    function _sendCmd($cmd)
+    {
+        $status = $this->_sock->getStatus();
+        if (PEAR::isError($status) || $status['eof']) {
+            return new PEAR_Error( 'Failed to write to socket: (connection lost!) ' );
+        }
+        if ( PEAR::isError( $error = $this->_sock->write( $cmd . "\r\n" ) ) ) {
+            return new PEAR_Error( 'Failed to write to socket: ' . $error->getMessage() );
+        }
+
+        if( $this->_debug ){
+            // C: means this data was sent by  the client (this class)
+            echo "C:$cmd\n";
+        }
+        return true;
+    }
+
+    /**
+    * Sends a string response to the server
+    *
+    * @access private
+    * @param string $cmd The command to send
+    */
+    function _sendStringResponse($str)
+    {
+        $response='{' .  $this->_getLineLength($str) . "+}\r\n" . $str  ;
+        return $this->_sendCmd($response);
+    }
+
+    function _recvLn()
+    {
+        $lastline='';
+        if (PEAR::isError( $lastline = $this->_sock->gets( 8192 ) ) ) {
+            return new PEAR_Error( 'Failed to write to socket: ' . $lastline->getMessage() );
+        }
+        $lastline=rtrim($lastline);
+        if($this->_debug){
+            // S: means this data was sent by  the IMAP Server
+            echo "S:$lastline\n" ;
+        }
+
+        if( $lastline === '' ) {
+            return new PEAR_Error( 'Failed to receive from the socket' );
+        }
+
+        return $lastline;
+    }
+
+    /**
+    * Send a command and retrieves a response from the server.
+    *
+    *
+    * @access private
+    * @param string $cmd The command to send
+    * @return mixed Reponse string if an OK response, PEAR_Error if a NO response
+    */
+    function _doCmd($cmd = '' )
+    {
+        $referralCount=0;
+        while($referralCount < $this->_maxReferralCount ){
+
+            if($cmd != '' ){
+                if(PEAR::isError($error = $this->_sendCmd($cmd) )) {
+                    return $error;
+                }
+            }
+            $response = '';
+
+            while (true) {
+                    if(PEAR::isError( $line=$this->_recvLn() )){
+                        return $line;
+                    }
+                    if ('ok' === strtolower(substr($line, 0, 2))) {
+                        $response .= $line;
+                        return rtrim($response);
+
+                    } elseif ('no' === strtolower(substr($line, 0, 2))) {
+                        // Check for string literal error message
+                        if (preg_match('/^no {([0-9]+)\+?}/i', $line, $matches)) {
+                            $line .= str_replace("\r\n", ' ', $this->_sock->read($matches[1] + 2 ));
+                            if($this->_debug){
+                                echo "S:$line\n";
+                            }
+                        }
+                        $msg=trim($response . substr($line, 2));
+                        $code=3;
+                        return $this->_raiseError($msg,$code);
+                    } elseif ('bye' === strtolower(substr($line, 0, 3))) {
+
+                        if(PEAR::isError($error = $this->disconnect(false) ) ){
+                            $msg="Can't handle bye, The error was= " . $error->getMessage() ;
+                            $code=4;
+                            return $this->_raiseError($msg,$code);
+                        }
+                        //if (preg_match('/^bye \(referral "([^"]+)/i', $line, $matches)) {
+                        if (preg_match('/^bye \(referral "(sieve:\/\/)?([^"]+)/i', $line, $matches)) {
+                            // Check for referral, then follow it.  Otherwise, carp an error.
+                            // Replace the old host with the referral host preserving any protocol prefix
+                            $this->_data['host'] = preg_replace('/\w+(?!(\w|\:\/\/)).*/',$matches[2],$this->_data['host']);
+                           if (PEAR::isError($error = $this->_handleConnectAndLogin() ) ){
+                                $msg="Can't follow referral to " . $this->_data['host'] . ", The error was= " . $error->getMessage() ;
+                                $code=5;
+                                return $this->_raiseError($msg,$code);
+                            }
+                            break;
+                            // Retry the command
+                            if(PEAR::isError($error = $this->_sendCmd($cmd) )) {
+                                return $error;
+                            }
+                            continue;
+                        }
+                        $msg=trim($response . $line);
+                        $code=6;
+                        return $this->_raiseError($msg,$code);
+                    } elseif (preg_match('/^{([0-9]+)\+?}/i', $line, $matches)) {
+                        // Matches String Responses.
+                        //$line = str_replace("\r\n", ' ', $this->_sock->read($matches[1] + 2 ));
+                        $str_size = $matches[1] + 2;
+                        $line = '';
+                        $line_length = 0;
+                        while ($line_length < $str_size) {
+                            $line .= $this->_sock->read($str_size - $line_length);
+                            $line_length = $this->_getLineLength($line);
+                        }
+                        if($this->_debug){
+                            echo "S:$line\n";
+                        }
+                        if($this->_state != NET_SIEVE_STATE_AUTHORISATION) {
+                            // receive the pending OK only if we aren't authenticating
+                            // since string responses during authentication don't need an
+                            // OK.
+                            $this->_recvLn();
+                        }
+                        return $line;
+                    }
+                    $response .= $line . "\r\n";
+                    $referralCount++;
+                }
+        }
+        $msg="Max referral count reached ($referralCount times) Cyrus murder loop error?";
+        $code=7;
+        return $this->_raiseError($msg,$code);
+    }
+
+    /**
+    * Sets the debug state
+    *
+    * @param boolean $debug
+    * @return void
+    */
+    function setDebug($debug = true)
+    {
+        $this->_debug = $debug;
+    }
+
+    /**
+    * Disconnect from the Sieve server
+    *
+    * @param  string $scriptname The name of the script to be set as active
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function disconnect($sendLogoutCMD=true)
+    {
+        return $this->_cmdLogout($sendLogoutCMD);
+    }
+
+    /**
+     * Returns the name of the best authentication method that the server
+     * has advertised.
+     *
+     * @param string if !=null,authenticate with this method ($userMethod).
+     *
+     * @return mixed    Returns a string containing the name of the best
+     *                  supported authentication method or a PEAR_Error object
+     *                  if a failure condition is encountered.
+     * @access private
+     * @since  1.0
+     */
+    function _getBestAuthMethod($userMethod = null)
+    {
+       if( isset($this->_capability['sasl']) ){
+           $serverMethods=$this->_capability['sasl'];
+       }else{
+           // if the server don't send an sasl capability fallback to login auth
+           //return 'LOGIN';
+           return new PEAR_Error("This server don't support any Auth methods SASL problem?");
+       }
+
+        if($userMethod != null ){
+            $methods = array();
+            $methods[] = $userMethod;
+        }else{
+
+            $methods = $this->supportedAuthMethods;
+        }
+        if( ($methods != null) && ($serverMethods != null)){
+            foreach ( $methods as $method ) {
+                if ( in_array( $method , $serverMethods ) ) {
+                    return $method;
+                }
+            }
+            $serverMethods=implode(',' , $serverMethods );
+            $myMethods=implode(',' ,$this->supportedAuthMethods);
+            return new PEAR_Error("$method NOT supported authentication method!. This server " .
+                "supports these methods= $serverMethods, but I support $myMethods");
+        }else{
+            return new PEAR_Error("This server don't support any Auth methods");
+        }
+    }
+
+    /**
+    * Return the list of extensions the server supports
+    *
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function getExtensions()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+
+        return $this->_capability['extensions'];
+    }
+
+    /**
+    * Return true if tyhe server has that extension
+    *
+    * @param string  the extension to compare
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function hasExtension($extension)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if(is_array($this->_capability['extensions'] ) ){
+            foreach( $this->_capability['extensions'] as $ext){
+                if( trim( strtolower( $ext ) ) === trim( strtolower( $extension ) ) )
+                    return true;
+            }
+        }
+        return false;
+    }
+
+    /**
+    * Return the list of auth methods the server supports
+    *
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function getAuthMechs()
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+        }
+        if(!isset($this->_capability['sasl']) ){
+            $this->_capability['sasl']=array();
+        }
+        return $this->_capability['sasl'];
+    }
+
+    /**
+    * Return true if the server has that extension
+    *
+    * @param string  the extension to compare
+    * @return mixed              array  on success, PEAR_Error on failure
+    */
+    function hasAuthMech($method)
+    {
+        if (NET_SIEVE_STATE_DISCONNECTED === $this->_state) {
+            $msg='Not currently connected';
+            $code=7;
+            return $this->_raiseError($msg,$code);
+            //return PEAR::raiseError('Not currently connected');
+        }
+
+        if(is_array($this->_capability['sasl'] ) ){
+            foreach( $this->_capability['sasl'] as $ext){
+                if( trim( strtolower( $ext ) ) === trim( strtolower( $method ) ) )
+                    return true;
+            }
+        }
+        return false;
+    }
+
+    /**
+    * Return true if the TLS negotiation was successful
+    *
+    * @access private
+    * @return mixed              true on success, PEAR_Error on failure
+    */
+    function _startTLS()
+    {
+        if (PEAR::isError($res = $this->_doCmd("STARTTLS"))) {
+            return $res;
+        }
+   
+        if(stream_socket_enable_crypto($this->_sock->fp, true, STREAM_CRYPTO_METHOD_TLS_CLIENT) == false) {
+            $msg='Failed to establish TLS connection';
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+
+        if($this->_debug === true) {
+            echo "STARTTLS Negotiation Successful\n";
+        }
+
+        // RFC says we need to query the server capabilities again
+        if(PEAR::isError($res = $this->_cmdCapability() )) {
+            $msg='Failed to connect, server said: ' . $res->getMessage();
+            $code=2;
+            return $this->_raiseError($msg,$code);
+        }
+        return true;
+    }
+
+    function _getLineLength($string) {
+        if (extension_loaded('mbstring') || @dl(PHP_SHLIB_PREFIX.'mbstring.'.PHP_SHLIB_SUFFIX)) {
+          return mb_strlen($string,'latin1');
+        } else {
+          return strlen($string);
+        }
+    }
+}
+?>
diff -ruNa rc-beta2-old/program/localization/bg_BG/labels.inc rc-beta2/program/localization/bg_BG/labels.inc
--- rc-beta2-old/program/localization/bg_BG/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/bg_BG/labels.inc  2009-02-11 09:01:46.251824143 +0100
@@ -257,4 +257,37 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = '';
+$labels['managefilters'] = '     ';
+$labels['filtername'] = '  ';
+$labels['newfilter'] = ' ';
+$labels['filteradd'] = '  ';
+$labels['filterdel'] = '  ';
+$labels['moveup'] = ' ';
+$labels['movedown'] = ' ';
+$labels['filterallof'] = '    ';
+$labels['filteranyof'] = '     ';
+$labels['filterany'] = ' ';
+$labels['filtercontains'] = '';
+$labels['filternotcontains'] = ' ';
+$labels['filteris'] = '  ';
+$labels['filterisnot'] = '   ';
+$labels['filterexists'] = '';
+$labels['filternotexists'] = ' ';
+$labels['filterunder'] = '';
+$labels['filterover'] = '';
+$labels['addrule'] = '  ';
+$labels['delrule'] = '  ';
+$labels['messagemoveto'] = '   ';
+$labels['messageredirect'] = '   ';
+$labels['messagereply'] = '  ';
+$labels['messagedelete'] = '  ';
+$labels['messagediscard'] = '  ';
+$labels['messagesrules'] = '  :';
+$labels['messagesactions'] = '...   ';
+$labels['add'] = '';
+$labels['del'] = '';
+$labels['sender'] = '';
+$labels['recipient'] = '';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/bg_BG/messages.inc rc-beta2/program/localization/bg_BG/messages.inc
--- rc-beta2-old/program/localization/bg_BG/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/bg_BG/messages.inc    2009-02-11 09:01:37.707685875 +0100
@@ -96,4 +96,16 @@
 $messages['nofromaddress'] = ' e-mail    ';
 $messages['editorwarning'] = '             .   ,    ?';
 
+$messages['filterunknownerror'] = '   ';
+$messages['filterconnerror'] = '    managesieve  ';
+$messages['filterdeleteerror'] = '    .  ';
+$messages['filterdeleted'] = '   ';
+$messages['filterconfirmdelete'] = '      ?';
+$messages['filtersaved'] = '   ';
+$messages['filtersaveerror'] = '     .  .';
+$messages['ruledeleteconfirm'] = '  ,      ?';
+$messages['actiondeleteconfirm'] = '  ,      ?';
+$messages['forbiddenchars'] = '   ';
+$messages['cannotbeempty'] = '     ';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/de_DE/labels.inc rc-beta2/program/localization/de_DE/labels.inc
--- rc-beta2-old/program/localization/de_DE/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/de_DE/labels.inc  2009-02-11 08:59:02.592418514 +0100
@@ -264,4 +264,36 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = 'Filter';
+$labels['managefilters'] = 'Verwalte eingehende Nachrichtenfilter';
+$labels['filtername'] = 'Filtername';
+$labels['newfilter'] = 'Neuer Filter';
+$labels['filteradd'] = 'Filter hinzufgen';
+$labels['filterdel'] = 'Filter lschen';
+$labels['moveup'] = 'Nach oben';
+$labels['movedown'] = 'Nach unten';
+$labels['filterallof'] = 'trifft auf alle folgenden Regeln zu';
+$labels['filteranyof'] = 'trifft auf eine der folgenden Regeln zu';
+$labels['filterany'] = 'alle Nachrichten';
+$labels['filtercontains'] = 'enthlt';
+$labels['filternotcontains'] = 'enthlt nicht';
+$labels['filteris'] = 'ist gleich';
+$labels['filterisnot'] = 'ist ungleich';
+$labels['filterexists'] = 'vorhanden';
+$labels['filternotexists'] = 'nicht vorhanden';
+$labels['filterunder'] = 'unter';
+$labels['filterover'] = 'ber';
+$labels['addrule'] = 'Regel hinzufgen';
+$labels['delrule'] = 'Regel lschen';
+$labels['messagemoveto'] = 'Verschiebe Nachricht nach';
+$labels['messageredirect'] = 'Leite Nachricht um nach';
+$labels['messagereply'] = 'Antworte mit Nachricht';
+$labels['messagedelete'] = 'Nachricht lschen';
+$labels['messagediscard'] = 'Discard with message';
+$labels['messagesrules'] = 'Fr eingehende Nachrichten:';
+$labels['messagesactions'] = '...fhre folgende Aktionen aus:';
+$labels['add'] = 'Hinzufgen';
+$labels['del'] = 'Lschen';
+$labels['sender'] = 'Absender';
+$labels['recipient'] = 'Empfnger';
 ?>
diff -ruNa rc-beta2-old/program/localization/de_DE/messages.inc rc-beta2/program/localization/de_DE/messages.inc
--- rc-beta2-old/program/localization/de_DE/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/de_DE/messages.inc    2009-02-11 08:59:02.608418009 +0100
@@ -95,4 +95,16 @@
 $messages['nofromaddress'] = 'Fehlende E-Mail-Adresse in ausgewhlter Identitt';
 $messages['editorwarning'] = 'Beim Wechseln in den Texteditor gehen alle Textformatierungen verloren. Mchten Sie fortfahren?';
 
+$messages['filterunknownerror'] = 'Unbekannter Serverfehler';
+$messages['filterconnerror'] = 'Kann nicht zum Sieve-Server verbinden';
+$messages['filterdeleteerror'] = 'Fehler beim des lschen  Filters. Serverfehler';
+$messages['filterdeleted'] = 'Filter erfolgreich gelscht';
+$messages['filterconfirmdelete'] = 'Mchten Sie den Filter lschen ?';
+$messages['filtersaved'] = 'Filter gespeichert';
+$messages['filtersaveerror'] = 'Serverfehler, konnte den Filter nicht speichern.';
+$messages['ruledeleteconfirm'] = 'Sicher, dass Sie die Regel lschen wollen?';
+$messages['actiondeleteconfirm'] = 'Sicher, dass Sie die ausgewaehlte Aktion lschen wollen?';
+$messages['forbiddenchars'] = 'Unerlaubte Zeichen im Feld';
+$messages['cannotbeempty'] = 'Feld darf nicht leer sein';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/en_US/labels.inc rc-beta2/program/localization/en_US/labels.inc
--- rc-beta2-old/program/localization/en_US/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/en_US/labels.inc  2009-02-24 12:57:54.884558014 +0100
@@ -323,4 +323,43 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = 'Filters';
+$labels['managefilters'] = 'Manage incoming mail filters';
+$labels['filtername'] = 'Filter name';
+$labels['newfilter'] = 'New filter';
+$labels['filteradd'] = 'Add filter';
+$labels['filterdel'] = 'Delete filter';
+$labels['moveup'] = 'Move up';
+$labels['movedown'] = 'Move down';
+$labels['filterallof'] = 'matching all of the following rules';
+$labels['filteranyof'] = 'matching any of the following rules';
+$labels['filterany'] = 'all messages';
+$labels['filtercontains'] = 'contains';
+$labels['filternotcontains'] = 'not contains';
+$labels['filteris'] = 'is equal to';
+$labels['filterisnot'] = 'is not equal to';
+$labels['filterexists'] = 'exists';
+$labels['filternotexists'] = 'not exists';
+$labels['filterunder'] = 'under';
+$labels['filterover'] = 'over';
+$labels['filtermaxdays'] = ' at most every ';
+$labels['filterdays'] = ' days';
+$labels['vacationaddresses'] = 'Additional list of recipient e-mails (coma separated):';
+$labels['vacationdays'] = 'How often send messages (in days):';
+$labels['vacationreason'] = 'Message body (vacation reason):';
+$labels['rulestop'] = 'Stop evaluating rules';
+$labels['addrule'] = 'Add rule';
+$labels['delrule'] = 'Delete rule';
+$labels['messagemoveto'] = 'Move message to';
+$labels['messageredirect'] = 'Redirect message to';
+$labels['messagereply'] = 'Reply with message';
+$labels['messagedelete'] = 'Delete message';
+$labels['messagediscard'] = 'Discard with message';
+$labels['messagesrules'] = 'For incoming mail:';
+$labels['messagesactions'] = '...execute the following actions:';
+$labels['add'] = 'Add';
+$labels['del'] = 'Delete';
+$labels['sender'] = 'Sender';
+$labels['recipient'] = 'Recipient';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/en_US/messages.inc rc-beta2/program/localization/en_US/messages.inc
--- rc-beta2-old/program/localization/en_US/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/en_US/messages.inc    2009-02-11 08:59:02.668421218 +0100
@@ -95,4 +95,16 @@
 $messages['nofromaddress'] = 'Missing e-mail address in selected identity';
 $messages['editorwarning'] = 'Switching to the plain text editor will cause all text formatting to be lost. Do you wish to continue?';
 
+$messages['filterunknownerror'] = 'Unknown server error';
+$messages['filterconnerror'] = 'Unable to connect to managesieve server';
+$messages['filterdeleteerror'] = 'Unable to delete filter. Server error occured';
+$messages['filterdeleted'] = 'Filter deleted successfully';
+$messages['filterconfirmdelete'] = 'Do you really want to delete selected filter?';
+$messages['filtersaved'] = 'Filter saved successfully';
+$messages['filtersaveerror'] = 'Unable to save filter. Server error occured.';
+$messages['ruledeleteconfirm'] = 'Are you sure, you want to delete selected rule?';
+$messages['actiondeleteconfirm'] = 'Are you sure, you want to delete selected action?';
+$messages['forbiddenchars'] = 'Forbidden characters in field';
+$messages['cannotbeempty'] = 'Field cannot be empty';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/fi_FI/labels.inc rc-beta2/program/localization/fi_FI/labels.inc
--- rc-beta2-old/program/localization/fi_FI/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/fi_FI/labels.inc  2009-02-11 09:02:55.793291753 +0100
@@ -255,4 +255,37 @@
 $labels['MB'] = 'Mt';
 $labels['GB'] = 'Gt';
 
+$labels['filters'] = 'Suodattimet';
+$labels['managefilters'] = 'Muokkaa saapuvan shkpostin suodattimia';
+$labels['filtername'] = 'Suodattimen nimi';
+$labels['newfilter'] = 'Uusi suodatin';
+$labels['filteradd'] = 'Lis suodatin';
+$labels['filterdel'] = 'Poista suodatin';
+$labels['moveup'] = 'Siirr yls';
+$labels['movedown'] = 'Siirr alas';
+$labels['filterallof'] = 'Tsm kaikkien sntjen mukaan';
+$labels['filteranyof'] = 'Tsm mink tahansa sntjen mukaan';
+$labels['filterany'] = 'Kaikki viestit';
+$labels['filtercontains'] = 'Sislt';
+$labels['filternotcontains'] = 'Ei Sisll';
+$labels['filteris'] = 'on samanlainen kuin';
+$labels['filterisnot'] = 'ei ole samanlainen kuin';
+$labels['filterexists'] = 'on olemassa';
+$labels['filternotexists'] = 'ei ole olemassa';
+$labels['filterunder'] = 'alla';
+$labels['filterover'] = 'yli';
+$labels['addrule'] = 'Lis snt';
+$labels['delrule'] = 'Poista snt';
+$labels['messagemoveto'] = 'Siirr viesti';
+$labels['messageredirect'] = 'Uudelleen ohjaa viesti';
+$labels['messagereply'] = 'Vastaa viestin kanssa';
+$labels['messagedelete'] = 'Poista viesti';
+$labels['messagediscard'] = 'Hylk viesti';
+$labels['messagesrules'] = 'Saapuva shkposti';
+$labels['messagesactions'] = 'Suorita seuraavat tapahtumat';
+$labels['add'] = 'Lis';
+$labels['del'] = 'Poista';
+$labels['sender'] = 'Lhettj';
+$labels['recipient'] = 'Vastaanottaja';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/fi_FI/messages.inc rc-beta2/program/localization/fi_FI/messages.inc
--- rc-beta2-old/program/localization/fi_FI/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/fi_FI/messages.inc    2009-02-11 09:02:48.817130299 +0100
@@ -95,4 +95,16 @@
 $messages['opnotpermitted'] = 'Toiminto ei ole sallittu!';
 $messages['nofromaddress'] = 'Valittu identiteetti ei sisll shkpostiosoitetta';
 
+$messages['filterunknownerror'] = 'Tuntematon palvelin virhe';
+$messages['filterconnerror'] = 'Yhdistminen palvelimeen eponnistui';
+$messages['filterdeleteerror'] = 'Suodattimen poistaminen eponnistui. Palvelin virhe';
+$messages['filterdeleted'] = 'Suodatin poistettu';
+$messages['filterconfirmdelete'] = 'Haluatko varmasti poistaa valitut suodattimet?';
+$messages['filtersaved'] = 'Suodatin tallennettu';
+$messages['filtersaveerror'] = 'Suodattimen tallennus eponnistui. Palvelin virhe';
+$messages['ruledeleteconfirm'] = 'Haluatko poistaa valitut snnt?';
+$messages['actiondeleteconfirm'] = 'Haluatko poistaa valitut tapahtumat?';
+$messages['forbiddenchars'] = 'Sislt kiellettyj kirjaimia';
+$messages['cannotbeempty'] = 'Kentt ei voi olla tyhj';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/fr_FR/labels.inc rc-beta2/program/localization/fr_FR/labels.inc
--- rc-beta2-old/program/localization/fr_FR/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/fr_FR/labels.inc  2009-02-24 10:59:00.808744784 +0100
@@ -266,4 +266,38 @@
 $labels['MB'] = 'Mo';
 $labels['GB'] = 'Go';
 
+$labels['filters'] = 'Filtres';
+$labels['managefilters'] = 'Gestion des filtres sur les mails entrants';
+$labels['filtername'] = 'Nom du filtre';
+$labels['newfilter'] = 'Nouveau filtre';
+$labels['filteradd'] = 'Ajouter un filtre';
+$labels['filterdel'] = 'Supprimer un filtre';
+$labels['moveup'] = 'Monter';
+$labels['movedown'] = 'Descendre';
+$labels['filterallof'] = 'valident toutes les conditions suivantes';
+$labels['filteranyof'] = 'valident au moins une des conditions suivantes';
+$labels['filterany'] = 'tous les messages';
+$labels['filtercontains'] = 'contient';
+$labels['filternotcontains'] = 'ne contient pas';
+$labels['filteris'] = 'est ';
+$labels['filterisnot'] = 'n\'est pas';
+$labels['filterexists'] = 'existe';
+$labels['filternotexists'] = 'n\'existe pas';
+$labels['filterunder'] = 'est plus petit que';
+$labels['filterover'] = 'est plus grand que';
+$labels['addrule'] = 'Ajouter une rgle';
+$labels['delrule'] = 'Supprimer une rgle';
+$labels['messagemoveto'] = 'Dplacer le message vers';
+$labels['messageredirect'] = 'Transfrer le message ';
+$labels['messagereply'] = 'Rpondre avec le message';
+$labels['messagedelete'] = 'Supprimer le message';
+$labels['messagediscard'] = 'Rejeter avec le message';
+$labels['messagesrules'] = 'Pour les mails entrants:';
+$labels['messagesactions'] = '...excuter les actions suivantes:';
+$labels['rulestop'] = 'Ne plus valuer d\'autre rgle';
+$labels['add'] = 'Ajouter';
+$labels['del'] = 'Supprimer';
+$labels['sender'] = 'Expditeur';
+$labels['recipient'] = 'Destinataire';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/fr_FR/messages.inc rc-beta2/program/localization/fr_FR/messages.inc
--- rc-beta2-old/program/localization/fr_FR/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/fr_FR/messages.inc    2009-02-11 08:59:02.700421608 +0100
@@ -97,4 +97,16 @@
 $messages['nofromaddress'] = 'Il manque une adresse e-mail dans l\'identite slectionne';
 $messages['editorwarning'] = 'Passer  l\'diteur texte seul causera la perte du formatage du texte. Voulez-vous continuer ?';
 
+$messages['filterunknownerror'] = 'Erreur du serveur inconnue';
+$messages['filterconnerror'] = 'Connexion au serveur Managesieve impossible';
+$messages['filterdeleteerror'] = 'Suppression du filtre impossible. Le serveur  produit une erreur';
+$messages['filterdeleted'] = 'Le filtre a bien t supprim';
+$messages['filterconfirmdelete'] = 'Voulez-vous vraiment supprimer le filtre slectionn ?';
+$messages['filtersaved'] = 'Le filtre a bien t enregistr';
+$messages['filtersaveerror'] = 'Enregistrement du filtre impossibe. Le serveur  produit une erreur';
+$messages['ruledeleteconfirm'] = 'Voulez-vous vraiment supprimer la rgle slectionne ?';
+$messages['actiondeleteconfirm'] = 'Voulez-vous vraiment supprimer l\'action slectionne ?';
+$messages['forbiddenchars'] = 'Caractres interdits dans le champ';
+$messages['cannotbeempty'] = 'Le champ ne peut pas tre vide';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/nl_NL/labels.inc rc-beta2/program/localization/nl_NL/labels.inc
--- rc-beta2-old/program/localization/nl_NL/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/nl_NL/labels.inc  2009-02-11 09:03:53.002484686 +0100
@@ -266,4 +266,37 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = 'Filters';
+$labels['managefilters'] = 'Beheer inkomende mail filters';
+$labels['filtername'] = 'Filternaam';
+$labels['newfilter'] = 'Nieuw filter';
+$labels['filteradd'] = 'Filter toevoegen';
+$labels['filterdel'] = 'Filter verwijderen';
+$labels['moveup'] = 'Omhoog';
+$labels['movedown'] = 'Omlaag';
+$labels['filterallof'] = 'die voldoen aan een van de volgende regels';
+$labels['filteranyof'] = 'die voldoen aan alle volgende regels';
+$labels['filterany'] = 'alle berichten';
+$labels['filtercontains'] = 'bevat';
+$labels['filternotcontains'] = 'bevat niet';
+$labels['filteris'] = 'is gelijk aan';
+$labels['filterisnot'] = 'is niet gelijk aan';
+$labels['filterexists'] = 'bestaat';
+$labels['filternotexists'] = 'bestaat niet';
+$labels['filterunder'] = 'onder';
+$labels['filterover'] = 'over';
+$labels['addrule'] = 'Regel toevoegen';
+$labels['delrule'] = 'Regel verwijderen';
+$labels['messagemoveto'] = 'Verplaats bericht naar';
+$labels['messageredirect'] = 'Redirect bericht naar';
+$labels['messagereply'] = 'Beantwoord met bericht';
+$labels['messagedelete'] = 'Verwijder bericht';
+$labels['messagediscard'] = 'Wijs af met bericht';
+$labels['messagesrules'] = 'Voor binnenkomende e-mail';
+$labels['messagesactions'] = '...voer de volgende acties uit';
+$labels['add'] = 'Toevoegen';
+$labels['del'] = 'Verwijderen';
+$labels['sender'] = 'Afzender';
+$labels['recipient'] = 'Ontvanger';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/nl_NL/messages.inc rc-beta2/program/localization/nl_NL/messages.inc
--- rc-beta2-old/program/localization/nl_NL/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/nl_NL/messages.inc    2009-02-11 09:03:46.162342625 +0100
@@ -96,4 +96,16 @@
 $messages['nofromaddress'] = 'Het e-mailadres mist in de geselecteerde identiteit';
 $messages['editorwarning'] = 'Door het overschakelen naar de platte tekst editor gaat alle opmaak verloren. Weet je zeker dat je verder wil gaan?';
 
+$messages['filterunknownerror'] = 'Onbekende fout';
+$messages['filterconnerror'] = 'Kan geen verbinding maken met de managesieve server';
+$messages['filterdeleteerror'] = 'Kan filter niet verwijderen. Er is een fout opgetreden';
+$messages['filterdeleted'] = 'Filter succesvol verwijderd';
+$messages['filterconfirmdelete'] = 'Weet je zeker dat je het geselecteerde filter wilt verwijderen?';
+$messages['filtersaved'] = 'Filter succesvol opgeslagen';
+$messages['filtersaveerror'] = 'Kan filter niet opslaan. Er is een fout opgetreden.';
+$messages['ruledeleteconfirm'] = 'Weet je zeker dat je de geselecteerde regel wilt verwijderen?';
+$messages['actiondeleteconfirm'] = 'Weet je zeker dat je de geselecteerde actie wilt verwijderen?';
+$messages['forbiddenchars'] = 'Verboden karakters in het veld';
+$messages['cannotbeempty'] = 'Veld mag niet leeg zijn';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/pl_PL/labels.inc rc-beta2/program/localization/pl_PL/labels.inc
--- rc-beta2-old/program/localization/pl_PL/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/pl_PL/labels.inc  2009-02-24 12:58:16.989045093 +0100
@@ -269,4 +269,41 @@
 $labels['GB'] = 'GB';
 $labels['checkallfolders'] = 'Sprawdzaj czy nadeszy nowe wiadomoci we wszystkich folderach';
 
+$labels['filters'] = 'Filtry';
+$labels['managefilters'] = 'Zarzdzaj filtrami wiadomoci przychodzcych';
+$labels['filtername'] = 'Nazwa filtru';
+$labels['newfilter'] = 'Nowy filtr';
+$labels['filteradd'] = 'Dodaj filtr';
+$labels['filterdel'] = 'Usu filtr';
+$labels['moveup'] = 'Przenie wyej';
+$labels['movedown'] = 'Przenie niej';
+$labels['filterallof'] = 'speniajce wszystkie ponisze kryteria';
+$labels['filteranyof'] = 'speniajce dowolne z poniszych kryteriw';
+$labels['filterany'] = 'wszystkich';
+$labels['filtercontains'] = 'zawiera';
+$labels['filternotcontains'] = 'nie zawiera';
+$labels['filteris'] = 'jest rwne';
+$labels['filterisnot'] = 'nie jest rwne';
+$labels['filterexists'] = 'istnieje';
+$labels['filternotexists'] = 'nie istnieje';
+$labels['filterunder'] = 'poniej';
+$labels['filterover'] = 'ponad';
+$labels['addrule'] = 'Dodaj regu';
+$labels['delrule'] = 'Usu regu';
+$labels['messagemoveto'] = 'Przenie wiadomo do folderu';
+$labels['messageredirect'] = 'Przeka wiadomo na konto';
+$labels['messagereply'] = 'Odpowiedz';
+$labels['messagedelete'] = 'Usu wiadomo';
+$labels['messagediscard'] = 'Odrzu z komunikatem';
+$labels['messagesrules'] = 'W stosunku do przychodzcych wiadomoci:';
+$labels['messagesactions'] = '...wykonaj nastpujce czynnoci:';
+$labels['add'] = 'Dodaj';
+$labels['del'] = 'Usu';
+$labels['sender'] = 'Nadawca';
+$labels['recipient'] = 'Odbiorca';
+$labels['vacationdays'] = 'Czstotliwo wysyania wiadomoci (w dniach):';
+$labels['vacationaddresses'] = 'Lista dodatkowych adresw odbiorcw (oddzielonych przecinkami):';
+$labels['vacationreason'] = 'Tre (przyczyna nieobecnoci):';
+$labels['rulestop'] = 'Przerwij przetwarzanie regu';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/pl_PL/messages.inc rc-beta2/program/localization/pl_PL/messages.inc
--- rc-beta2-old/program/localization/pl_PL/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/pl_PL/messages.inc    2009-02-11 08:59:02.760411128 +0100
@@ -100,4 +100,16 @@
 $messages['nofromaddress'] = 'Brak adresu e-mail w wybranej tosamoci';
 $messages['editorwarning'] = 'Zmiana edytora spowoduje utrat formatowania tekstu. Czy jeste pewien, e chcesz to zrobi?';
 
+$messages['filterunknownerror'] = 'Nieznany bd serwera';
+$messages['filterconnerror'] = 'Nie mona nawiza poczenia z serwerem managesieve';
+$messages['filterdeleteerror'] = 'Nie mona usun filtra. Wystpi bd serwera';
+$messages['filterdeleted'] = 'Filtr zosta usunity pomylnie';
+$messages['filterconfirmdelete'] = 'Czy na pewno chcesz usun wybrany filtr?';
+$messages['filtersaved'] = 'Filtr zosta zapisany pomylnie';
+$messages['filtersaveerror'] = 'Nie mona zapisa filtra. Wystpi bd serwera.';
+$messages['ruledeleteconfirm'] = 'Czy na pewno chcesz usun wybran regu?';
+$messages['actiondeleteconfirm'] = 'Czy na pewno usun wybran akcj?';
+$messages['forbiddenchars'] = 'Pole zawiera niedozwolone znaki';
+$messages['cannotbeempty'] = 'Pole nie moe by puste';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/ru_RU/labels.inc rc-beta2/program/localization/ru_RU/labels.inc
--- rc-beta2-old/program/localization/ru_RU/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/ru_RU/labels.inc  2009-02-11 08:59:02.780419927 +0100
@@ -266,4 +266,37 @@
 $labels['MB'] = '';
 $labels['GB'] = '';
 
+$labels['filters'] = '';
+$labels['managefilters'] = '    ';
+$labels['filtername'] = ' ';
+$labels['newfilter'] = ' ';
+$labels['filteradd'] = ' ';
+$labels['filterdel'] = ' ';
+$labels['moveup'] = ' ';
+$labels['movedown'] = ' ';
+$labels['filterallof'] = '   ';
+$labels['filteranyof'] = '    ';
+$labels['filterany'] = ' ';
+$labels['filtercontains'] = '';
+$labels['filternotcontains'] = ' ';
+$labels['filteris'] = '';
+$labels['filterisnot'] = ' ';
+$labels['filterexists'] = '';
+$labels['filternotexists'] = ' ';
+$labels['filterunder'] = '';
+$labels['filterover'] = '';
+$labels['addrule'] = ' ';
+$labels['delrule'] = ' ';
+$labels['messagemoveto'] = '  ';
+$labels['messageredirect'] = '   ';
+$labels['messagereply'] = '  ';
+$labels['messagedelete'] = ' ';
+$labels['messagediscard'] = '  ';
+$labels['messagesrules'] = '  :';
+$labels['messagesactions'] = '...  :';
+$labels['add'] = '';
+$labels['del'] = '';
+$labels['sender'] = '';
+$labels['recipient'] = '';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/ru_RU/messages.inc rc-beta2/program/localization/ru_RU/messages.inc
--- rc-beta2-old/program/localization/ru_RU/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/ru_RU/messages.inc    2009-02-11 08:59:02.816425148 +0100
@@ -97,4 +97,16 @@
 $messages['nofromaddress'] = '       ';
 $messages['editorwarning'] = '         . ?';
 
+$messages['filterunknownerror'] = '  ';
+$messages['filterconnerror'] = '    ';
+$messages['filterdeleteerror'] = '  .  ';
+$messages['filterdeleted'] = '  ';
+$messages['filterconfirmdelete'] = '    ?';
+$messages['filtersaved'] = '  ';
+$messages['filtersaveerror'] = '  .  ';
+$messages['ruledeleteconfirm'] = ' ,     ?';
+$messages['actiondeleteconfirm'] = ' ,     ?';
+$messages['forbiddenchars'] = '   ';
+$messages['cannotbeempty'] = '    ';
+
 ?>
diff -ruNa rc-beta2-old/program/localization/zh_CN/labels.inc rc-beta2/program/localization/zh_CN/labels.inc
--- rc-beta2-old/program/localization/zh_CN/labels.inc  2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/zh_CN/labels.inc  2009-02-11 08:59:02.860413217 +0100
@@ -265,4 +265,36 @@
 $labels['MB'] = 'MB';
 $labels['GB'] = 'GB';
 
+$labels['filters'] = '';
+$labels['managefilters'] = '';
+$labels['filtername'] = '';
+$labels['newfilter'] = '';
+$labels['filteradd'] = '';
+$labels['filterdel'] = '';
+$labels['moveup'] = '';
+$labels['movedown'] = '';
+$labels['filterallof'] = '';
+$labels['filteranyof'] = '';
+$labels['filterany'] = '';
+$labels['filtercontains'] = '';
+$labels['filternotcontains'] = '';
+$labels['filteris'] = '';
+$labels['filterisnot'] = '';
+$labels['filterexists'] = '';
+$labels['filternotexists'] = '';
+$labels['filterunder'] = '';
+$labels['filterover'] = '';
+$labels['addrule'] = '';
+$labels['delrule'] = '';
+$labels['messagemoveto'] = '';
+$labels['messageredirect'] = '';
+$labels['messagereply'] = '';
+$labels['messagedelete'] = '';
+$labels['messagediscard'] = '';
+$labels['messagesrules'] = '';
+$labels['messagesactions'] = '...';
+$labels['add'] = '';
+$labels['del'] = '';
+$labels['sender'] = '';
+$labels['recipient'] = '';
 ?>
diff -ruNa rc-beta2-old/program/localization/zh_CN/messages.inc rc-beta2/program/localization/zh_CN/messages.inc
--- rc-beta2-old/program/localization/zh_CN/messages.inc    2009-02-11 08:50:50.000000000 +0100
+++ rc-beta2/program/localization/zh_CN/messages.inc    2009-02-11 08:59:02.880423971 +0100
@@ -96,4 +96,16 @@
 $messages['nofromaddress'] = '';
 $messages['editorwarning'] = '';
 
+$messages['filterunknownerror'] = '';
+$messages['filterconnerror'] = ' managesieve ';
+$messages['filterdeleteerror'] = '';
+$messages['filterdeleted'] = '';
+$messages['filterconfirmdelete'] = '';
+$messages['filtersaved'] = '';
+$messages['filtersaveerror'] = '';
+$messages['ruledeleteconfirm'] = '';
+$messages['actiondeleteconfirm'] = '';
+$messages['forbiddenchars'] = '';
+$messages['cannotbeempty'] = '';
+
 ?>
diff -ruNa rc-beta2-old/program/steps/settings/managesieve.inc rc-beta2/program/steps/settings/managesieve.inc
--- rc-beta2-old/program/steps/settings/managesieve.inc 1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/program/steps/settings/managesieve.inc 2009-03-01 15:40:30.181976376 +0100
@@ -0,0 +1,807 @@
+<?php
+
+/*
+ +-----------------------------------------------------------------------+
+ | program/steps/settings/managesieve.inc                                |
+ |                                                                       |
+ | This file is part of the RoundCube Webmail client                     |
+ | Copyright (C) 2007, RoundCube Dev. - Switzerland                      |
+ | Licensed under the GNU GPL                                            |
+ |                                                                       |
+ | PURPOSE:                                                              |
+ |   Sieve scripts management                                            |
+ |                                                                       |
+ +-----------------------------------------------------------------------+
+ | Author: Aleksander Machniak <alec@alec.pl>                            |
+ +-----------------------------------------------------------------------+
+ $Id$
+*/
+
+// try to connect to managesieve server and to fetch the script
+$SIEVE = new rcube_sieve($_SESSION['username'], 
+       $RCMAIL->decrypt_passwd($_SESSION['password']), 
+       ($CONFIG['managesieve_host'] ? $CONFIG['managesieve_host'] : 'localhost'),
+       ($CONFIG['managesieve_port'] ? $CONFIG['managesieve_port'] : 2000),
+       (bool) $CONFIG['managesieve_usetls'],
+       $CONFIG['managesieve_disabled_extensions']);
+
+$error = $SIEVE->error();
+
+if ($error == SIEVE_ERROR_NOT_EXISTS)
+{
+  // if script not exists build default script contents
+  if (!empty($CONFIG['managesieve_default']) && is_readable($CONFIG['managesieve_default']))
+    $SIEVE->script->add_text(file_get_contents($CONFIG['managesieve_default'])); 
+  // that's not exactly an error
+  $error = false;
+}
+elseif ($error)
+{
+  switch ($error)
+  {
+    case SIEVE_ERROR_CONNECTION:
+    case SIEVE_ERROR_LOGIN:
+      $OUTPUT->show_message('filterconnerror', 'error');  
+    break;
+    default:
+      $OUTPUT->show_message('filterunknownerror', 'error');
+    break;
+  }
+
+  // to disable 'Add filter' button set env variable
+  $OUTPUT->set_env('filterconnerror', true);
+}
+
+// finally set script objects
+if ($error)
+{
+  $SCRIPT = array();
+}
+else
+{
+  $SCRIPT = $SIEVE->script->as_array();
+  $EXT = $SIEVE->get_extensions();
+}
+
+
+// Some helper data and functions
+$HEADERS = array(
+  'subject' => 'Subject',
+  'sender' => 'From',
+  'recipient' => 'To',
+);
+
+
+function strip_val($str)
+{
+  return trim(strip_tags($str));
+}
+
+function error_class($id, $type, $target, $name_only=false)
+{
+  global $FORM_ERR;
+
+  // TODO: tooltips
+  if ($type == 'test' && isset($FORM_ERR['tests'][$id][$target]))
+    return ($name_only ? 'error' : ' class="error"');
+  elseif ($type == 'action' && isset($FORM_ERR['actions'][$id][$target]))
+    return ($name_only ? 'error' : ' class="error"');
+
+  return '';
+}
+
+function check_email($email)
+{
+  // Check for invalid characters
+  if (preg_match('/[\x00-\x1F\x7F-\xFF]/', $email))
+    return false;
+
+  // Check that there's one @ symbol, and that the lengths are right
+  if (!preg_match('/^[^@]{1,64}@[^@]{1,255}$/', $email))
+    return false;
+
+  // Split it into sections to make life easier
+  $email_array = explode('@', $email);
+
+  // Check local part
+  $local_array = explode('.', $email_array[0]);
+  foreach ($local_array as $local_part)
+    if (!preg_match('/^(([A-Za-z0-9!#$%&\'*+\/=?^_`{|}~-]+)|("[^"]+"))$/', $local_part))
+      return false;
+
+  // Check domain part
+  if (preg_match('/^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}$/', $email_array[1]) 
+    || preg_match('/^\[(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])){3}\]$/', $email_array[1]))
+    return true; // If an IP address
+  else
+  { // If not an IP address
+    $domain_array = explode('.', $email_array[1]);
+    if (sizeof($domain_array) < 2)
+      return false; // Not enough parts to be a valid domain
+
+    foreach ($domain_array as $domain_part)
+      if (!preg_match('/^(([A-Za-z0-9][A-Za-z0-9-]{0,61}[A-Za-z0-9])|([A-Za-z0-9]))$/', $domain_part))
+   return false;
+
+    return true;
+  }
+  
+  return false;
+} 
+
+// add/edit action
+if (isset($_POST['_name']))
+{
+  $name = trim(get_input_value('_name', RCUBE_INPUT_POST));
+  $fid = trim(get_input_value('_fid', RCUBE_INPUT_POST));
+  $join = trim(get_input_value('_join', RCUBE_INPUT_POST));
+  
+  // and arrays
+  $headers = $_POST['_header'];
+  $cust_headers = $_POST['_custom_header'];
+  $ops = $_POST['_rule_op'];
+  $sizeops = $_POST['_rule_size_op'];
+  $sizeitems = $_POST['_rule_size_item'];
+  $sizetargets = $_POST['_rule_size_target'];
+  $targets = $_POST['_rule_target'];
+  $act_types = $_POST['_action_type'];
+  $mailboxes = $_POST['_action_mailbox'];
+  $act_targets = $_POST['_action_target'];
+  $area_targets = $_POST['_action_target_area'];
+  $reasons = $_POST['_action_reason'];
+  $addresses = $_POST['_action_addresses'];
+  $days = $_POST['_action_days'];
+
+  // we need a "hack" for radiobuttons
+  foreach ($sizeitems as $item)
+    $items[] = $item;
+
+  $S['join'] = $join=='allof' ? true : false;
+  $S['name'] = $name;
+  $S['tests'] = array();
+  $S['actions'] = array();
+
+  if ($name == '')
+    $FORM_ERR['name'] = rcube_label('cannotbeempty');
+  else
+    foreach($SCRIPT as $idx => $rule)
+      if($rule['name'] == $name && $idx != $fid)
+      {
+   $FORM_ERR['name'] = rcube_label('ruleexist');
+        break;
+      }
+      
+  $i = 0;
+  // rules
+  if ($join == 'any')
+  {
+    $S['tests'][0]['test'] = 'true';
+  }
+  else foreach($headers as $idx => $header)
+  {
+    $header = strip_val($header);
+    $target = strip_val($targets[$idx]);
+    $op = strip_val($ops[$idx]);
+
+    // normal header
+    if (in_array($header, $HEADERS))
+    {
+      if(preg_match('/^not/', $op))
+        $S['tests'][$i]['not'] = true;
+      $type = preg_replace('/^not/', '', $op);
+
+      if ($type == 'exists')
+        {
+   $S['tests'][$i]['test'] = 'exists';
+        $S['tests'][$i]['arg'] = $header;
+   }
+      else
+        {  
+   $S['tests'][$i]['type'] = $type;
+        $S['tests'][$i]['test'] = 'header';
+        $S['tests'][$i]['arg1'] = $header;
+        $S['tests'][$i]['arg2'] = $target;
+   
+        if ($target == '')
+          $FORM_ERR['tests'][$i]['target'] = rcube_label('cannotbeempty');
+   }
+    }
+    else
+      switch ($header)
+      {
+        case 'size':
+     $sizeop = strip_val($sizeops[$idx]);
+     $sizeitem = strip_val($items[$idx]);
+     $sizetarget = strip_val($sizetargets[$idx]);
+
+          $S['tests'][$i]['test'] = 'size';
+          $S['tests'][$i]['type'] = $sizeop;
+          $S['tests'][$i]['arg'] = $sizetarget.$sizeitem;
+
+     if (!preg_match('/^[0-9]+(K|M|G)*$/i', $sizetarget))
+       $FORM_ERR['tests'][$i]['sizetarget'] = rcube_label('wrongformat');
+   break;
+   case '...':
+          $cust_header = strip_val($cust_headers[$idx]);
+
+          if(preg_match('/^not/', $op))
+       $S['tests'][$i]['not'] = true;
+         $type = preg_replace('/^not/', '', $op);
+
+          if ($cust_header == '')
+           $FORM_ERR['tests'][$i]['header'] = rcube_label('cannotbeempty');
+          elseif (!preg_match('/^[a-z0-9-]+$/i', $cust_header))
+           $FORM_ERR['tests'][$i]['header'] = rcube_label('forbiddenchars');
+
+          if ($type == 'exists')
+           {
+       $S['tests'][$i]['test'] = 'exists';
+           $S['tests'][$i]['arg'] = $cust_header;
+       }
+          else
+           {   
+           $S['tests'][$i]['test'] = 'header';
+       $S['tests'][$i]['type'] = $type;
+            $S['tests'][$i]['arg1'] = $cust_header;
+           $S['tests'][$i]['arg2'] = $target;
+
+            if ($target == '')
+             $FORM_ERR['tests'][$i]['target'] = rcube_label('cannotbeempty');
+       }
+   break;
+      }
+    $i++;
+  }
+  
+  $i = 0;
+  // actions
+  foreach($act_types as $idx => $type)
+  {
+    $type = strip_val($type);
+    $target = strip_val($act_targets[$idx]);
+  
+    $S['actions'][$i]['type'] = $type;
+    
+    switch ($type)
+    {
+      case 'fileinto':
+   $mailbox = strip_val($mailboxes[$idx]);
+   $S['actions'][$i]['target'] = $mailbox;
+      break;
+      case 'reject':
+      case 'ereject':
+   $target = strip_val($area_targets[$idx]);
+   $S['actions'][$i]['target'] = str_replace("\r\n", "\n", $target);
+
+ //       if ($target == '')
+//       $FORM_ERR['actions'][$i]['targetarea'] = rcube_label('cannotbeempty');
+      break;
+      case 'redirect':
+   $S['actions'][$i]['target'] = $target;
+
+        if ($S['actions'][$i]['target'] == '')
+         $FORM_ERR['actions'][$i]['target'] = rcube_label('cannotbeempty');
+        else if (!check_email($S['actions'][$i]['target']))
+         $FORM_ERR['actions'][$i]['target'] = rcube_label('noemailwarning');
+      break;
+      case 'vacation':
+        $reason = strip_val($reasons[$idx]);
+        $S['actions'][$i]['reason'] = str_replace("\r\n", "\n", $reason);
+   $S['actions'][$i]['days'] = $days[$idx];
+   $S['actions'][$i]['addresses'] = explode(',', $addresses[$idx]);
+// @TODO: vacation :subject, :mime, :from, :handle
+
+   if ($S['actions'][$i]['addresses']) {
+     foreach($S['actions'][$i]['addresses'] as $aidx => $address) {
+       $address = trim($address);
+       if (!$address)
+         unset($S['actions'][$i]['addresses'][$aidx]);
+       else if(!check_email($address)) {
+         $FORM_ERR['actions'][$i]['addresses'] = rcube_label('noemailwarning');
+         break;
+       } else
+         $S['actions'][$i]['addresses'][$aidx] = $address;
+     }
+   }
+        if ($S['actions'][$i]['reason'] == '')
+         $FORM_ERR['actions'][$i]['reason'] = rcube_label('cannotbeempty');
+        if ($S['actions'][$i]['days'] && !preg_match('/^[0-9]+$/', $S['actions'][$i]['days']))
+         $FORM_ERR['actions'][$i]['days'] = rcube_label('forbiddenchars');
+      break;
+    }
+  
+    $i++;
+  }
+
+  if (!$FORM_ERR)
+  {
+    // zapis skryptu
+    if (!isset($SCRIPT[$fid]))
+    {
+      $fid = $SIEVE->script->add_rule($S);
+      $new = true;
+    }
+    else
+      $fid = $SIEVE->script->update_rule($fid, $S);
+
+    if ($fid !== false)
+      $save = $SIEVE->save();
+
+    if ($save && $fid !== false)
+    {
+       $OUTPUT->show_message('filtersaved', 'confirmation');
+       $OUTPUT->command('sievefilter_updatelist', isset($new) ? 'add' : 'update', $S['name'], $fid);
+//     $OUTPUT->send();
+    }
+    else
+    {
+       $OUTPUT->show_message('filtersaveerror', 'error');
+//     $OUTPUT->send();
+    }
+  }
+}
+
+// return the filters list as HTML table
+function rcmail_filters_list($attrib)
+{
+  global $SCRIPT, $OUTPUT;
+
+  // add id to message list table if not specified
+  if (!strlen($attrib['id']))
+    $attrib['id'] = 'rcmfilterslist';
+  
+  // define list of cols to be displayed
+  $a_show_cols = array('filtername');
+
+  foreach($SCRIPT as $idx => $filter)
+    $result[] = array('filtername' => $filter['name'], 'id' => $idx);
+    
+  // create XHTML table
+  $out = rcube_table_output($attrib, $result, $a_show_cols, 'id');
+  
+  // set client env
+  $OUTPUT->add_gui_object('filterslist', $attrib['id']);
+  $OUTPUT->include_script('list.js');
+  
+  // add some labels to client
+  $OUTPUT->add_label('filterconfirmdelete');
+  
+  return $out;
+}
+
+
+function rcmail_filter_frame($attrib)
+{
+  global $OUTPUT;
+
+  if (!$attrib['id'])
+    $attrib['id'] = 'rcmfilterframe';
+    
+  $attrib['name'] = $attrib['id'];
+
+  $OUTPUT->set_env('contentframe', $attrib['name']);
+  $OUTPUT->set_env('blankpage', $attrib['src'] ? $OUTPUT->abs_url($attrib['src']) : 'program/blank.gif');
+
+  return html::tag('iframe', $attrib);
+}
+
+
+function rcmail_filter_form($attrib)
+{
+  global $RCMAIL, $OUTPUT, $SCRIPT, $S, $FORM_ERR, $SIEVE;
+
+  if (!$attrib['id'])
+    $attrib['id'] = 'rcmfilterform';
+
+  $fid = get_input_value('_fid', RCUBE_INPUT_GPC);
+  $scr = isset($S) ? $S : $SCRIPT[$fid];
+
+  $hiddenfields = new html_hiddenfield(array('name' => '_task', 'value' => $RCMAIL->task));
+  $hiddenfields->add(array('name' => '_action', 'value' => 'managesieve'));
+  $hiddenfields->add(array('name' => '_framed', 'value' => ($_POST['_framed'] || $_GET['_framed'] ? 1 : 0)));
+  $hiddenfields->add(array('name' => '_fid', 'value' => $fid));
+
+  $out = '<form name="filterform" action="./" method="post">'."\n";
+  $out .= $hiddenfields->show();
+//  $out .= $SESS_HIDDEN_FIELD;
+
+  // 'any' flag 
+  if (sizeof($scr['tests']) == 1 && $scr['tests'][0]['test'] == 'true' && !$scr['tests'][0]['not'])
+    $any = true; 
+
+  // filter name input
+  $field_id = '_name';
+  $input_name = new html_inputfield(array('name' => '_name', 'id' => $field_id, 'size' => 30,
+   'class' => ($FORM_ERR['name'] ? 'error' : '')));
+
+  if (isset($scr))
+    $input_name = $input_name->show($scr['name']);
+  else
+    $input_name = $input_name->show();
+
+  $out .= sprintf("\n<label for=\"%s\"><b>%s:</b></label> %s<br /><br />\n",
+           $field_id, Q(rcube_label('filtername')), $input_name);
+
+  $out .= '<fieldset><legend>' . Q(rcube_label('messagesrules')) . "</legend>\n";
+
+  // any, allof, anyof radio buttons
+  $field_id = '_allof';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'allof',
+   'onclick' => 'rule_join_radio(\'allof\')', 'class' => 'radio'));
+
+  if (isset($scr) && !$any)
+    $input_join = $input_join->show($scr['join'] ? 'allof' : '');
+  else
+    $input_join = $input_join->show();
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>&nbsp;\n",
+           $input_join, $field_id, Q(rcube_label('filterallof')));
+
+  $field_id = '_anyof';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'anyof',
+   'onclick' => 'rule_join_radio(\'anyof\')', 'class' => 'radio'));
+
+  if (isset($scr) && !$any)
+    $input_join = $input_join->show($scr['join'] ? '' : 'anyof');
+  else
+    $input_join = $input_join->show('anyof'); // default
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>\n",
+           $input_join, $field_id, Q(rcube_label('filteranyof')));
+
+  $field_id = '_any';
+  $input_join = new html_radiobutton(array('name' => '_join', 'id' => $field_id, 'value' => 'any',
+   'onclick' => 'rule_join_radio(\'any\')', 'class' => 'radio'));
+
+  $input_join = $input_join->show($any ? 'any' : '');
+
+  $out .= sprintf("%s<label for=\"%s\">%s</label>\n",
+           $input_join, $field_id, Q(rcube_label('filterany')));
+
+  $rows_num = isset($scr) ? sizeof($scr['tests']) : 1;
+
+  $out .= '<div id="rules"'.($any ? ' style="display: none"' : '').'>';
+  for ($x=0; $x<$rows_num; $x++)
+    $out .= rcmail_rule_div($fid, $x);
+  $out .= "</div>\n";
+
+  $out .= "</fieldset>\n";
+
+  // actions
+  $out .= '<fieldset><legend>' . Q(rcube_label('messagesactions')) . "</legend>\n";
+
+  $rows_num = isset($scr) ? sizeof($scr['actions']) : 1;
+
+  $out .= '<div id="actions">';
+  for ($x=0; $x<$rows_num; $x++)
+    $out .= rcmail_action_div($fid, $x);
+  $out .= "</div>\n";
+
+  $out .= "</fieldset>\n";
+
+  $OUTPUT->add_label('ruledeleteconfirm');
+  $OUTPUT->add_label('actiondeleteconfirm');
+  $OUTPUT->add_gui_object('sieveform', 'filterform');
+
+  return $out;
+}
+
+
+function rcmail_rule_div($fid, $id, $div=true)
+{
+  global $SCRIPT, $S, $OUTPUT, $HEADERS;
+  
+  $rule = isset($S) ? $S['tests'][$id] : $SCRIPT[$fid]['tests'][$id];
+  $rows_num = isset($S) ? sizeof($S['tests']) : sizeof($SCRIPT[$fid]['tests']);
+  
+  $out = $div ? '<div class="rulerow" id="rulerow' .$id .'">'."\n" : '';
+
+  $out .= '<table><tr><td class="rowactions">';
+
+  // headers select
+  $select_header = new html_select(array('name' => "_header[]", 'id' => 'header'.$id,
+    'onchange' => 'header_select(' .$id .')'));
+  foreach($HEADERS as $name => $val)
+    $select_header->add(Q(rcube_label($name)), Q($val));
+  $select_header->add(Q(rcube_label('size')), 'size');
+  $select_header->add(Q(rcube_label('...')), '...');
+
+  // TODO: list arguments
+
+  if ((isset($rule['test']) && $rule['test'] == 'header') && in_array($rule['arg1'], $HEADERS))
+    $out .= $select_header->show($rule['arg1']);
+  elseif ((isset($rule['test']) && $rule['test'] == 'exists') && in_array($rule['arg'], $HEADERS))
+    $out .= $select_header->show($rule['arg']);
+  elseif (isset($rule['test']) && $rule['test'] == 'size')
+    $out .= $select_header->show('size');
+  elseif (isset($rule['test']) && $rule['test'] != 'true')
+    $out .= $select_header->show('...');
+  else
+    $out .= $select_header->show();
+
+  $out .= '</td><td class="rowtargets">';
+
+  if ((isset($rule['test']) && $rule['test'] == 'header') && !in_array($rule['arg1'], $HEADERS))
+    $custom = $rule['arg1'];
+  elseif ((isset($rule['test']) && $rule['test'] == 'exists') && !in_array($rule['arg'], $HEADERS))
+    $custom = $rule['arg'];
+    
+  $out .= '<div id="custom_header' .$id. '" style="display:' .(isset($custom) ? 'inline' : 'none'). '">
+    <input type="text" name="_custom_header[]" '. error_class($id, 'test', 'header') .'
+    value="' .Q($custom). '" size="20" />&nbsp;</div>' . "\n";
+  
+  // matching type select (operator)
+  $select_op = new html_select(array('name' => "_rule_op[]", 'id' => 'rule_op'.$id, 
+    'style' => 'display:' .($rule['test']!='size' ? 'inline' : 'none'), 'onchange' => 'rule_op_select('.$id.')'));
+  $select_op->add(Q(rcube_label('filtercontains')), 'contains');
+  $select_op->add(Q(rcube_label('filternotcontains')), 'notcontains');
+  $select_op->add(Q(rcube_label('filteris')), 'is');
+  $select_op->add(Q(rcube_label('filterisnot')), 'notis');
+  $select_op->add(Q(rcube_label('filterexists')), 'exists');
+  $select_op->add(Q(rcube_label('filternotexists')), 'notexists');
+//    $select_op->add(Q(rcube_label('filtermatches')), 'matches');
+//    $select_op->add(Q(rcube_label('filternotmatches')), 'notmatches');
+
+  // target input (TODO: lists)
+
+  if ($rule['test'] == 'header')
+    {
+    $out .= $select_op->show(($rule['not'] ? 'not' : '').$rule['type']);
+    $target = $rule['arg2'];
+    }
+  elseif ($rule['test'] == 'size')
+    {
+    $out .= $select_op->show();
+    if(preg_match('/^([0-9]+)(K|M|G)*$/', $rule['arg'], $matches))
+      {
+   $sizetarget = $matches[1];
+   $sizeitem = $matches[2];
+      }
+    }
+  else
+    {
+    $out .= $select_op->show(($rule['not'] ? 'not' : '').$rule['test']);
+    $target = '';
+    }
+
+  $out .= '<input type="text" name="_rule_target[]" id="rule_target' .$id. '" 
+   value="' .Q($target). '" size="20" ' . error_class($id, 'test', 'target') 
+   . ' style="display:' . ($rule['test']!='size' && $rule['test'] != 'exists' ? 'inline' : 'none') . '" />'."\n";
+
+  $select_size_op = new html_select(array('name' => "_rule_size_op[]", 'id' => 'rule_size_op'.$id));
+  $select_size_op->add(Q(rcube_label('filterunder')), 'under');
+  $select_size_op->add(Q(rcube_label('filterover')), 'over');
+
+  $out .= '<div id="rule_size' .$id. '" style="display:' . ($rule['test']=='size' ? 'inline' : 'none') .'">';
+  $out .= $select_size_op->show($rule['test']=='size' ? $rule['type'] : '');
+  $out .= '<input type="text" name="_rule_size_target[]" value="'.$sizetarget.'" size="10" ' . error_class($id, 'test', 'sizetarget') .' />
+   <input type="radio" name="_rule_size_item['.$id.']" value=""'. (!$sizeitem ? ' checked="checked"' : '') .' class="radio" />B
+   <input type="radio" name="_rule_size_item['.$id.']" value="K"'. ($sizeitem=='K' ? ' checked="checked"' : '') .' class="radio" />kB
+   <input type="radio" name="_rule_size_item['.$id.']" value="M"'. ($sizeitem=='M' ? ' checked="checked"' : '') .' class="radio" />MB
+   <input type="radio" name="_rule_size_item['.$id.']" value="G"'. ($sizeitem=='G' ? ' checked="checked"' : '') .' class="radio" />GB';
+  $out .= '</div>';
+  $out .= '</td>';
+  
+  // add/del buttons
+  $out .= '<td class="rowbuttons">';
+  $out .= '<input type="button" id="ruleadd' . $id .'" value="'. Q(rcube_label('add')). '" 
+    onclick="rcmail.sievefilter_ruleadd(' . $id .')" class="button" /> ';
+  $out .= '<input type="button" id="ruledel' . $id .'" value="'. Q(rcube_label('del')). '"
+    onclick="rcmail.sievefilter_ruledel(' . $id .')" class="button' . ($rows_num<2 ? ' disabled' : '') .'"'
+    . ($rows_num<2 ? ' disabled="disabled"' : '') .' />';
+  $out .= '</td></tr></table>';
+
+  $out .= $div ? "</div>\n" : '';
+        
+  return $out;
+}
+
+function rcmail_action_div($fid, $id, $div=true)
+{
+  global $RCMAIL, $CONFIG, $SCRIPT, $S, $EXT, $IMAP;
+
+  $action = isset($S) ? $S['actions'][$id] : $SCRIPT[$fid]['actions'][$id];
+  $rows_num = isset($S) ? sizeof($S['actions']) : sizeof($SCRIPT[$fid]['actions']);
+
+  $out = $div ? '<div class="actionrow" id="actionrow' .$id .'">'."\n" : '';
+
+  $out .= '<table><tr><td class="rowactions">';
+
+  // action select
+  $select_action = new html_select(array('name' => "_action_type[]", 'id' => 'action_type'.$id,
+    'onchange' => 'action_type_select(' .$id .')'));
+  if (in_array('fileinto', $EXT))
+    $select_action->add(Q(rcube_label('messagemoveto')), 'fileinto');
+  $select_action->add(Q(rcube_label('messageredirect')), 'redirect');
+  if (in_array('reject', $EXT))
+    $select_action->add(Q(rcube_label('messagediscard')), 'reject');
+  elseif (in_array('ereject', $EXT))
+    $select_action->add(Q(rcube_label('messagediscard')), 'ereject');
+  if (in_array('vacation', $EXT))
+    $select_action->add(Q(rcube_label('messagereply')), 'vacation');
+  $select_action->add(Q(rcube_label('messagedelete')), 'discard');
+  $select_action->add(Q(rcube_label('rulestop')), 'stop');
+
+  $out .= $select_action->show($action['type']);
+  $out .= '</td>';
+
+  // actions target inputs
+  $out .= '<td class="rowtargets">';
+  // shared targets
+  $out .= '<input type="text" name="_action_target[]" id="action_target' .$id. '" '
+   .'value="' .($action['type']=='redirect' ? Q($action['target'], 'strict', false) : ''). '" size="40" '
+   .'style="display:' .($action['type']=='redirect' ? 'inline' : 'none') .'" '
+   . error_class($id, 'action', 'target') .' />';
+  $out .= '<textarea name="_action_target_area[]" id="action_target_area' .$id. '" '
+   .'rows="3" cols="40" '. error_class($id, 'action', 'targetarea')
+   .'style="display:' .(in_array($action['type'], array('reject', 'ereject')) ? 'inline' : 'none') .'">'
+   . (in_array($action['type'], array('reject', 'ereject')) ? Q($action['target'], 'strict', false) : '')
+   . "</textarea>\n";
+
+  // vacation
+  $out .= '<div id="action_vacation' .$id.'" style="display:' .($action['type']=='vacation' ? 'inline' : 'none') .'">';
+  $out .= '<span class="label">'. Q(rcube_label('vacationreason')) .'</span><br />'
+   .'<textarea name="_action_reason[]" id="action_reason' .$id. '" '
+   .'rows="3" cols="40" '. error_class($id, 'action', 'reason') . '>'
+   . Q($action['reason'], 'strict', false) . "</textarea>\n";
+  $out .= '<br /><span class="label">' .Q(rcube_label('vacationaddresses')) . '</span><br />'
+   .'<input type="text" name="_action_addresses[]" '
+        .'value="' . (is_array($action['addresses']) ? Q(implode(', ', $action['addresses']), 'strict', false) : $action['addresses']) . '" size="40" '
+        . error_class($id, 'action', 'addresses') .' />';
+  $out .= '<br /><span class="label">' . Q(rcube_label('vacationdays')) . '</span><br />'
+   .'<input type="text" name="_action_days[]" '
+        .'value="' .Q($action['days'], 'strict', false) . '" size="2" '
+        . error_class($id, 'action', 'days') .' />';
+  $out .= '</div>';
+
+  // mailbox select
+  $out .= '<select id="action_mailbox' .$id. '" name="_action_mailbox[]" style="display:' 
+    .(!isset($action) || $action['type']=='fileinto' ? 'inline' : 'none'). '">';
+
+  $RCMAIL->imap_init(true);
+
+  $a_folders = $IMAP->list_mailboxes();
+  $delimiter = $IMAP->get_hierarchy_delimiter();
+
+  if ($action['type'] == 'fileinto')
+    $mailbox = $action['target'];
+  else
+    $mailbox = '';
+
+  foreach ($a_folders as $folder)
+  {
+    $utf7folder = $folder;
+    $names = explode($delimiter, rcube_charset_convert($folder, 'UTF-7'));
+    $name = $names[sizeof($names)-1];
+    
+    if (!empty($CONFIG['managesieve_replace_delimiter']))
+      $utf7folder = str_replace($delimiter, $CONFIG['managesieve_replace_delimiter'], $utf7folder);
+    
+    if ($folder_class = rcmail_folder_classname($name))
+      $foldername = rcube_label($folder_class);
+    else
+      $foldername = $name;
+
+    $out .= sprintf('<option value="%s"%s>%s%s</option>'."\n",
+                    htmlspecialchars($utf7folder),
+           ($mailbox == $utf7folder ? ' selected="selected"' : ''),
+           str_repeat('&nbsp;', 4 * (sizeof($names)-1)),
+           Q(abbreviate_string($foldername, 40 - (2 * sizeof($names)-1))));
+  }
+  $out .= '</select>';
+  $out .= '</td>';
+
+  // add/del buttons
+  $out .= '<td class="rowbuttons">';
+  $out .= '<input type="button" id="actionadd' . $id .'" value="'. Q(rcube_label('add')). '" 
+    onclick="rcmail.sievefilter_actionadd(' . $id .')" class="button" /> ';
+  $out .= '<input type="button" id="actiondel' . $id .'" value="'. Q(rcube_label('del')). '"
+    onclick="rcmail.sievefilter_actiondel(' . $id .')" class="button' . ($rows_num<2 ? ' disabled' : '') .'"'
+    . ($rows_num<2 ? ' disabled="disabled"' : '') .' />';
+  $out .= '</td>';
+  
+  $out .= '</tr></table>';
+
+  $out .= $div ? "</div>\n" : '';
+
+  return $out;
+}
+
+function genid()
+{
+   $result = intval(rcube_timer());
+   return $result;
+}
+
+
+// Handle user requests
+if ($action = get_input_value('_act', RCUBE_INPUT_GPC))
+{
+  $fid = get_input_value('_fid', RCUBE_INPUT_GET);
+
+  if ($action=='up' && !$error)
+  {
+    if ($fid && isset($SCRIPT[$fid]) && isset($SCRIPT[$fid-1]))
+    {
+      if ($SIEVE->script->update_rule($fid, $SCRIPT[$fid-1]) !== false
+        && $SIEVE->script->update_rule($fid-1, $SCRIPT[$fid]) !== false)
+   $result = $SIEVE->save();
+      
+      if ($result)
+      {
+//        $OUTPUT->show_message('filtersaved', 'confirmation');
+   $OUTPUT->command('sievefilter_updatelist', 'up', '', $fid);
+      }
+      else
+        $OUTPUT->show_message('filtersaveerror', 'error');
+    }
+  }
+  elseif ($action=='down' && !$error)
+  {
+    if (isset($SCRIPT[$fid]) && isset($SCRIPT[$fid+1]))
+    {
+      if ($SIEVE->script->update_rule($fid, $SCRIPT[$fid+1]) !== false
+        && $SIEVE->script->update_rule($fid+1, $SCRIPT[$fid]) !== false)
+   $result = $SIEVE->save();
+      
+      if ($result)
+      {
+//        $OUTPUT->show_message('filtersaved', 'confirmation');
+   $OUTPUT->command('sievefilter_updatelist', 'down', '', $fid);
+      }
+      else
+        $OUTPUT->show_message('filtersaveerror', 'error');
+    }
+  }
+  elseif ($action=='delete' && !$error)
+  {
+    if (isset($SCRIPT[$fid]))
+    {
+      if ($SIEVE->script->delete_rule($fid))
+        $result = $SIEVE->save();
+
+      if (!$result)
+        $OUTPUT->show_message('filterdeleteerror', 'error');
+      else
+      {
+   $OUTPUT->show_message('filterdeleted', 'confirmation');
+   $OUTPUT->command('sievefilter_updatelist', 'delete', '', $fid);
+      }
+    }
+  }
+  elseif ($action=='ruleadd')
+  {
+    $rid = get_input_value('_rid', RCUBE_INPUT_GPC);
+    $id = genid();
+    $content = rcmail_rule_div($fid, $id, false);
+
+    $OUTPUT->command('sievefilter_rulefill', $content, $id, $rid);
+  }
+  elseif ($action=='actionadd')
+  {
+    $aid = get_input_value('_aid', RCUBE_INPUT_GPC);
+    $id = genid();
+    $content = rcmail_action_div($fid, $id, false);
+    
+    $OUTPUT->command('sievefilter_actionfill', $content, $id, $aid);
+  }
+
+  $OUTPUT->send();
+}
+
+$OUTPUT->set_pagetitle(rcube_label('filters'));
+  
+// register UI objects
+$OUTPUT->add_handlers(array(
+  'filterslist' => 'rcmail_filters_list',
+  'filterframe' => 'rcmail_filter_frame',
+  'filterform' => 'rcmail_filter_form',
+));
+
+// Handle form action 
+if (isset($_GET['_framed']) || isset($_POST['_framed']))
+  $OUTPUT->send('managesieveedit');
+else
+  $OUTPUT->send('managesieve');
+
+?>
diff -ruNa rc-beta2-old/skins/default/filters.css rc-beta2/skins/default/filters.css
--- rc-beta2-old/skins/default/filters.css  1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/filters.css  2009-03-01 15:32:29.743529598 +0100
@@ -0,0 +1,157 @@
+/***** RoundCube|Filters styles *****/
+
+
+#filterslist
+{
+  position: absolute;
+  left: 20px;
+  width: 220px;
+  top: 130px;
+  bottom: 30px;
+  border: 1px solid #999999;
+  background-color: #F9F9F9;
+  overflow: auto;
+  /* css hack for IE */
+  height: expression((parseInt(document.documentElement.clientHeight)-155)+'px');
+}
+
+#filters-table
+{
+  width: 100%;
+  table-layout: fixed;
+  /* css hack for IE */
+  width: expression(document.getElementById('filterslist').clientWidth);
+}
+
+#filters-table tbody td
+{
+  cursor: pointer;
+}
+
+#filtersbuttons
+{
+  position: absolute;
+  left: 20px;
+  top: 95px;
+}
+
+#filter-box
+{
+  position: absolute;
+  top: 95px;
+  left: 250px;
+  right: 20px;
+  bottom: 30px;
+  border: 1px solid #999999;
+  overflow: hidden;
+  /* css hack for IE */
+  width: expression((parseInt(document.documentElement.clientWidth)-30-parseInt(document.getElementById('filterslist').offsetLeft)-parseInt(document.getElementById('filterslist').offsetWidth))+'px');
+  height: expression((parseInt(document.documentElement.clientHeight)-120)+'px');
+}
+
+#filter-frame
+{
+  background-color: #F9F9F9;
+  border: none;
+}
+
+body.iframe
+{
+  background-color: #F9F9F9;
+  min-width: 740px;
+  width: expression(Math.max(740, document.documentElement.clientWidth)+'px');
+}
+
+#filter-form
+{
+  min-width: 650px;
+  white-space: nowrap;
+  background-color: #F9F9F9;
+  padding: 20px 10px 10px 10px;
+}
+
+#filter-form input, select
+{
+  font-size: 10pt;
+  font-family: inherit;
+}
+
+fieldset
+{
+  background-color: white;
+}
+
+label
+{
+  color: #666666;
+}
+
+#rules, #actions
+{
+  margin-top: 5px;
+  width: 100%;
+  padding: 0;
+  border-collapse: collapse;
+}
+
+div.rulerow, div.actionrow
+{
+  width: 100%;
+  padding: 2px;
+  white-space: nowrap;
+  float: left;
+  border: 1px solid white;
+  display: block;
+}
+
+div.rulerow:hover, div.actionrow:hover
+{
+  padding: 2px;
+  white-space: nowrap;
+  display: block;
+  float: left;
+  background: #F2F2F2;
+  border: 1px solid silver;
+}
+
+div.rulerow table, div.actionrow table
+{
+  width: 100%;
+  padding: 0px;
+}
+
+td.rowbuttons
+{
+  width: 98%;
+  text-align: right;
+  white-space: nowrap;
+}
+
+td.rowactions, td.rowtargets
+{
+  width: 1%;
+  white-space: nowrap;
+}
+
+input.disabled, input.disabled:hover
+{
+  color: #999999;
+}
+
+input.error, textarea.error
+{
+  background-color: #FFFF88;
+}
+
+input.box,
+input.radio
+{
+  border: 0;
+}
+
+span.label
+{
+  color: #666666;
+  font-size: 10px;
+  white-space: nowrap;
+}
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_add_pas.png rc-beta2/skins/default/images/buttons/filter_add_pas.png
--- rc-beta2-old/skins/default/images/buttons/filter_add_pas.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_add_pas.png    2009-02-11 08:59:02.944429779 +0100
@@ -0,0 +1,6 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? +?P?X  ?IDATX?M?W??^??????wmgm?#'?D??:??H??!?@Ns?D.Hp??#K   BJ?? D?^yegwvgg{????0?;3f??????U?????ZT??6??lf????G-U ??{????Wu????D ????3?s????c?Y???????h:??c9P]TE???T??????~?c???}?XK?{"2<E?+K?}???c?FQU?(?[9?x-??8?XTH 2?`??[k?>?w??zk????n???]
+??o???Dh=Q??]?h??????U%v??I??(>????c?9b?.=???6?&-?'???I?'"??2??&G?T???nC?JFY?cx}D??N:Byj?????0v?????xi4 ???Ag#j&????G?Y?gJ?g
+???v9????????Y??? ?$?1_?piv????????z??????P?T7?hyH%??(??????o????KJ??Ts?z?????j?z???>???}???~?3?yX?+$B??P???jy?/??/?_'v1?Sm:?&?_y????j?cnj?;??????A????V\90*??????P?B????n????SID?z:?pe?i????rc???\?I??k??n|Y??4U??A L?+?/Y??????L;C?:Ni9)hEJ'RZ6p?Q?~??)?5???Gi?*w?{??b?Fb2j?pb?j&?$VIlN??m6X??????Z\??X??i??L?kX,?M.6=5?I?{!2U??Q=O?:?*???o?W???????h???R?"(???*?2?K=???:??^=?U?9?^>x??????ubS0??f?M??h?!?%?:?fsU!2B?'?qU?v(?a???,Dt??J@?;????o^??Pws\??F,?u??39?????ICB#j??"_?qcy?i?L??????4ww?F_?(?M@P?$Q?????t]???s(R??{??i????7&???FJz?Ly?/?JVH?w?M<?"1X??Cdb??P?.?^???g??oL?a??\???????UT:x-???1??Yh^?T????????P?:???{")?,?Msy?K???????k????$???U??_?Ss_(???o??&?!ldYvSD?HeG??Tas?a??,M]Y???o????}??t1I?L?3?k]?????`?W?GT??wt:R%$??33/???;;??????b
+b?`*^`?v?D?i???~???7?$??UK&.?GX-7??s/?????D????Y?^?}?{#Rdy>????E??tgSG ??    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_add.png rc-beta2/skins/default/images/buttons/filter_add.png
--- rc-beta2-old/skins/default/images/buttons/filter_add.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_add.png    2009-02-11 08:59:02.968421060 +0100
@@ -0,0 +1,13 @@
+?PNG
+
+   IHDR           szz?    pHYs     ??    cHRM  z%  ??  ??  ??  u0  ?`  :?  o?_?F  ?IDATx?[lW???e/??u???8?9??u???HU?*D???> ?
+?%HT????<5/H?(T?
+?mS?$-???@.j??q???????????0?k;q?]8?3g???;????GYky????????Q
+??B?r?
+?k????md??j??c?5km?>?d3]=]???lf???X?"Bd???hzvnj?F?W??? ??&?eM?ZbD??LFo??x????R???:k????T"vmM?Vh??J?????}???ndU?)?????k?P   1B:?*~t??\??^m???o?`C??\?m?@??)?????[???\&?3\?>F???]?]???V?uXi?k??l&CGqA?%?IcD???[??????4{(??8Z?y.A?%????U??nv??Mnb-X?u?`5???n?$W?l???z???(??k,?i?w5?K?v?D?h??%?A-??? ??`B?E?4???D+?1??"?G)\Wq?H?I??uX???R??8??g?D?zi
+n?J*?2?v????;?N??    ??IP?%??a?:??x?r~?F?KDb??Y????C{?????oO/?hg?nE?F?n?W??7(?UCl5????N1W?)???T8?z???????v???K?'3O\/??p?s?
+ H3?/??E??z?u?y?4O?dg????v/QH?8w?9???E'?????7?z???h?xif??F?????=2?H??%c?U??????cS>C???<??a???!????!qG{s??W???bw?q??:?:?????I<?d>?3?|???v?[R?as?6U?(??Xz2?f??#????>???Jw-_?\?[@b?b?? "?l4b??r?|?????@????{??q? ?Z<CP?*|?????qr??6?[?[?6?a$??j'?l??XRx?7?Ww?l???i?O98J?v?h??Xy????Xahv?0??x?*cfjgG?p????icb?IJN??wz???(?w????o???t????4??~?'??N2????^?P?ZE$"??G??D!?+e?UxZ?9
+??,?b#v7#ZU?G???  ?[????c????'????}?????g?:?(?)Z?y??<?j?2?#? @??!NBjY????+a??y{?$?R???06??????}??\???)?E??Q
+?Ok?a68?V?LB?@?@dV-??e??? ]-?R??-??^d=<?x?q?K???b
+?dMsx?g?/??\?n(  ?.??}?|$??l???}?=v??U?.??*aP???ta_??LL??h??V5?Z?Fh?? q?d?47MofG?<??.53??]B????;y????{???b?^|???:?Fn|?Z?N5B????7?J??_??1J?
+_?xn??;z??????????????n??X|??u???????s???Zyl?+?????$??x??9g????|??????d?-8z?r?uhz?????B?o?3???7??&?,MN.?1?gO?"2J)??J\?vt?Fi???l????z?<(*?j????????k:?i?o9??g f    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_add_sel.png rc-beta2/skins/default/images/buttons/filter_add_sel.png
--- rc-beta2-old/skins/default/images/buttons/filter_add_sel.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_add_sel.png    2009-02-11 08:59:02.996428630 +0100
@@ -0,0 +1,13 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? /,_?i  ?IDATX?]lW?????wm?]?v'??4m?????*?
+?!}l%$}? }??}AB?T"?70?? >()?N(J?DI? DI??q??w??3s??a??N?F??u?????s????s?)??>?    g?1?o??*??????$sc~??F???f????ra8::4?7??M?,??
+"?s??^Y??..,???????&?M??-6DcQ??J??q??X^???y????k???Xc??&???l?=1fM_c?Z?)?Lf???N?r??n ?F?w=&???f????O?????m???3p/p?]???r?y?^?#N???C?S ????xd?????0?""??h??'??F,X>?f?? k,????G????!? ??? '??UP?-?@??i?{?(?_?\7?v??l??????C??M?????VC:@n?d?%??*?w>o+? ??*?8i????b????????[?????6<u  ??J*B?g)?9????a?U?go???9?*$I????????95w???"N?|2?'?8<??????o??*????~E?6?m?????E%n$h#?????Kg_c5m??(XX?:??/????????}/??????o??_???> ?Z??$ ??i^?4?F??.????bw?(C??????I
+?<?7?????9?x?g??"????/?\?\???kmW?<Y?5?s8?p??<:???p??p?????mc?C
+A???????|i?$??????)fR???j???<?}???????DI]???Dp*8u8?&C"?qJ???????-?=????P??y???HV
+R??gf?o?cdp?k?????')?s???:??V?3???
+{?
+~?B?????: ?8r>?B!?????@???o??3O???tEAs0???2?E???L(FyFz>F`,?X?^K??v???)
+A?C?Z?I??c?1?M?41?+<??oz6???k40w??c5?N_???gw=?n?>???w????+???*I9?s?9q?????
+??z?T?7???-j??`0?%??q??v??@W???`#?Q??h??|?__?VkX@_??O??
+?8y??.??a0,(fj,'yJJ??#j3?4Aj????E?Y???I??????7????iB!??O?x??k??????Q?j?j?????J?????~?? ??6,?T?TRv?M0?s???   r~,??v?z?'?Edl????(?]?'??%??NJ[?\?w????SQV?1?{?#$?aj???v?IXM&??????????fBE???w?V?_^]?_vp??o?&?:H?????9y?8+?'???&4$e??I????p??8^l+???tv??:c?m~?v????3T?+{F????w?????iV?%?)?X???x#<:?Em;?X?????J??mfff?7ON{[??EU?a?y`??s?????????a?q????%???*?`??YZ??\??8?=?????a??b%???vkq?{+????FJ?<???R$??LYR9[Y^y}.?v?Z?Zk?????cW??    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_del_pas.png rc-beta2/skins/default/images/buttons/filter_del_pas.png
--- rc-beta2-old/skins/default/images/buttons/filter_del_pas.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_del_pas.png    2009-02-11 08:59:03.020424940 +0100
@@ -0,0 +1,14 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? *4??@  ?IDATX?K?G?U??===3??u????Q?,??"?SDN?GHN?q?\?? '$??KBI??D?]?1? ?a????z?;???L??8???qI???QU??????D???]?^R??i?v?(?????U9??F???<?|??7?{" m0_?&?Ck??YD?"??Z??Y??jw~??``2~?? EP
+?t%)?4w?Z??{C??1???y*?)?BV????3???~i??h?b/? s?~*??[qW 
+&Pj??(??6??~??0T?1?n/e???z?I???Z59??{
+?0??$?   ??"???X?/????_?BkMh-???n'??['-?{??a&6???DtWW????@
+??^??H???^?- >[?^&???>Hx?R?,;#????|xi?<??4?1?B?a-
+??5???9c<C??~XRN?;????7t/]?w?
+y???`lH8=M?g???g?????????f?P???"n??;G?=?????>?  ?XP
+????U??<????cO????Z???7???  /?x?/???8??=?ko????R?FFFh??R?R?F?????~MU??a???%? 0R?L/~??M???<}????`c?J?)??9?{?`?'@????,??F?$?????kL????Z?L?"?'????3w????l??l??$?C_`??Q??N{?3u?}?8?Ge??G?????*/<??j??Z?MF.???-??t??+pKWac??\F{???x?^?G??t?<??' ?4?SJz/?\?G7?I???n?#bkUom??p? ????<?4:?X??9??,???d??t:??(??'50~?/D8X?gD??@?
+???i?????? r? ???u??O?PG`!58?t?v?Dh????????????H? ?B3??8B?^?????
+Q?`b\?^n:???~?k???&?s??<?t????"???C  |???t?$?V???????eB?~\??s??y?e?F?`f7?K    k??????Z?~????x?p???jI*?laB???p??I6\?????:??????w??l?#Zo?6 h?5q9H?':?y2????????  ^?e?b?[4>"B?y*_9F??%??+?_=M?k???&?"!??B???"?{w?0???{?Roc?'2?j"&?d? ??.??<????
+??2??3?7HH?|?c?????>?O>??????<_/?
+ ??KY?]RJ9????????????*?g??/???}?b?8L<L???w?J;???D??}h??;?G;???blxI?\_y??9*.c???>x?>?V??y??i/???z}?;??.rBd?0?v?T?>gsR???x? ??????i???k???hF??:????+?\?6    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_del.png rc-beta2/skins/default/images/buttons/filter_del.png
--- rc-beta2-old/skins/default/images/buttons/filter_del.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_del.png    2009-02-11 08:59:03.064430050 +0100
@@ -0,0 +1,7 @@
+?PNG
+
+   IHDR           szz?    pHYs     ??    cHRM  z%  ??  ??  ??  u0  ?`  :?  o?_?F  ?IDATx?{?\U????;?{gvfw???]????]??m?    ??H?F?&?Q??T???XQ???jB?-T!A??P$"?R??P?J*m)??v?????{??????]w93g??????????^y??B?g?#?@?p?????1??????????,?b?m???q 2????.?e?Jk??H?H8??S?gXFs ??'?Kz?1????u???+???????c/i@????]Z?m  ,??+g?l?:?6-u#?L1?/t"??&?J?n??h6??UK a-??B??c?9 kfl?f?k???D?Mk??????'??Ez???7H5n??h;jY?aY ??R??.??&2?M????????.?????#@`  H$??L?[?[???f?L????\?    C{??C???f?m-u?? E5?{?0???,6?\A^??Q4?R???? f?rU ?m0??A]ORJ+B?Q:??6Fc???qWN??i?fY???7T?   ?0@??   ?E4?Hg3?\??xI?l?V?x? 4j???? f?B?1????<y?2F)?,?h???-[O?W)N??yl;5?ms?+s?k??? _???o>??TH7H?.BX?P2q?$#??M[?[?~?u?214??e????Sg@)???R
+Y?Q???!?RL??I??? )???lC7? ??x?4?|#????/?M?QV?|j??c ???u?PRG?JE,)R?>??Ci\??????{IMRIRB?(t???@??*??w7?[
+??D????cF?K??d?+?B?Q??0Sfd
+?4ww?n$?$r?SS?6????{p??8?,??}????~?????;???{kQ?:?Z???*3?? y?$??2k?2?A?y????c/?????? L?T?1??s????;f????D&?&????/g??W??a??5?2I<7???a?;? ?h??6?0vS3 ??z????i???pbt?]?|~s]?D ???>W?rVR*P
+??K"??e)7??????v??^?,D2O????FAWIg ??a??x??j^ ?/?HE??&??jA??r$*?A?AUX???s8?To???UX,!?????0???M?k??V_?????C2|???<?ShCI??U???wQ??!D?@ GG?????%??/?s?kU??j?4Z??VI?o3fr??O?km=???@?/s??[?/ ???34?:?-?^ ?i]y?/?N?P?}l???h6E?e????2rl?pl$??T?o?5??4?p/ =?0?r??$%????u??e-t8?B?a?*i???????z?????M???G(?S(?q???~???mTy?l?Bv?Gqn??3y??ZJ=??????8m???????lb??3??>?Sg??Y?Mr??|?o????$S??7m???????j???3??p?T.?X????????i????z?wiY=??????E^?A8  ?F*P?|?w??????Lx???3[  c???q{???F7???u????????W_B??????7??|;??M??59r???T???]????6?????uI???w????F(???d?}?45?lP*?m[???y??n?= ?)r#d    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_del_sel.png rc-beta2/skins/default/images/buttons/filter_del_sel.png
--- rc-beta2-old/skins/default/images/buttons/filter_del_sel.png    1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_del_sel.png    2009-02-11 08:59:03.088415326 +0100
@@ -0,0 +1,11 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? /78  ?IDATX?m?\W???w?wg7??y??]?4?5?"$6m?Ah!?_T)?bc?*AP??Z?)"4?*???XjcUjL????i^?}7?3;3w?y?????tWz???3??{??>????s???0o??p??X???yZ,B X?X?n?X?h?????Q?xN
+?r???w?????U?`?~???c,Zk\??yy?:35u??? ??&?e?hocB??-u??h?S37???: B?"vyE R??)D?l?<p2?wk??j?R ?@H???????C'??p?^y???z??'Z?[a??o?????}????????u???02>???qq?}R? ,???ad????aH?0????l6}?v^??E45RH!q=?t: ???6 ???]\???X???w!?R?K?K?v?Z.w??j~h??&
+?.P???I?[?j?!m *???????????R<h?Q?`?A?@a??)????\`??0y3)BVJ??D&????  =g^:r?=? ??Y??$?q?zl??~????????i???kU?????????????q??m???,?l????<???????W?z?T?N???*????L??][?mZ????L??GdG??? ?n??m?gm???K?DZ3{?$???)~R?[C:?%\? ?"??[Meh???k?3????t\????1?iZ??F+?V?y?Gkj??q??_?O??-???g????
+_??<??M???}dK%?????O?_?zJ?n_k????e????Z????????b/?e??Q(?Im?/??????3???%??????Wv?yxzt?G@???=??Y??????^?W?6?????T1?3?S??Wqry 
+?r???????????49`,?4c?.?????(???!??E?i? ?1W?0??'??? ??s/??8?S(p?7'???8Y/E."'G?S?\??mF'+A???Pm"jZcGG??a??C?y????')???/R??)??4??b??t&?u????b?????c??!??"??B?+3A???{??
+Y@??8JA??[??dd??$,7   ??:?Z???k1??xr=;N???>?S?AkMT? ???C~???1??4N*????DQ???$!P?69?h@PG?Z?F??m??<zd???Nz{'?S??/?&????)
+_?>JI??Z?-?^?j Zq?I?5?:?Z?b?l#D??P7+????p??????.2q? ?? ?W?`+5?|?y?O??& ?M????????0?zx???h?5???$?D/?O1??m.3??!*?;i??E????p??;\?q????
+cl3!??$??wZ?o~v??????o??<?Cp?9rx??U???.??8?<a-"??a?;?h4f)??j?Z?!??Sn??g*??????~???D?BM??R`????>? ??=???/??L????&???y??g???&x???x??q?s???^G?^?F??q???c6l?[yf???????T<08? +<Xk>?t
+7?z??)o?T?Bk?T???y?Z?;W+????V?-:??_1?'v??    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_down_pas.png rc-beta2/skins/default/images/buttons/filter_down_pas.png
--- rc-beta2-old/skins/default/images/buttons/filter_down_pas.png   1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_down_pas.png   2009-02-11 08:59:03.112426863 +0100
@@ -0,0 +1,9 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? +87?*  ?IDATX?W??U]?/?L?3??1????a^+6??=d??-??%?XDd   ?H?@#a???(?qP:    3d??LOUu?9,?_?G<???????w?{???2?J???3I\?n8?1?GUP?:Q??2?m?Z??>?????#?   ???g????aUETaxt?I???N?2O0??(UJ?4?
+D????7??8?}UD???k????/G????/ 7fDE    7????W?????0b?(\???8??8O?0??%M36{[l??Q??f?cL?c}?H???{\P???t-???^??|v L?!3d??9K?=a?_PU?0%=SeZ???w<+ CgT?.?#x??:rd????0?L?????|O??$SUE????%QuC&g ??#?pJ!?BV??
+?D?S:???r?l:k??Ev?(??=??L)l}???^?M?B?B:q?O;?Y??????/B0^3UT????+c?t;*:)
+???.\?';EN?t{\??>?Z?????6????????QE?:?2????UpS
+??\?\?6p?6Z4???O????qdf?(?t?X????^#??????;???}?ET??????R????????i?iF???y?g:G81w????P??z????{????(?%?????eB?Y/K??o?A?3:?Nh{??u?????t?B?p;????h7Z?w??S0?NTP?a????2???Yy???F??%q!f?A5qP?p?r=???;?????     &4?i2?2]??p+??j??:??;I?   ??L[Q)9??%D?[?=??FQ??D:?d????A???cWU??H???i??E????!ZVK*%K??|b????_?o?%?B.i??k`hZ???gZ?[C^???`>????1UN??e?????P?g?`t?u"????`???oQ??[?u?7ll]`&j???]k:OV
+???5????x? N???>X?#?O?L',???E($?????p.???(?$    <[?M?`?m\????.d??we?????r???e?r?1\??*?W???\X??0x?*?%,5?#?e^?v3?K??!?
+?J-?X0p?????_C???'?*?(?R?I>??d???~?lY??nh?I????{?????}?????)??8?_????[dy????*????ug?FD?[k'???l????>??G?_?p=???v'9??w?^?n??Y?G?k?6` ?w-?k=?J?d?m???I?????5???w?`~v??0?+???M??)?R??????????????dYza?]?_X???! }@8?'q??????????T??<???Ev^D:??i ?/????    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_down.png rc-beta2/skins/default/images/buttons/filter_down.png
--- rc-beta2-old/skins/default/images/buttons/filter_down.png   1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_down.png   2009-02-11 08:59:03.136415770 +0100
@@ -0,0 +1,7 @@
+?PNG
+
+   IHDR           szz?    pHYs     ??    cHRM  z%  ??  ??  ??  u0  ?`  :?  o?_?F  ?IDATx?il\W??y?yl??8?u??$m?R?VjZPDU$(???P?P ? H?Z@B(PT?TMh?D@,JP?I?Z??I?;??3?,??s??f?c'Nb?h?yo????y?9???m???R?R???9'??PT?Jbtb???R?????? ?H???t?Jr?"?a??D0"??3??????Bt?\??7?&u?????d2?7?4??|?1vu ?R?( ?Zk?RD?Fk??uO7???YkW???(?D/w_??Fb????~??tjPD?; W2x?J?P(?q?alJ?z?o????u_?f??_B)
+b????9?snd?R?|S??Z??U?R    ?\??H?t?gI%???O`?D"1i??.??CT??0)?H?X?#?JJ?$V"??iT ???Y??~?s8P?O\55d+3???}G?S];???hu ???\h?57_e+?J7&?J?D\3.z!??Qa???? \?'?1???????'N?W???? p?!?p{"S??
+A#?d$N?KQ?%???y*?z?i??7??A?*&K?<s?(GG??Ha?@M???}|h`??;6o{h?T8???D@??j?t?(?T-??? U6z?_?    3??D&Lk?86v??g???g>???????O?~????s?J7 ????A?;c?b???????li%?E???{??3<?r????HWK'?_??G??????OM\?:??^,C'.?M?u5k$?Z?pt?E?2???k???$i??'#<???|l?vtn")??6ttRV?O??=??'?x?*v8?X??+U???W[??R    (?2?8?3z[??O?X?zBWB ?WZw??}?v^??s???]??`&? xz?X1! c?^E?N??I>???????*??=??T?;?R??   ?????????6??-??nmjy???`L5???p:?
+??})K??????H? ?B???????0??<??7?2??????????t???v?c?????a??a??o?3????=?T l???;y????????7K*?'?y;?'R?}Kx?Z?6L?4?u$<?|???"Q????v?E? ???Ngrw??r??P?!    ?ND?d3fYT?N`m?????8?|?ANM` ?M&?
+??kIG???7_?K.?$QU$?S??m?R?t???? ?z+RMF?Fu-P)??y;??P.????W??x,X?2????I??????=????????2?q?TO?P?????????6??,??((??W????????R*?-?F?*???Y0?J?kCq?V???|`?s?? ????W?N_8?q??_???s??i?s?e6v????OL???T h?V??v8qRUWo?"a5???h6k??-?P?:J??V????????'?+<EG"IEJ&???>>??Q73>??X3?y?b/0?L??O{?????]??q?6?9/?_s{7%?u???x???1{+y??p?#4E??%???=??s?'Mn????_?? ?r?????EDV3?[q??G?-???l??????3??)??bH???Jm???w{NNN??????7N?[?m?wC?????5D"3ua???|????k??n??u??y#?????#?7?`?   ??,g?? (n?=??(    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_down_sel.png rc-beta2/skins/default/images/buttons/filter_down_sel.png
--- rc-beta2-old/skins/default/images/buttons/filter_down_sel.png   1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_down_sel.png   2009-02-11 08:59:03.160424513 +0100
@@ -0,0 +1,4 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? .??j?  ?IDATX?ldU????yo?L??v????m)eaYv???(A  ????Dc???H?1?/??n?Cc??FP?PTVTTQ`A~?fY?n???vf?=??N?????;?f?}?|???9???Gy?????(pu?q?aj??U1i??O}??l=??????~r I?LN?o???P????U????DQn??Juy?t? =?6\S???U/j?f ?8??$?e?S?*????Ez?p8zA?s??APs?ba??????qn?<?~d%G?kv?|?T,^??\???<???Y?????W?x,???w?? ??Q?ce?????l?y4pA?' J???&$IL?R????/J?$????????g????c?Y? ?!QR,&??=?b?Y?:?????a??6N?k??o?O{mXo??7g?5???a?F?B?&??@?e?0??.?#?????"?@???(????0? ???wfmA2??   ?y??*bB!?S?H??????-??&?tiEn??v??O=4???O??7???s?Sx??EEf??:??+??l??????j??'?)?y?k?@?{?!R??h????Z??O????Yn?RNJ???W?]x?Cc???+???])~??8 f?d ?#@??l? D<????????x???V?????_r?|???^ev?eF?xi?M>???8p?=?C?+?v??P???*?? ^??U$???????|??Ge[J"B37????3<C1l0{?+??)????7 T??!??)b??v8?J=-Z???G?/??1{?e8Q@;*9?7&e4????f?8?????????\T? P#3"?? ??"x?x?*??????\?yJQ?`>?:??9G9N??`0????????#s+????B ??N:?A?' ?X?7?E????m?NR??Lk?H??:7???x????72?`?/J??H?v?h???!f??Z??P??<{????wp???5?K???????;?n?8pX)?zVe%??Mu?a?\?7????????k> rr, p??v>s??q.?2\?`vF??w?p??(??q@QP?Z#U??:?|?WO????(??[L??R??{????G??sr?A??V???4Qkg?"j-?t??XK???????F??sO??WN??,?p????j<?`>aa??? ?r[??Wk?]hs@?
+?&????5??i???RK?????k?Ov?7?8???4?3?/bq????b?????,h?_E7?e??^?Z?'???H???8t?^??~1x???i????|5c????u????4m?? ???v???????V?????NS8??c???K_?V?J????)?m????K???'????07?@D?V??^?f????7%????w|f?z??t|?????9???~???YT??d k=M_??)J??????X??r??/?3?=z???<??4?b??|.?sJ?5_??=???qRiP?)?`j?Z??s???w???g?.?+W???QCq?I/I ?A?O--<?R_??py?C?n??q??}?V?=>?x???>?`S3?_jWS???-_    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_up_pas.png rc-beta2/skins/default/images/buttons/filter_up_pas.png
--- rc-beta2-old/skins/default/images/buttons/filter_up_pas.png 1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_up_pas.png 2009-02-11 08:59:03.188426495 +0100
@@ -0,0 +1,11 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? *????  ?IDATX?W???zt???x??3??$J???? A??6???7?XZbED@??"??@hd?y?$???g?g?????a????c;?a?+]?[}???s?s????7_?'???w???f`X?R?????(~?q???|j?  ?????g?(<??f??A?z??u?ts????!??V?????M ????;>=??$?}U???C  "????o?Qx??>Y P?bj??:?0?V??>?#?3"???Q??0w???qt " ??#M36??ln?)????x?-??DP%cx???(?A@?F?????h????^Ie??#
+C?(|????*??2?(?????? T?hT*y?? ???8<?? ? ?A?Y?U<?????<53L{@L?30_    ?09# ?????B1%+s??.??a#\?;????????f?CY*R*;?.?????v?CiJ?#f?  ??\>?23???n?????g!???>W"{??u?O:-
+??[-~??t??$? ??D????????;???3?O?n??*K?>j?jo5U?????zT?r?
+?[p?gz|?8i&    ''O?W???1n??????&??O?j?????@5??C??\??(???-q????qH?
+&#?kK?????ynrGF(?cc????G?f??A<?~)?\+:?Je?,??
+?p????????B?g?????????
+?@???Y?6?????D??}?\2? {)fZy?{?(????O_?=g^f~la@?_Z<???*BF#P???\k???V0 ?=?+L?sC?{?]N6???$  B^?=?\}??j?????3L'??uYn???A????K:???\?0/?le?ng??? ???AZd?????L?V?\N??\?8???!??P+?m(????@p,?pkg?~tGOd??ore? ???m?????b?p??????????7hm]g:q?*?no??w}?;??<??Xm'!I??EQ?"?}JX?e???HK??3?>h+?d???L??u??
+?R?&?????nOSw???N?V'??a????h??<?e????/??]?K??/??? 0??j<?v?Wy?_-
+x?e??YV???iD&)?9??[??3r-????b????????,?a!rnAC=???N7%?q>3?5D?QZ?b?Kks???i?]b/U(J?%?x~?U?l?w?s?f?????{???i???/3??????L???o.?wc???*]M????^??K?sM??<?b???????q??-?C??4\075??(?~?.?Lm?7???%?    c?q?jKyqgg??,K/????? ??H?0?x??o?a????9  ?L??y???U?Z%?? ???p?/    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_up.png rc-beta2/skins/default/images/buttons/filter_up.png
--- rc-beta2-old/skins/default/images/buttons/filter_up.png 1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_up.png 2009-02-11 08:59:03.212417637 +0100
@@ -0,0 +1,8 @@
+?PNG
+
+   IHDR           szz?    pHYs     ??    cHRM  z%  ??  ??  ??  u0  ?`  :?  o?_?F  ?IDATx?]l\W??w??x?N??NR??M???j??J?}T(    $T@j???????? AZ??HUUB??-J??D@?B)--$Nb;????w???????];?????W?w???f?3??s?????\????@+?(?Xi9?8?jXM?]?|v?\y?SV???????????={??7??9??F? ;6=[(LM?*???K?s??"7e?9?sX?J%??-?/?:??5?R?fYk,xZ??F)??4Z???????(??^??y
+?B"?????r[&?ED?; ?s???B?PJ???v????x???f??/????33;?+\?\?l?]??e?u?? \?W?MH&?t?s?S)??8????????1?L8?~4???"}PDI?{A??I?S?W??V"???[|?jo?BT?????le%t??w?^?{?[????g??;???N?????qkB?J(c??KF????b7p3L?sQc?7)k+8?  ?!N?8\\)<_5?-??CVA{"S    ???a#?????OSR?b?o|U??|?
+?2?74??? AU?)^:????_-N?!??-????8?u???????r?u??$j ?WG??B??1'8 ???????'x???L??t?{?%Wex?????????W?g^??~k?kT??(n?
+?f?ZL?c-"????????*?E,g?gm?$}?9????w??????#??F?C?Y?lki ?M????5]?m?T??????cl??DO[???@&?S???|?O??!|W ?t??????t???N????????z???F#???>?VC*??w????59n?te6?5O?y???m |{??|?? I5Go?0?????~t??k??{  ?X?@?? ??*??p???????3V?;?k??0??\J??;??Q?0?????o@:?????%?7??/?c?x?S8?}?}D?/m;???UK?y|s?!s???y??/3N?k1 ?(??????X?s??q?q?@???m?rG~ ??P????
+?y????{???2^??R???d:?? ?S?<?m3q??? ML???opf?????cx N????w_ ?d???????P??HC???U??pq??`}??s%a?r???|???N\>l_G??   ??_c????X?9kc??:Mg??\.?/dH?Z???"?d???s\????}7??y??9?l?V*5?!f?3???R~?? ?E????-??N-)?z???X>??5??[?m?O?z?4??F? ??d???y)<? ?B???5?R?\<?l -c?Ass<????O(???,???}?V?z????^?:9v?Z?T[?PK?l????F??v?.h7????C??T??0????Q?G?2S?%???JHl?}?O<L6?L?~?+?9??|,?L|??<HK
+6????i?`??T????w??22{+B[??t?3$c??46|?&?OL]y^CC??~s?s??f ??$????o????c?????df?{?L??Vn]s7kt??#s?Dd?Rv5 ????<3;??IWn?????;e76?u|N???/?]??1&?Z???? ??B'??    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/images/buttons/filter_up_sel.png rc-beta2/skins/default/images/buttons/filter_up_sel.png
--- rc-beta2-old/skins/default/images/buttons/filter_up_sel.png 1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/images/buttons/filter_up_sel.png 2009-02-11 08:59:03.236428615 +0100
@@ -0,0 +1,14 @@
+?PNG
+
+   IHDR           szz?   sRGB ???   bKGD ? ? ?????    pHYs     ??   tIME? .,d??  ?IDATX?]l\G?3?????^?v?&1??/7  m?&m(O????m?Ph??
+?  ????)??HT|(jZ!?JZ?G6)?? mL?6q\o?8???3??p??Y??;??????LLL0??3??
+?R?51?p??
+???EPqgK3W??T??(0????? !@&??r?`?l???,??*?!?s??????1pUT??*??E0@6???+:???o??`ho???b?!0kmn??m????~/??@?1??z??&b?x!??z??DG.?}9V?????Y?W??s?-?wm{&E????0?(???0U???Z}?@?    kl?- ????s2?==??,?T
+??L&s??3T??????7?H???ZB?r??lf???r?@R?'??Ub?wu?????:????4W???v?j?X???"??p??[?F?T??I?
+m?1???5???&1?}BP^/???(??? X+ 4??^6I?u??`W????4a?8?tT?AW??0
+Q/?????H?XnN9??A?3S???fl??L/\#?)???v?}??xi??X?V}I??*h?? ????
+I-???Z?z??{??????U??v?????1c?q?????????>???+?'??????????E?VIDq^Q\c????z???~H?J1??|??b??F???nF?6???7y?w?f? Ol?,??[?? ^\???????;I??'??CM?=?wO??m}????<??s|s??|x?=??)?<?=????r??@?{?Tz?i-?
+?x??+N4yk?z?J???Q??^=?`g??????K?=?hq _???8@?TL;F?=?Y??3S??x8
+?l?(???xq8?q.qG?)?8S>?B???)F5??!??}??M???0?? ??}=EN?~????|??+??^%?K?Mwx?wK???s????9??>????{?(xh?a????w?Zz?)Jnv????@kO???????$ ???UY?/SL?v????? ???d>7I??@*xx?????Ur????l~??4?y?,??4?b%;<?J:4?%4Ub7??+o???F????gx??? T}?????Bdo??-u`?x/W??B??`acv?sU?R???????$?o??p>G`???{????87_?Z??????Z?v>G?@h?yB%?+????#??ye6e?:F??k=??!?#8??%?^~\^?Dg??a???x???4l?WHCZ??S?/2?f?s?x?%?9??`??f   L?u???C?E?t?V}iu?$?e??R?,??-?c?!b??tf+???.f??C??>x??+?G??^oB+?x?F    n\??J?[,??7???_??e     'K?M>???S?UK>
+???y?????G??;??z?? V??{?]]\|5?5?7%???-G?*??p^???>u??t??L??YteNMCQ"??y?`??e??O????Cs??6:fbb??8(?4?^U??0?9??G:
+?oL?^??Xy???????????6????????)=VY(???p?mvD???iH,??]???????O6????8z??I&5?^NW_L/M?t????U???O#?&    IEND?B`?
\ Brak znaku nowej linii na kocu pliku
diff -ruNa rc-beta2-old/skins/default/includes/settingstabs.html rc-beta2/skins/default/includes/settingstabs.html
--- rc-beta2-old/skins/default/includes/settingstabs.html   2009-02-11 08:50:51.000000000 +0100
+++ rc-beta2/skins/default/includes/settingstabs.html   2009-02-11 08:59:03.272419030 +0100
@@ -2,4 +2,5 @@
 <span id="settingstabdefault" class="tablink"><roundcube:button command="preferences" type="link" label="preferences" title="editpreferences" /></span>
 <span id="settingstabfolders" class="tablink"><roundcube:button command="folders" type="link" label="folders" title="managefolders" class="tablink" /></span>
 <span id="settingstabidentities" class="tablink"><roundcube:button command="identities" type="link" label="identities" title="manageidentities" class="tablink" /></span>
+<span id="settingstabmanagesieve" class="tablink"><roundcube:button command="managesieve" type="link" label="filters" title="managefilters" class="tablink" /></span>
 </div>
diff -ruNa rc-beta2-old/skins/default/templates/managesieveedit.html rc-beta2/skins/default/templates/managesieveedit.html
--- rc-beta2-old/skins/default/templates/managesieveedit.html   1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/templates/managesieveedit.html   2009-02-24 10:08:45.851584233 +0100
@@ -0,0 +1,110 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<title><roundcube:object name="pagetitle" /></title>
+<roundcube:include file="/includes/links.html" />
+<link rel="stylesheet" type="text/css" href="/settings.css" />
+<link rel="stylesheet" type="text/css" href="/filters.css" />
+</head>
+<body class="iframe">
+
+<script type="text/javascript">
+
+function header_select(id)
+{
+    var obj = document.getElementById('header'+id);
+
+    if (obj.value == 'size')
+    {
+   document.getElementById('rule_size' + id).style.display = 'inline';
+   document.getElementById('rule_op' + id).style.display = 'none';
+   document.getElementById('rule_target' + id).style.display = 'none';
+   document.getElementById('custom_header' + id).style.display = 'none';
+    }
+    else
+    {
+   if (obj.value != '...')
+       document.getElementById('custom_header' + id).style.display = 'none';
+   else
+       document.getElementById('custom_header' + id).style.display = 'inline';
+    
+   document.getElementById('rule_size' + id).style.display = 'none';
+   document.getElementById('rule_op' + id).style.display = 'inline';
+   rule_op_select(id);
+    }
+}
+
+function rule_op_select(id)
+{
+    var obj = document.getElementById('rule_op'+id);
+
+    if (obj.value == 'exists' || obj.value == 'notexists')
+    {
+   document.getElementById('rule_target' + id).style.display = 'none';
+    }
+    else
+    {
+   document.getElementById('rule_target' + id).style.display = 'inline';
+    }
+}
+
+function action_type_select(id)
+{
+    var obj = document.getElementById('action_type'+id);
+
+    if (obj.value == 'fileinto')
+    {
+   document.getElementById('action_mailbox' + id).style.display = 'inline';
+   document.getElementById('action_target' + id).style.display = 'none';
+   document.getElementById('action_target_area' + id).style.display = 'none';
+   document.getElementById('action_vacation' + id).style.display = 'none';
+    }
+    else if (obj.value == 'redirect')
+    {
+   document.getElementById('action_target' + id).style.display = 'inline';
+   document.getElementById('action_mailbox' + id).style.display = 'none';
+   document.getElementById('action_target_area' + id).style.display = 'none';
+   document.getElementById('action_vacation' + id).style.display = 'none';
+    }
+    else if (obj.value.match(/^reject|ereject$/))
+    {
+   document.getElementById('action_target_area' + id).style.display = 'inline';
+   document.getElementById('action_vacation' + id).style.display = 'none';
+   document.getElementById('action_target' + id).style.display = 'none';
+   document.getElementById('action_mailbox' + id).style.display = 'none';
+    }
+    else if (obj.value == 'vacation')
+    {
+   document.getElementById('action_vacation' + id).style.display = 'inline';
+        document.getElementById('action_target_area' + id).style.display = 'none';
+   document.getElementById('action_target' + id).style.display = 'none';
+   document.getElementById('action_mailbox' + id).style.display = 'none';
+    }
+    else // discard, keep, stop
+    {
+   document.getElementById('action_target_area' + id).style.display = 'none';
+   document.getElementById('action_vacation' + id).style.display = 'none';
+   document.getElementById('action_target' + id).style.display = 'none';
+   document.getElementById('action_mailbox' + id).style.display = 'none';
+    }
+}
+
+function rule_join_radio(value)
+{
+    document.getElementById('rules').style.display = (value=='any' ? 'none' : 'block');
+}
+</script>
+
+<div id="filter-form">
+<roundcube:object name="filterform" />
+
+<p>
+<roundcube:button command="sievefiltersave" type="input" class="button mainaction" label="save" />
+</p>
+
+</form>
+</div>
+
+
+</body>
+</html>
diff -ruNa rc-beta2-old/skins/default/templates/managesieve.html rc-beta2/skins/default/templates/managesieve.html
--- rc-beta2-old/skins/default/templates/managesieve.html   1970-01-01 01:00:00.000000000 +0100
+++ rc-beta2/skins/default/templates/managesieve.html   2009-02-11 08:59:03.336432101 +0100
@@ -0,0 +1,34 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<title><roundcube:object name="pagetitle" /></title>
+<roundcube:include file="/includes/links.html" />
+<link rel="stylesheet" type="text/css" href="/settings.css" />
+<link rel="stylesheet" type="text/css" href="/filters.css" />
+<script type="text/javascript" src="/functions.js"></script>
+</head>
+<body onload="rcube_init_settings_tabs()">
+
+<roundcube:include file="/includes/taskbar.html" />
+<roundcube:include file="/includes/header.html" />
+<roundcube:include file="/includes/settingstabs.html" />
+
+<div id="filtersbuttons">
+<roundcube:button command="sievefilteradd" imageSel="/images/buttons/filter_add_sel.png" imagePas="/images/buttons/filter_add_pas.png" imageAct="/images/buttons/filter_add.png" width="32" height="32" title="filteradd" />
+<roundcube:button command="sievefilterdel" imageSel="/images/buttons/filter_del_sel.png" imagePas="/images/buttons/filter_del_pas.png" imageAct="/images/buttons/filter_del.png"  width="32" height="32" title="filterdel" />
+<roundcube:button command="sievefilterup" imageSel="/images/buttons/filter_up_sel.png" imagePas="/images/buttons/filter_up_pas.png" imageAct="/images/buttons/filter_up.png"  width="32" height="32" title="moveup" />
+<roundcube:button command="sievefilterdown" imageSel="/images/buttons/filter_down_sel.png" imagePas="/images/buttons/filter_down_pas.png" imageAct="/images/buttons/filter_down.png"  width="32" height="32" title="movedown" />
+</div>
+
+<div id="filterslist">
+<roundcube:object name="filterslist" id="filters-table" class="records-table" cellspacing="0" summary="Filters list" />
+</div>
+
+<div id="filter-box">
+<roundcube:object name="filterframe" id="filter-frame" width="100%" height="100%" frameborder="0" src="/watermark.html" />
+</div>
+
+<roundcube:include file="/includes/settingscripts.html" />
+
+</body>
+</html>
